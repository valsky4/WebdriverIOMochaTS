"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.default = exports.commands = void 0;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _cssConverter = _interopRequireDefault(require("../css-converter"));
var _driver = require("appium/driver");
var _support = require("appium/support");
const MAGIC_FIRST_VIS_CHILD_SEL = /\/\*\[@firstVisible\s*=\s*('|")true\1\]/;
const MAGIC_SCROLLABLE_SEL = /\/\/\*\[@scrollable\s*=\s*('|")true\1\]/;
const WDA_CLASS_CHAIN_STRATEGY = 'class chain';
let helpers = {},
  commands = {},
  extensions = {};
exports.commands = commands;
exports.helpers = helpers;
helpers.findElOrEls = async function findElOrEls(strategy, selector, mult, context) {
  if (this.isWebview()) {
    return await this.findWebElementOrElements(strategy, selector, mult, context);
  } else {
    return await this.findNativeElementOrElements(strategy, selector, mult, context);
  }
};
helpers.findNativeElementOrElements = async function findNativeElementOrElements(strategy, selector, mult, context) {
  const initSelector = selector;
  let rewroteSelector = false;
  if (strategy === '-ios predicate string') {
    strategy = 'predicate string';
  } else if (strategy === '-ios class chain') {
    strategy = WDA_CLASS_CHAIN_STRATEGY;
  } else if (strategy === 'css selector') {
    strategy = WDA_CLASS_CHAIN_STRATEGY;
    selector = _cssConverter.default.toIosClassChainSelector(selector);
  }
  function stripViewFromSelector(selector) {
    const keepView = ['XCUIElementTypeScrollView', 'XCUIElementTypeCollectionView', 'XCUIElementTypeTextView', 'XCUIElementTypeWebView'].includes(selector);
    if (!keepView && selector.indexOf('View') === selector.length - 4) {
      return selector.substr(0, selector.length - 4);
    } else {
      return selector;
    }
  }
  if (strategy === 'class name') {
    if (selector.startsWith('UIA')) {
      selector = selector.substring(3);
    }
    if (!selector.startsWith('XCUIElementType')) {
      selector = stripViewFromSelector(`XCUIElementType${selector}`);
      rewroteSelector = true;
    }
  }
  if (strategy === 'xpath' && MAGIC_FIRST_VIS_CHILD_SEL.test(selector)) {
    return await this.getFirstVisibleChild(mult, context);
  } else if (strategy === 'xpath' && MAGIC_SCROLLABLE_SEL.test(selector)) {
    [strategy, selector] = rewriteMagicScrollable(mult, this.log);
  } else if (strategy === 'xpath') {
    selector = selector.replace(/(^|\/)(UIA)([^[/]+)/g, (str, g1, g2, g3) => {
      rewroteSelector = true;
      return g1 + stripViewFromSelector(`XCUIElementType${g3}`);
    });
  }
  if (rewroteSelector) {
    this.log.info(`Rewrote incoming selector from '${initSelector}' to ` + `'${selector}' to match XCUI type. You should consider ` + `updating your tests to use the new selectors directly`);
  }
  return await this.doNativeFind(strategy, selector, mult, context);
};
helpers.doNativeFind = async function doNativeFind(strategy, selector, mult, context) {
  context = _support.util.unwrapElement(context);
  let endpoint = `/element${context ? `/${context}/element` : ''}${mult ? 's' : ''}`;
  let body = {
    using: strategy,
    value: selector
  };
  let method = 'POST';
  let els;
  try {
    await this.implicitWaitForCondition(async () => {
      try {
        els = await this.proxyCommand(endpoint, method, body);
      } catch (err) {
        els = [];
      }
      return !_lodash.default.isEmpty(els);
    });
  } catch (err) {
    if (err.message && err.message.match(/Condition unmet/)) {
      els = [];
    } else {
      throw err;
    }
  }
  if (mult) {
    return els;
  }
  if (_lodash.default.isEmpty(els)) {
    throw new _driver.errors.NoSuchElementError();
  }
  return els;
};
helpers.getFirstVisibleChild = async function getFirstVisibleChild(mult, context) {
  this.log.info(`Getting first visible child`);
  if (mult) {
    throw new Error('Cannot get multiple first visible children!');
  }
  if (!context) {
    throw new Error('Cannot get first visible child without a context element');
  }
  let index = 1;
  while (true) {
    const strategy = WDA_CLASS_CHAIN_STRATEGY;
    const selector = `*[${index}]`;
    const nthChild = await this.doNativeFind(strategy, selector, false, context);
    const visible = await this.getAttribute('visible', nthChild);
    if (visible === 'true') {
      this.log.info(`Found first visible child at position ${index}`);
      return nthChild;
    }
    index++;
  }
};
function rewriteMagicScrollable(mult, log = null) {
  const pred = ['ScrollView', 'Table', 'CollectionView', 'WebView'].map(t => `type == "XCUIElementType${t}"`).join(' OR ');
  const strategy = WDA_CLASS_CHAIN_STRATEGY;
  let selector = '**/*[`' + pred + '`]';
  if (!mult) {
    selector += '[1]';
  }
  log === null || log === void 0 ? void 0 : log.info('Rewrote request for scrollable descendants to class chain ' + `format with selector '${selector}'`);
  return [strategy, selector];
}
Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfY3NzQ29udmVydGVyIiwiX2RyaXZlciIsIl9zdXBwb3J0IiwiTUFHSUNfRklSU1RfVklTX0NISUxEX1NFTCIsIk1BR0lDX1NDUk9MTEFCTEVfU0VMIiwiV0RBX0NMQVNTX0NIQUlOX1NUUkFURUdZIiwiaGVscGVycyIsImNvbW1hbmRzIiwiZXh0ZW5zaW9ucyIsImV4cG9ydHMiLCJmaW5kRWxPckVscyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsImlzV2VidmlldyIsImZpbmRXZWJFbGVtZW50T3JFbGVtZW50cyIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImluaXRTZWxlY3RvciIsInJld3JvdGVTZWxlY3RvciIsIkNzc0NvbnZlcnRlciIsInRvSW9zQ2xhc3NDaGFpblNlbGVjdG9yIiwic3RyaXBWaWV3RnJvbVNlbGVjdG9yIiwia2VlcFZpZXciLCJpbmNsdWRlcyIsImluZGV4T2YiLCJsZW5ndGgiLCJzdWJzdHIiLCJzdGFydHNXaXRoIiwic3Vic3RyaW5nIiwidGVzdCIsImdldEZpcnN0VmlzaWJsZUNoaWxkIiwicmV3cml0ZU1hZ2ljU2Nyb2xsYWJsZSIsImxvZyIsInJlcGxhY2UiLCJzdHIiLCJnMSIsImcyIiwiZzMiLCJpbmZvIiwiZG9OYXRpdmVGaW5kIiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJlbmRwb2ludCIsImJvZHkiLCJ1c2luZyIsInZhbHVlIiwibWV0aG9kIiwiZWxzIiwiaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uIiwicHJveHlDb21tYW5kIiwiZXJyIiwiXyIsImlzRW1wdHkiLCJtZXNzYWdlIiwibWF0Y2giLCJlcnJvcnMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJFcnJvciIsImluZGV4IiwibnRoQ2hpbGQiLCJ2aXNpYmxlIiwiZ2V0QXR0cmlidXRlIiwicHJlZCIsIm1hcCIsInQiLCJqb2luIiwiT2JqZWN0IiwiYXNzaWduIiwiX2RlZmF1bHQiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2NvbW1hbmRzL2ZpbmQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBDc3NDb252ZXJ0ZXIgZnJvbSAnLi4vY3NzLWNvbnZlcnRlcic7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0vZHJpdmVyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0vc3VwcG9ydCc7XG5cbi8vIHdlIG92ZXJyaWRlIHRoZSB4cGF0aCBzZWFyY2ggZm9yIHRoaXMgZmlyc3QtdmlzaWJsZS1jaGlsZCBzZWxlY3Rvciwgd2hpY2hcbi8vIGxvb2tzIGxpa2UgLypbQGZpcnN0VmlzaWJsZT1cInRydWVcIl1cbmNvbnN0IE1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwgPSAvXFwvXFwqXFxbQGZpcnN0VmlzaWJsZVxccyo9XFxzKignfFwiKXRydWVcXDFcXF0vO1xuXG4vLyB3ZSBsaWtld2lzZSBvdmVycmlkZSB4cGF0aCBzZWFyY2ggdG8gcHJvdmlkZSBhIHNob3J0Y3V0IGZvciBmaW5kaW5nIGFsbFxuLy8gc2Nyb2xsYWJsZSBlbGVtZW50c1xuY29uc3QgTUFHSUNfU0NST0xMQUJMRV9TRUwgPSAvXFwvXFwvXFwqXFxbQHNjcm9sbGFibGVcXHMqPVxccyooJ3xcIil0cnVlXFwxXFxdLztcblxuY29uc3QgV0RBX0NMQVNTX0NIQUlOX1NUUkFURUdZID0gJ2NsYXNzIGNoYWluJztcblxubGV0IGhlbHBlcnMgPSB7fSwgY29tbWFuZHMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5oZWxwZXJzLmZpbmRFbE9yRWxzID0gYXN5bmMgZnVuY3Rpb24gZmluZEVsT3JFbHMgKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICBpZiAodGhpcy5pc1dlYnZpZXcoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRXZWJFbGVtZW50T3JFbGVtZW50cyhzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyhzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICB9XG59O1xuXG5oZWxwZXJzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyA9IGFzeW5jIGZ1bmN0aW9uIGZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIGNvbnN0IGluaXRTZWxlY3RvciA9IHNlbGVjdG9yO1xuICBsZXQgcmV3cm90ZVNlbGVjdG9yID0gZmFsc2U7XG4gIGlmIChzdHJhdGVneSA9PT0gJy1pb3MgcHJlZGljYXRlIHN0cmluZycpIHtcbiAgICAvLyBXZWJEcml2ZXJBZ2VudCB1c2VzICdwcmVkaWNhdGUgc3RyaW5nJ1xuICAgIHN0cmF0ZWd5ID0gJ3ByZWRpY2F0ZSBzdHJpbmcnO1xuICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSAnLWlvcyBjbGFzcyBjaGFpbicpIHtcbiAgICAvLyBXZWJEcml2ZXJBZ2VudCB1c2VzICdjbGFzcyBjaGFpbidcbiAgICBzdHJhdGVneSA9IFdEQV9DTEFTU19DSEFJTl9TVFJBVEVHWTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gJ2NzcyBzZWxlY3RvcicpIHtcbiAgICBzdHJhdGVneSA9IFdEQV9DTEFTU19DSEFJTl9TVFJBVEVHWTtcbiAgICBzZWxlY3RvciA9IENzc0NvbnZlcnRlci50b0lvc0NsYXNzQ2hhaW5TZWxlY3RvcihzZWxlY3Rvcik7XG4gIH1cblxuICAvLyBDaGVjayBpZiB0aGUgd29yZCAnVmlldycgaXMgYXBwZW5kZWQgdG8gc2VsZWN0b3IgYW5kIGlmIGl0IGlzLCBzdHJpcCBpdCBvdXRcbiAgZnVuY3Rpb24gc3RyaXBWaWV3RnJvbVNlbGVjdG9yIChzZWxlY3Rvcikge1xuICAgIC8vIERvbid0IHN0cmlwIGl0IG91dCBpZiBpdCdzIG9uZSBvZiB0aGVzZSA0IGVsZW1lbnQgdHlwZXNcbiAgICAvLyAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9XZWJEcml2ZXJBZ2VudC9ibG9iL21hc3Rlci9XZWJEcml2ZXJBZ2VudExpYi9VdGlsaXRpZXMvRkJFbGVtZW50VHlwZVRyYW5zZm9ybWVyLm0gZm9yIHJlZmVyZW5jZSlcbiAgICBjb25zdCBrZWVwVmlldyA9IFtcbiAgICAgICdYQ1VJRWxlbWVudFR5cGVTY3JvbGxWaWV3JyxcbiAgICAgICdYQ1VJRWxlbWVudFR5cGVDb2xsZWN0aW9uVmlldycsXG4gICAgICAnWENVSUVsZW1lbnRUeXBlVGV4dFZpZXcnLFxuICAgICAgJ1hDVUlFbGVtZW50VHlwZVdlYlZpZXcnLFxuICAgIF0uaW5jbHVkZXMoc2VsZWN0b3IpO1xuXG4gICAgaWYgKCFrZWVwVmlldyAmJiBzZWxlY3Rvci5pbmRleE9mKCdWaWV3JykgPT09IHNlbGVjdG9yLmxlbmd0aCAtIDQpIHtcbiAgICAgIHJldHVybiBzZWxlY3Rvci5zdWJzdHIoMCwgc2VsZWN0b3IubGVuZ3RoIC0gNCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBzZWxlY3RvcjtcbiAgICB9XG4gIH1cblxuICBpZiAoc3RyYXRlZ3kgPT09ICdjbGFzcyBuYW1lJykge1xuICAgIC8vIFhDVUlUZXN0IGNsYXNzZXMgaGF2ZSBgWENVSUVsZW1lbnRUeXBlYCBwcmVwZW5kZWRcbiAgICAvLyBmaXJzdCBjaGVjayBpZiB0aGVyZSBpcyB0aGUgb2xkIGBVSUFgIHByZWZpeFxuICAgIGlmIChzZWxlY3Rvci5zdGFydHNXaXRoKCdVSUEnKSkge1xuICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5zdWJzdHJpbmcoMyk7XG4gICAgfVxuICAgIC8vIG5vdyBjaGVjayBpZiB3ZSBuZWVkIHRvIGFkZCBgWENVSUVsZW1lbnRUeXBlYFxuICAgIGlmICghc2VsZWN0b3Iuc3RhcnRzV2l0aCgnWENVSUVsZW1lbnRUeXBlJykpIHtcbiAgICAgIHNlbGVjdG9yID0gc3RyaXBWaWV3RnJvbVNlbGVjdG9yKGBYQ1VJRWxlbWVudFR5cGUke3NlbGVjdG9yfWApO1xuICAgICAgcmV3cm90ZVNlbGVjdG9yID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBpZiAoc3RyYXRlZ3kgPT09ICd4cGF0aCcgJiYgTUFHSUNfRklSU1RfVklTX0NISUxEX1NFTC50ZXN0KHNlbGVjdG9yKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldEZpcnN0VmlzaWJsZUNoaWxkKG11bHQsIGNvbnRleHQpO1xuICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSAneHBhdGgnICYmIE1BR0lDX1NDUk9MTEFCTEVfU0VMLnRlc3Qoc2VsZWN0b3IpKSB7XG4gICAgW3N0cmF0ZWd5LCBzZWxlY3Rvcl0gPSByZXdyaXRlTWFnaWNTY3JvbGxhYmxlKG11bHQsIHRoaXMubG9nKTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gJ3hwYXRoJykge1xuICAgIC8vIFJlcGxhY2UgVUlBIGlmIGl0IGNvbWVzIGFmdGVyIGEgZm9yd2FyZCBzbGFzaCBvciBpcyBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBzdHJpbmdcbiAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoLyhefFxcLykoVUlBKShbXlsvXSspL2csIChzdHIsIGcxLCBnMiwgZzMpID0+IHtcbiAgICAgIHJld3JvdGVTZWxlY3RvciA9IHRydWU7XG4gICAgICByZXR1cm4gZzEgKyBzdHJpcFZpZXdGcm9tU2VsZWN0b3IoYFhDVUlFbGVtZW50VHlwZSR7ZzN9YCk7XG4gICAgfSk7XG4gIH1cblxuICBpZiAocmV3cm90ZVNlbGVjdG9yKSB7XG4gICAgdGhpcy5sb2cuaW5mbyhgUmV3cm90ZSBpbmNvbWluZyBzZWxlY3RvciBmcm9tICcke2luaXRTZWxlY3Rvcn0nIHRvIGAgK1xuICAgICAgICAgICAgIGAnJHtzZWxlY3Rvcn0nIHRvIG1hdGNoIFhDVUkgdHlwZS4gWW91IHNob3VsZCBjb25zaWRlciBgICtcbiAgICAgICAgICAgICBgdXBkYXRpbmcgeW91ciB0ZXN0cyB0byB1c2UgdGhlIG5ldyBzZWxlY3RvcnMgZGlyZWN0bHlgKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLmRvTmF0aXZlRmluZChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xufTtcblxuaGVscGVycy5kb05hdGl2ZUZpbmQgPSBhc3luYyBmdW5jdGlvbiBkb05hdGl2ZUZpbmQgKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICBjb250ZXh0ID0gdXRpbC51bndyYXBFbGVtZW50KGNvbnRleHQpO1xuXG4gIGxldCBlbmRwb2ludCA9IGAvZWxlbWVudCR7Y29udGV4dCA/IGAvJHtjb250ZXh0fS9lbGVtZW50YCA6ICcnfSR7bXVsdCA/ICdzJyA6ICcnfWA7XG5cbiAgbGV0IGJvZHkgPSB7XG4gICAgdXNpbmc6IHN0cmF0ZWd5LFxuICAgIHZhbHVlOiBzZWxlY3RvclxuICB9O1xuXG4gIGxldCBtZXRob2QgPSAnUE9TVCc7XG5cbiAgLy8gVGhpcyBpcyBlaXRoZXIgYW4gYXJyYXkgaXMgbXVsdCA9PT0gdHJ1ZVxuICAvLyBvciBhbiBvYmplY3QgaWYgbXVsdCA9PT0gZmFsc2VcbiAgbGV0IGVscztcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBlbHMgPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChlbmRwb2ludCwgbWV0aG9kLCBib2R5KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBlbHMgPSBbXTtcbiAgICAgIH1cbiAgICAgIC8vIHdlIHN1Y2NlZWQgaWYgd2UgZ2V0IHNvbWUgZWxlbWVudHNcbiAgICAgIHJldHVybiAhXy5pc0VtcHR5KGVscyk7XG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIubWVzc2FnZSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcbiAgICAgIC8vIGNvbmRpdGlvbiB3YXMgbm90IG1ldCBzZXR0aW5nIHJlcyB0byBlbXB0eSBhcnJheVxuICAgICAgZWxzID0gW107XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cbiAgaWYgKG11bHQpIHtcbiAgICByZXR1cm4gZWxzO1xuICB9XG4gIGlmIChfLmlzRW1wdHkoZWxzKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gIH1cbiAgcmV0dXJuIGVscztcbn07XG5cbmhlbHBlcnMuZ2V0Rmlyc3RWaXNpYmxlQ2hpbGQgPSBhc3luYyBmdW5jdGlvbiBnZXRGaXJzdFZpc2libGVDaGlsZCAobXVsdCwgY29udGV4dCkge1xuICB0aGlzLmxvZy5pbmZvKGBHZXR0aW5nIGZpcnN0IHZpc2libGUgY2hpbGRgKTtcbiAgaWYgKG11bHQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBnZXQgbXVsdGlwbGUgZmlyc3QgdmlzaWJsZSBjaGlsZHJlbiEnKTtcbiAgfVxuICBpZiAoIWNvbnRleHQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBnZXQgZmlyc3QgdmlzaWJsZSBjaGlsZCB3aXRob3V0IGEgY29udGV4dCBlbGVtZW50Jyk7XG4gIH1cbiAgbGV0IGluZGV4ID0gMTtcbiAgLy8gbG9vcCB0aHJvdWdoIGNoaWxkcmVuIHZpYSBjbGFzcy1jaGFpbiBmaW5kcywgdW50aWwgd2UgcnVuIG91dCBvZiBjaGlsZHJlblxuICAvLyBvciB3ZSBmaW5kIGEgdmlzaWJsZSBvbmUuIFRoaXMgbG9vcCBsb29rcyBpbmZpbml0ZSBidXQgaXRzIG5vdCwgYmVjYXVzZSBhdFxuICAvLyBzb21lIHBvaW50IHRoZSBjYWxsIHRvIGRvTmF0aXZlRmluZCB3aWxsIHRocm93IHdpdGggYW4gRWxlbWVudCBOb3QgRm91bmRcbiAgLy8gZXJyb3IsIHdoZW4gdGhlIGluZGV4IGdldHMgaGlnaGVyIHRoYW4gdGhlIG51bWJlciBvZiBjaGlsZCBlbGVtZW50cy4gVGhpc1xuICAvLyBpcyB3aGF0IHdlIHdhbnQgYmVjYXVzZSB0aGF0IGVycm9yIHdpbGwgaGFsdCB0aGUgbG9vcCBhbmQgbWFrZSBpdCBhbGwgdGhlXG4gIC8vIHdheSB0byB0aGUgY2xpZW50LlxuICB3aGlsZSAodHJ1ZSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnN0YW50LWNvbmRpdGlvblxuICAgIGNvbnN0IHN0cmF0ZWd5ID0gV0RBX0NMQVNTX0NIQUlOX1NUUkFURUdZO1xuICAgIGNvbnN0IHNlbGVjdG9yID0gYCpbJHtpbmRleH1dYDtcbiAgICBjb25zdCBudGhDaGlsZCA9IGF3YWl0IHRoaXMuZG9OYXRpdmVGaW5kKHN0cmF0ZWd5LCBzZWxlY3RvciwgZmFsc2UsIGNvbnRleHQpO1xuICAgIGNvbnN0IHZpc2libGUgPSBhd2FpdCB0aGlzLmdldEF0dHJpYnV0ZSgndmlzaWJsZScsIG50aENoaWxkKTtcbiAgICBpZiAodmlzaWJsZSA9PT0gJ3RydWUnKSB7XG4gICAgICB0aGlzLmxvZy5pbmZvKGBGb3VuZCBmaXJzdCB2aXNpYmxlIGNoaWxkIGF0IHBvc2l0aW9uICR7aW5kZXh9YCk7XG4gICAgICByZXR1cm4gbnRoQ2hpbGQ7XG4gICAgfVxuICAgIGluZGV4Kys7XG4gIH1cbn07XG5cbmZ1bmN0aW9uIHJld3JpdGVNYWdpY1Njcm9sbGFibGUgKG11bHQsIGxvZyA9IG51bGwpIHtcbiAgY29uc3QgcHJlZCA9IFtcbiAgICAnU2Nyb2xsVmlldycsXG4gICAgJ1RhYmxlJyxcbiAgICAnQ29sbGVjdGlvblZpZXcnLFxuICAgICdXZWJWaWV3J1xuICBdLm1hcCgodCkgPT4gYHR5cGUgPT0gXCJYQ1VJRWxlbWVudFR5cGUke3R9XCJgKS5qb2luKCcgT1IgJyk7XG4gIGNvbnN0IHN0cmF0ZWd5ID0gV0RBX0NMQVNTX0NIQUlOX1NUUkFURUdZO1xuICBsZXQgc2VsZWN0b3IgPSAnKiovKltgJyArIHByZWQgKyAnYF0nO1xuICBpZiAoIW11bHQpIHtcbiAgICBzZWxlY3RvciArPSAnWzFdJztcbiAgfVxuICBsb2c/LmluZm8oJ1Jld3JvdGUgcmVxdWVzdCBmb3Igc2Nyb2xsYWJsZSBkZXNjZW5kYW50cyB0byBjbGFzcyBjaGFpbiAnICtcbiAgICBgZm9ybWF0IHdpdGggc2VsZWN0b3IgJyR7c2VsZWN0b3J9J2ApO1xuICByZXR1cm4gW3N0cmF0ZWd5LCBzZWxlY3Rvcl07XG59XG5cblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVyc307XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLGFBQUEsR0FBQUYsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFFLE9BQUEsR0FBQUYsT0FBQTtBQUNBLElBQUFHLFFBQUEsR0FBQUgsT0FBQTtBQUlBLE1BQU1JLHlCQUF5QixHQUFHLHlDQUF5QztBQUkzRSxNQUFNQyxvQkFBb0IsR0FBRyx5Q0FBeUM7QUFFdEUsTUFBTUMsd0JBQXdCLEdBQUcsYUFBYTtBQUU5QyxJQUFJQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO0VBQUVDLFFBQVEsR0FBRyxDQUFDLENBQUM7RUFBRUMsVUFBVSxHQUFHLENBQUMsQ0FBQztBQUFDQyxPQUFBLENBQUFGLFFBQUEsR0FBQUEsUUFBQTtBQUFBRSxPQUFBLENBQUFILE9BQUEsR0FBQUEsT0FBQTtBQUVqREEsT0FBTyxDQUFDSSxXQUFXLEdBQUcsZUFBZUEsV0FBV0EsQ0FBRUMsUUFBUSxFQUFFQyxRQUFRLEVBQUVDLElBQUksRUFBRUMsT0FBTyxFQUFFO0VBQ25GLElBQUksSUFBSSxDQUFDQyxTQUFTLEVBQUUsRUFBRTtJQUNwQixPQUFPLE1BQU0sSUFBSSxDQUFDQyx3QkFBd0IsQ0FBQ0wsUUFBUSxFQUFFQyxRQUFRLEVBQUVD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