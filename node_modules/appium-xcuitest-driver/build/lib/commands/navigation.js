"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.default = exports.commands = void 0;
require("source-map-support/register");
var _driver = require("appium/driver");
var _lodash = _interopRequireDefault(require("lodash"));
var _asyncbox = require("asyncbox");
var _utils = require("../utils");
let commands = {},
  helpers = {},
  extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const CLOSE_WINDOW_TIMEOUT = 5000;
const CLOSE_WINDOW_INTERVAL = 100;
commands.back = async function back() {
  if (!this.isWebContext()) {
    await this.nativeBack();
  } else {
    await this.mobileWebNav('back');
  }
};
helpers.nativeBack = async function nativeBack() {
  try {
    let navBar = await this.findNativeElementOrElements('class name', 'XCUIElementTypeNavigationBar', false);
    let buttons = await this.findNativeElementOrElements('class name', 'XCUIElementTypeButton', true, navBar);
    if (buttons.length === 0) {
      throw new Error('No buttons found in navigation bar');
    }
    let backButton = _lodash.default.filter(buttons, value => value.label === 'Back')[0];
    if (backButton) {
      this.log.debug(`Found navigation bar 'back' button. Clicking.`);
    } else {
      this.log.debug(`Unable to find 'Back' button. Trying first button in navigation bar`);
      backButton = buttons[0];
    }
    await this.nativeClick(backButton);
  } catch (err) {
    this.log.error(`Unable to find navigation bar and back button: ${err.message}`);
  }
};
commands.forward = async function forward() {
  if (!this.isWebContext()) {}
  await this.mobileWebNav('forward');
};
commands.closeWindow = async function closeWindow() {
  if (!this.isWebContext()) {
    throw new _driver.errors.NotImplementedError();
  }
  const script = `setTimeout(function () {window.open('','_self').close();}, 0); return true;`;
  const context = this.curContext;
  try {
    return await this.executeAtom('execute_script', [script, []], true);
  } finally {
    try {
      await (0, _asyncbox.waitForCondition)(() => this.curContext !== context, {
        waitMs: CLOSE_WINDOW_TIMEOUT,
        intervalMs: CLOSE_WINDOW_INTERVAL
      });
    } catch (ign) {
      this.log.debug('Context has not yet been changed after closing window. Continuing...');
    }
  }
};
commands.mobileDeepLink = async function mobileDeepLink(opts = {}) {
  const {
    url,
    bundleId
  } = (0, _utils.requireArgs)('url', opts);
  return await this.proxyCommand('/url', 'POST', {
    url,
    bundleId
  });
};
Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZHJpdmVyIiwicmVxdWlyZSIsIl9sb2Rhc2giLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwiX2FzeW5jYm94IiwiX3V0aWxzIiwiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsImV4cG9ydHMiLCJDTE9TRV9XSU5ET1dfVElNRU9VVCIsIkNMT1NFX1dJTkRPV19JTlRFUlZBTCIsImJhY2siLCJpc1dlYkNvbnRleHQiLCJuYXRpdmVCYWNrIiwibW9iaWxlV2ViTmF2IiwibmF2QmFyIiwiZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzIiwiYnV0dG9ucyIsImxlbmd0aCIsIkVycm9yIiwiYmFja0J1dHRvbiIsIl8iLCJmaWx0ZXIiLCJ2YWx1ZSIsImxhYmVsIiwibG9nIiwiZGVidWciLCJuYXRpdmVDbGljayIsImVyciIsImVycm9yIiwibWVzc2FnZSIsImZvcndhcmQiLCJjbG9zZVdpbmRvdyIsImVycm9ycyIsIk5vdEltcGxlbWVudGVkRXJyb3IiLCJzY3JpcHQiLCJjb250ZXh0IiwiY3VyQ29udGV4dCIsImV4ZWN1dGVBdG9tIiwid2FpdEZvckNvbmRpdGlvbiIsIndhaXRNcyIsImludGVydmFsTXMiLCJpZ24iLCJtb2JpbGVEZWVwTGluayIsIm9wdHMiLCJ1cmwiLCJidW5kbGVJZCIsInJlcXVpcmVBcmdzIiwicHJveHlDb21tYW5kIiwiT2JqZWN0IiwiYXNzaWduIiwiX2RlZmF1bHQiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2NvbW1hbmRzL25hdmlnYXRpb24uanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtL2RyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHJlcXVpcmVBcmdzIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbi8vIHRoZXNlIHR3byBjb25zdGl0dXRlIHRoZSB3YWl0IGFmdGVyIGNsb3NpbmcgYSB3aW5kb3dcbmNvbnN0IENMT1NFX1dJTkRPV19USU1FT1VUID0gNTAwMDtcbmNvbnN0IENMT1NFX1dJTkRPV19JTlRFUlZBTCA9IDEwMDtcblxuY29tbWFuZHMuYmFjayA9IGFzeW5jIGZ1bmN0aW9uIGJhY2sgKCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBhd2FpdCB0aGlzLm5hdGl2ZUJhY2soKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLm1vYmlsZVdlYk5hdignYmFjaycpO1xuICB9XG59O1xuXG5oZWxwZXJzLm5hdGl2ZUJhY2sgPSBhc3luYyBmdW5jdGlvbiBuYXRpdmVCYWNrICgpIHtcbiAgdHJ5IHtcbiAgICBsZXQgbmF2QmFyID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlTmF2aWdhdGlvbkJhcicsIGZhbHNlKTtcbiAgICBsZXQgYnV0dG9ucyA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZUJ1dHRvbicsIHRydWUsIG5hdkJhcik7XG4gICAgaWYgKGJ1dHRvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGJ1dHRvbnMgZm91bmQgaW4gbmF2aWdhdGlvbiBiYXInKTtcbiAgICB9XG5cbiAgICBsZXQgYmFja0J1dHRvbiA9IF8uZmlsdGVyKGJ1dHRvbnMsICh2YWx1ZSkgPT4gdmFsdWUubGFiZWwgPT09ICdCYWNrJylbMF07XG4gICAgaWYgKGJhY2tCdXR0b24pIHtcbiAgICAgIHRoaXMubG9nLmRlYnVnKGBGb3VuZCBuYXZpZ2F0aW9uIGJhciAnYmFjaycgYnV0dG9uLiBDbGlja2luZy5gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2cuZGVidWcoYFVuYWJsZSB0byBmaW5kICdCYWNrJyBidXR0b24uIFRyeWluZyBmaXJzdCBidXR0b24gaW4gbmF2aWdhdGlvbiBiYXJgKTtcbiAgICAgIGJhY2tCdXR0b24gPSBidXR0b25zWzBdO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLm5hdGl2ZUNsaWNrKGJhY2tCdXR0b24pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICB0aGlzLmxvZy5lcnJvcihgVW5hYmxlIHRvIGZpbmQgbmF2aWdhdGlvbiBiYXIgYW5kIGJhY2sgYnV0dG9uOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG59O1xuXG5jb21tYW5kcy5mb3J3YXJkID0gYXN5bmMgZnVuY3Rpb24gZm9yd2FyZCAoKSB7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICB9XG4gIGF3YWl0IHRoaXMubW9iaWxlV2ViTmF2KCdmb3J3YXJkJyk7XG59O1xuXG5jb21tYW5kcy5jbG9zZVdpbmRvdyA9IGFzeW5jIGZ1bmN0aW9uIGNsb3NlV2luZG93ICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICAvLyBzaW5jZSB0aGUgd2luZG93IHdpbGwgYmUgY2xvc2VkIGFuZCB0aGUgZXhlY3V0aW9uIGNvbnRleHQgZ29uZSwgcmV0dXJuXG4gIC8vIGZpcnN0IGJlZm9yZSBjbG9zaW5nLiBXYWl0aW5nIGZvciBjbG9zZSB3aWxsIGhhcHBlbiBpbiB0aGUgZmluYWxseSBibG9ja1xuICBjb25zdCBzY3JpcHQgPSBgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7d2luZG93Lm9wZW4oJycsJ19zZWxmJykuY2xvc2UoKTt9LCAwKTsgcmV0dXJuIHRydWU7YDtcbiAgY29uc3QgY29udGV4dCA9IHRoaXMuY3VyQ29udGV4dDtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbc2NyaXB0LCBbXV0sIHRydWUpO1xuICB9IGZpbmFsbHkge1xuICAgIC8vIHdhaXQgZm9yIHRoZSB3aW5kb3cgdG8gc3VjY2Vzc2Z1bGx5IGNoYW5nZS4uLlxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKCgpID0+IHRoaXMuY3VyQ29udGV4dCAhPT0gY29udGV4dCwge1xuICAgICAgICB3YWl0TXM6IENMT1NFX1dJTkRPV19USU1FT1VULFxuICAgICAgICBpbnRlcnZhbE1zOiBDTE9TRV9XSU5ET1dfSU5URVJWQUwsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIHRoaXMubG9nLmRlYnVnKCdDb250ZXh0IGhhcyBub3QgeWV0IGJlZW4gY2hhbmdlZCBhZnRlciBjbG9zaW5nIHdpbmRvdy4gQ29udGludWluZy4uLicpO1xuICAgIH1cbiAgfVxufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBEZWVwTGlua09wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwgVGhlIFVSTCB0byBiZSBvcGVuZWQuIFRoaXMgcGFyYW1ldGVyIGlzIG1hbmFkYXRvcnlcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nP30gYnVuZGxlSWQgVGhlIGJ1bmRsZSBpZGVudGlmaWVyIG9mIGFuIGFwcGxpY2F0aW9uIHRvIG9wZW4gdGhlXG4gKiBnaXZlbiB1cmwgd2l0aC4gSWYgbm90IHByb3ZpZGVkIHRoZW4gdGhlIGRlZmF1bHQgYXBwbGljYXRpb24gZm9yIHRoZSBnaXZlbiB1cmwgc2NoZW1lXG4gKiBpcyBnb2luZyB0byBiZSB1c2VkLlxuICovXG5cbi8qKlxuICogT3BlbnMgdGhlIGdpdmVuIFVSTCB3aXRoIHRoZSBkZWZhdWx0IG9yIHRoZSBnaXZlbiBhcHBsaWNhdGlvblxuICpcbiAqIEBwYXJhbSB7RGVlcExpbmtPcHRpb25zfSBvcHRzXG4gKi9cbmNvbW1hbmRzLm1vYmlsZURlZXBMaW5rID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlRGVlcExpbmsgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdXJsLFxuICAgIGJ1bmRsZUlkLFxuICB9ID0gcmVxdWlyZUFyZ3MoJ3VybCcsIG9wdHMpO1xuXG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3VybCcsICdQT1NUJywge1xuICAgIHVybCxcbiAgICBidW5kbGVJZCxcbiAgfSk7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLE9BQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQUYsT0FBQTtBQUNBLElBQUFHLFNBQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLE1BQUEsR0FBQUosT0FBQTtBQUVBLElBQUlLLFFBQVEsR0FBRyxDQUFDLENBQUM7RUFBRUMsT0FBTyxHQUFHLENBQUMsQ0FBQztFQUFFQyxVQUFVLEdBQUcsQ0FBQyxDQUFDO0FBQUNDLE9BQUEsQ0FBQUYsT0FBQSxHQUFBQSxPQUFBO0FBQUFFLE9BQUEsQ0FBQUgsUUFBQSxHQUFBQSxRQUFBO0FBR2pELE1BQU1JLG9CQUFvQixHQUFHLElBQUk7QUFDakMsTUFBTUMscUJBQXFCLEdBQUcsR0FBRztBQUVqQ0wsUUFBUSxDQUFDTSxJQUFJLEdBQUcsZUFBZUEsSUFBSUEsQ0FBQSxFQUFJO0VBQ3JDLElBQUksQ0FBQyxJQUFJLENBQUNDLFlBQVksRUFBRSxFQUFFO0lBQ3hCLE1BQU0sSUFBSSxDQUFDQyxVQUFVLEVBQUU7RUFDekIsQ0FBQyxNQUFNO0lBQ0wsTUFBTSxJQUFJLENBQUNDLFlBQVksQ0FBQyxNQUFNLENBQUM7RUFDakM7QUFDRixDQUFDO0FBRURSLE9BQU8sQ0FBQ08sVUFBVSxHQUFHLGVBQWVBLFVBQVVBLENBQUEsRUFBSTtFQUNoRCxJQUFJO0lB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