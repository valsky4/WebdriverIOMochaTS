{"version":3,"file":"proxy-helper.js","names":["_driver","require","_bluebird","_interopRequireDefault","GET","POST","DELETE","SUPPORTED_METHODS","helpers","extensions","exports","WDA_ROUTES","wdaRouteToCommandName","endpoint","method","proxyCommand","body","isSessionCommand","shutdownUnexpectedly","log","errorAndThrow","includes","join","wda","Error","proxy","jwproxy","noSessionProxy","cmdName","routeToCommandName","timeout","_getCommandTimeout","info","command","debug","isCommandExpired","res","B","resolve","catch","Promise","TimeoutError","cancelActiveRequests","errMsg","startUnexpectedShutdown","errors","Object","assign","_default","default"],"sources":["../../../lib/commands/proxy-helper.js"],"sourcesContent":["import { errors, routeToCommandName } from 'appium/driver';\nimport B from 'bluebird';\n\n\nconst GET = 'GET';\nconst POST = 'POST';\nconst DELETE = 'DELETE';\nconst SUPPORTED_METHODS = [GET, POST, DELETE];\n\nlet helpers = {}, extensions = {};\n\nconst WDA_ROUTES = {\n  '/wda/touch/perform': {\n    POST: 'performTouch',\n  },\n  '/wda/touch/multi/perform': {\n    POST: 'performMultiAction',\n  },\n  '/wda/screen': {\n    GET: 'getScreenInfo',\n  },\n  '/wda/alert/buttons': {\n    GET: 'getAlertButtons',\n  },\n  '/wda/apps/launch': {\n    POST: 'mobileLaunchApp',\n  },\n  '/wda/apps/terminate': {\n    POST: 'mobileTerminateApp',\n  },\n  '/wda/apps/activate': {\n    POST: 'mobileActivateApp',\n  },\n  '/wda/apps/state': {\n    POST: 'mobileQueryAppState',\n  },\n  '/wda/keys': {\n    POST: 'keys',\n  },\n  '/wda/touch_id': {\n    POST: 'touchId',\n  },\n  '/wda/keyboard/dismiss': {\n    POST: 'hideKeyboard',\n  },\n  '/wda/lock': {\n    POST: 'lock',\n  },\n  '/wda/unlock': {\n    POST: 'unlock',\n  },\n  '/wda/locked': {\n    GET: 'isLocked',\n  },\n  '/wda/tap/nil': {\n    POST: 'clickCoords',\n  },\n  '/window/size': {\n    GET: 'getWindowSize',\n  },\n};\n\nfunction wdaRouteToCommandName (endpoint, method) {\n  return WDA_ROUTES[endpoint] ? WDA_ROUTES[endpoint][method] : null;\n}\n\nhelpers.proxyCommand = async function proxyCommand (endpoint, method, body, isSessionCommand = true) {\n  if (this.shutdownUnexpectedly) {\n    return;\n  }\n\n  if (!endpoint) {\n    this.log.errorAndThrow('Proxying requires an endpoint');\n  } else if (!SUPPORTED_METHODS.includes(method)) {\n    this.log.errorAndThrow(`Proxying only works for the following requests: ${SUPPORTED_METHODS.join(', ')}`);\n  }\n\n  if (!this.wda) {\n    throw new Error('Cannot call proxyCommand without WDA driver active');\n  }\n  const proxy = isSessionCommand ? this.wda.jwproxy : this.wda.noSessionProxy;\n  if (!proxy) {\n    throw new Error('Cannot call proxyCommand without WDA proxy active');\n  }\n\n  let cmdName = wdaRouteToCommandName(endpoint, method) || routeToCommandName(endpoint, method);\n  const timeout = this._getCommandTimeout(cmdName);\n  if (!cmdName) {\n    // this should never happen except when adding new routes\n    cmdName = 'Unknown'; // just for logging purposes below\n    this.log.info(`Proxying to WDA with an unknown route: ${method} ${endpoint}`);\n  }\n\n  if (!timeout) {\n    return await proxy.command(endpoint, method, body);\n  }\n\n  this.log.debug(`Setting custom timeout to ${timeout} ms for '${cmdName}' command`);\n  let isCommandExpired = false;\n  const res = await B.resolve(proxy.command(endpoint, method, body))\n                .timeout(timeout)\n                .catch(B.Promise.TimeoutError, () => {\n                  isCommandExpired = true;\n                });\n  if (isCommandExpired) {\n    proxy.cancelActiveRequests();\n    const errMsg = `Appium did not get any response from '${cmdName}' command in ${timeout} ms`;\n    await this.startUnexpectedShutdown(new errors.TimeoutError(errMsg));\n    this.log.errorAndThrow(errMsg);\n  }\n  return res;\n};\n\nObject.assign(extensions, helpers);\nexport { helpers };\nexport default extensions;\n"],"mappings":"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"}