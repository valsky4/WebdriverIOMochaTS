"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _support = require("appium/support");
var _teen_process = require("teen_process");
var _utils = require("../utils");
var _deviceConnectionsFactory = _interopRequireDefault(require("../device-connections-factory"));
var _appiumWebdriveragent = require("appium-webdriveragent");
var _asyncbox = require("asyncbox");
var _url = _interopRequireDefault(require("url"));
let commands = {};
exports.commands = commands;
const MAX_RECORDING_TIME_SEC = 60 * 30;
const DEFAULT_RECORDING_TIME_SEC = 60 * 3;
const DEFAULT_MJPEG_SERVER_PORT = 9100;
const DEFAULT_FPS = 10;
const DEFAULT_QUALITY = 'medium';
const DEFAULT_VCODEC = 'mjpeg';
const MP4_EXT = '.mp4';
const FFMPEG_BINARY = 'ffmpeg';
const ffmpegLogger = _support.logger.getLogger(FFMPEG_BINARY);
const QUALITY_MAPPING = {
  low: 10,
  medium: 25,
  high: 75,
  photo: 100
};
class ScreenRecorder {
  constructor(udid, log, videoPath, opts = {}) {
    this.videoPath = videoPath;
    this.log = log;
    this.opts = opts;
    this.udid = udid;
    this.mainProcess = null;
    this.timeoutHandler = null;
  }
  async start(timeoutMs) {
    try {
      await _support.fs.which(FFMPEG_BINARY);
    } catch (err) {
      throw new Error(`'${FFMPEG_BINARY}' binary is not found in PATH. Install it using 'brew install ffmpeg'. ` + `Check https://www.ffmpeg.org/download.html for more details.`);
    }
    const {
      remotePort,
      remoteUrl,
      usePortForwarding,
      videoFps,
      videoType,
      videoScale,
      videoFilters,
      pixelFormat
    } = this.opts;
    try {
      await _deviceConnectionsFactory.default.requestConnection(this.udid, remotePort, {
        devicePort: remotePort,
        usePortForwarding
      });
    } catch (err) {
      this.log.warn(`Cannot forward the local port ${remotePort} to ${remotePort} ` + `on the device ${this.udid}. Set the custom value to 'mjpegServerPort' ` + `capability if this is an undesired behavior.`);
    }
    const args = ['-f', 'mjpeg', '-reconnect', '1', '-reconnect_at_eof', '1', '-reconnect_streamed', '1', '-reconnect_delay_max', `${timeoutMs / 1000 + 1}`];
    if (videoFps && videoType === 'libx264') {
      args.push('-r', videoFps);
    }
    const {
      protocol,
      hostname
    } = _url.default.parse(remoteUrl);
    args.push('-i', `${protocol}//${hostname}:${remotePort}`);
    if (videoFilters || videoScale) {
      args.push('-vf', videoFilters || `scale=${videoScale}`);
    }
    if (pixelFormat) {
      args.push('-pix_fmt', pixelFormat);
    }
    args.push('-vcodec', videoType, '-y', this.videoPath);
    this.mainProcess = new _teen_process.SubProcess(FFMPEG_BINARY, args);
    let isCaptureStarted = false;
    this.mainProcess.on('output', (stdout, stderr) => {
      if (stderr) {
        if (stderr.trim().startsWith('frame=')) {
          if (!isCaptureStarted) {
            isCaptureStarted = true;
          }
        } else {
          ffmpegLogger.info(`${stderr}`);
        }
      }
    });
    await this.mainProcess.start(0);
    const startupTimeout = 5000;
    try {
      await (0, _asyncbox.waitForCondition)(() => isCaptureStarted, {
        waitMs: startupTimeout,
        intervalMs: 300
      });
    } catch (e) {
      this.log.warn(`Screen capture process did not start within ${startupTimeout}ms. Continuing anyway`);
    }
    if (!this.mainProcess.isRunning) {
      throw new Error(`The screen capture process '${FFMPEG_BINARY}' died unexpectedly. ` + `Check server logs for more details`);
    }
    this.log.info(`Starting screen capture on the device '${this.udid}' with command: '${FFMPEG_BINARY} ${args.join(' ')}'. ` + `Will timeout in ${timeoutMs}ms`);
    this.timeoutHandler = setTimeout(async () => {
      if (!(await this.interrupt())) {
        this.log.warn(`Cannot finish the active screen recording on the device '${this.udid}' after ${timeoutMs}ms timeout`);
      }
    }, timeoutMs);
  }
  async interrupt(force = false) {
    let result = true;
    if (this.timeoutHandler) {
      clearTimeout(this.timeoutHandler);
      this.timeoutHandler = null;
    }
    if (this.mainProcess && this.mainProcess.isRunning) {
      const interruptPromise = this.mainProcess.stop(force ? 'SIGTERM' : 'SIGINT');
      this.mainProcess = null;
      try {
        await interruptPromise;
      } catch (e) {
        this.log.warn(`Cannot ${force ? 'terminate' : 'interrupt'} ${FFMPEG_BINARY}. ` + `Original error: ${e.message}`);
        result = false;
      }
    }
    _deviceConnectionsFactory.default.releaseConnection(this.udid, this.opts.remotePort);
    return result;
  }
  async finish() {
    await this.interrupt();
    return this.videoPath;
  }
  async cleanup() {
    if (await _support.fs.exists(this.videoPath)) {
      await _support.fs.rimraf(this.videoPath);
    }
  }
}
commands.startRecordingScreen = async function startRecordingScreen(options = {}) {
  const {
    videoType = DEFAULT_VCODEC,
    timeLimit = DEFAULT_RECORDING_TIME_SEC,
    videoQuality = DEFAULT_QUALITY,
    videoFps = DEFAULT_FPS,
    videoFilters,
    videoScale,
    forceRestart,
    pixelFormat
  } = options;
  let result = '';
  if (!forceRestart) {
    this.log.info(`Checking if there is/was a previous screen recording. ` + `Set 'forceRestart' option to 'true' if you'd like to skip this step.`);
    result = await this.stopRecordingScreen(options);
  }
  const videoPath = await _support.tempDir.path({
    prefix: `appium_${Math.random().toString(16).substring(2, 8)}`,
    suffix: MP4_EXT
  });
  const wdaBaseUrl = this.opts.wdaBaseUrl || _appiumWebdriveragent.WDA_BASE_URL;
  const screenRecorder = new ScreenRecorder(this.opts.device.udid, this.log, videoPath, {
    remotePort: this.opts.mjpegServerPort || DEFAULT_MJPEG_SERVER_PORT,
    remoteUrl: wdaBaseUrl,
    usePortForwarding: this.isRealDevice() && (0, _utils.isLocalHost)(wdaBaseUrl),
    videoType,
    videoFilters,
    videoScale,
    videoFps,
    pixelFormat
  });
  if (!(await screenRecorder.interrupt(true))) {
    this.log.errorAndThrow('Unable to stop screen recording process');
  }
  if (this._recentScreenRecorder) {
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }
  const timeoutSeconds = parseFloat(timeLimit);
  if (isNaN(timeoutSeconds) || timeoutSeconds > MAX_RECORDING_TIME_SEC || timeoutSeconds <= 0) {
    this.log.errorAndThrow(`The timeLimit value must be in range [1, ${MAX_RECORDING_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
  }
  let {
    mjpegServerScreenshotQuality,
    mjpegServerFramerate
  } = await this.proxyCommand('/appium/settings', 'GET');
  if (videoQuality) {
    const quality = _lodash.default.isInteger(videoQuality) ? videoQuality : QUALITY_MAPPING[_lodash.default.toLower(videoQuality)];
    if (!quality) {
      throw new Error(`videoQuality value should be one of ${JSON.stringify(_lodash.default.keys(QUALITY_MAPPING))} or a number in range 1..100. ` + `'${videoQuality}' is given instead`);
    }
    mjpegServerScreenshotQuality = mjpegServerScreenshotQuality !== quality ? quality : undefined;
  } else {
    mjpegServerScreenshotQuality = undefined;
  }
  if (videoFps) {
    const fps = parseInt(videoFps, 10);
    if (isNaN(fps)) {
      throw new Error(`videoFps value should be a valid number in range 1..60. ` + `'${videoFps}' is given instead`);
    }
    mjpegServerFramerate = mjpegServerFramerate !== fps ? fps : undefined;
  } else {
    mjpegServerFramerate = undefined;
  }
  if (_support.util.hasValue(mjpegServerScreenshotQuality) || _support.util.hasValue(mjpegServerFramerate)) {
    await this.proxyCommand('/appium/settings', 'POST', {
      settings: {
        mjpegServerScreenshotQuality,
        mjpegServerFramerate
      }
    });
  }
  try {
    await screenRecorder.start(timeoutSeconds * 1000);
  } catch (e) {
    await screenRecorder.interrupt(true);
    await screenRecorder.cleanup();
    throw e;
  }
  this._recentScreenRecorder = screenRecorder;
  return result;
};
commands.stopRecordingScreen = async function stopRecordingScreen(options = {}) {
  if (!this._recentScreenRecorder) {
    this.log.info('Screen recording is not running. There is nothing to stop.');
    return '';
  }
  try {
    const videoPath = await this._recentScreenRecorder.finish();
    if (!(await _support.fs.exists(videoPath))) {
      this.log.errorAndThrow(`The screen recorder utility has failed ` + `to store the actual screen recording at '${videoPath}'`);
    }
    return await (0, _utils.encodeBase64OrUpload)(videoPath, options.remotePath, options);
  } finally {
    await this._recentScreenRecorder.interrupt(true);
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }
};
var _default = commands;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfc3VwcG9ydCIsIl90ZWVuX3Byb2Nlc3MiLCJfdXRpbHMiLCJfZGV2aWNlQ29ubmVjdGlvbnNGYWN0b3J5IiwiX2FwcGl1bVdlYmRyaXZlcmFnZW50IiwiX2FzeW5jYm94IiwiX3VybCIsImNvbW1hbmRzIiwiZXhwb3J0cyIsIk1BWF9SRUNPUkRJTkdfVElNRV9TRUMiLCJERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyIsIkRFRkFVTFRfTUpQRUdfU0VSVkVSX1BPUlQiLCJERUZBVUxUX0ZQUyIsIkRFRkFVTFRfUVVBTElUWSIsIkRFRkFVTFRfVkNPREVDIiwiTVA0X0VYVCIsIkZGTVBFR19CSU5BUlkiLCJmZm1wZWdMb2dnZXIiLCJsb2dnZXIiLCJnZXRMb2dnZXIiLCJRVUFMSVRZX01BUFBJTkciLCJsb3ciLCJtZWRpdW0iLCJoaWdoIiwicGhvdG8iLCJTY3JlZW5SZWNvcmRlciIsImNvbnN0cnVjdG9yIiwidWRpZCIsImxvZyIsInZpZGVvUGF0aCIsIm9wdHMiLCJtYWluUHJvY2VzcyIsInRpbWVvdXRIYW5kbGVyIiwic3RhcnQiLCJ0aW1lb3V0TXMiLCJmcyIsIndoaWNoIiwiZXJyIiwiRXJyb3IiLCJyZW1vdGVQb3J0IiwicmVtb3RlVXJsIiwidXNlUG9ydEZvcndhcmRpbmciLCJ2aWRlb0ZwcyIsInZpZGVvVHlwZSIsInZpZGVvU2NhbGUiLCJ2aWRlb0ZpbHRlcnMiLCJwaXhlbEZvcm1hdCIsIkRFVklDRV9DT05ORUNUSU9OU19GQUNUT1JZIiwicmVxdWVzdENvbm5lY3Rpb24iLCJkZXZpY2VQb3J0Iiwid2FybiIsImFyZ3MiLCJwdXNoIiwicHJvdG9jb2wiLCJob3N0bmFtZSIsInVybCIsInBhcnNlIiwiU3ViUHJvY2VzcyIsImlzQ2FwdHVyZVN0YXJ0ZWQiLCJvbiIsInN0ZG91dCIsInN0ZGVyciIsInRyaW0iLCJzdGFydHNXaXRoIiwiaW5mbyIsInN0YXJ0dXBUaW1lb3V0Iiwid2FpdEZvckNvbmRpdGlvbiIsIndhaXRNcyIsImludGVydmFsTXMiLCJlIiwiaXNSdW5uaW5nIiwiam9pbiIsInNldFRpbWVvdXQiLCJpbnRlcnJ1cHQiLCJmb3JjZSIsInJlc3VsdCIsImNsZWFyVGltZW91dCIsImludGVycnVwdFByb21pc2UiLCJzdG9wIiwibWVzc2FnZSIsInJlbGVhc2VDb25uZWN0aW9uIiwiZmluaXNoIiwiY2xlYW51cCIsImV4aXN0cyIsInJpbXJhZiIsInN0YXJ0UmVjb3JkaW5nU2NyZWVuIiwib3B0aW9ucyIsInRpbWVMaW1pdCIsInZpZGVvUXVhbGl0eSIsImZvcmNlUmVzdGFydCIsInN0b3BSZWNvcmRpbmdTY3JlZW4iLCJ0ZW1wRGlyIiwicGF0aCIsInByZWZpeCIsIk1hdGgiLCJyYW5kb20iLCJ0b1N0cmluZyIsInN1YnN0cmluZyIsInN1ZmZpeCIsIndkYUJhc2VVcmwiLCJXREFfQkFTRV9VUkwiLCJzY3JlZW5SZWNvcmRlciIsImRldmljZSIsIm1qcGVnU2VydmVyUG9ydCIsImlzUmVhbERldmljZSIsImlzTG9jYWxIb3N0IiwiZXJyb3JBbmRUaHJvdyIsIl9yZWNlbnRTY3JlZW5SZWNvcmRlciIsInRpbWVvdXRTZWNvbmRzIiwicGFyc2VGbG9hdCIsImlzTmFOIiwibWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSIsIm1qcGVnU2VydmVyRnJhbWVyYXRlIiwicHJveHlDb21tYW5kIiwicXVhbGl0eSIsIl8iLCJpc0ludGVnZXIiLCJ0b0xvd2VyIiwiSlNPTiIsInN0cmluZ2lmeSIsImtleXMiLCJ1bmRlZmluZWQiLCJmcHMiLCJwYXJzZUludCIsInV0aWwiLCJoYXNWYWx1ZSIsInNldHRpbmdzIiwiZW5jb2RlQmFzZTY0T3JVcGxvYWQiLCJyZW1vdGVQYXRoIiwiX2RlZmF1bHQiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2NvbW1hbmRzL3JlY29yZHNjcmVlbi5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIsIGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZW5jb2RlQmFzZTY0T3JVcGxvYWQsIGlzTG9jYWxIb3N0IH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IERFVklDRV9DT05ORUNUSU9OU19GQUNUT1JZIGZyb20gJy4uL2RldmljZS1jb25uZWN0aW9ucy1mYWN0b3J5JztcbmltcG9ydCB7IFdEQV9CQVNFX1VSTCB9IGZyb20gJ2FwcGl1bS13ZWJkcml2ZXJhZ2VudCc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgTUFYX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMzA7XG5jb25zdCBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMztcbmNvbnN0IERFRkFVTFRfTUpQRUdfU0VSVkVSX1BPUlQgPSA5MTAwO1xuY29uc3QgREVGQVVMVF9GUFMgPSAxMDtcbmNvbnN0IERFRkFVTFRfUVVBTElUWSA9ICdtZWRpdW0nO1xuY29uc3QgREVGQVVMVF9WQ09ERUMgPSAnbWpwZWcnO1xuY29uc3QgTVA0X0VYVCA9ICcubXA0JztcbmNvbnN0IEZGTVBFR19CSU5BUlkgPSAnZmZtcGVnJztcbmNvbnN0IGZmbXBlZ0xvZ2dlciA9IGxvZ2dlci5nZXRMb2dnZXIoRkZNUEVHX0JJTkFSWSk7XG5jb25zdCBRVUFMSVRZX01BUFBJTkcgPSB7XG4gIGxvdzogMTAsXG4gIG1lZGl1bTogMjUsXG4gIGhpZ2g6IDc1LFxuICBwaG90bzogMTAwLFxufTtcblxuXG5jbGFzcyBTY3JlZW5SZWNvcmRlciB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCBsb2csIHZpZGVvUGF0aCwgb3B0cyA9IHt9KSB7XG4gICAgdGhpcy52aWRlb1BhdGggPSB2aWRlb1BhdGg7XG4gICAgdGhpcy5sb2cgPSBsb2c7XG4gICAgdGhpcy5vcHRzID0gb3B0cztcbiAgICB0aGlzLnVkaWQgPSB1ZGlkO1xuICAgIHRoaXMubWFpblByb2Nlc3MgPSBudWxsO1xuICAgIHRoaXMudGltZW91dEhhbmRsZXIgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKHRpbWVvdXRNcykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcy53aGljaChGRk1QRUdfQklOQVJZKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJyR7RkZNUEVHX0JJTkFSWX0nIGJpbmFyeSBpcyBub3QgZm91bmQgaW4gUEFUSC4gSW5zdGFsbCBpdCB1c2luZyAnYnJldyBpbnN0YWxsIGZmbXBlZycuIGAgK1xuICAgICAgICBgQ2hlY2sgaHR0cHM6Ly93d3cuZmZtcGVnLm9yZy9kb3dubG9hZC5odG1sIGZvciBtb3JlIGRldGFpbHMuYCk7XG4gICAgfVxuXG4gICAgY29uc3Qge1xuICAgICAgcmVtb3RlUG9ydCxcbiAgICAgIHJlbW90ZVVybCxcbiAgICAgIHVzZVBvcnRGb3J3YXJkaW5nLFxuICAgICAgdmlkZW9GcHMsXG4gICAgICB2aWRlb1R5cGUsXG4gICAgICB2aWRlb1NjYWxlLFxuICAgICAgdmlkZW9GaWx0ZXJzLFxuICAgICAgcGl4ZWxGb3JtYXQsXG4gICAgfSA9IHRoaXMub3B0cztcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBERVZJQ0VfQ09OTkVDVElPTlNfRkFDVE9SWS5yZXF1ZXN0Q29ubmVjdGlvbih0aGlzLnVkaWQsIHJlbW90ZVBvcnQsIHtcbiAgICAgICAgZGV2aWNlUG9ydDogcmVtb3RlUG9ydCxcbiAgICAgICAgdXNlUG9ydEZvcndhcmRpbmcsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMubG9nLndhcm4oYENhbm5vdCBmb3J3YXJkIHRoZSBsb2NhbCBwb3J0ICR7cmVtb3RlUG9ydH0gdG8gJHtyZW1vdGVQb3J0fSBgICtcbiAgICAgICAgYG9uIHRoZSBkZXZpY2UgJHt0aGlzLnVkaWR9LiBTZXQgdGhlIGN1c3RvbSB2YWx1ZSB0byAnbWpwZWdTZXJ2ZXJQb3J0JyBgICtcbiAgICAgICAgYGNhcGFiaWxpdHkgaWYgdGhpcyBpcyBhbiB1bmRlc2lyZWQgYmVoYXZpb3IuYCk7XG4gICAgfVxuXG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICctZicsICdtanBlZycsXG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvMTYyOTRcbiAgICAgICctcmVjb25uZWN0JywgJzEnLFxuICAgICAgJy1yZWNvbm5lY3RfYXRfZW9mJywgJzEnLFxuICAgICAgJy1yZWNvbm5lY3Rfc3RyZWFtZWQnLCAnMScsXG4gICAgICAnLXJlY29ubmVjdF9kZWxheV9tYXgnLCBgJHt0aW1lb3V0TXMgLyAxMDAwICsgMX1gLFxuICAgIF07XG4gICAgLy9QYXJhbWV0ZXIgYC1yYCBpcyBvcHRpb25hbC4gU2VlIGRldGFpbHM6IGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xMjA2N1xuICAgIGlmICh2aWRlb0ZwcyAmJiB2aWRlb1R5cGUgPT09ICdsaWJ4MjY0Jykge1xuICAgICAgYXJncy5wdXNoKCctcicsIHZpZGVvRnBzKTtcbiAgICB9XG4gICAgY29uc3Qge3Byb3RvY29sLCBob3N0bmFtZX0gPSB1cmwucGFyc2UocmVtb3RlVXJsKTtcbiAgICBhcmdzLnB1c2goJy1pJywgYCR7cHJvdG9jb2x9Ly8ke2hvc3RuYW1lfToke3JlbW90ZVBvcnR9YCk7XG4gICAgaWYgKHZpZGVvRmlsdGVycyB8fCB2aWRlb1NjYWxlKSB7XG4gICAgICBhcmdzLnB1c2goJy12ZicsIHZpZGVvRmlsdGVycyB8fCBgc2NhbGU9JHt2aWRlb1NjYWxlfWApO1xuICAgIH1cbiAgICAvLyBRdWlja3RpbWUgY29tcGF0aWJpbGl0eSB2aWEgcGl4ZWxGb3JtYXQ6ICd5dXY0MjBwJ1xuICAgIGlmIChwaXhlbEZvcm1hdCkge1xuICAgICAgYXJncy5wdXNoKCctcGl4X2ZtdCcsIHBpeGVsRm9ybWF0KTtcbiAgICB9XG4gICAgYXJncy5wdXNoKFxuICAgICAgJy12Y29kZWMnLCB2aWRlb1R5cGUsXG4gICAgICAnLXknLCB0aGlzLnZpZGVvUGF0aFxuICAgICk7XG5cbiAgICB0aGlzLm1haW5Qcm9jZXNzID0gbmV3IFN1YlByb2Nlc3MoRkZNUEVHX0JJTkFSWSwgYXJncyk7XG4gICAgbGV0IGlzQ2FwdHVyZVN0YXJ0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLm1haW5Qcm9jZXNzLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgIGlmIChzdGRlcnIpIHtcbiAgICAgICAgaWYgKHN0ZGVyci50cmltKCkuc3RhcnRzV2l0aCgnZnJhbWU9JykpIHtcbiAgICAgICAgICBpZiAoIWlzQ2FwdHVyZVN0YXJ0ZWQpIHtcbiAgICAgICAgICAgIGlzQ2FwdHVyZVN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmZm1wZWdMb2dnZXIuaW5mbyhgJHtzdGRlcnJ9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLm1haW5Qcm9jZXNzLnN0YXJ0KDApO1xuICAgIGNvbnN0IHN0YXJ0dXBUaW1lb3V0ID0gNTAwMDtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbigoKSA9PiBpc0NhcHR1cmVTdGFydGVkLCB7XG4gICAgICAgIHdhaXRNczogc3RhcnR1cFRpbWVvdXQsXG4gICAgICAgIGludGVydmFsTXM6IDMwMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMubG9nLndhcm4oYFNjcmVlbiBjYXB0dXJlIHByb2Nlc3MgZGlkIG5vdCBzdGFydCB3aXRoaW4gJHtzdGFydHVwVGltZW91dH1tcy4gQ29udGludWluZyBhbnl3YXlgKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLm1haW5Qcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc2NyZWVuIGNhcHR1cmUgcHJvY2VzcyAnJHtGRk1QRUdfQklOQVJZfScgZGllZCB1bmV4cGVjdGVkbHkuIGAgK1xuICAgICAgICBgQ2hlY2sgc2VydmVyIGxvZ3MgZm9yIG1vcmUgZGV0YWlsc2ApO1xuICAgIH1cbiAgICB0aGlzLmxvZy5pbmZvKGBTdGFydGluZyBzY3JlZW4gY2FwdHVyZSBvbiB0aGUgZGV2aWNlICcke3RoaXMudWRpZH0nIHdpdGggY29tbWFuZDogJyR7RkZNUEVHX0JJTkFSWX0gJHthcmdzLmpvaW4oJyAnKX0nLiBgICtcbiAgICAgIGBXaWxsIHRpbWVvdXQgaW4gJHt0aW1lb3V0TXN9bXNgKTtcblxuICAgIHRoaXMudGltZW91dEhhbmRsZXIgPSBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgIGlmICghYXdhaXQgdGhpcy5pbnRlcnJ1cHQoKSkge1xuICAgICAgICB0aGlzLmxvZy53YXJuKGBDYW5ub3QgZmluaXNoIHRoZSBhY3RpdmUgc2NyZWVuIHJlY29yZGluZyBvbiB0aGUgZGV2aWNlICcke3RoaXMudWRpZH0nIGFmdGVyICR7dGltZW91dE1zfW1zIHRpbWVvdXRgKTtcbiAgICAgIH1cbiAgICB9LCB0aW1lb3V0TXMpO1xuICB9XG5cbiAgYXN5bmMgaW50ZXJydXB0IChmb3JjZSA9IGZhbHNlKSB7XG4gICAgbGV0IHJlc3VsdCA9IHRydWU7XG5cbiAgICBpZiAodGhpcy50aW1lb3V0SGFuZGxlcikge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dEhhbmRsZXIpO1xuICAgICAgdGhpcy50aW1lb3V0SGFuZGxlciA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubWFpblByb2Nlc3MgJiYgdGhpcy5tYWluUHJvY2Vzcy5pc1J1bm5pbmcpIHtcbiAgICAgIGNvbnN0IGludGVycnVwdFByb21pc2UgPSB0aGlzLm1haW5Qcm9jZXNzLnN0b3AoZm9yY2UgPyAnU0lHVEVSTScgOiAnU0lHSU5UJyk7XG4gICAgICB0aGlzLm1haW5Qcm9jZXNzID0gbnVsbDtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGludGVycnVwdFByb21pc2U7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRoaXMubG9nLndhcm4oYENhbm5vdCAke2ZvcmNlID8gJ3Rlcm1pbmF0ZScgOiAnaW50ZXJydXB0J30gJHtGRk1QRUdfQklOQVJZfS4gYCArXG4gICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgICAgcmVzdWx0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgREVWSUNFX0NPTk5FQ1RJT05TX0ZBQ1RPUlkucmVsZWFzZUNvbm5lY3Rpb24odGhpcy51ZGlkLCB0aGlzLm9wdHMucmVtb3RlUG9ydCk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgYXN5bmMgZmluaXNoICgpIHtcbiAgICBhd2FpdCB0aGlzLmludGVycnVwdCgpO1xuICAgIHJldHVybiB0aGlzLnZpZGVvUGF0aDtcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXAgKCkge1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHModGhpcy52aWRlb1BhdGgpKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodGhpcy52aWRlb1BhdGgpO1xuICAgIH1cbiAgfVxufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB2aWRlbyBzaG91bGQgYmUgdXBsb2FkZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZm9sbG93aW5nIHByb3RvY29scyBhcmUgc3VwcG9ydGVkOiBodHRwL2h0dHBzLCBmdHAuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOdWxsIG9yIGVtcHR5IHN0cmluZyB2YWx1ZSAodGhlIGRlZmF1bHQgc2V0dGluZykgbWVhbnMgdGhlIGNvbnRlbnQgb2YgcmVzdWx0aW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlIHNob3VsZCBiZSBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb2ludCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIG1lZGlhIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb3B0aW9uIG9ubHkgaGFzIGFuIGVmZmVjdCBpZiB0aGVyZSBpcyBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MgaW4gcHJvZ3Jlc3NcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBgZm9yY2VSZXN0YXJ0YCBwYXJhbWV0ZXIgaXMgbm90IHNldCB0byBgdHJ1ZWAuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBtZXRob2QgLSBUaGUgaHR0cCBtdWx0aXBhcnQgdXBsb2FkIG1ldGhvZCBuYW1lLiBUaGUgJ1BVVCcgb25lIGlzIHVzZWQgYnkgZGVmYXVsdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZpZGVvVHlwZSAtIFRoZSB2aWRlbyBjb2RlYyB0eXBlIHVzZWQgZm9yIGVuY29kaW5nIG9mIHRoZSBiZSByZWNvcmRlZCBzY3JlZW4gY2FwdHVyZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRXhlY3V0ZSBgZmZtcGVnIC1jb2RlY3NgIGluIHRoZSB0ZXJtaW5hbCB0byBzZWUgdGhlIGxpc3Qgb2Ygc3VwcG9ydGVkIHZpZGVvIGNvZGVjcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21qcGVnJyBieSBkZWZhdWx0LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gdmlkZW9RdWFsaXR5IC0gVGhlIHZpZGVvIGVuY29kaW5nIHF1YWxpdHkgKGxvdywgbWVkaXVtLCBoaWdoLCBwaG90byAtIGRlZmF1bHRzIHRvIG1lZGl1bSkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSB2aWRlb0ZwcyAtIFRoZSBGcmFtZXMgUGVyIFNlY29uZCByYXRlIG9mIHRoZSByZWNvcmRlZCB2aWRlby4gQ2hhbmdlIHRoaXMgdmFsdWUgaWYgdGhlIHJlc3VsdGluZyB2aWRlb1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzIHRvbyBzbG93IG9yIHRvbyBmYXN0LiBEZWZhdWx0cyB0byAxMC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmlkZW9GaWx0ZXJzIC0gVGhlIEZGTVBFRyB2aWRlbyBmaWx0ZXJzIHRvIGFwcGx5LiBUaGVzZSBmaWx0ZXJzIGFsbG93IHRvIHNjYWxlLCBmbGlwLCByb3RhdGUgYW5kIGRvIG1hbnlcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXIgdXNlZnVsIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGUgc291cmNlIHZpZGVvIHN0cmVhbS4gVGhlIGZvcm1hdCBvZiB0aGUgcHJvcGVydHlcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVzdCBjb21wbHkgd2l0aCBodHRwczovL2ZmbXBlZy5vcmcvZmZtcGVnLWZpbHRlcnMuaHRtbFxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2aWRlb1NjYWxlIC0gVGhlIHNjYWxpbmcgdmFsdWUgdG8gYXBwbHkuIFJlYWQgaHR0cHM6Ly90cmFjLmZmbXBlZy5vcmcvd2lraS9TY2FsaW5nIGZvciBwb3NzaWJsZSB2YWx1ZXMuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBObyBzY2FsZSBpcyBhcHBsaWVkIGJ5IGRlZmF1bHQuIElmIGJvdGggYHZpZGVvRmlsdGVyc2AgYW5kIGB2aWRlb1NjYWxlYCBhcmUgc2V0IHRoZW5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubHkgYHZpZGVvRmlsdGVyc2AgdmFsdWUgd2lsbCBiZSByZXNwZWN0ZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBpeGVsRm9ybWF0IC0gT3V0cHV0IHBpeGVsIGZvcm1hdC4gUnVuIGBmZm1wZWcgLXBpeF9mbXRzYCB0byBsaXN0IHBvc3NpYmxlIHZhbHVlcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGb3IgUXVpY2t0aW1lIGNvbXBhdGliaWxpdHksIHNldCB0byBcInl1djQyMHBcIiBhbG9uZyB3aXRoIHZpZGVvVHlwZTogXCJsaWJ4MjY0XCIuXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBmb3JjZVJlc3RhcnQgLSBXaGV0aGVyIHRvIHRyeSB0byBjYXRjaCBhbmQgdXBsb2FkL3JldHVybiB0aGUgY3VycmVudGx5IHJ1bm5pbmcgc2NyZWVuIHJlY29yZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGBmYWxzZWAsIHRoZSBkZWZhdWx0IHNldHRpbmcpIG9yIGlnbm9yZSB0aGUgcmVzdWx0IG9mIGl0IGFuZCBzdGFydCBhIG5ldyByZWNvcmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltbWVkaWF0ZWx5LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gdGltZUxpbWl0IC0gVGhlIG1heGltdW0gcmVjb3JkaW5nIHRpbWUsIGluIHNlY29uZHMuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAxODAsIHRoZSBtYXhpbXVtIHZhbHVlIGlzIDYwMCAoMTAgbWludXRlcykuXG4gKi9cblxuLyoqXG4gKiBSZWNvcmQgdGhlIGRpc3BsYXkgb2YgZGV2aWNlcyBydW5uaW5nIGlPUyBTaW11bGF0b3Igc2luY2UgWGNvZGUgOSBvciByZWFsIGRldmljZXMgc2luY2UgaU9TIDExXG4gKiAoZmZtcGVnIHV0aWxpdHkgaXMgcmVxdWlyZWQ6ICdicmV3IGluc3RhbGwgZmZtcGVnJykuXG4gKiBJdCByZWNvcmRzIHNjcmVlbiBhY3Rpdml0eSB0byBhIE1QRUctNCBmaWxlLiBBdWRpbyBpcyBub3QgcmVjb3JkZWQgd2l0aCB0aGUgdmlkZW8gZmlsZS5cbiAqIElmIHNjcmVlbiByZWNvcmRpbmcgaGFzIGJlZW4gYWxyZWFkeSBzdGFydGVkIHRoZW4gdGhlIGNvbW1hbmQgd2lsbCBzdG9wIGl0IGZvcmNlZnVsbHkgYW5kIHN0YXJ0IGEgbmV3IG9uZS5cbiAqIFRoZSBwcmV2aW91c2x5IHJlY29yZGVkIHZpZGVvIGZpbGUgd2lsbCBiZSBkZWxldGVkLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWZcbiAqICAgICAgICAgICAgICAgICAgIGFueSBzY3JlZW4gcmVjb3JkaW5nIGlzIGN1cnJlbnRseSBydW5uaW5nIG9yIGFuIGVtcHR5IHN0cmluZy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzY3JlZW4gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gc3RhcnQuXG4gKi9cbmNvbW1hbmRzLnN0YXJ0UmVjb3JkaW5nU2NyZWVuID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdmlkZW9UeXBlID0gREVGQVVMVF9WQ09ERUMsXG4gICAgdGltZUxpbWl0ID0gREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMsXG4gICAgdmlkZW9RdWFsaXR5ID0gREVGQVVMVF9RVUFMSVRZLFxuICAgIHZpZGVvRnBzID0gREVGQVVMVF9GUFMsXG4gICAgdmlkZW9GaWx0ZXJzLFxuICAgIHZpZGVvU2NhbGUsXG4gICAgZm9yY2VSZXN0YXJ0LFxuICAgIHBpeGVsRm9ybWF0XG4gIH0gPSBvcHRpb25zO1xuXG4gIGxldCByZXN1bHQgPSAnJztcbiAgaWYgKCFmb3JjZVJlc3RhcnQpIHtcbiAgICB0aGlzLmxvZy5pbmZvKGBDaGVja2luZyBpZiB0aGVyZSBpcy93YXMgYSBwcmV2aW91cyBzY3JlZW4gcmVjb3JkaW5nLiBgICtcbiAgICAgIGBTZXQgJ2ZvcmNlUmVzdGFydCcgb3B0aW9uIHRvICd0cnVlJyBpZiB5b3UnZCBsaWtlIHRvIHNraXAgdGhpcyBzdGVwLmApO1xuICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMuc3RvcFJlY29yZGluZ1NjcmVlbihvcHRpb25zKTtcbiAgfVxuXG4gIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7XG4gICAgcHJlZml4OiBgYXBwaXVtXyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDIsIDgpfWAsXG4gICAgc3VmZml4OiBNUDRfRVhULFxuICB9KTtcblxuICBjb25zdCB3ZGFCYXNlVXJsID0gdGhpcy5vcHRzLndkYUJhc2VVcmwgfHwgV0RBX0JBU0VfVVJMO1xuICBjb25zdCBzY3JlZW5SZWNvcmRlciA9IG5ldyBTY3JlZW5SZWNvcmRlcih0aGlzLm9wdHMuZGV2aWNlLnVkaWQsIHRoaXMubG9nLCB2aWRlb1BhdGgsIHtcbiAgICByZW1vdGVQb3J0OiB0aGlzLm9wdHMubWpwZWdTZXJ2ZXJQb3J0IHx8IERFRkFVTFRfTUpQRUdfU0VSVkVSX1BPUlQsXG4gICAgcmVtb3RlVXJsOiB3ZGFCYXNlVXJsLFxuICAgIHVzZVBvcnRGb3J3YXJkaW5nOiB0aGlzLmlzUmVhbERldmljZSgpICYmIGlzTG9jYWxIb3N0KHdkYUJhc2VVcmwpLFxuICAgIHZpZGVvVHlwZSxcbiAgICB2aWRlb0ZpbHRlcnMsXG4gICAgdmlkZW9TY2FsZSxcbiAgICB2aWRlb0ZwcyxcbiAgICBwaXhlbEZvcm1hdFxuICB9KTtcbiAgaWYgKCFhd2FpdCBzY3JlZW5SZWNvcmRlci5pbnRlcnJ1cHQodHJ1ZSkpIHtcbiAgICB0aGlzLmxvZy5lcnJvckFuZFRocm93KCdVbmFibGUgdG8gc3RvcCBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MnKTtcbiAgfVxuICBpZiAodGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIpIHtcbiAgICBhd2FpdCB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICB9XG5cbiAgY29uc3QgdGltZW91dFNlY29uZHMgPSBwYXJzZUZsb2F0KHRpbWVMaW1pdCk7XG4gIGlmIChpc05hTih0aW1lb3V0U2Vjb25kcykgfHwgdGltZW91dFNlY29uZHMgPiBNQVhfUkVDT1JESU5HX1RJTUVfU0VDIHx8IHRpbWVvdXRTZWNvbmRzIDw9IDApIHtcbiAgICB0aGlzLmxvZy5lcnJvckFuZFRocm93KGBUaGUgdGltZUxpbWl0IHZhbHVlIG11c3QgYmUgaW4gcmFuZ2UgWzEsICR7TUFYX1JFQ09SRElOR19USU1FX1NFQ31dIHNlY29uZHMuIGAgK1xuICAgICAgYFRoZSB2YWx1ZSBvZiAnJHt0aW1lTGltaXR9JyBoYXMgYmVlbiBwYXNzZWQgaW5zdGVhZC5gKTtcbiAgfVxuXG4gIGxldCB7XG4gICAgbWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSxcbiAgICBtanBlZ1NlcnZlckZyYW1lcmF0ZSxcbiAgfSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvYXBwaXVtL3NldHRpbmdzJywgJ0dFVCcpO1xuICBpZiAodmlkZW9RdWFsaXR5KSB7XG4gICAgY29uc3QgcXVhbGl0eSA9IF8uaXNJbnRlZ2VyKHZpZGVvUXVhbGl0eSkgPyB2aWRlb1F1YWxpdHkgOiBRVUFMSVRZX01BUFBJTkdbXy50b0xvd2VyKHZpZGVvUXVhbGl0eSldO1xuICAgIGlmICghcXVhbGl0eSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGB2aWRlb1F1YWxpdHkgdmFsdWUgc2hvdWxkIGJlIG9uZSBvZiAke0pTT04uc3RyaW5naWZ5KF8ua2V5cyhRVUFMSVRZX01BUFBJTkcpKX0gb3IgYSBudW1iZXIgaW4gcmFuZ2UgMS4uMTAwLiBgICtcbiAgICAgICAgYCcke3ZpZGVvUXVhbGl0eX0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgICB9XG4gICAgbWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSA9IG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHkgIT09IHF1YWxpdHkgPyBxdWFsaXR5IDogdW5kZWZpbmVkO1xuICB9IGVsc2Uge1xuICAgIG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHkgPSB1bmRlZmluZWQ7XG4gIH1cbiAgaWYgKHZpZGVvRnBzKSB7XG4gICAgY29uc3QgZnBzID0gcGFyc2VJbnQodmlkZW9GcHMsIDEwKTtcbiAgICBpZiAoaXNOYU4oZnBzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGB2aWRlb0ZwcyB2YWx1ZSBzaG91bGQgYmUgYSB2YWxpZCBudW1iZXIgaW4gcmFuZ2UgMS4uNjAuIGAgK1xuICAgICAgICBgJyR7dmlkZW9GcHN9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gICAgfVxuICAgIG1qcGVnU2VydmVyRnJhbWVyYXRlID0gbWpwZWdTZXJ2ZXJGcmFtZXJhdGUgIT09IGZwcyA/IGZwcyA6IHVuZGVmaW5lZDtcbiAgfSBlbHNlIHtcbiAgICBtanBlZ1NlcnZlckZyYW1lcmF0ZSA9IHVuZGVmaW5lZDtcbiAgfVxuICBpZiAodXRpbC5oYXNWYWx1ZShtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5KSB8fCB1dGlsLmhhc1ZhbHVlKG1qcGVnU2VydmVyRnJhbWVyYXRlKSkge1xuICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvYXBwaXVtL3NldHRpbmdzJywgJ1BPU1QnLCB7XG4gICAgICBzZXR0aW5nczoge1xuICAgICAgICBtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5LFxuICAgICAgICBtanBlZ1NlcnZlckZyYW1lcmF0ZSxcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgc2NyZWVuUmVjb3JkZXIuc3RhcnQodGltZW91dFNlY29uZHMgKiAxMDAwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGF3YWl0IHNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCBzY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhyb3cgZTtcbiAgfVxuICB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlciA9IHNjcmVlblJlY29yZGVyO1xuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0b3BSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB2aWRlbyBzaG91bGQgYmUgdXBsb2FkZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZm9sbG93aW5nIHByb3RvY29scyBhcmUgc3VwcG9ydGVkOiBodHRwL2h0dHBzLCBmdHAuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOdWxsIG9yIGVtcHR5IHN0cmluZyB2YWx1ZSAodGhlIGRlZmF1bHQgc2V0dGluZykgbWVhbnMgdGhlIGNvbnRlbnQgb2YgcmVzdWx0aW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlIHNob3VsZCBiZSBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb2ludCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIG1lZGlhIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXNlciAtIFRoZSBuYW1lIG9mIHRoZSB1c2VyIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIFRoZSAnUFVUJyBvbmUgaXMgdXNlZCBieSBkZWZhdWx0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P09iamVjdH0gaGVhZGVycyAtIEFkZGl0aW9uYWwgaGVhZGVycyBtYXBwaW5nIGZvciBtdWx0aXBhcnQgaHR0cChzKSB1cGxvYWRzXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGZpbGVGaWVsZE5hbWUgW2ZpbGVdIC0gVGhlIG5hbWUgb2YgdGhlIGZvcm0gZmllbGQsIHdoZXJlIHRoZSBmaWxlIGNvbnRlbnQgQkxPQiBzaG91bGQgYmUgc3RvcmVkIGZvclxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAocykgdXBsb2Fkc1xuICogQHByb3BlcnR5IHs/T2JqZWN0fEFycmF5PFBhaXI+fSBmb3JtRmllbGRzIC0gQWRkaXRpb25hbCBmb3JtIGZpZWxkcyBmb3IgbXVsdGlwYXJ0IGh0dHAocykgdXBsb2Fkc1xuICovXG5cbi8qKlxuICogU3RvcCByZWNvcmRpbmcgdGhlIHNjcmVlbi4gSWYgbm8gc2NyZWVuIHJlY29yZGluZyBwcm9jZXNzIGlzIHJ1bm5pbmcgdGhlblxuICogdGhlIGVuZHBvaW50IHdpbGwgdHJ5IHRvIGdldCB0aGUgcmVjZW50bHkgcmVjb3JkZWQgZmlsZS5cbiAqIElmIG5vIHByZXZpb3VzbHkgcmVjb3JkZWQgZmlsZSBpcyBmb3VuZCBhbmQgbm8gYWN0aXZlIHNjcmVlbiByZWNvcmRpbmdcbiAqIHByb2Nlc3NlcyBhcmUgcnVubmluZyB0aGVuIHRoZSBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcuXG4gKlxuICogQHBhcmFtIHs/U3RvcFJlY29yZGluZ09wdGlvbnN9IG9wdGlvbnMgLSBUaGUgYXZhaWxhYmxlIG9wdGlvbnMuXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBCYXNlNjQtZW5jb2RlZCBjb250ZW50IG9mIHRoZSByZWNvcmRlZCBtZWRpYSBmaWxlIGlmICdyZW1vdGVQYXRoJ1xuICogICAgICAgICAgICAgICAgICAgcGFyYW1ldGVyIGlzIGVtcHR5IG9yIG51bGwgb3IgYW4gZW1wdHkgc3RyaW5nLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBnZXR0aW5nIHRoZSBuYW1lIG9mIGEgbWVkaWEgZmlsZVxuICogICAgICAgICAgICAgICAgIG9yIHRoZSBmaWxlIGNvbnRlbnQgY2Fubm90IGJlIHVwbG9hZGVkIHRvIHRoZSByZW1vdGUgbG9jYXRpb24uXG4gKi9cbmNvbW1hbmRzLnN0b3BSZWNvcmRpbmdTY3JlZW4gPSBhc3luYyBmdW5jdGlvbiBzdG9wUmVjb3JkaW5nU2NyZWVuIChvcHRpb25zID0ge30pIHtcbiAgaWYgKCF0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlcikge1xuICAgIHRoaXMubG9nLmluZm8oJ1NjcmVlbiByZWNvcmRpbmcgaXMgbm90IHJ1bm5pbmcuIFRoZXJlIGlzIG5vdGhpbmcgdG8gc3RvcC4nKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmZpbmlzaCgpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHZpZGVvUGF0aCkpIHtcbiAgICAgIHRoaXMubG9nLmVycm9yQW5kVGhyb3coYFRoZSBzY3JlZW4gcmVjb3JkZXIgdXRpbGl0eSBoYXMgZmFpbGVkIGAgK1xuICAgICAgICBgdG8gc3RvcmUgdGhlIGFjdHVhbCBzY3JlZW4gcmVjb3JkaW5nIGF0ICcke3ZpZGVvUGF0aH0nYCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCBlbmNvZGVCYXNlNjRPclVwbG9hZCh2aWRlb1BhdGgsIG9wdGlvbnMucmVtb3RlUGF0aCwgb3B0aW9ucyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIuaW50ZXJydXB0KHRydWUpO1xuICAgIGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmNsZWFudXAoKTtcbiAgICB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlciA9IG51bGw7XG4gIH1cbn07XG5cblxuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLFFBQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLGFBQUEsR0FBQUYsT0FBQTtBQUNBLElBQUFHLE1BQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLHlCQUFBLEdBQUFMLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBSyxxQkFBQSxHQUFBTCxPQUFBO0FBQ0EsSUFBQU0sU0FBQSxHQUFBTixPQUFBO0FBQ0EsSUFBQU8sSUFBQSxHQUFBUixzQkFBQSxDQUFBQyxPQUFBO0FBRUEsSUFBSVEsUUFBUSxHQUFHLENBQUMsQ0FBQztBQUFDQyxPQUFBLENBQUFELFFBQUEsR0FBQUEsUUFBQTtBQUVsQixNQUFNRSxzQkFBc0IsR0FBRyxFQUFFLEdBQUcsRUFBRTtBQUN0QyxNQUFNQywwQkFBMEIsR0FBRyxFQUFFLEdBQUcsQ0FBQztBQUN6QyxNQUFNQyx5QkFBeUIsR0FBRyxJQUFJO0FBQ3RDLE1BQU1DLFdBQVcsR0FBRyxFQUFFO0FBQ3RCLE1BQU1DLGVBQWUsR0FBRyxRQUFRO0FBQ2hDLE1BQU1DLGNBQWMsR0FBRyxPQUFPO0FBQzlCLE1BQU1DLE9BQU8sR0FBRyxNQUFNO0FBQ3RCLE1BQU1DLGFBQWEsR0FBRyxRQUFRO0FBQzlCLE1BQU1DLFlBQVksR0FBR0MsZUFBTSxDQUFDQyxTQUFTLENBQUNILGFBQWEsQ0FBQztBQUNwRCxNQUFNSSxlQUFlLEdBQUc7RUFDdEJDLEdBQUcsRUFBRSxFQUFFO0VBQ1BDLE1BQU0sRUFBRSxFQUFFO0VBQ1ZDLElBQUksRUFBRSxFQUFFO0VBQ1JDLEtBQUssRUFBRTtBQUNULENBQUM7QUFHRCxNQUFNQyxjQUFjLENBQUM7RUFDbkJDLFdBQVdBLENBQUVDLElBQUksRUFBRUMsR0FBRyxFQUFFQyxTQUFTLEVBQUVDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRTtJQUM1QyxJQUFJLENBQUNELFNBQVMsR0FBR0EsU0FBUztJQUMxQixJQUFJLENBQUNELEdBQUcsR0FBR0EsR0FBRztJQUNkLElBQUksQ0FBQ0UsSUFBSSxHQUFHQSxJQUFJO0lBQ2hCLElBQUksQ0FBQ0gsSUFBSSxHQUFHQSxJQUFJO0lBQ2hCLElBQUksQ0FBQ0ksV0FBVyxHQUFHLElBQUk7SUFDdkIsSUFBSSxDQUFDQyxjQUFjLEdBQUcsSUFBSTtFQUM1QjtFQUVBLE1BQU1DLEtBQUtBLENBQUVDLFNBQVMsRUFBRTtJQUN0QixJQUFJO01BQ0YsTUFBTUMsV0FBRSxDQUFDQyxLQUFLLENBQUNwQixhQUFhLENBQUM7SUFDL0IsQ0FBQyxDQUFDLE9BQU9xQixHQUFHLEVBQUU7TUFDWixNQUFNLElBQUlDLEtBQUssQ0FBRSxJQUFHdEIsYUFBYyx5RUFBd0UsR0FDdkcsOERBQTZELENBQUM7SUFDbkU7SUFFQSxNQUFNO01BQ0p1QixVQUFVO01BQ1ZDLFNBQVM7TUFDVEMsaUJBQWlCO01BQ2pCQyxRQUFRO01BQ1JDLFNBQVM7TUFDVEMsVUFBVTtNQUNWQyxZQUFZO01BQ1pDO0lBQ0YsQ0FBQyxHQUFHLElBQUksQ0FBQ2hCLElBQUk7SUFFYixJQUFJO01BQ0YsTUFBTWlCLGlDQUEwQixDQUFDQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUNyQixJQUFJLEVBQUVZLFVBQVUsRUFBRTtRQUN4RVUsVUFBVSxFQUFFVixVQUFVO1FBQ3RCRTtNQUNGLENBQUMsQ0FBQztJQUNKLENBQUMsQ0FBQyxPQUFPSixHQUFHLEVBQUU7TUFDWixJQUFJLENBQUNULEdBQUcsQ0FBQ3NCLElBQUksQ0FBRSxpQ0FBZ0NYLFVBQVcsT0FBTUEsVUFBVyxHQUFFLEdBQzFFLGlCQUFnQixJQUFJLENBQUNaLElBQUssOENBQTZDLEdBQ3ZFLDhDQUE2QyxDQUFDO0lBQ25EO0lBRUEsTUFBTXdCLElBQUksR0FBRyxDQUNYLElBQUksRUFBRSxPQUFPLEVBRWIsWUFBWSxFQUFFLEdBQUcsRUFDakIsbUJBQW1CLEVBQUUsR0FBRyxFQUN4QixxQkFBcUIsRUFBRSxHQUFHLEVBQzFCLHNCQUFzQixFQUFHLEdBQUVqQixTQUFTLEdBQUcsSUFBSSxHQUFHLENBQUUsRUFBQyxDQUNsRDtJQUVELElBQUlRLFFBQVEsSUFBSUMsU0FBUyxLQUFLLFNBQVMsRUFBRTtNQUN2Q1EsSUFBSSxDQUFDQyxJQUFJLENBQUMsSUFBSSxFQUFFVixRQUFRLENBQUM7SUFDM0I7SUFDQSxNQUFNO01BQUNXLFFBQVE7TUFBRUM7SUFBUSxDQUFDLEdBQUdDLFlBQUcsQ0FBQ0MsS0FBSyxDQUFDaEIsU0FBUyxDQUFDO0lBQ2pEVyxJQUFJLENBQUNDLElBQUksQ0FBQyxJQUFJLEVBQUcsR0FBRUMsUUFBUyxLQUFJQyxRQUFTLElBQUdmLFVBQVcsRUFBQyxDQUFDO0lBQ3pELElBQUlNLFlBQVksSUFBSUQsVUFBVSxFQUFFO01BQzlCTyxJQUFJLENBQUNDLElBQUksQ0FBQyxLQUFLLEVBQUVQLFlBQVksSUFBSyxTQUFRRCxVQUFXLEVBQUMsQ0FBQztJQUN6RDtJQUVBLElBQUlFLFdBQVcsRUFBRTtNQUNmSyxJQUFJLENBQUNDLElBQUksQ0FBQyxVQUFVLEVBQUVOLFdBQVcsQ0FBQztJQUNwQztJQUNBSyxJQUFJLENBQUNDLElBQUksQ0FDUCxTQUFTLEVBQUVULFNBQVMsRUFDcEIsSUFBSSxFQUFFLElBQUksQ0FBQ2QsU0FBUyxDQUNyQjtJQUVELElBQUksQ0FBQ0UsV0FBVyxHQUFHLElBQUkwQix3QkFBVSxDQUFDekMsYUFBYSxFQUFFbUMsSUFBSSxDQUFDO0lBQ3RELElBQUlPLGdCQUFnQixHQUFHLEtBQUs7SUFDNUIsSUFBSSxDQUFDM0IsV0FBVyxDQUFDNEIsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDQyxNQUFNLEVBQUVDLE1BQU0sS0FBSztNQUNoRCxJQUFJQSxNQUFNLEVBQUU7UUFDVixJQUFJQSxNQUFNLENBQUNDLElBQUksRUFBRSxDQUFDQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7VUFDdEMsSUFBSSxDQUFDTCxnQkFBZ0IsRUFBRTtZQUNyQkEsZ0JBQWdCLEdBQUcsSUFBSTtVQUN6QjtRQUNGLENBQUMsTUFBTTtVQUNMekMsWUFBWSxDQUFDK0MsSUFBSSxDQUFFLEdBQUVILE1BQU8sRUFBQyxDQUFDO1FBQ2hDO01BQ0Y7SUFDRixDQUFDLENBQUM7SUFDRixNQUFNLElBQUksQ0FBQzlCLFdBQVcsQ0FBQ0UsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUMvQixNQUFNZ0MsY0FBYyxHQUFHLElBQUk7SUFDM0IsSUFBSTtNQUNGLE1BQU0sSUFBQUMsMEJBQWdCLEVBQUMsTUFBTVIsZ0JBQWdCLEVBQUU7UUFDN0NTLE1BQU0sRUFBRUYsY0FBYztRQUN0QkcsVUFBVSxFQUFFO01BQ2QsQ0FBQyxDQUFDO0lBQ0osQ0FBQyxDQUFDLE9BQU9DLENBQUMsRUFBRTtNQUNWLElBQUksQ0FBQ3pDLEdBQUcsQ0FBQ3NCLElBQUksQ0FBRSwrQ0FBOENlLGNBQWUsdUJBQXNCLENBQUM7SUFDckc7SUFDQSxJQUFJLENBQUMsSUFBSSxDQUFDbEMsV0FBVyxDQUFDdUMsU0FBUyxFQUFFO01BQy9CLE1BQU0sSUFBSWhDLEtBQUssQ0FBRSwrQkFBOEJ0QixhQUFjLHVCQUFzQixHQUNoRixvQ0FBbUMsQ0FBQztJQUN6QztJQUNBLElBQUksQ0FBQ1ksR0FBRyxDQUFDb0MsSUFBSSxDQUFFLDBDQUF5QyxJQUFJLENBQUNyQyxJQUFLLG9CQUFtQlgsYUFBYyxJQUFHbUMsSUFBSSxDQUFDb0IsSUFBSSxDQUFDLEdBQUcsQ0FBRSxLQUFJLEdBQ3RILG1CQUFrQnJDLFNBQVUsSUFBRyxDQUFDO0lBRW5DLElBQUksQ0FBQ0YsY0FBYyxHQUFHd0MsVUFBVSxDQUFDLFlBQVk7TUFDM0MsSUFBSSxFQUFDLE1BQU0sSUFBSSxDQUFDQyxTQUFTLEVBQUUsR0FBRTtRQUMzQixJQUFJLENBQUM3QyxHQUFHLENBQUNzQixJQUFJLENBQUUsNERBQTJELElBQUksQ0FBQ3ZCLElBQUssV0FBVU8sU0FBVSxZQUFXLENBQUM7TUFDdEg7SUFDRixDQUFDLEVBQUVBLFNBQVMsQ0FBQztFQUNmO0VBRUEsTUFBTXVDLFNBQVNBLENBQUVDLEtBQUssR0FBRyxLQUFLLEVBQUU7SUFDOUIsSUFBSUMsTUFBTSxHQUFHLElBQUk7SUFFakIsSUFBSSxJQUFJLENBQUMzQyxjQUFjLEVBQUU7TUFDdkI0QyxZQUFZLENBQUMsSUFBSSxDQUFDNUMsY0FBYyxDQUFDO01BQ2pDLElBQUksQ0FBQ0EsY0FBYyxHQUFHLElBQUk7SUFDNUI7SUFFQSxJQUFJLElBQUksQ0FBQ0QsV0FBVyxJQUFJLElBQUksQ0FBQ0EsV0FBVyxDQUFDdUMsU0FBUyxFQUFFO01BQ2xELE1BQU1PLGdCQUFnQixHQUFHLElBQUksQ0FBQzlDLFdBQVcsQ0FBQytDLElBQUksQ0FBQ0osS0FBSyxHQUFHLFNBQVMsR0FBRyxRQUFRLENBQUM7TUFDNUUsSUFBSSxDQUFDM0MsV0FBVyxHQUFHLElBQUk7TUFDdkIsSUFBSTtRQUNGLE1BQU04QyxnQkFBZ0I7TUFDeEIsQ0FBQyxDQUFDLE9BQU9SLENBQUMsRUFBRTtRQUNWLElBQUksQ0FBQ3pDLEdBQUcsQ0FBQ3NCLElBQUksQ0FBRSxVQUFTd0IsS0FBSyxHQUFHLFdBQVcsR0FBRyxXQUFZLElBQUcxRCxhQUFjLElBQUcsR0FDM0UsbUJBQWtCcUQsQ0FBQyxDQUFDVSxPQUFRLEVBQUMsQ0FBQztRQUNqQ0osTUFBTSxHQUFHLEtBQUs7TUFDaEI7SUFDRjtJQUVBNUIsaUNBQTBCLENBQUNpQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUNyRCxJQUFJLEVBQUUsSUFBSSxDQUFDRyxJQUFJLENBQUNTLFVBQVUsQ0FBQztJQUU3RSxPQUFPb0MsTUFBTTtFQUNmO0VBRUEsTUFBTU0sTUFBTUEsQ0FBQSxFQUFJO0lBQ2QsTUFBTSxJQUFJLENBQUNSLFNBQVMsRUFBRTtJQUN0QixPQUFPLElBQUksQ0FBQzVDLFNBQVM7RUFDdkI7RUFFQSxNQUFNcUQsT0FBT0EsQ0FBQSxFQUFJO0lBQ2YsSUFBSSxNQUFNL0MsV0FBRSxDQUFDZ0QsTUFBTSxDQUFDLElBQUksQ0FBQ3RELFNBQVMsQ0FBQyxFQUFFO01BQ25DLE1BQU1NLFdBQUUsQ0FBQ2lELE1BQU0sQ0FBQyxJQUFJLENBQUN2RCxTQUFTLENBQUM7SUFDakM7RUFDRjtBQUNGO0FBbURBdEIsUUFBUSxDQUFDOEUsb0JBQW9CLEdBQUcsZUFBZUEsb0JBQW9CQSxDQUFFQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLEVBQUU7RUFDakYsTUFBTTtJQUNKM0MsU0FBUyxHQUFHN0IsY0FBYztJQUMxQnlFLFNBQVMsR0FBRzdFLDBCQUEwQjtJQUN0QzhFLFlBQVksR0FBRzNFLGVBQWU7SUFDOUI2QixRQUFRLEdBQUc5QixXQUFXO0lBQ3RCaUMsWUFBWTtJQUNaRCxVQUFVO0lBQ1Y2QyxZQUFZO0lBQ1ozQztFQUNGLENBQUMsR0FBR3dDLE9BQU87RUFFWCxJQUFJWCxNQUFNLEdBQUcsRUFBRTtFQUNmLElBQUksQ0FBQ2MsWUFBWSxFQUFFO0lBQ2pCLElBQUksQ0FBQzdELEdBQUcsQ0FBQ29DLElBQUksQ0FBRSx3REFBdUQsR0FDbkUsc0VBQXFFLENBQUM7SUFDekVXLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQ2UsbUJBQW1CLENBQUNKLE9BQU8sQ0FBQztFQUNsRDtFQUVBLE1BQU16RCxTQUFTLEdBQUcsTUFBTThELGdCQUFPLENBQUNDLElBQUksQ0FBQztJQUNuQ0MsTUFBTSxFQUFHLFVBQVNDLElBQUksQ0FBQ0MsTUFBTSxFQUFFLENBQUNDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQ0MsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUUsRUFBQztJQUM5REMsTUFBTSxFQUFFbkY7RUFDVixDQUFDLENBQUM7RUFFRixNQUFNb0YsVUFBVSxHQUFHLElBQUksQ0FBQ3JFLElBQUksQ0FBQ3FFLFVBQVUsSUFBSUMsa0NBQVk7RUFDdkQsTUFBTUMsY0FBYyxHQUFHLElBQUk1RSxjQUFjLENBQUMsSUFBSSxDQUFDSyxJQUFJLENBQUN3RSxNQUFNLENBQUMzRSxJQUFJLEVBQUUsSUFBSSxDQUFDQyxHQUFHLEVBQUVDLFNBQVMsRUFBRTtJQUNwRlUsVUFBVSxFQUFFLElBQUksQ0FBQ1QsSUFBSSxDQUFDeUUsZUFBZSxJQUFJNUYseUJBQXlCO0lBQ2xFNkIsU0FBUyxFQUFFMkQsVUFBVTtJQUNyQjFELGlCQUFpQixFQUFFLElBQUksQ0FBQytELFlBQVksRUFBRSxJQUFJLElBQUFDLGtCQUFXLEVBQUNOLFVBQVUsQ0FBQztJQUNqRXhELFNBQVM7SUFDVEUsWUFBWTtJQUNaRCxVQUFVO0lBQ1ZGLFFBQVE7SUFDUkk7RUFDRixDQUFDLENBQUM7RUFDRixJQUFJLEVBQUMsTUFBTXVELGNBQWMsQ0FBQzVCLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRTtJQUN6QyxJQUFJLENBQUM3QyxHQUFHLENBQUM4RSxhQUFhLENBQUMseUNBQXlDLENBQUM7RUFDbkU7RUFDQSxJQUFJLElBQUksQ0FBQ0MscUJBQXFCLEVBQUU7SUFDOUIsTUFBTSxJQUFJLENBQUNBLHFCQUFxQixDQUFDekIsT0FBTyxFQUFFO0lBQzFDLElBQUksQ0FBQ3lCLHFCQUFxQixHQUFHLElBQUk7RUFDbkM7RUFFQSxNQUFNQyxjQUFjLEdBQUdDLFVBQVUsQ0FBQ3RCLFNBQVMsQ0FBQztFQUM1QyxJQUFJdUIsS0FBSyxDQUFDRixjQUFjLENBQUMsSUFBSUEsY0FBYyxHQUFHbkcsc0JBQXNCLElBQUltRyxjQUFjLElBQUksQ0FBQyxFQUFFO0lBQzNGLElBQUksQ0FBQ2hGLEdBQUcsQ0FBQzhFLGFBQWEsQ0FBRSw0Q0FBMkNqRyxzQkFBdUIsYUFBWSxHQUNuRyxpQkFBZ0I4RSxTQUFVLDRCQUEyQixDQUFDO0VBQzNEO0VBRUEsSUFBSTtJQUNGd0IsNEJBQTRCO0lBQzVCQztFQUNGLENBQUMsR0FBRyxNQUFNLElBQUksQ0FBQ0MsWUFBWSxDQUFDLGtCQUFrQixFQUFFLEtBQUssQ0FBQztFQUN0RCxJQUFJekIsWUFBWSxFQUFFO0lBQ2hCLE1BQU0wQixPQUFPLEdBQUdDLGVBQUMsQ0FBQ0MsU0FBUyxDQUFDNUIsWUFBWSxDQUFDLEdBQUdBLFlBQVksR0FBR3BFLGVBQWUsQ0FBQytGLGVBQUMsQ0FBQ0UsT0FBTyxDQUFDN0IsWUFBWSxDQUFDLENBQUM7SUFDbkcsSUFBSSxDQUFDMEIsT0FBTyxFQUFFO01BQ1osTUFBTSxJQUFJNUUsS0FBSyxDQUFFLHVDQUFzQ2dGLElBQUksQ0FBQ0MsU0FBUyxDQUFDSixlQUFDLENBQUNLLElBQUksQ0FBQ3BHLGVBQWUsQ0FBQyxDQUFFLGdDQUErQixHQUMzSCxJQUFHb0UsWUFBYSxvQkFBbUIsQ0FBQztJQUN6QztJQUNBdUIsNEJBQTRCLEdBQUdBLDRCQUE0QixLQUFLRyxPQUFPLEdBQUdBLE9BQU8sR0FBR08sU0FBUztFQUMvRixDQUFDLE1BQU07SUFDTFYsNEJBQTRCLEdBQUdVLFNBQVM7RUFDMUM7RUFDQSxJQUFJL0UsUUFBUSxFQUFFO0lBQ1osTUFBTWdGLEdBQUcsR0FBR0MsUUFBUSxDQUFDakYsUUFBUSxFQUFFLEVBQUUsQ0FBQztJQUNsQyxJQUFJb0UsS0FBSyxDQUFDWSxHQUFHLENBQUMsRUFBRTtNQUNkLE1BQU0sSUFBSXBGLEtBQUssQ0FBRSwwREFBeUQsR0FDdkUsSUFBR0ksUUFBUyxvQkFBbUIsQ0FBQztJQUNyQztJQUNBc0Usb0JBQW9CLEdBQUdBLG9CQUFvQixLQUFLVSxHQUFHLEdBQUdBLEdBQUcsR0FBR0QsU0FBUztFQUN2RSxDQUFDLE1BQU07SUFDTFQsb0JBQW9CLEdBQUdTLFNBQVM7RUFDbEM7RUFDQSxJQUFJRyxhQUFJLENBQUNDLFFBQVEsQ0FBQ2QsNEJBQTRCLENBQUMsSUFBSWEsYUFBSSxDQUFDQyxRQUFRLENBQUNiLG9CQUFvQixDQUFDLEVBQUU7SUFDdEYsTUFBTSxJQUFJLENBQUNDLFlBQVksQ0FBQyxrQkFBa0IsRUFBRSxNQUFNLEVBQUU7TUFDbERhLFFBQVEsRUFBRTtRQUNSZiw0QkFBNEI7UUFDNUJDO01BQ0Y7SUFDRixDQUFDLENBQUM7RUFDSjtFQUVBLElBQUk7SUFDRixNQUFNWCxjQUFjLENBQUNwRSxLQUFLLENBQUMyRSxjQUFjLEdBQUcsSUFBSSxDQUFDO0VBQ25ELENBQUMsQ0FBQyxPQUFPdkMsQ0FBQyxFQUFFO0lBQ1YsTUFBTWdDLGNBQWMsQ0FBQzVCLFNBQVMsQ0FBQyxJQUFJLENBQUM7SUFDcEMsTUFBTTRCLGNBQWMsQ0FBQ25CLE9BQU8sRUFBRTtJQUM5QixNQUFNYixDQUFDO0VBQ1Q7RUFDQSxJQUFJLENBQUNzQyxxQkFBcUIsR0FBR04sY0FBYztFQUUzQyxPQUFPMUIsTUFBTTtBQUNmLENBQUM7QUFpQ0RwRSxRQUFRLENBQUNtRixtQkFBbUIsR0FBRyxlQUFlQSxtQkFBbUJBLENBQUVKLE9BQU8sR0FBRyxDQUFDLENBQUMsRUFBRTtFQUMvRSxJQUFJLENBQUMsSUFBSSxDQUFDcUIscUJBQXFCLEVBQUU7SUFDL0IsSUFBSSxDQUFDL0UsR0FBRyxDQUFDb0MsSUFBSSxDQUFDLDREQUE0RCxDQUFDO0lBQzNFLE9BQU8sRUFBRTtFQUNYO0VBRUEsSUFBSTtJQUNGLE1BQU1uQyxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUM4RSxxQkFBcUIsQ0FBQzFCLE1BQU0sRUFBRTtJQUMzRCxJQUFJLEVBQUMsTUFBTTlDLFdBQUUsQ0FBQ2dELE1BQU0sQ0FBQ3RELFNBQVMsQ0FBQyxHQUFFO01BQy9CLElBQUksQ0FBQ0QsR0FBRyxDQUFDOEUsYUFBYSxDQUFFLHlDQUF3QyxHQUM3RCw0Q0FBMkM3RSxTQUFVLEdBQUUsQ0FBQztJQUM3RDtJQUNBLE9BQU8sTUFBTSxJQUFBa0csMkJBQW9CLEVBQUNsRyxTQUFTLEVBQUV5RCxPQUFPLENBQUMwQyxVQUFVLEVBQUUxQyxPQUFPLENBQUM7RUFDM0UsQ0FBQyxTQUFTO0lBQ1IsTUFBTSxJQUFJLENBQUNxQixxQkFBcUIsQ0FBQ2xDLFNBQVMsQ0FBQyxJQUFJLENBQUM7SUFDaEQsTUFBTSxJQUFJLENBQUNrQyxxQkFBcUIsQ0FBQ3pCLE9BQU8sRUFBRTtJQUMxQyxJQUFJLENBQUN5QixxQkFBcUIsR0FBRyxJQUFJO0VBQ25DO0FBQ0YsQ0FBQztBQUFDLElBQUFzQixRQUFBLEdBSWExSCxRQUFRO0FBQUFDLE9BQUEsQ0FBQTBILE9BQUEsR0FBQUQsUUFBQSJ9