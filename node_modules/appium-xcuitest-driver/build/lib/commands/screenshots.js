"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _asyncbox = require("asyncbox");
var _lodash = _interopRequireDefault(require("lodash"));
var _support = require("appium/support");
let commands = {};
commands.getScreenshot = async function getScreenshot() {
  const getScreenshotFromWDA = async () => {
    this.log.debug(`Taking screenshot with WDA`);
    const data = await this.proxyCommand('/screenshot', 'GET');
    if (!_lodash.default.isString(data)) {
      throw new Error(`Unable to take screenshot. WDA returned '${JSON.stringify(data)}'`);
    }
    return data;
  };
  if (this.mjpegStream) {
    this.log.info(`mjpeg video stream provided, returning latest frame as screenshot`);
    const data = await this.mjpegStream.lastChunkPNGBase64();
    if (data) {
      return data;
    }
    this.log.warn('Tried to get screenshot from active MJPEG stream, but there ' + 'was no data yet. Falling back to regular screenshot methods.');
  }
  try {
    return await getScreenshotFromWDA();
  } catch (err) {
    this.log.warn(`Error getting screenshot: ${err.message}`);
  }
  if (this.isSimulator()) {
    this.log.info(`Falling back to 'simctl io screenshot' API`);
    return await this.opts.device.simctl.getScreenshot();
  }
  return await (0, _asyncbox.retryInterval)(2, 1000, getScreenshotFromWDA);
};
commands.getElementScreenshot = async function getElementScreenshot(el) {
  el = _support.util.unwrapElement(el);
  if (this.isWebContext()) {
    const atomsElement = this.getAtomsElement(el);
    return await this.executeAtom('getElementScreenshot', [atomsElement]);
  }
  const data = await this.proxyCommand(`/element/${el}/screenshot`, 'GET');
  if (!_lodash.default.isString(data)) {
    this.log.errorAndThrow(`Unable to take a screenshot of the element ${el}. WDA returned '${JSON.stringify(data)}'`);
  }
  return data;
};
commands.getViewportScreenshot = async function getViewportScreenshot() {
  let statusBarHeight = await this.getStatusBarHeight();
  const screenshot = await this.getScreenshot();
  if (statusBarHeight === 0) {
    return screenshot;
  }
  const scale = await this.getDevicePixelRatio();
  statusBarHeight = Math.round(statusBarHeight * scale);
  const windowSize = await this.getWindowSize();
  let rect = {
    left: 0,
    top: statusBarHeight,
    width: windowSize.width * scale,
    height: windowSize.height * scale - statusBarHeight
  };
  let newScreenshot = await _support.imageUtil.cropBase64Image(screenshot, rect);
  return newScreenshot;
};
var _default = commands;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYXN5bmNib3giLCJyZXF1aXJlIiwiX2xvZGFzaCIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJfc3VwcG9ydCIsImNvbW1hbmRzIiwiZ2V0U2NyZWVuc2hvdCIsImdldFNjcmVlbnNob3RGcm9tV0RBIiwibG9nIiwiZGVidWciLCJkYXRhIiwicHJveHlDb21tYW5kIiwiXyIsImlzU3RyaW5nIiwiRXJyb3IiLCJKU09OIiwic3RyaW5naWZ5IiwibWpwZWdTdHJlYW0iLCJpbmZvIiwibGFzdENodW5rUE5HQmFzZTY0Iiwid2FybiIsImVyciIsIm1lc3NhZ2UiLCJpc1NpbXVsYXRvciIsIm9wdHMiLCJkZXZpY2UiLCJzaW1jdGwiLCJyZXRyeUludGVydmFsIiwiZ2V0RWxlbWVudFNjcmVlbnNob3QiLCJlbCIsInV0aWwiLCJ1bndyYXBFbGVtZW50IiwiaXNXZWJDb250ZXh0IiwiYXRvbXNFbGVtZW50IiwiZ2V0QXRvbXNFbGVtZW50IiwiZXhlY3V0ZUF0b20iLCJlcnJvckFuZFRocm93IiwiZ2V0Vmlld3BvcnRTY3JlZW5zaG90Iiwic3RhdHVzQmFySGVpZ2h0IiwiZ2V0U3RhdHVzQmFySGVpZ2h0Iiwic2NyZWVuc2hvdCIsInNjYWxlIiwiZ2V0RGV2aWNlUGl4ZWxSYXRpbyIsIk1hdGgiLCJyb3VuZCIsIndpbmRvd1NpemUiLCJnZXRXaW5kb3dTaXplIiwicmVjdCIsImxlZnQiLCJ0b3AiLCJ3aWR0aCIsImhlaWdodCIsIm5ld1NjcmVlbnNob3QiLCJpbWFnZVV0aWwiLCJjcm9wQmFzZTY0SW1hZ2UiLCJfZGVmYXVsdCIsImV4cG9ydHMiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2NvbW1hbmRzL3NjcmVlbnNob3RzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdXRpbCwgaW1hZ2VVdGlsIH0gZnJvbSAnYXBwaXVtL3N1cHBvcnQnO1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuY29tbWFuZHMuZ2V0U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbnNob3QgKCkge1xuICBjb25zdCBnZXRTY3JlZW5zaG90RnJvbVdEQSA9IGFzeW5jICgpID0+IHtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgVGFraW5nIHNjcmVlbnNob3Qgd2l0aCBXREFgKTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9zY3JlZW5zaG90JywgJ0dFVCcpO1xuICAgIGlmICghXy5pc1N0cmluZyhkYXRhKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gdGFrZSBzY3JlZW5zaG90LiBXREEgcmV0dXJuZWQgJyR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICAvLyBpZiB3ZSd2ZSBzcGVjaWZpZWQgYW4gbWpwZWcgc2VydmVyLCB1c2UgdGhhdFxuICBpZiAodGhpcy5tanBlZ1N0cmVhbSkge1xuICAgIHRoaXMubG9nLmluZm8oYG1qcGVnIHZpZGVvIHN0cmVhbSBwcm92aWRlZCwgcmV0dXJuaW5nIGxhdGVzdCBmcmFtZSBhcyBzY3JlZW5zaG90YCk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMubWpwZWdTdHJlYW0ubGFzdENodW5rUE5HQmFzZTY0KCk7XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cbiAgICB0aGlzLmxvZy53YXJuKCdUcmllZCB0byBnZXQgc2NyZWVuc2hvdCBmcm9tIGFjdGl2ZSBNSlBFRyBzdHJlYW0sIGJ1dCB0aGVyZSAnICtcbiAgICAgICd3YXMgbm8gZGF0YSB5ZXQuIEZhbGxpbmcgYmFjayB0byByZWd1bGFyIHNjcmVlbnNob3QgbWV0aG9kcy4nKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IGdldFNjcmVlbnNob3RGcm9tV0RBKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRoaXMubG9nLndhcm4oYEVycm9yIGdldHRpbmcgc2NyZWVuc2hvdDogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIHNpbXVsYXRvciBhdHRlbXB0XG4gIGlmICh0aGlzLmlzU2ltdWxhdG9yKCkpIHtcbiAgICB0aGlzLmxvZy5pbmZvKGBGYWxsaW5nIGJhY2sgdG8gJ3NpbWN0bCBpbyBzY3JlZW5zaG90JyBBUElgKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5vcHRzLmRldmljZS5zaW1jdGwuZ2V0U2NyZWVuc2hvdCgpO1xuICB9XG5cbiAgLy8gUmV0cnkgZm9yIHJlYWwgZGV2aWNlcyBvbmx5LiBGYWlsIGZhc3Qgb24gU2ltdWxhdG9yIGlmIHNpbWN0bCBkb2VzIG5vdCB3b3JrIGFzIGV4cGVjdGVkXG4gIHJldHVybiBhd2FpdCByZXRyeUludGVydmFsKDIsIDEwMDAsIGdldFNjcmVlbnNob3RGcm9tV0RBKTtcbn07XG5cbmNvbW1hbmRzLmdldEVsZW1lbnRTY3JlZW5zaG90ID0gYXN5bmMgZnVuY3Rpb24gZ2V0RWxlbWVudFNjcmVlbnNob3QgKGVsKSB7XG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBjb25zdCBhdG9tc0VsZW1lbnQgPSB0aGlzLmdldEF0b21zRWxlbWVudChlbCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldEVsZW1lbnRTY3JlZW5zaG90JywgW2F0b21zRWxlbWVudF0pO1xuICB9XG5cbiAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsfS9zY3JlZW5zaG90YCwgJ0dFVCcpO1xuICBpZiAoIV8uaXNTdHJpbmcoZGF0YSkpIHtcbiAgICB0aGlzLmxvZy5lcnJvckFuZFRocm93KGBVbmFibGUgdG8gdGFrZSBhIHNjcmVlbnNob3Qgb2YgdGhlIGVsZW1lbnQgJHtlbH0uIFdEQSByZXR1cm5lZCAnJHtKU09OLnN0cmluZ2lmeShkYXRhKX0nYCk7XG4gIH1cbiAgcmV0dXJuIGRhdGE7XG59O1xuXG5jb21tYW5kcy5nZXRWaWV3cG9ydFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiBnZXRWaWV3cG9ydFNjcmVlbnNob3QgKCkge1xuICBsZXQgc3RhdHVzQmFySGVpZ2h0ID0gYXdhaXQgdGhpcy5nZXRTdGF0dXNCYXJIZWlnaHQoKTtcbiAgY29uc3Qgc2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuXG4gIC8vIGlmIHdlIGRvbid0IGhhdmUgYSBzdGF0dXMgYmFyLCB0aGVyZSdzIG5vdGhpbmcgdG8gY3JvcCwgc28gd2UgY2FuIGF2b2lkXG4gIC8vIGV4dHJhIGNhbGxzIGFuZCByZXR1cm4gc3RyYWlnaHRhd2F5XG4gIGlmIChzdGF0dXNCYXJIZWlnaHQgPT09IDApIHtcbiAgICByZXR1cm4gc2NyZWVuc2hvdDtcbiAgfVxuXG4gIGNvbnN0IHNjYWxlID0gYXdhaXQgdGhpcy5nZXREZXZpY2VQaXhlbFJhdGlvKCk7XG4gIC8vIHN0YXR1cyBiYXIgaGVpZ2h0IGNvbWVzIGluIHVuc2NhbGVkLCBzbyBzY2FsZSBpdFxuICBzdGF0dXNCYXJIZWlnaHQgPSBNYXRoLnJvdW5kKHN0YXR1c0JhckhlaWdodCAqIHNjYWxlKTtcbiAgY29uc3Qgd2luZG93U2l6ZSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuICBsZXQgcmVjdCA9IHtcbiAgICBsZWZ0OiAwLFxuICAgIHRvcDogc3RhdHVzQmFySGVpZ2h0LFxuICAgIHdpZHRoOiB3aW5kb3dTaXplLndpZHRoICogc2NhbGUsXG4gICAgaGVpZ2h0OiAoKHdpbmRvd1NpemUuaGVpZ2h0ICogc2NhbGUpIC0gc3RhdHVzQmFySGVpZ2h0KVxuICB9O1xuICBsZXQgbmV3U2NyZWVuc2hvdCA9IGF3YWl0IGltYWdlVXRpbC5jcm9wQmFzZTY0SW1hZ2Uoc2NyZWVuc2hvdCwgcmVjdCk7XG4gIHJldHVy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