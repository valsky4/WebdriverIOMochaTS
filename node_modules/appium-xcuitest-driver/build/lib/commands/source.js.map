{"version":3,"file":"source.js","names":["_xmldom","_interopRequireDefault","require","_js2xmlparser","commands","helpers","extensions","exports","APPIUM_AUT_TAG","APPIUM_SRC_XML","APPIUM_TAG_PATTERN","RegExp","getPageSource","isWebContext","script","executeAtom","settings","getSettings","useJSONSource","srcTree","mobileGetSource","format","getSourceXml","getTreeForXML","getNativePageSource","proxyCommand","test","parser","xmldom","DOMParser","tree","parseFromString","doc","documentElement","appendChild","XMLSerializer","serializeToString","opts","paramsMap","scope","excludedAttributes","excluded_attributes","query","Object","entries","map","k","v","encodeURIComponent","join","getTree","element","elementIndex","parentPath","curPath","rect","subtree","type","enabled","parseInt","isEnabled","visible","isVisible","x","y","width","height","name","label","value","i","children","length","push","jsonSource","js2xml","wrapArray","elementName","declaration","include","prettyPrinting","indentString","assign","_default","default"],"sources":["../../../lib/commands/source.js"],"sourcesContent":["import xmldom from '@xmldom/xmldom';\nimport js2xml from 'js2xmlparser2';\n\n\nlet commands = {}, helpers = {}, extensions = {};\n\nconst APPIUM_AUT_TAG = 'AppiumAUT';\nconst APPIUM_SRC_XML = `<?xml version=\"1.0\" encoding=\"UTF-8\"?><${APPIUM_AUT_TAG}/>`;\nconst APPIUM_TAG_PATTERN = new RegExp(`</?${APPIUM_AUT_TAG}/?>`);\n\n\ncommands.getPageSource = async function getPageSource () {\n  if (this.isWebContext()) {\n    const script = 'return document.documentElement.outerHTML';\n    return await this.executeAtom('execute_script', [script, []]);\n  }\n\n  if ((await this.settings.getSettings()).useJSONSource) {\n    const srcTree = await this.mobileGetSource({format: 'json'});\n    return getSourceXml(getTreeForXML(srcTree));\n  }\n  return await this.getNativePageSource();\n};\n\nhelpers.getNativePageSource = async function getNativePageSource () {\n  const srcTree = await this.proxyCommand(`/source?scope=${APPIUM_AUT_TAG}`, 'GET');\n  if (APPIUM_TAG_PATTERN.test(srcTree)) {\n    return srcTree;\n  }\n  // This might only happen if the driver is using an older/cached WDA\n  // build (e.g. below 3.16.0)\n  // TODO: remove this block after a while\n  const parser = new xmldom.DOMParser();\n  const tree = parser.parseFromString(srcTree);\n  const doc = parser.parseFromString(APPIUM_SRC_XML);\n  doc.documentElement.appendChild(tree.documentElement);\n  return new xmldom.XMLSerializer().serializeToString(doc);\n};\n\nhelpers.mobileGetSource = async function mobileGetSource (opts = {}) {\n  const paramsMap = {\n    format: opts.format || 'xml',\n    scope: APPIUM_AUT_TAG,\n  };\n  if (opts.excludedAttributes) {\n    paramsMap.excluded_attributes = opts.excludedAttributes;\n  }\n  const query = Object.entries(paramsMap)\n    .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)\n    .join('&');\n  return await this.proxyCommand(`/source?${query}`, 'GET');\n};\n\n/* Will get JSON of the form:\n *   { isEnabled: '1',\n *     isVisible: '1',\n *     frame: '{{0, 0}, {375, 667}}',\n *     children:\n *      [ { isEnabled: '1',\n *          isVisible: '1',\n *          frame: '{{0, 0}, {375, 667}}',\n *          children: [],\n *          rect: { x: 0, y: 0, width: 375, height: 667 },\n *          value: null,\n *          label: null,\n *          type: 'Other',\n *          name: null,\n *          rawIdentifier: null },\n *     rect: { origin: { x: 0, y: 0 }, size: { width: 375, height: 667 } },\n *     value: null,\n *     label: 'UICatalog',\n *     type: 'Application',\n *     name: 'UICatalog',\n *     rawIdentifier: null }\n */\nfunction getTreeForXML (srcTree) {\n  function getTree (element, elementIndex, parentPath) {\n    let curPath = `${parentPath}/${elementIndex}`;\n    let rect = element.rect || {};\n    let subtree = {\n      '@': {\n        type: `XCUIElementType${element.type}`,\n        enabled: parseInt(element.isEnabled, 10) === 1,\n        visible: parseInt(element.isVisible, 10) === 1,\n        x: rect.x,\n        y: rect.y,\n        width: rect.width,\n        height: rect.height,\n      },\n      '>': []\n    };\n    if (element.name !== null) {\n      subtree['@'].name = element.name;\n    }\n    if (element.label !== null) {\n      subtree['@'].label = element.label;\n    }\n    if (element.value !== null) {\n      subtree['@'].value = element.value;\n    }\n    for (let i = 0; i < (element.children || []).length; i++) {\n      subtree['>'].push(getTree(element.children[i], i, curPath));\n    }\n    return {\n      [`XCUIElementType${element.type}`]: subtree\n    };\n  }\n  let tree = getTree(srcTree, 0, '');\n  return tree;\n}\n\nfunction getSourceXml (jsonSource) {\n  return js2xml('AppiumAUT', jsonSource, {\n    wrapArray: {enabled: false, elementName: 'element'},\n    declaration: {include: true},\n    prettyPrinting: {indentString: '  '}\n  });\n}\n\n\nObject.assign(extensions, commands, helpers);\nexport { commands, helpers };\nexport default extensions;\n"],"mappings":"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"}