"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.IOSPerformanceLog = void 0;
require("source-map-support/register");
var _support = require("appium/support");
var _lodash = _interopRequireDefault(require("lodash"));
const log = _support.logger.getLogger('IOSPerformanceLog');
const MAX_EVENTS = 5000;
class IOSPerformanceLog {
  constructor(remoteDebugger, maxEvents = MAX_EVENTS) {
    this.remoteDebugger = remoteDebugger;
    this.maxEvents = parseInt(maxEvents, 10);
    this.timelineEvents = [];
  }
  async startCapture() {
    log.debug('Starting performance (Timeline) log capture');
    this.timelineEvents = [];
    return await this.remoteDebugger.startTimeline(this.onTimelineEvent.bind(this));
  }
  async stopCapture() {
    log.debug('Stopping performance (Timeline) log capture');
    return await this.remoteDebugger.stopTimeline();
  }
  onTimelineEvent(event) {
    log.debug(`Received Timeline event: ${_lodash.default.truncate(JSON.stringify(event))}`);
    this.timelineEvents.push(event);
    if (this.timelineEvents.length > this.maxEvents) {
      let removedEvent = this.timelineEvents.shift();
      log.warn(`Too many Timeline events, removing earliest: ${_lodash.default.truncate(JSON.stringify(removedEvent))}`);
    }
  }
  async getLogs() {
    let events = this.timelineEvents;
    log.debug('Flushing Timeline events');
    this.timelineEvents = [];
    return events;
  }
  async getAllLogs() {
    return this.getLogs();
  }
}
exports.IOSPerformanceLog = IOSPerformanceLog;
var _default = IOSPerformanceLog;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3VwcG9ydCIsInJlcXVpcmUiLCJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIk1BWF9FVkVOVFMiLCJJT1NQZXJmb3JtYW5jZUxvZyIsImNvbnN0cnVjdG9yIiwicmVtb3RlRGVidWdnZXIiLCJtYXhFdmVudHMiLCJwYXJzZUludCIsInRpbWVsaW5lRXZlbnRzIiwic3RhcnRDYXB0dXJlIiwiZGVidWciLCJzdGFydFRpbWVsaW5lIiwib25UaW1lbGluZUV2ZW50IiwiYmluZCIsInN0b3BDYXB0dXJlIiwic3RvcFRpbWVsaW5lIiwiZXZlbnQiLCJfIiwidHJ1bmNhdGUiLCJKU09OIiwic3RyaW5naWZ5IiwicHVzaCIsImxlbmd0aCIsInJlbW92ZWRFdmVudCIsInNoaWZ0Iiwid2FybiIsImdldExvZ3MiLCJldmVudHMiLCJnZXRBbGxMb2dzIiwiZXhwb3J0cyIsIl9kZWZhdWx0IiwiZGVmYXVsdCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9kZXZpY2UtbG9nL2lvcy1wZXJmb3JtYW5jZS1sb2cuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignSU9TUGVyZm9ybWFuY2VMb2cnKTtcbmNvbnN0IE1BWF9FVkVOVFMgPSA1MDAwO1xuXG5jbGFzcyBJT1NQZXJmb3JtYW5jZUxvZyB7XG4gIGNvbnN0cnVjdG9yIChyZW1vdGVEZWJ1Z2dlciwgbWF4RXZlbnRzID0gTUFYX0VWRU5UUykge1xuICAgIHRoaXMucmVtb3RlRGVidWdnZXIgPSByZW1vdGVEZWJ1Z2dlcjtcbiAgICB0aGlzLm1heEV2ZW50cyA9IHBhcnNlSW50KG1heEV2ZW50cywgMTApO1xuXG4gICAgdGhpcy50aW1lbGluZUV2ZW50cyA9IFtdO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRDYXB0dXJlICgpIHtcbiAgICBsb2cuZGVidWcoJ1N0YXJ0aW5nIHBlcmZvcm1hbmNlIChUaW1lbGluZSkgbG9nIGNhcHR1cmUnKTtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRzID0gW107XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucmVtb3RlRGVidWdnZXIuc3RhcnRUaW1lbGluZSh0aGlzLm9uVGltZWxpbmVFdmVudC5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIGFzeW5jIHN0b3BDYXB0dXJlICgpIHtcbiAgICBsb2cuZGVidWcoJ1N0b3BwaW5nIHBlcmZvcm1hbmNlIChUaW1lbGluZSkgbG9nIGNhcHR1cmUnKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5yZW1vdGVEZWJ1Z2dlci5zdG9wVGltZWxpbmUoKTtcbiAgfVxuXG4gIG9uVGltZWxpbmVFdmVudCAoZXZlbnQpIHtcbiAgICBsb2cuZGVidWcoYFJlY2VpdmVkIFRpbWVsaW5lIGV2ZW50OiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKX1gKTtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRzLnB1c2goZXZlbnQpO1xuXG4gICAgLy8gaWYgd2UgaGF2ZSB0b28gbWFueSwgZ2V0IHJpZCBvZiB0aGUgb2xkZXN0IGxvZyBsaW5lXG4gICAgaWYgKHRoaXMudGltZWxpbmVFdmVudHMubGVuZ3RoID4gdGhpcy5tYXhFdmVudHMpIHtcbiAgICAgIGxldCByZW1vdmVkRXZlbnQgPSB0aGlzLnRpbWVsaW5lRXZlbnRzLnNoaWZ0KCk7XG4gICAgICBsb2cud2FybihgVG9vIG1hbnkgVGltZWxpbmUgZXZlbnRzLCByZW1vdmluZyBlYXJsaWVzdDogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHJlbW92ZWRFdmVudCkpfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldExvZ3MgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICBsZXQgZXZlbnRzID0gdGhpcy50aW1lbGluZUV2ZW50cztcblxuICAgIC8vIGZsdXNoIGV2ZW50c1xuICAgIGxvZy5kZWJ1ZygnRmx1c2hpbmcgVGltZWxpbmUgZXZlbnRzJyk7XG4gICAgdGhpcy50aW1lbGluZUV2ZW50cyA9IFtdO1xuXG4gICAgcmV0dXJuIGV2ZW50cztcbiAgfVxuXG4gIGFzeW5jIGdldEFsbExvZ3MgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICByZXR1cm4gdGhpcy5nZXRMb2dzKCk7XG4gIH1cbn1cblxuXG5leHBvcnQgeyBJT1NQZXJmb3JtYW5jZUxvZyB9O1xuZXhwb3J0IGRlZmF1bHQgSU9TUGVyZm9ybWFuY2VMb2c7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsSUFBQUEsUUFBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsT0FBQSxHQUFBQyxzQkFBQSxDQUFBRixPQUFBO0FBRUEsTUFBTUcsR0FBRyxHQUFHQyxlQUFNLENBQUNDLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQztBQUNqRCxNQUFNQyxVQUFVLEdBQUcsSUFBSTtBQUV2QixNQUFNQyxpQkFBaUIsQ0FBQztFQUN0QkMsV0FBV0EsQ0FBRUMsY0FBYyxFQUFFQyxTQUFTLEdBQUdKLFVBQVUsRUFBRTtJQUNuRCxJQUFJLENBQUNHLGNBQWMsR0FBR0EsY0FBYztJQUNwQyxJQUFJLENBQUNDLFNBQVMsR0FBR0MsUUFBUSxDQUFDRCxTQUFTLEVBQUUsRUFBRSxDQUFDO0lBRXhDLElBQUksQ0FBQ0UsY0FBYyxHQUFHLEVBQUU7RUFDMUI7RUFFQSxNQUFNQyxZQUFZQSxDQUFBLEVBQUk7SUFDcEJWLEdBQUcsQ0FBQ1csS0FBSyxDQUFDLDZDQUE2QyxDQUFDO0lBQ3hELElBQUksQ0FBQ0YsY0FBYyxHQUFHLEVBQUU7SUFDeEIsT0FBTyxNQUFNLElBQUksQ0FBQ0gsY0FBYyxDQUFDTSxhQUFhLENBQUMsSUFBSSxDQUFDQyxlQUFlLENBQUNDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztFQUNqRjtFQUVBLE1BQU1DLFdBQVdBLENBQUEsRUFBSTtJQUNuQmYsR0FBRyxDQUFDVyxLQUFLLENBQUMsNkNBQTZDLENBQUM7SUFDeEQsT0FBTyxNQUFNLElBQUksQ0FBQ0wsY0FBYyxDQUFDVSxZQUFZLEVBQUU7RUFDakQ7RUFFQUgsZUFBZUEsQ0FBRUksS0FBSyxFQUFFO0lBQ3RCakIsR0FBRyxDQUFDVyxLQUFLLENBQUUsNEJBQTJCTyxlQUFDLENBQUNDLFFBQVEsQ0FBQ0MsSUFBSSxDQUFDQyxTQUFTLENBQUNKLEtBQUssQ0FBQyxDQUFFLEVBQUMsQ0FBQztJQUMxRSxJQUFJLENBQUNSLGNBQWMsQ0FBQ2EsSUFBSSxDQUFDTCxLQUFLLENBQUM7SUFHL0IsSUFBSSxJQUFJLENBQUNSLGNBQWMsQ0FBQ2MsTUFBTSxHQUFHLElBQUksQ0FBQ2hCLFNBQVMsRUFBRTtNQUMvQyxJQUFJaUIsWUFBWSxHQUFHLElBQUksQ0FBQ2YsY0FBYyxDQUFDZ0IsS0FBSyxFQUFFO01BQzlDekIsR0FBRyxDQUFDMEIsSUFBSSxDQUFFLGdEQUErQ1IsZUFBQyxDQUFDQyxRQUFRLENBQUNDLElBQUksQ0FBQ0MsU0FBUyxDQUFDRyxZQUFZLENBQUMsQ0FBRSxFQUFDLENBQUM7SUFDdEc7RUFDRjtFQUVBLE1BQU1HLE9BQU9BLENBQUEsRUFBSTtJQUNmLElBQUlDLE1BQU0sR0FBRyxJQUFJLENBQUNuQixjQUFjO0lBR2hDVCxHQUFHLENBQUNXLEtBQUssQ0FBQywwQkFBMEIsQ0FBQztJQUNyQyxJQUFJLENBQUNGLGNBQWMsR0FBRyxFQUFFO0lBRXhCLE9BQU9tQixNQUFNO0VBQ2Y7RUFFQSxNQUFNQyxVQUFVQSxDQUFBLEVBQUk7SUFDbEIsT0FBTyxJQUFJLENBQUNGLE9BQU8sRUFBRTtFQUN2QjtBQUNGO0FBQUNHLE9BQUEsQ0FBQTFCLGlCQUFBLEdBQUFBLGlCQUFBO0FBQUEsSUFBQTJCLFFBQUEsR0FJYzNCLGlCQUFpQjtBQUFBMEIsT0FBQSxDQUFBRSxPQUFBLEdBQUFELFFBQUEifQ==