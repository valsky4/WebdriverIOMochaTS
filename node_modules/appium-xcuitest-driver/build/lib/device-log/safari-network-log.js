"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SafariNetworkLog = void 0;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _url = _interopRequireDefault(require("url"));
var _support = require("appium/support");
var _rotatingLog = require("./rotating-log");
class SafariNetworkLog extends _rotatingLog.RotatingLog {
  constructor(showLogs) {
    super(showLogs, 'SafariNetwork');
  }
  getEntry(requestId) {
    let outputEntry;
    while (this.logs.length >= _rotatingLog.MAX_LOG_ENTRIES_COUNT) {
      const entry = this.logs.shift();
      if (entry && entry.requestId === requestId) {
        outputEntry = entry;
        this.logs.push(outputEntry);
        continue;
      }
      if (this.logIdxSinceLastRequest > 0) {
        this.logIdxSinceLastRequest--;
      }
    }
    if (!outputEntry) {
      for (let i = this.logs.length - 1; i >= 0; i--) {
        if (this.logs[i].requestId === requestId) {
          outputEntry = this.logs[i];
          this.logs.splice(i, 1);
          break;
        }
      }
      if (!outputEntry) {
        outputEntry = {
          requestId,
          logs: []
        };
      }
      this.logs.push(outputEntry);
    }
    return outputEntry;
  }
  addLogLine(method, out) {
    if (!this.isCapturing && !this.showLogs) {
      return;
    }
    if (['Network.dataReceived'].includes(method)) {
      return;
    }
    const outputEntry = this.getEntry(out.requestId);
    if (this.isCapturing) {
      outputEntry.logs = outputEntry.logs || [];
      outputEntry.logs.push(out);
    }
    if (!this.showLogs) {
      return;
    }
    if (method === 'Network.loadingFinished' || method === 'Network.loadingFailed') {
      this.printLogLine(outputEntry);
    }
  }
  getLogDetails(outputEntry) {
    const record = outputEntry.logs.reduce(function getRecord(record, entry) {
      record.requestId = entry.requestId;
      if (entry.response) {
        const url = _url.default.parse(entry.response.url);
        record.name = `${_lodash.default.last(url.pathname.split('/'))}${url.search ? `?${url.search}` : ''}` || url.host;
        record.status = entry.response.status;
        if (entry.response.timing) {
          record.time = entry.response.timing.receiveHeadersEnd || entry.response.timing.responseStart || 0;
        }
        record.source = entry.response.source;
      }
      if (entry.type) {
        record.type = entry.type;
      }
      if (entry.initiator) {
        record.initiator = entry.initiator;
      }
      if (entry.metrics) {
        record.size = entry.metrics.responseBodyBytesReceived || 0;
      }
      if (entry.errorText) {
        record.errorText = entry.errorText;
        record.cancelled = entry.canceled;
      }
      return record;
    }, {});
    return record;
  }
  printLogLine(outputEntry) {
    const {
      requestId,
      name,
      status,
      type,
      initiator = {},
      size = 0,
      time = 0,
      source,
      errorText,
      cancelled = false
    } = this.getLogDetails(outputEntry);
    this.log.debug(`Network event:`);
    this.log.debug(`  Id: ${requestId}`);
    this.log.debug(`  Name: ${name}`);
    this.log.debug(`  Status: ${status}`);
    this.log.debug(`  Type: ${type}`);
    this.log.debug(`  Initiator: ${initiator.type}`);
    for (const line of initiator.stackTrace || []) {
      const functionName = line.functionName || '(anonymous)';
      const url = !line.url || line.url === '[native code]' ? '' : `@${_lodash.default.last((_url.default.parse(line.url).pathname || '').split('/'))}:${line.lineNumber}`;
      this.log.debug(`    ${_lodash.default.padEnd(_lodash.default.truncate(functionName, {
        length: 20
      }), 21)} ${url}`);
    }
    const sizeStr = source.includes('cache') ? ` (from ${source.replace('-', ' ')})` : `${size}B`;
    this.log.debug(`  Size: ${sizeStr}`);
    this.log.debug(`  Time: ${Math.round(time)}ms`);
    if (errorText) {
      this.log.debug(`  Error: ${errorText}`);
    }
    if (_support.util.hasValue(cancelled)) {
      this.log.debug(`  Cancelled: ${cancelled}`);
    }
  }
  async getLogs() {
    const logs = await super.getLogs();
    return logs.map(function adjustEntry(entry) {
      return Object.assign({}, entry, {
        level: 'INFO',
        timestamp: Date.now(),
        message: JSON.stringify(entry)
      });
    });
  }
}
exports.SafariNetworkLog = SafariNetworkLog;
var _default = SafariNetworkLog;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfdXJsIiwiX3N1cHBvcnQiLCJfcm90YXRpbmdMb2ciLCJTYWZhcmlOZXR3b3JrTG9nIiwiUm90YXRpbmdMb2ciLCJjb25zdHJ1Y3RvciIsInNob3dMb2dzIiwiZ2V0RW50cnkiLCJyZXF1ZXN0SWQiLCJvdXRwdXRFbnRyeSIsImxvZ3MiLCJsZW5ndGgiLCJNQVhfTE9HX0VOVFJJRVNfQ09VTlQiLCJlbnRyeSIsInNoaWZ0IiwicHVzaCIsImxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QiLCJpIiwic3BsaWNlIiwiYWRkTG9nTGluZSIsIm1ldGhvZCIsIm91dCIsImlzQ2FwdHVyaW5nIiwiaW5jbHVkZXMiLCJwcmludExvZ0xpbmUiLCJnZXRMb2dEZXRhaWxzIiwicmVjb3JkIiwicmVkdWNlIiwiZ2V0UmVjb3JkIiwicmVzcG9uc2UiLCJ1cmwiLCJVUkwiLCJwYXJzZSIsIm5hbWUiLCJfIiwibGFzdCIsInBhdGhuYW1lIiwic3BsaXQiLCJzZWFyY2giLCJob3N0Iiwic3RhdHVzIiwidGltaW5nIiwidGltZSIsInJlY2VpdmVIZWFkZXJzRW5kIiwicmVzcG9uc2VTdGFydCIsInNvdXJjZSIsInR5cGUiLCJpbml0aWF0b3IiLCJtZXRyaWNzIiwic2l6ZSIsInJlc3BvbnNlQm9keUJ5dGVzUmVjZWl2ZWQiLCJlcnJvclRleHQiLCJjYW5jZWxsZWQiLCJjYW5jZWxlZCIsImxvZyIsImRlYnVnIiwibGluZSIsInN0YWNrVHJhY2UiLCJmdW5jdGlvbk5hbWUiLCJsaW5lTnVtYmVyIiwicGFkRW5kIiwidHJ1bmNhdGUiLCJzaXplU3RyIiwicmVwbGFjZSIsIk1hdGgiLCJyb3VuZCIsInV0aWwiLCJoYXNWYWx1ZSIsImdldExvZ3MiLCJtYXAiLCJhZGp1c3RFbnRyeSIsIk9iamVjdCIsImFzc2lnbiIsImxldmVsIiwidGltZXN0YW1wIiwiRGF0ZSIsIm5vdyIsIm1lc3NhZ2UiLCJKU09OIiwic3RyaW5naWZ5IiwiZXhwb3J0cyIsIl9kZWZhdWx0IiwiZGVmYXVsdCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9kZXZpY2UtbG9nL3NhZmFyaS1uZXR3b3JrLWxvZy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFVSTCBmcm9tICd1cmwnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IFJvdGF0aW5nTG9nLCBNQVhfTE9HX0VOVFJJRVNfQ09VTlQgfSBmcm9tICcuL3JvdGF0aW5nLWxvZyc7XG5cblxuY2xhc3MgU2FmYXJpTmV0d29ya0xvZyBleHRlbmRzIFJvdGF0aW5nTG9nIHtcbiAgY29uc3RydWN0b3IgKHNob3dMb2dzKSB7XG4gICAgc3VwZXIoc2hvd0xvZ3MsICdTYWZhcmlOZXR3b3JrJyk7XG4gIH1cblxuICBnZXRFbnRyeSAocmVxdWVzdElkKSB7XG4gICAgbGV0IG91dHB1dEVudHJ5O1xuICAgIHdoaWxlICh0aGlzLmxvZ3MubGVuZ3RoID49IE1BWF9MT0dfRU5UUklFU19DT1VOVCkge1xuICAgICAgLy8gcHVsbCB0aGUgZmlyc3QgZW50cnksIHdoaWNoIGlzIHRoZSBvbGRlc3RcbiAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5sb2dzLnNoaWZ0KCk7XG4gICAgICBpZiAoZW50cnkgJiYgZW50cnkucmVxdWVzdElkID09PSByZXF1ZXN0SWQpIHtcbiAgICAgICAgLy8gd2UgYXJlIGFkZGluZyB0byBhbiBleGlzdGluZyBlbnRyeSwgYW5kIGl0IHdhcyBhbG1vc3QgcmVtb3ZlZFxuICAgICAgICAvLyBhZGQgdG8gdGhlIGVuZCBvZiB0aGUgbGlzdCBhbmQgdHJ5IGFnYWluXG4gICAgICAgIG91dHB1dEVudHJ5ID0gZW50cnk7XG4gICAgICAgIHRoaXMubG9ncy5wdXNoKG91dHB1dEVudHJ5KTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyB3ZSd2ZSByZW1vdmVkIGFuIGVsZW1lbnQsIHNvIHRoZSBjb3VudCBpcyBkb3duIG9uZVxuICAgICAgaWYgKHRoaXMubG9nSWR4U2luY2VMYXN0UmVxdWVzdCA+IDApIHtcbiAgICAgICAgdGhpcy5sb2dJZHhTaW5jZUxhc3RSZXF1ZXN0LS07XG4gICAgICB9XG4gICAgfVxuXG5cbiAgICBpZiAoIW91dHB1dEVudHJ5KSB7XG4gICAgICAvLyB3ZSBkbyBub3QgeWVzIGhhdmUgYW4gZW50cnkgdG8gYXNzb2NpYXRlIHRoaXMgYml0IG9mIG91dHB1dCB3aXRoXG4gICAgICAvLyBtb3N0IGxpa2VseSB0aGUgZW50cnkgd2lsbCBiZSBhdCB0aGUgZW5kIG9mIHRoZSBsaXN0LCBzbyBzdGFydCB0aGVyZVxuICAgICAgZm9yIChsZXQgaSA9IHRoaXMubG9ncy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICBpZiAodGhpcy5sb2dzW2ldLnJlcXVlc3RJZCA9PT0gcmVxdWVzdElkKSB7XG4gICAgICAgICAgLy8gZm91bmQgaXQhXG4gICAgICAgICAgb3V0cHV0RW50cnkgPSB0aGlzLmxvZ3NbaV07XG4gICAgICAgICAgLy8gdGhpcyBpcyBub3cgdGhlIG1vc3QgY3VycmVudCBlbnRyeSwgc28gcmVtb3ZlIGl0IGZyb20gdGhlIGxpc3RcbiAgICAgICAgICAvLyB0byBiZSBhZGRlZCB0byB0aGUgZW5kIGJlbG93XG4gICAgICAgICAgdGhpcy5sb2dzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBub3RoaW5nIGhhcyBiZWVuIGZvdW5kLCBzbyBjcmVhdGUgYSBuZXcgZW50cnlcbiAgICAgIGlmICghb3V0cHV0RW50cnkpIHtcbiAgICAgICAgb3V0cHV0RW50cnkgPSB7XG4gICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgIGxvZ3M6IFtdLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBmaW5hbGx5LCBhZGQgdGhlIGVudHJ5IHRvIHRoZSBlbmQgb2YgdGhlIGxpc3RcbiAgICAgIHRoaXMubG9ncy5wdXNoKG91dHB1dEVudHJ5KTtcbiAgICB9XG5cbiAgICByZXR1cm4gb3V0cHV0RW50cnk7XG4gIH1cblxuICBhZGRMb2dMaW5lIChtZXRob2QsIG91dCkge1xuICAgIGlmICghdGhpcy5pc0NhcHR1cmluZyAmJiAhdGhpcy5zaG93TG9ncykge1xuICAgICAgLy8gbmVpdGhlciBjYXB0dXJpbmcgbm9yIGRpc3BsYXlpbmcsIHNvIGRvIG5vdGhpbmdcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoWydOZXR3b3JrLmRhdGFSZWNlaXZlZCddLmluY2x1ZGVzKG1ldGhvZCkpIHtcbiAgICAgIC8vIHN0YXR1cyB1cGRhdGUsIG5vIG5lZWQgdG8gaGFuZGxlXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gZXZlbnRzIHdlIGNhcmUgYWJvdXQ6XG4gICAgLy8gICBOZXR3b3JrLnJlcXVlc3RXaWxsQmVTZW50XG4gICAgLy8gICBOZXR3b3JrLnJlc3BvbnNlUmVjZWl2ZWRcbiAgICAvLyAgIE5ldHdvcmsubG9hZGluZ0ZpbmlzaGVkXG4gICAgLy8gICBOZXR3b3JrLmxvYWRpbmdGYWlsZWRcblxuICAgIGNvbnN0IG91dHB1dEVudHJ5ID0gdGhpcy5nZXRFbnRyeShvdXQucmVxdWVzdElkKTtcbiAgICBpZiAodGhpcy5pc0NhcHR1cmluZykge1xuICAgICAgLy8gbm93IGFkZCB0aGUgb3V0cHV0IHdlIGp1c3QgcmVjZWl2ZWQgdG8gdGhlIGxvZ3MgZm9yIHRoaXMgcGFydGljdWxhciBlbnRyeVxuICAgICAgb3V0cHV0RW50cnkubG9ncyA9IG91dHB1dEVudHJ5LmxvZ3MgfHwgW107XG5cbiAgICAgIG91dHB1dEVudHJ5LmxvZ3MucHVzaChvdXQpO1xuICAgIH1cblxuICAgIC8vIGlmIHdlIGFyZSBub3QgZGlzcGxheWluZyB0aGUgbG9ncyxcbiAgICAvLyBvciB3ZSBhcmUgbm90IGZpbmlzaGVkIGdldHRpbmcgZXZlbnRzIGZvciB0aGlzIG5ldHdvcmsgY2FsbCxcbiAgICAvLyB3ZSBhcmUgZG9uZVxuICAgIGlmICghdGhpcy5zaG93TG9ncykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChtZXRob2QgPT09ICdOZXR3b3JrLmxvYWRpbmdGaW5pc2hlZCcgfHwgbWV0aG9kID09PSAnTmV0d29yay5sb2FkaW5nRmFpbGVkJykge1xuICAgICAgdGhpcy5wcmludExvZ0xpbmUob3V0cHV0RW50cnkpO1xuICAgIH1cbiAgfVxuXG4gIGdldExvZ0RldGFpbHMgKG91dHB1dEVudHJ5KSB7XG4gICAgLy8gZXh0cmFjdCB0aGUgZGF0YVxuICAgIGNvbnN0IHJlY29yZCA9IG91dHB1dEVudHJ5LmxvZ3MucmVkdWNlKGZ1bmN0aW9uIGdldFJlY29yZCAocmVjb3JkLCBlbnRyeSkge1xuICAgICAgcmVjb3JkLnJlcXVlc3RJZCA9IGVudHJ5LnJlcXVlc3RJZDtcbiAgICAgIGlmIChlbnRyeS5yZXNwb25zZSkge1xuICAgICAgICBjb25zdCB1cmwgPSBVUkwucGFyc2UoZW50cnkucmVzcG9uc2UudXJsKTtcbiAgICAgICAgLy8gZ2V0IHRoZSBsYXN0IHBhcnQgb2YgdGhlIHVybCwgYWxvbmcgd2l0aCB0aGUgcXVlcnkgc3RyaW5nLCBpZiBwb3NzaWJsZVxuICAgICAgICByZWNvcmQubmFtZSA9IGAke18ubGFzdCh1cmwucGF0aG5hbWUuc3BsaXQoJy8nKSl9JHt1cmwuc2VhcmNoID8gYD8ke3VybC5zZWFyY2h9YCA6ICcnfWAgfHwgdXJsLmhvc3Q7XG4gICAgICAgIHJlY29yZC5zdGF0dXMgPSBlbnRyeS5yZXNwb25zZS5zdGF0dXM7XG4gICAgICAgIGlmIChlbnRyeS5yZXNwb25zZS50aW1pbmcpIHtcbiAgICAgICAgICByZWNvcmQudGltZSA9IGVudHJ5LnJlc3BvbnNlLnRpbWluZy5yZWNlaXZlSGVhZGVyc0VuZFxuICAgICAgICAgICAgfHwgZW50cnkucmVzcG9uc2UudGltaW5nLnJlc3BvbnNlU3RhcnRcbiAgICAgICAgICAgIHx8IDA7XG4gICAgICAgIH1cbiAgICAgICAgcmVjb3JkLnNvdXJjZSA9IGVudHJ5LnJlc3BvbnNlLnNvdXJjZTtcbiAgICAgIH1cbiAgICAgIGlmIChlbnRyeS50eXBlKSB7XG4gICAgICAgIHJlY29yZC50eXBlID0gZW50cnkudHlwZTtcbiAgICAgIH1cbiAgICAgIGlmIChlbnRyeS5pbml0aWF0b3IpIHtcbiAgICAgICAgcmVjb3JkLmluaXRpYXRvciA9IGVudHJ5LmluaXRpYXRvcjtcbiAgICAgIH1cbiAgICAgIGlmIChlbnRyeS5tZXRyaWNzKSB7XG4gICAgICAgIC8vIFNhZmFyaSBoYXMgYSBgbWV0cmljc2Agb2JqZWN0IG9uIGl0J3MgYE5ldHdvcmsubG9hZGluZ0ZpbmlzaGVkYCBldmVudFxuICAgICAgICByZWNvcmQuc2l6ZSA9IGVudHJ5Lm1ldHJpY3MucmVzcG9uc2VCb2R5Qnl0ZXNSZWNlaXZlZCB8fCAwO1xuICAgICAgfVxuICAgICAgaWYgKGVudHJ5LmVycm9yVGV4dCkge1xuICAgICAgICByZWNvcmQuZXJyb3JUZXh0ID0gZW50cnkuZXJyb3JUZXh0O1xuICAgICAgICAvLyBXaGVuIGEgbmV0d29yayBjYWxsIGlzIGNhbmNlbGxlZCwgU2FmYXJpIHJldHVybnMgYGNhbmNlbGxlZGAgYXMgZXJyb3IgdGV4dFxuICAgICAgICAvLyBidXQgaGFzIGEgYm9vbGVhbiBgY2FuY2VsZWRgLiBOb3JtYWxpemUgdGhlIHR3byBzcGVsbGluZ3MgaW4gZmF2b3Igb2ZcbiAgICAgICAgLy8gdGhlIHRleHQsIHdoaWNoIHdpbGwgYWxzbyBiZSBkaXNwbGF5ZWRcbiAgICAgICAgcmVjb3JkLmNhbmNlbGxlZCA9IGVudHJ5LmNhbmNlbGVkO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LCB7fSk7XG5cbiAgICByZXR1cm4gcmVjb3JkO1xuICB9XG5cbiAgcHJpbnRMb2dMaW5lIChvdXRwdXRFbnRyeSkge1xuICAgIGNvbnN0IHtcbiAgICAgIHJlcXVlc3RJZCxcbiAgICAgIG5hbWUsXG4gICAgICBzdGF0dXMsXG4gICAgICB0eXBlLFxuICAgICAgaW5pdGlhdG9yID0ge30sXG4gICAgICBzaXplID0gMCxcbiAgICAgIHRpbWUgPSAwLFxuICAgICAgc291cmNlLFxuICAgICAgZXJyb3JUZXh0LFxuICAgICAgY2FuY2VsbGVkID0gZmFsc2UsXG4gICAgfSA9IHRoaXMuZ2V0TG9nRGV0YWlscyhvdXRwdXRFbnRyeSk7XG5cbiAgICAvLyBwcmludCBvdXQgdGhlIHJlY29yZCwgZm9ybWF0dGVkIGFwcHJvcHJpYXRlbHlcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgTmV0d29yayBldmVudDpgKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBJZDogJHtyZXF1ZXN0SWR9YCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYCAgTmFtZTogJHtuYW1lfWApO1xuICAgIHRoaXMubG9nLmRlYnVnKGAgIFN0YXR1czogJHtzdGF0dXN9YCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYCAgVHlwZTogJHt0eXBlfWApO1xuICAgIHRoaXMubG9nLmRlYnVnKGAgIEluaXRpYXRvcjogJHtpbml0aWF0b3IudHlwZX1gKTtcbiAgICBmb3IgKGNvbnN0IGxpbmUgb2YgKGluaXRpYXRvci5zdGFja1RyYWNlIHx8IFtdKSkge1xuICAgICAgY29uc3QgZnVuY3Rpb25OYW1lID0gbGluZS5mdW5jdGlvbk5hbWUgfHwgJyhhbm9ueW1vdXMpJztcblxuICAgICAgY29uc3QgdXJsID0gKCFsaW5lLnVybCB8fCBsaW5lLnVybCA9PT0gJ1tuYXRpdmUgY29kZV0nKVxuICAgICAgICA/ICcnXG4gICAgICAgIDogYEAke18ubGFzdCgoVVJMLnBhcnNlKGxpbmUudXJsKS5wYXRobmFtZSB8fCAnJykuc3BsaXQoJy8nKSl9OiR7bGluZS5saW5lTnVtYmVyfWA7XG4gICAgICB0aGlzLmxvZy5kZWJ1ZyhgICAgICR7Xy5wYWRFbmQoXy50cnVuY2F0ZShmdW5jdGlvbk5hbWUsIHtsZW5ndGg6IDIwfSksIDIxKX0gJHt1cmx9YCk7XG4gICAgfVxuICAgIC8vIGdldCBgbWVtb3J5LWNhY2hlYCBvciBgZGlzay1jYWNoZWAsIGV0Yy4sIHJpZ2h0XG4gICAgY29uc3Qgc2l6ZVN0ciA9IHNvdXJjZS5pbmNsdWRlcygnY2FjaGUnKSA/IGAgKGZyb20gJHtzb3VyY2UucmVwbGFjZSgnLScsICcgJyl9KWAgOiBgJHtzaXplfUJgO1xuICAgIHRoaXMubG9nLmRlYnVnKGAgIFNpemU6ICR7c2l6ZVN0cn1gKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBUaW1lOiAke01hdGgucm91bmQodGltZSl9bXNgKTtcbiAgICBpZiAoZXJyb3JUZXh0KSB7XG4gICAgICB0aGlzLmxvZy5kZWJ1ZyhgICBFcnJvcjogJHtlcnJvclRleHR9YCk7XG4gICAgfVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKGNhbmNlbGxlZCkpIHtcbiAgICAgIHRoaXMubG9nLmRlYnVnKGAgIENhbmNlbGxlZDogJHtjYW5jZWxsZWR9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0TG9ncyAoKSB7XG4gICAgY29uc3QgbG9ncyA9IGF3YWl0IHN1cGVyLmdldExvZ3MoKTtcbiAgICAvLyBpbiBvcmRlciB0byBzYXRpc2Z5IGNlcnRhaW4gY2xpZW50cywgd2UgbmVlZCB0byBoYXZlIGEgYmFzaWMgc3RydWN0dXJlXG4gICAgLy8gdG8gdGhlIHJlc3VsdHMsIHdpdGggYGxldmVsYCwgYHRpbWVzdGFtcGAsIGFuZCBgbWVzc2FnZWAsIHdoaWNoIGlzXG4gICAgLy8gYWxsIHRoZSBpbmZvcm1hdGlvbiBzdHJpbmdpZmllZFxuICAgIHJldHVybiBsb2dzLm1hcChmdW5jdGlvbiBhZGp1c3RFbnRyeSAoZW50cnkpIHtcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBlbnRyeSwge1xuICAgICAgICBsZXZlbDogJ0lORk8nLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KGVudHJ5KSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCB7IFNhZmFyaU5ldHdvcmtMb2cgfTtcbmV4cG9ydCBkZWZhdWx0IFNhZmFyaU5ldHdvcmtMb2c7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsSUFBQUEsT0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsSUFBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUUsUUFBQSxHQUFBRixPQUFBO0FBQ0EsSUFBQUcsWUFBQSxHQUFBSCxPQUFBO0FBR0EsTUFBTUksZ0JBQWdCLFNBQVNDLHdCQUFXLENBQUM7RUFDekNDLFdBQVdBLENBQUVDLFFBQVEsRUFBRTtJQUNyQixLQUFLLENBQUNBLFFBQVEsRUFBRSxlQUFlLENBQUM7RUFDbEM7RUFFQUMsUUFBUUEsQ0FBRUMsU0FBUyxFQUFFO0lBQ25CLElBQUlDLFdBQVc7SUFDZixPQUFPLElBQUksQ0FBQ0MsSUFBSSxDQUFDQyxNQUFNLElBQUlDLGtDQUFxQixFQUFFO01BRWhELE1BQU1DLEtBQUssR0FBRyxJQUFJLENBQUNILElBQUksQ0FBQ0ksS0FBSyxFQUFFO01BQy9CLElBQUlELEtBQUssSUFBSUEsS0FBSyxDQUFDTCxTQUFTLEtBQUtBLFNBQVMsRUFBRTtRQUcxQ0MsV0FBVyxHQUFHSSxLQUFLO1FBQ25CLElBQUksQ0FBQ0gsSUFBSSxDQUFDSyxJQUFJLENBQUNOLFdBQVcsQ0FBQztRQUMzQjtNQUNGO01BRUEsSUFBSSxJQUFJLENBQUNPLHNCQUFzQixHQUFHLENBQUMsRUFBRTtRQUNuQyxJQUFJLENBQUNBLHNCQUFzQixFQUFFO01BQy9CO0lBQ0Y7SUFHQSxJQUFJLENBQUNQLFdBQVcsRUFBRTtNQUdoQixLQUFLLElBQUlRLENBQUMsR0FBRyxJQUFJLENBQUNQLElBQUksQ0FBQ0MsTUFBTSxHQUFHLENBQUMsRUFBRU0sQ0FBQyxJQUFJLENBQUMsRUFBRUEsQ0FBQyxFQUFFLEVBQUU7UUFDOUMsSUFBSSxJQUFJLENBQUNQLElBQUksQ0FBQ08sQ0FBQyxDQUFDLENBQUNULFNBQVMsS0FBS0EsU0FBUyxFQUFFO1VBRXhDQyxXQUFXLEdBQUcsSUFBSSxDQUFDQyxJQUFJLENBQUNPLENBQUMsQ0FBQztVQUcxQixJQUFJLENBQUNQLElBQUksQ0FBQ1EsTUFBTSxDQUFDRCxDQUFDLEVBQUUsQ0FBQyxDQUFDO1VBQ3RCO1FBQ0Y7TUFDRjtNQUdBLElBQUksQ0FBQ1IsV0FBVyxFQUFFO1FBQ2hCQSxXQUFXLEdBQUc7VUFDWkQsU0FBUztVQUNURSxJQUFJLEVBQUU7UUFDUixDQUFDO01BQ0g7TUFHQSxJQUFJLENBQUNBLElBQUksQ0FBQ0ssSUFBSSxDQUFDTixXQUFXLENBQUM7SUFDN0I7SUFFQSxPQUFPQSxXQUFXO0VBQ3BCO0VBRUFVLFVBQVVBLENBQUVDLE1BQU0sRUFBRUMsR0FBRyxFQUFFO0lBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUNDLFdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQ2hCLFFBQVEsRUFBRTtNQUV2QztJQUNGO0lBRUEsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUNpQixRQUFRLENBQUNILE1BQU0sQ0FBQyxFQUFFO01BRTdDO0lBQ0Y7SUFRQSxNQUFNWCxXQUFXLEdBQUcsSUFBSSxDQUFDRixRQUFRLENBQUNjLEdBQUcsQ0FBQ2IsU0FBUyxDQUFDO0lBQ2hELElBQUksSUFBSSxDQUFDYyxXQUFXLEVBQUU7TUFFcEJiLFdBQVcsQ0FBQ0MsSUFBSSxHQUFHRCxXQUFXLENBQUNDLElBQUksSUFBSSxFQUFFO01BRXpDRCxXQUFXLENBQUNDLElBQUksQ0FBQ0ssSUFBSSxDQUFDTSxHQUFHLENBQUM7SUFDNUI7SUFLQSxJQUFJLENBQUMsSUFBSSxDQUFDZixRQUFRLEVBQUU7TUFDbEI7SUFDRjtJQUVBLElBQUljLE1BQU0sS0FBSyx5QkFBeUIsSUFBSUEsTUFBTSxLQUFLLHVCQUF1QixFQUFFO01BQzlFLElBQUksQ0FBQ0ksWUFBWSxDQUFDZixXQUFXLENBQUM7SUFDaEM7RUFDRjtFQUVBZ0IsYUFBYUEsQ0FBRWhCLFdBQVcsRUFBRTtJQUUxQixNQUFNaUIsTUFBTSxHQUFHakIsV0FBVyxDQUFDQyxJQUFJLENBQUNpQixNQUFNLENBQUMsU0FBU0MsU0FBU0EsQ0FBRUYsTUFBTSxFQUFFYixLQUFLLEVBQUU7TUFDeEVhLE1BQU0sQ0FBQ2xCLFNBQVMsR0FBR0ssS0FBSyxDQUFDTCxTQUFTO01BQ2xDLElBQUlLLEtBQUssQ0FBQ2dCLFFBQVEsRUFBRTtRQUNsQixNQUFNQyxHQUFHLEdBQUdDLFlBQUcsQ0FBQ0MsS0FBSyxDQUFDbkIsS0FBSyxDQUFDZ0IsUUFBUSxDQUFDQyxHQUFHLENBQUM7UUFFekNKLE1BQU0sQ0FBQ08sSUFBSSxHQUFJLEdBQUVDLGVBQUMsQ0FBQ0MsSUFBSSxDQUFDTCxHQUFHLENBQUNNLFFBQVEsQ0FBQ0MsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFFLEdBQUVQLEdBQUcsQ0FBQ1EsTUFBTSxHQUFJLElBQUdSLEdBQUcsQ0FBQ1EsTUFBTyxFQUFDLEdBQUcsRUFBRyxFQUFDLElBQUlSLEdBQUcsQ0FBQ1MsSUFBSTtRQUNuR2IsTUFBTSxDQUFDYyxNQUFNLEdBQUczQixLQUFLLENBQUNnQixRQUFRLENBQUNXLE1BQU07UUFDckMsSUFBSTNCLEtBQUssQ0FBQ2dCLFFBQVEsQ0FBQ1ksTUFBTSxFQUFFO1VBQ3pCZixNQUFNLENBQUNnQixJQUFJLEdBQUc3QixLQUFLLENBQUNnQixRQUFRLENBQUNZLE1BQU0sQ0FBQ0UsaUJBQWlCLElBQ2hEOUIsS0FBSyxDQUFDZ0IsUUFBUSxDQUFDWSxNQUFNLENBQUNHLGFBQWEsSUFDbkMsQ0FBQztRQUNSO1FBQ0FsQixNQUFNLENBQUNtQixNQUFNLEdBQUdoQyxLQUFLLENBQUNnQixRQUFRLENBQUNnQixNQUFNO01BQ3ZDO01BQ0EsSUFBSWhDLEtBQUssQ0FBQ2lDLElBQUksRUFBRTtRQUNkcEIsTUFBTSxDQUFDb0IsSUFBSSxHQUFHakMsS0FBSyxDQUFDaUMsSUFBSTtNQUMxQjtNQUNBLElBQUlqQyxLQUFLLENBQUNrQyxTQUFTLEVBQUU7UUFDbkJyQixNQUFNLENBQUNxQixTQUFTLEdBQUdsQyxLQUFLLENBQUNrQyxTQUFTO01BQ3BDO01BQ0EsSUFBSWxDLEtBQUssQ0FBQ21DLE9BQU8sRUFBRTtRQUVqQnRCLE1BQU0sQ0FBQ3VCLElBQUksR0FBR3BDLEtBQUssQ0FBQ21DLE9BQU8sQ0FBQ0UseUJBQXlCLElBQUksQ0FBQztNQUM1RDtNQUNBLElBQUlyQyxLQUFLLENBQUNzQyxTQUFTLEVBQUU7UUFDbkJ6QixNQUFNLENBQUN5QixTQUFTLEdBQUd0QyxLQUFLLENBQUNzQyxTQUFTO1FBSWxDekIsTUFBTSxDQUFDMEIsU0FBUyxHQUFHdkMsS0FBSyxDQUFDd0MsUUFBUTtNQUNuQztNQUNBLE9BQU8zQixNQUFNO0lBQ2YsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRU4sT0FBT0EsTUFBTTtFQUNmO0VBRUFGLFlBQVlBLENBQUVmLFdBQVcsRUFBRTtJQUN6QixNQUFNO01BQ0pELFNBQVM7TUFDVHlCLElBQUk7TUFDSk8sTUFBTTtNQUNOTSxJQUFJO01BQ0pDLFNBQVMsR0FBRyxDQUFDLENBQUM7TUFDZEUsSUFBSSxHQUFHLENBQUM7TUFDUlAsSUFBSSxHQUFHLENBQUM7TUFDUkcsTUFBTTtNQUNOTSxTQUFTO01BQ1RDLFNBQVMsR0FBRztJQUNkLENBQUMsR0FBRyxJQUFJLENBQUMzQixhQUFhLENBQUNoQixXQUFXLENBQUM7SUFHbkMsSUFBSSxDQUFDNkMsR0FBRyxDQUFDQyxLQUFLLENBQUUsZ0JBQWUsQ0FBQztJQUNoQyxJQUFJLENBQUNELEdBQUcsQ0FBQ0MsS0FBSyxDQUFFLFNBQVEvQyxTQUFVLEVBQUMsQ0FBQztJQUNwQyxJQUFJLENBQUM4QyxHQUFHLENBQUNDLEtBQUssQ0FBRSxXQUFVdEIsSUFBSyxFQUFDLENBQUM7SUFDakMsSUFBSSxDQUFDcUIsR0FBRyxDQUFDQyxLQUFLLENBQUUsYUFBWWYsTUFBTyxFQUFDLENBQUM7SUFDckMsSUFBSSxDQUFDYyxHQUFHLENBQUNDLEtBQUssQ0FBRSxXQUFVVCxJQUFLLEVBQUMsQ0FBQztJQUNqQyxJQUFJLENBQUNRLEdBQUcsQ0FBQ0MsS0FBSyxDQUFFLGdCQUFlUixTQUFTLENBQUNELElBQUssRUFBQyxDQUFDO0lBQ2hELEtBQUssTUFBTVUsSUFBSSxJQUFLVCxTQUFTLENBQUNVLFVBQVUsSUFBSSxFQUFFLEVBQUc7TUFDL0MsTUFBTUMsWUFBWSxHQUFHRixJQUFJLENBQUNFLFlBQVksSUFBSSxhQUFhO01BRXZELE1BQU01QixHQUFHLEdBQUksQ0FBQzBCLElBQUksQ0FBQzFCLEdBQUcsSUFBSTBCLElBQUksQ0FBQzFCLEdBQUcsS0FBSyxlQUFlLEdBQ2xELEVBQUUsR0FDRCxJQUFHSSxlQUFDLENBQUNDLElBQUksQ0FBQyxDQUFDSixZQUFHLENBQUNDLEtBQUssQ0FBQ3dCLElBQUksQ0FBQzFCLEdBQUcsQ0FBQyxDQUFDTSxRQUFRLElBQUksRUFBRSxFQUFFQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUUsSUFBR21CLElBQUksQ0FBQ0csVUFBVyxFQUFDO01BQ3BGLElBQUksQ0FBQ0wsR0FBRyxDQUFDQyxLQUFLLENBQUUsT0FBTXJCLGVBQUMsQ0FBQzBCLE1BQU0sQ0FBQzFCLGVBQUMsQ0FBQzJCLFFBQVEsQ0FBQ0gsWUFBWSxFQUFFO1FBQUMvQyxNQUFNLEVBQUU7TUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUUsSUFBR21CLEdBQUksRUFBQyxDQUFDO0lBQ3RGO0lBRUEsTUFBTWdDLE9BQU8sR0FBR2pCLE1BQU0sQ0FBQ3RCLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBSSxVQUFTc0IsTUFBTSxDQUFDa0IsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUUsR0FBRSxHQUFJLEdBQUVkLElBQUssR0FBRTtJQUM3RixJQUFJLENBQUNLLEdBQUcsQ0FBQ0MsS0FBSyxDQUFFLFdBQVVPLE9BQVEsRUFBQyxDQUFDO0lBQ3BDLElBQUksQ0FBQ1IsR0FBRyxDQUFDQyxLQUFLLENBQUUsV0FBVVMsSUFBSSxDQUFDQyxLQUFLLENBQUN2QixJQUFJLENBQUUsSUFBRyxDQUFDO0lBQy9DLElBQUlTLFNBQVMsRUFBRTtNQUNiLElBQUksQ0FBQ0csR0FBRyxDQUFDQyxLQUFLLENBQUUsWUFBV0osU0FBVSxFQUFDLENBQUM7SUFDekM7SUFDQSxJQUFJZSxhQUFJLENBQUNDLFFBQVEsQ0FBQ2YsU0FBUyxDQUFDLEVBQUU7TUFDNUIsSUFBSSxDQUFDRSxHQUFHLENBQUNDLEtBQUssQ0FBRSxnQkFBZUgsU0FBVSxFQUFDLENBQUM7SUFDN0M7RUFDRjtFQUVBLE1BQU1nQixPQUFPQSxDQUFBLEVBQUk7SUFDZixNQUFNMUQsSUFBSSxHQUFHLE1BQU0sS0FBSyxDQUFDMEQsT0FBTyxFQUFFO0lBSWxDLE9BQU8xRCxJQUFJLENBQUMyRCxHQUFHLENBQUMsU0FBU0MsV0FBV0EsQ0FBRXpELEtBQUssRUFBRTtNQUMzQyxPQUFPMEQsTUFBTSxDQUFDQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUzRCxLQUFLLEVBQUU7UUFDOUI0RCxLQUFLLEVBQUUsTUFBTTtRQUNiQyxTQUFTLEVBQUVDLElBQUksQ0FBQ0MsR0FBRyxFQUFFO1FBQ3JCQyxPQUFPLEVBQUVDLElBQUksQ0FBQ0MsU0FBUyxDQUFDbEUsS0FBSztNQUMvQixDQUFDLENBQUM7SUFDSixDQUFDLENBQUM7RUFDSjtBQUNGO0FBQUNtRSxPQUFBLENBQUE3RSxnQkFBQSxHQUFBQSxnQkFBQTtBQUFBLElBQUE4RSxRQUFBLEdBR2M5RSxnQkFBZ0I7QUFBQTZFLE9BQUEsQ0FBQUUsT0FBQSxHQUFBRCxRQUFBIn0=