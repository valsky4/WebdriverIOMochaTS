"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _support = require("appium/support");
var _path = _interopRequireDefault(require("path"));
var _appiumIosDevice = require("appium-ios-device");
var _bluebird = _interopRequireDefault(require("bluebird"));
var _logger = _interopRequireDefault(require("./logger"));
var _lodash = _interopRequireDefault(require("lodash"));
var _teen_process = require("teen_process");
var _appUtils = require("./app-utils");
var _iosFsHelpers = require("./ios-fs-helpers");
const APPLICATION_INSTALLED_NOTIFICATION = 'com.apple.mobile.application_installed';
const INSTALLATION_STAGING_DIR = 'PublicStaging';
const APPLICATION_NOTIFICATION_TIMEOUT_MS = 30 * 1000;
const IOS_DEPLOY_TIMEOUT_MS = 4 * 60 * 1000;
const IOS_DEPLOY = 'ios-deploy';
const APP_INSTALL_STRATEGY = Object.freeze({
  SERIAL: 'serial',
  PARALLEL: 'parallel',
  IOS_DEPLOY
});
class IOSDeploy {
  constructor(udid) {
    this.udid = udid;
  }
  async remove(bundleId) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    try {
      await service.uninstallApplication(bundleId);
    } finally {
      service.close();
    }
  }
  async removeApp(bundleId) {
    await this.remove(bundleId);
  }
  async install(app, timeout, strategy = null) {
    if (strategy && !_lodash.default.values(APP_INSTALL_STRATEGY).includes(_lodash.default.toLower(strategy))) {
      throw new Error(`App installation strategy '${strategy}' is unknown. ` + `Only the following strategies are supported: ${_lodash.default.values(APP_INSTALL_STRATEGY)}`);
    }
    _logger.default.debug(`Using '${strategy ?? APP_INSTALL_STRATEGY.SERIAL}' app deployment strategy. ` + `You could change it by providing another value to the 'appInstallStrategy' capability`);
    const installWithIosDeploy = async () => {
      try {
        await _support.fs.which(IOS_DEPLOY);
      } catch (err) {
        throw new Error(`'${IOS_DEPLOY}' utility has not been found in PATH. Is it installed?`);
      }
      try {
        await (0, _teen_process.exec)(IOS_DEPLOY, ['--id', this.udid, '--bundle', app], {
          timeout: timeout ?? IOS_DEPLOY_TIMEOUT_MS
        });
      } catch (err) {
        throw new Error(err.stderr || err.stdout || err.message);
      }
    };
    const timer = new _support.timing.Timer().start();
    if (_lodash.default.toLower(strategy) === APP_INSTALL_STRATEGY.IOS_DEPLOY) {
      await installWithIosDeploy();
    } else {
      const afcService = await _appiumIosDevice.services.startAfcService(this.udid);
      try {
        const bundleId = await (0, _appUtils.extractBundleId)(app);
        const bundlePathOnPhone = _path.default.join(INSTALLATION_STAGING_DIR, bundleId);
        await (0, _iosFsHelpers.pushFolder)(afcService, app, bundlePathOnPhone, {
          timeoutMs: timeout,
          enableParallelPush: _lodash.default.toLower(strategy) === APP_INSTALL_STRATEGY.PARALLEL
        });
        await this.installOrUpgradeApplication(bundlePathOnPhone, await this.isAppInstalled(bundleId));
      } catch (err) {
        _logger.default.warn(`Error installing app '${app}': ${err.message}`);
        if (err instanceof _bluebird.default.TimeoutError) {
          _logger.default.warn(`Consider increasing the value of 'appPushTimeout' capability`);
        }
        _logger.default.warn(`Falling back to '${IOS_DEPLOY}' usage`);
        try {
          await installWithIosDeploy();
        } catch (err1) {
          throw new Error(`Could not install '${app}':\n` + `  - ${err.message}\n` + `  - ${err1.message}`);
        }
      } finally {
        afcService.close();
      }
    }
    _logger.default.info(`App installation succeeded after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
  }
  async installOrUpgradeApplication(bundlePathOnPhone, isUpgrade = false) {
    const notificationService = await _appiumIosDevice.services.startNotificationProxyService(this.udid);
    const installationService = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    const appInstalledNotification = new _bluebird.default(resolve => {
      notificationService.observeNotification(APPLICATION_INSTALLED_NOTIFICATION, {
        notification: resolve
      });
    });
    const clientOptions = {
      PackageType: 'Developer'
    };
    try {
      if (isUpgrade) {
        _logger.default.debug(`An upgrade of the existing application is going to be performed`);
        await installationService.upgradeApplication(bundlePathOnPhone, clientOptions);
      } else {
        _logger.default.debug(`A new application installation is going to be performed`);
        await installationService.installApplication(bundlePathOnPhone, clientOptions);
      }
      try {
        await appInstalledNotification.timeout(APPLICATION_NOTIFICATION_TIMEOUT_MS, `Could not get the application installed notification within ` + `${APPLICATION_NOTIFICATION_TIMEOUT_MS}ms but we will continue`);
      } catch (e) {
        _logger.default.warn(`Failed to receive the notification. Error: ${e.message}`);
      }
    } finally {
      installationService.close();
      notificationService.close();
    }
  }
  async installApp(...args) {
    return await this.install(...args);
  }
  async isAppInstalled(bundleId) {
    return Boolean(await this.fetchAppInfo(bundleId));
  }
  async fetchAppInfo(bundleId) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    try {
      return (await service.lookupApplications({
        bundleIds: bundleId
      }))[bundleId];
    } finally {
      service.close();
    }
  }
  async terminateApp(bundleId) {
    let instrumentService;
    let installProxyService;
    try {
      installProxyService = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
      const apps = await installProxyService.listApplications();
      if (!apps[bundleId]) {
        _logger.default.info(`The bundle id '${bundleId}' did not exist`);
        return false;
      }
      const executableName = apps[bundleId].CFBundleExecutable;
      _logger.default.debug(`The executable name for the bundle id '${bundleId}' was '${executableName}'`);
      instrumentService = await _appiumIosDevice.services.startInstrumentService(this.udid);
      const processes = await instrumentService.callChannel(_appiumIosDevice.INSTRUMENT_CHANNEL.DEVICE_INFO, 'runningProcesses');
      const process = processes.selector.find(process => process.name === executableName);
      if (!process) {
        _logger.default.info(`The process of the bundle id '${bundleId}' was not running`);
        return false;
      }
      await instrumentService.callChannel(_appiumIosDevice.INSTRUMENT_CHANNEL.PROCESS_CONTROL, 'killPid:', `${process.pid}`);
      return true;
    } catch (err) {
      _logger.default.warn(`Failed to kill '${bundleId}'. Original error: ${err.stderr || err.message}`);
      return false;
    } finally {
      if (installProxyService) {
        installProxyService.close();
      }
      if (instrumentService) {
        instrumentService.close();
      }
    }
  }
  async getUserInstalledBundleIdsByBundleName(bundleName) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    try {
      const applications = await service.listApplications({
        applicationType: 'User'
      });
      return _lodash.default.reduce(applications, (acc, {
        CFBundleName
      }, key) => {
        if (CFBundleName === bundleName) {
          acc.push(key);
        }
        return acc;
      }, []);
    } finally {
      service.close();
    }
  }
  async getPlatformVersion() {
    return await _appiumIosDevice.utilities.getOSVersion(this.udid);
  }
}
var _default = IOSDeploy;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3VwcG9ydCIsInJlcXVpcmUiLCJfcGF0aCIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJfYXBwaXVtSW9zRGV2aWNlIiwiX2JsdWViaXJkIiwiX2xvZ2dlciIsIl9sb2Rhc2giLCJfdGVlbl9wcm9jZXNzIiwiX2FwcFV0aWxzIiwiX2lvc0ZzSGVscGVycyIsIkFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04iLCJJTlNUQUxMQVRJT05fU1RBR0lOR19ESVIiLCJBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVF9NUyIsIklPU19ERVBMT1lfVElNRU9VVF9NUyIsIklPU19ERVBMT1kiLCJBUFBfSU5TVEFMTF9TVFJBVEVHWSIsIk9iamVjdCIsImZyZWV6ZSIsIlNFUklBTCIsIlBBUkFMTEVMIiwiSU9TRGVwbG95IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwicmVtb3ZlIiwiYnVuZGxlSWQiLCJzZXJ2aWNlIiwic2VydmljZXMiLCJzdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSIsInVuaW5zdGFsbEFwcGxpY2F0aW9uIiwiY2xvc2UiLCJyZW1vdmVBcHAiLCJpbnN0YWxsIiwiYXBwIiwidGltZW91dCIsInN0cmF0ZWd5IiwiXyIsInZhbHVlcyIsImluY2x1ZGVzIiwidG9Mb3dlciIsIkVycm9yIiwibG9nIiwiZGVidWciLCJpbnN0YWxsV2l0aElvc0RlcGxveSIsImZzIiwid2hpY2giLCJlcnIiLCJleGVjIiwic3RkZXJyIiwic3Rkb3V0IiwibWVzc2FnZSIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsImFmY1NlcnZpY2UiLCJzdGFydEFmY1NlcnZpY2UiLCJleHRyYWN0QnVuZGxlSWQiLCJidW5kbGVQYXRoT25QaG9uZSIsInBhdGgiLCJqb2luIiwicHVzaEZvbGRlciIsInRpbWVvdXRNcyIsImVuYWJsZVBhcmFsbGVsUHVzaCIsImluc3RhbGxPclVwZ3JhZGVBcHBsaWNhdGlvbiIsImlzQXBwSW5zdGFsbGVkIiwid2FybiIsIkIiLCJUaW1lb3V0RXJyb3IiLCJlcnIxIiwiaW5mbyIsImdldER1cmF0aW9uIiwiYXNNaWxsaVNlY29uZHMiLCJ0b0ZpeGVkIiwiaXNVcGdyYWRlIiwibm90aWZpY2F0aW9uU2VydmljZSIsInN0YXJ0Tm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlIiwiaW5zdGFsbGF0aW9uU2VydmljZSIsImFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbiIsInJlc29sdmUiLCJvYnNlcnZlTm90aWZpY2F0aW9uIiwibm90aWZpY2F0aW9uIiwiY2xpZW50T3B0aW9ucyIsIlBhY2thZ2VUeXBlIiwidXBncmFkZUFwcGxpY2F0aW9uIiwiaW5zdGFsbEFwcGxpY2F0aW9uIiwiZSIsImluc3RhbGxBcHAiLCJhcmdzIiwiQm9vbGVhbiIsImZldGNoQXBwSW5mbyIsImxvb2t1cEFwcGxpY2F0aW9ucyIsImJ1bmRsZUlkcyIsInRlcm1pbmF0ZUFwcCIsImluc3RydW1lbnRTZXJ2aWNlIiwiaW5zdGFsbFByb3h5U2VydmljZSIsImFwcHMiLCJsaXN0QXBwbGljYXRpb25zIiwiZXhlY3V0YWJsZU5hbWUiLCJDRkJ1bmRsZUV4ZWN1dGFibGUiLCJzdGFydEluc3RydW1lbnRTZXJ2aWNlIiwicHJvY2Vzc2VzIiwiY2FsbENoYW5uZWwiLCJJTlNUUlVNRU5UX0NIQU5ORUwiLCJERVZJQ0VfSU5GTyIsInByb2Nlc3MiLCJzZWxlY3RvciIsImZpbmQiLCJuYW1lIiwiUFJPQ0VTU19DT05UUk9MIiwicGlkIiwiZ2V0VXNlckluc3RhbGxlZEJ1bmRsZUlkc0J5QnVuZGxlTmFtZSIsImJ1bmRsZU5hbWUiLCJhcHBsaWNhdGlvbnMiLCJhcHBsaWNhdGlvblR5cGUiLCJyZWR1Y2UiLCJhY2MiLCJDRkJ1bmRsZU5hbWUiLCJrZXkiLCJwdXNoIiwiZ2V0UGxhdGZvcm1WZXJzaW9uIiwidXRpbGl0aWVzIiwiZ2V0T1NWZXJzaW9uIiwiX2RlZmF1bHQiLCJleHBvcnRzIiwiZGVmYXVsdCJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9pb3MtZGVwbG95LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzLCB0aW1pbmcgfSBmcm9tICdhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHNlcnZpY2VzLCB1dGlsaXRpZXMsIElOU1RSVU1FTlRfQ0hBTk5FTCB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZXh0cmFjdEJ1bmRsZUlkIH0gZnJvbSAnLi9hcHAtdXRpbHMnO1xuaW1wb3J0IHsgcHVzaEZvbGRlciB9IGZyb20gJy4vaW9zLWZzLWhlbHBlcnMnO1xuXG5jb25zdCBBUFBMSUNBVElPTl9JTlNUQUxMRURfTk9USUZJQ0FUSU9OID0gJ2NvbS5hcHBsZS5tb2JpbGUuYXBwbGljYXRpb25faW5zdGFsbGVkJztcbmNvbnN0IElOU1RBTExBVElPTl9TVEFHSU5HX0RJUiA9ICdQdWJsaWNTdGFnaW5nJztcbmNvbnN0IEFQUExJQ0FUSU9OX05PVElGSUNBVElPTl9USU1FT1VUX01TID0gMzAgKiAxMDAwO1xuY29uc3QgSU9TX0RFUExPWV9USU1FT1VUX01TID0gNCAqIDYwICogMTAwMDtcbmNvbnN0IElPU19ERVBMT1kgPSAnaW9zLWRlcGxveSc7XG5jb25zdCBBUFBfSU5TVEFMTF9TVFJBVEVHWSA9IE9iamVjdC5mcmVlemUoe1xuICBTRVJJQUw6ICdzZXJpYWwnLFxuICBQQVJBTExFTDogJ3BhcmFsbGVsJyxcbiAgSU9TX0RFUExPWSxcbn0pO1xuXG5cbmNsYXNzIElPU0RlcGxveSB7XG5cbiAgY29uc3RydWN0b3IgKHVkaWQpIHtcbiAgICB0aGlzLnVkaWQgPSB1ZGlkO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlIChidW5kbGVJZCkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBzZXJ2aWNlLnVuaW5zdGFsbEFwcGxpY2F0aW9uKGJ1bmRsZUlkKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgc2VydmljZS5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUFwcCAoYnVuZGxlSWQpIHtcbiAgICBhd2FpdCB0aGlzLnJlbW92ZShidW5kbGVJZCk7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsIChhcHAsIHRpbWVvdXQsIHN0cmF0ZWd5ID0gbnVsbCkge1xuICAgIGlmIChzdHJhdGVneSAmJiAhXy52YWx1ZXMoQVBQX0lOU1RBTExfU1RSQVRFR1kpLmluY2x1ZGVzKF8udG9Mb3dlcihzdHJhdGVneSkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEFwcCBpbnN0YWxsYXRpb24gc3RyYXRlZ3kgJyR7c3RyYXRlZ3l9JyBpcyB1bmtub3duLiBgICtcbiAgICAgICAgYE9ubHkgdGhlIGZvbGxvd2luZyBzdHJhdGVnaWVzIGFyZSBzdXBwb3J0ZWQ6ICR7Xy52YWx1ZXMoQVBQX0lOU1RBTExfU1RSQVRFR1kpfWApO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFVzaW5nICcke3N0cmF0ZWd5ID8/IEFQUF9JTlNUQUxMX1NUUkFURUdZLlNFUklBTH0nIGFwcCBkZXBsb3ltZW50IHN0cmF0ZWd5LiBgICtcbiAgICAgIGBZb3UgY291bGQgY2hhbmdlIGl0IGJ5IHByb3ZpZGluZyBhbm90aGVyIHZhbHVlIHRvIHRoZSAnYXBwSW5zdGFsbFN0cmF0ZWd5JyBjYXBhYmlsaXR5YCk7XG5cbiAgICBjb25zdCBpbnN0YWxsV2l0aElvc0RlcGxveSA9IGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLndoaWNoKElPU19ERVBMT1kpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJyR7SU9TX0RFUExPWX0nIHV0aWxpdHkgaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIElzIGl0IGluc3RhbGxlZD9gKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGV4ZWMoSU9TX0RFUExPWSwgW1xuICAgICAgICAgICctLWlkJywgdGhpcy51ZGlkLFxuICAgICAgICAgICctLWJ1bmRsZScsIGFwcCxcbiAgICAgICAgXSwge3RpbWVvdXQ6IHRpbWVvdXQgPz8gSU9TX0RFUExPWV9USU1FT1VUX01TfSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyci5zdGRlcnIgfHwgZXJyLnN0ZG91dCB8fCBlcnIubWVzc2FnZSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgaWYgKF8udG9Mb3dlcihzdHJhdGVneSkgPT09IEFQUF9JTlNUQUxMX1NUUkFURUdZLklPU19ERVBMT1kpIHtcbiAgICAgIGF3YWl0IGluc3RhbGxXaXRoSW9zRGVwbG95KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGFmY1NlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEFmY1NlcnZpY2UodGhpcy51ZGlkKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGJ1bmRsZUlkID0gYXdhaXQgZXh0cmFjdEJ1bmRsZUlkKGFwcCk7XG4gICAgICAgIGNvbnN0IGJ1bmRsZVBhdGhPblBob25lID0gcGF0aC5qb2luKElOU1RBTExBVElPTl9TVEFHSU5HX0RJUiwgYnVuZGxlSWQpO1xuICAgICAgICBhd2FpdCBwdXNoRm9sZGVyKGFmY1NlcnZpY2UsIGFwcCwgYnVuZGxlUGF0aE9uUGhvbmUsIHtcbiAgICAgICAgICB0aW1lb3V0TXM6IHRpbWVvdXQsXG4gICAgICAgICAgZW5hYmxlUGFyYWxsZWxQdXNoOiBfLnRvTG93ZXIoc3RyYXRlZ3kpID09PSBBUFBfSU5TVEFMTF9TVFJBVEVHWS5QQVJBTExFTCxcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHRoaXMuaW5zdGFsbE9yVXBncmFkZUFwcGxpY2F0aW9uKGJ1bmRsZVBhdGhPblBob25lLCBhd2FpdCB0aGlzLmlzQXBwSW5zdGFsbGVkKGJ1bmRsZUlkKSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLndhcm4oYEVycm9yIGluc3RhbGxpbmcgYXBwICcke2FwcH0nOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQi5UaW1lb3V0RXJyb3IpIHtcbiAgICAgICAgICBsb2cud2FybihgQ29uc2lkZXIgaW5jcmVhc2luZyB0aGUgdmFsdWUgb2YgJ2FwcFB1c2hUaW1lb3V0JyBjYXBhYmlsaXR5YCk7XG4gICAgICAgIH1cbiAgICAgICAgbG9nLndhcm4oYEZhbGxpbmcgYmFjayB0byAnJHtJT1NfREVQTE9ZfScgdXNhZ2VgKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBpbnN0YWxsV2l0aElvc0RlcGxveSgpO1xuICAgICAgICB9IGNhdGNoIChlcnIxKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgaW5zdGFsbCAnJHthcHB9JzpcXG5gICtcbiAgICAgICAgICAgIGAgIC0gJHtlcnIubWVzc2FnZX1cXG5gICtcbiAgICAgICAgICAgIGAgIC0gJHtlcnIxLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIGFmY1NlcnZpY2UuY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbG9nLmluZm8oYEFwcCBpbnN0YWxsYXRpb24gc3VjY2VlZGVkIGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsT3JVcGdyYWRlQXBwbGljYXRpb24gKGJ1bmRsZVBhdGhPblBob25lLCBpc1VwZ3JhZGUgPSBmYWxzZSkge1xuICAgIGNvbnN0IG5vdGlmaWNhdGlvblNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydE5vdGlmaWNhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIGNvbnN0IGluc3RhbGxhdGlvblNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIGNvbnN0IGFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbiA9IG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICBub3RpZmljYXRpb25TZXJ2aWNlLm9ic2VydmVOb3RpZmljYXRpb24oQVBQTElDQVRJT05fSU5TVEFMTEVEX05PVElGSUNBVElPTiwge1xuICAgICAgICBub3RpZmljYXRpb246IHJlc29sdmVcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGNvbnN0IGNsaWVudE9wdGlvbnMgPSB7UGFja2FnZVR5cGU6ICdEZXZlbG9wZXInfTtcbiAgICB0cnkge1xuICAgICAgaWYgKGlzVXBncmFkZSkge1xuICAgICAgICBsb2cuZGVidWcoYEFuIHVwZ3JhZGUgb2YgdGhlIGV4aXN0aW5nIGFwcGxpY2F0aW9uIGlzIGdvaW5nIHRvIGJlIHBlcmZvcm1lZGApO1xuICAgICAgICBhd2FpdCBpbnN0YWxsYXRpb25TZXJ2aWNlLnVwZ3JhZGVBcHBsaWNhdGlvbihidW5kbGVQYXRoT25QaG9uZSwgY2xpZW50T3B0aW9ucyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoYEEgbmV3IGFwcGxpY2F0aW9uIGluc3RhbGxhdGlvbiBpcyBnb2luZyB0byBiZSBwZXJmb3JtZWRgKTtcbiAgICAgICAgYXdhaXQgaW5zdGFsbGF0aW9uU2VydmljZS5pbnN0YWxsQXBwbGljYXRpb24oYnVuZGxlUGF0aE9uUGhvbmUsIGNsaWVudE9wdGlvbnMpO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgYXBwSW5zdGFsbGVkTm90aWZpY2F0aW9uLnRpbWVvdXQoQVBQTElDQVRJT05fTk9USUZJQ0FUSU9OX1RJTUVPVVRfTVMsXG4gICAgICAgICAgYENvdWxkIG5vdCBnZXQgdGhlIGFwcGxpY2F0aW9uIGluc3RhbGxlZCBub3RpZmljYXRpb24gd2l0aGluIGAgK1xuICAgICAgICAgIGAke0FQUExJQ0FUSU9OX05PVElGSUNBVElPTl9USU1FT1VUX01TfW1zIGJ1dCB3ZSB3aWxsIGNvbnRpbnVlYCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBGYWlsZWQgdG8gcmVjZWl2ZSB0aGUgbm90aWZpY2F0aW9uLiBFcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGluc3RhbGxhdGlvblNlcnZpY2UuY2xvc2UoKTtcbiAgICAgIG5vdGlmaWNhdGlvblNlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnN0YWxsQXBwICguLi5hcmdzKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuaW5zdGFsbCguLi5hcmdzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gYW4gYXBwbGljYXRpb24gb2JqZWN0IGlmIHRlc3QgYXBwIGhhcyAnYnVuZGxlaWQnLlxuICAgKiBUaGUgdGFyZ2V0IGJ1bmRsZWlkIGNhbiBiZSBVc2VyIGFuZCBTeXN0ZW0gYXBwcy5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZUlkIFRoZSBidW5kbGVJZCB0byBlbnN1cmUgaXQgaXMgaW5zdGFsbGVkXG4gICAqIEByZXR1cm4ge1Byb21pc2U8Ym9vbGVhbj59IFJldHVybnMgVHJ1ZSBpZiB0aGUgYnVuZGxlaWQgZXhpc3RzIGluIHRoZSByZXN1bHQgb2YgJ2xpc3RBcHBsaWNhdGlvbnMnIGxpa2U6XG4gICAqIHsgXCJjb20uYXBwbGUuUHJlZmVyZW5jZXNcIjp7XG4gICAqICAgXCJVSVJlcXVpcmVkRGV2aWNlQ2FwYWJpbGl0aWVzXCI6W1wiYXJtNjRcIl0sXG4gICAqICAgXCJVSVJlcXVpcmVzRnVsbFNjcmVlblwiOnRydWUsXG4gICAqICAgXCJDRkJ1bmRsZUluZm9EaWN0aW9uYXJ5VmVyc2lvblwiOlwiNi4wXCIsXG4gICAqICAgXCJFbnRpdGxlbWVudHNcIjpcbiAgICogICAgIHtcImNvbS5hcHBsZS5mcm9udGJvYXJkLmRlbGV0ZS1hcHBsaWNhdGlvbi1zbmFwc2hvdHNcIjp0cnVlLC4uXG4gICAqL1xuICBhc3luYyBpc0FwcEluc3RhbGxlZCAoYnVuZGxlSWQpIHtcbiAgICByZXR1cm4gQm9vbGVhbihhd2FpdCB0aGlzLmZldGNoQXBwSW5mbyhidW5kbGVJZCkpO1xuICB9XG5cbiAgYXN5bmMgZmV0Y2hBcHBJbmZvIChidW5kbGVJZCkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gKGF3YWl0IHNlcnZpY2UubG9va3VwQXBwbGljYXRpb25zKHsgYnVuZGxlSWRzOiBidW5kbGVJZCB9KSlbYnVuZGxlSWRdO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdGVybWluYXRlQXBwIChidW5kbGVJZCkge1xuICAgIGxldCBpbnN0cnVtZW50U2VydmljZTtcbiAgICBsZXQgaW5zdGFsbFByb3h5U2VydmljZTtcbiAgICB0cnkge1xuICAgICAgaW5zdGFsbFByb3h5U2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgICBjb25zdCBhcHBzID0gYXdhaXQgaW5zdGFsbFByb3h5U2VydmljZS5saXN0QXBwbGljYXRpb25zKCk7XG4gICAgICBpZiAoIWFwcHNbYnVuZGxlSWRdKSB7XG4gICAgICAgIGxvZy5pbmZvKGBUaGUgYnVuZGxlIGlkICcke2J1bmRsZUlkfScgZGlkIG5vdCBleGlzdGApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBjb25zdCBleGVjdXRhYmxlTmFtZSA9IGFwcHNbYnVuZGxlSWRdLkNGQnVuZGxlRXhlY3V0YWJsZTtcbiAgICAgIGxvZy5kZWJ1ZyhgVGhlIGV4ZWN1dGFibGUgbmFtZSBmb3IgdGhlIGJ1bmRsZSBpZCAnJHtidW5kbGVJZH0nIHdhcyAnJHtleGVjdXRhYmxlTmFtZX0nYCk7XG4gICAgICBpbnN0cnVtZW50U2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0SW5zdHJ1bWVudFNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICAgIGNvbnN0IHByb2Nlc3NlcyA9IGF3YWl0IGluc3RydW1lbnRTZXJ2aWNlLmNhbGxDaGFubmVsKElOU1RSVU1FTlRfQ0hBTk5FTC5ERVZJQ0VfSU5GTywgJ3J1bm5pbmdQcm9jZXNzZXMnKTtcbiAgICAgIGNvbnN0IHByb2Nlc3MgPSBwcm9jZXNzZXMuc2VsZWN0b3IuZmluZCgocHJvY2VzcykgPT4gcHJvY2Vzcy5uYW1lID09PSBleGVjdXRhYmxlTmFtZSk7XG4gICAgICBpZiAoIXByb2Nlc3MpIHtcbiAgICAgICAgbG9nLmluZm8oYFRoZSBwcm9jZXNzIG9mIHRoZSBidW5kbGUgaWQgJyR7YnVuZGxlSWR9JyB3YXMgbm90IHJ1bm5pbmdgKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgYXdhaXQgaW5zdHJ1bWVudFNlcnZpY2UuY2FsbENoYW5uZWwoSU5TVFJVTUVOVF9DSEFOTkVMLlBST0NFU1NfQ09OVFJPTCwgJ2tpbGxQaWQ6JywgYCR7cHJvY2Vzcy5waWR9YCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBGYWlsZWQgdG8ga2lsbCAnJHtidW5kbGVJZH0nLiBPcmlnaW5hbCBlcnJvcjogJHtlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlfWApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBpZiAoaW5zdGFsbFByb3h5U2VydmljZSkge1xuICAgICAgICBpbnN0YWxsUHJveHlTZXJ2aWNlLmNsb3NlKCk7XG4gICAgICB9XG4gICAgICBpZiAoaW5zdHJ1bWVudFNlcnZpY2UpIHtcbiAgICAgICAgaW5zdHJ1bWVudFNlcnZpY2UuY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZU5hbWUgVGhlIG5hbWUgb2YgQ0ZCdW5kbGVOYW1lIGluIEluZm8ucGxpc3RcbiAgICpcbiAgICogQHJldHVybnMge0FycmF5PHN0cmluZz59IEEgbGlzdCBvZiBVc2VyIGxldmVsIGFwcHMnIGJ1bmRsZSBpZHMgd2hpY2ggaGFzXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAnQ0ZCdW5kbGVOYW1lJyBhdHRyaWJ1dGUgYXMgJ2J1bmRsZU5hbWUnLlxuICAgKi9cbiAgYXN5bmMgZ2V0VXNlckluc3RhbGxlZEJ1bmRsZUlkc0J5QnVuZGxlTmFtZSAoYnVuZGxlTmFtZSkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcHBsaWNhdGlvbnMgPSBhd2FpdCBzZXJ2aWNlLmxpc3RBcHBsaWNhdGlvbnMoe2FwcGxpY2F0aW9uVHlwZTogJ1VzZXInfSk7XG4gICAgICByZXR1cm4gXy5yZWR1Y2UoYXBwbGljYXRpb25zLCAoYWNjLCB7Q0ZCdW5kbGVOYW1lfSwga2V5KSA9PiB7XG4gICAgICAgIGlmIChDRkJ1bmRsZU5hbWUgPT09IGJ1bmRsZU5hbWUpIHtcbiAgICAgICAgICBhY2MucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LCBbXSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRQbGF0Zm9ybVZlcnNpb24gKCkge1xuICAgIHJldHVybiBhd2FpdCB1dGlsaXRpZXMuZ2V0T1NWZXJzaW9uKHRoaXMudWRpZCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSU9TRGVwbG95O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLFFBQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLEtBQUEsR0FBQUMsc0JBQUEsQ0FBQUYsT0FBQTtBQUNBLElBQUFHLGdCQUFBLEdBQUFILE9BQUE7QUFDQSxJQUFBSSxTQUFBLEdBQUFGLHNCQUFBLENBQUFGLE9BQUE7QUFDQSxJQUFBSyxPQUFBLEdBQUFILHNCQUFBLENBQUFGLE9BQUE7QUFDQSxJQUFBTSxPQUFBLEdBQUFKLHNCQUFBLENBQUFGLE9BQUE7QUFDQSxJQUFBTyxhQUFBLEdBQUFQLE9BQUE7QUFDQSxJQUFBUSxTQUFBLEdBQUFSLE9BQUE7QUFDQSxJQUFBUyxhQUFBLEdBQUFULE9BQUE7QUFFQSxNQUFNVSxrQ0FBa0MsR0FBRyx3Q0FBd0M7QUFDbkYsTUFBTUMsd0JBQXdCLEdBQUcsZUFBZTtBQUNoRCxNQUFNQyxtQ0FBbUMsR0FBRyxFQUFFLEdBQUcsSUFBSTtBQUNyRCxNQUFNQyxxQkFBcUIsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUk7QUFDM0MsTUFBTUMsVUFBVSxHQUFHLFlBQVk7QUFDL0IsTUFBTUMsb0JBQW9CLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBTSxDQUFDO0VBQ3pDQyxNQUFNLEVBQUUsUUFBUTtFQUNoQkMsUUFBUSxFQUFFLFVBQVU7RUFDcEJMO0FBQ0YsQ0FBQyxDQUFDO0FBR0YsTUFBTU0sU0FBUyxDQUFDO0VBRWRDLFdBQVdBLENBQUVDLElBQUksRUFBRTtJQUNqQixJQUFJLENBQUNBLElBQUksR0FBR0EsSUFBSTtFQUNsQjtFQUVBLE1BQU1DLE1BQU1BLENBQUVDLFFBQVEsRUFBRTtJQUN0QixNQUFNQyxPQUFPLEdBQUcsTUFBTUMseUJBQVEsQ0FBQ0MsNkJBQTZCLENBQUMs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