"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.pullFile = pullFile;
exports.pullFolder = pullFolder;
exports.pushFile = pushFile;
exports.pushFolder = pushFolder;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _bluebird = _interopRequireDefault(require("bluebird"));
var _support = require("appium/support");
var _path = _interopRequireDefault(require("path"));
var _logger = _interopRequireDefault(require("./logger"));
const IO_TIMEOUT_MS = 4 * 60 * 1000;
const MAX_IO_CHUNK_SIZE = 8;
async function pullFile(afcService, remotePath) {
  const stream = await afcService.createReadStream(remotePath, {
    autoDestroy: true
  });
  const pullPromise = new _bluebird.default((resolve, reject) => {
    stream.on('close', resolve);
    stream.on('error', reject);
  }).timeout(IO_TIMEOUT_MS);
  const buffers = [];
  stream.on('data', data => buffers.push(data));
  await pullPromise;
  return Buffer.concat(buffers);
}
async function folderExists(folderPath) {
  try {
    return (await _support.fs.stat(folderPath)).isDirectory();
  } catch (e) {
    return false;
  }
}
async function pullFolder(afcService, remoteRootPath) {
  const tmpFolder = await _support.tempDir.openDir();
  try {
    let localTopItem = null;
    let countFilesSuccess = 0;
    let countFilesFail = 0;
    let countFolders = 0;
    const pullPromises = [];
    await afcService.walkDir(remoteRootPath, true, async (remotePath, isDir) => {
      const localPath = _path.default.join(tmpFolder, remotePath);
      const dirname = isDir ? localPath : _path.default.dirname(localPath);
      if (!(await folderExists(dirname))) {
        await (0, _support.mkdirp)(dirname);
      }
      if (!localTopItem || localPath.split(_path.default.sep).length < localTopItem.split(_path.default.sep).length) {
        localTopItem = localPath;
      }
      if (isDir) {
        ++countFolders;
        return;
      }
      const readStream = await afcService.createReadStream(remotePath, {
        autoDestroy: true
      });
      const writeStream = _support.fs.createWriteStream(localPath, {
        autoClose: true
      });
      pullPromises.push(new _bluebird.default(resolve => {
        writeStream.on('close', () => {
          ++countFilesSuccess;
          resolve();
        });
        const onStreamingError = e => {
          readStream.unpipe(writeStream);
          _logger.default.warn(`Cannot pull '${remotePath}' to '${localPath}'. ` + `The file will be skipped. Original error: ${e.message}`);
          ++countFilesFail;
          resolve();
        };
        writeStream.on('error', onStreamingError);
        readStream.on('error', onStreamingError);
      }).timeout(IO_TIMEOUT_MS));
      readStream.pipe(writeStream);
      if (pullPromises.length >= MAX_IO_CHUNK_SIZE) {
        await _bluebird.default.any(pullPromises);
      }
      _lodash.default.remove(pullPromises, p => p.isFulfilled());
    });
    if (!_lodash.default.isEmpty(pullPromises)) {
      await _bluebird.default.all(pullPromises);
    }
    _logger.default.info(`Pulled ${_support.util.pluralize('file', countFilesSuccess, true)} out of ` + `${countFilesSuccess + countFilesFail} and ${_support.util.pluralize('folder', countFolders, true)} ` + `from '${remoteRootPath}'`);
    return await _support.zip.toInMemoryZip(localTopItem ? _path.default.dirname(localTopItem) : tmpFolder, {
      encodeToBase64: true
    });
  } finally {
    await _support.fs.rimraf(tmpFolder);
  }
}
async function remoteMkdirp(afcService, remoteRoot) {
  if (remoteRoot === '.' || remoteRoot === '/') {
    return;
  }
  try {
    await afcService.listDirectory(remoteRoot);
    return;
  } catch (e) {
    await remoteMkdirp(afcService, _path.default.dirname(remoteRoot));
  }
  await afcService.createDirectory(remoteRoot);
}
async function pushFile(afcService, remotePath, base64Data) {
  await remoteMkdirp(afcService, _path.default.dirname(remotePath));
  const stream = await afcService.createWriteStream(remotePath, {
    autoDestroy: true
  });
  let pushError = null;
  const pushPromise = new _bluebird.default((resolve, reject) => {
    stream.on('error', e => {
      pushError = e;
    });
    stream.on('close', () => {
      if (pushError) {
        reject(pushError);
      } else {
        resolve();
      }
    });
  }).timeout(IO_TIMEOUT_MS);
  stream.write(Buffer.from(base64Data, 'base64'));
  stream.end();
  await pushPromise;
}
async function pushFolder(afcService, srcRootPath, dstRootPath, opts = {}) {
  const {
    timeoutMs = IO_TIMEOUT_MS,
    enableParallelPush = false
  } = opts;
  const timer = new _support.timing.Timer().start();
  const itemsToPush = await _support.fs.glob('**', {
    cwd: srcRootPath,
    nosort: true,
    mark: true
  });
  _logger.default.debug(`Successfully scanned the tree structure of '${srcRootPath}'`);
  const [foldersToPush, filesToPush] = itemsToPush.reduce((acc, x) => {
    acc[_lodash.default.endsWith(x, _path.default.sep) ? 0 : 1].push(x);
    return acc;
  }, [[], []]);
  _logger.default.debug(`Got ${_support.util.pluralize('folder', foldersToPush.length, true)} and ` + `${_support.util.pluralize('file', filesToPush.length, true)} to push`);
  try {
    await afcService.deleteDirectory(dstRootPath);
  } catch (ign) {}
  await afcService.createDirectory(dstRootPath);
  const foldersToPushByHierarchy = foldersToPush.sort((a, b) => a.split(_path.default.sep).length - b.split(_path.default.sep).length);
  for (const relativeFolderPath of foldersToPushByHierarchy) {
    const absoluteFolderPath = _lodash.default.trimEnd(_path.default.join(dstRootPath, relativeFolderPath), _path.default.sep);
    if (absoluteFolderPath) {
      await afcService.createDirectory(absoluteFolderPath);
    }
  }
  _logger.default.debug(`Successfully created the remote folder structure ` + `(${_support.util.pluralize('item', foldersToPush.length + 1, true)})`);
  const pushFile = async relativePath => {
    const absoluteSourcePath = _path.default.join(srcRootPath, relativePath);
    const readStream = _support.fs.createReadStream(absoluteSourcePath, {
      autoClose: true
    });
    const absoluteDestinationPath = _path.default.join(dstRootPath, relativePath);
    const writeStream = await afcService.createWriteStream(absoluteDestinationPath, {
      autoDestroy: true
    });
    writeStream.on('finish', writeStream.destroy);
    let pushError = null;
    const filePushPromise = new _bluebird.default((resolve, reject) => {
      writeStream.on('close', () => {
        if (pushError) {
          reject(pushError);
        } else {
          resolve();
        }
      });
      const onStreamError = e => {
        readStream.unpipe(writeStream);
        _logger.default.debug(e);
        pushError = e;
      };
      writeStream.on('error', onStreamError);
      readStream.on('error', onStreamError);
    });
    readStream.pipe(writeStream);
    await filePushPromise.timeout(timeoutMs);
  };
  if (enableParallelPush) {
    _logger.default.debug(`Proceeding to parallel files push (max ${MAX_IO_CHUNK_SIZE} writers)`);
    const pushPromises = [];
    for (const relativeFilePath of _lodash.default.shuffle(filesToPush)) {
      pushPromises.push(_bluebird.default.resolve(pushFile(relativeFilePath)));
      if (pushPromises.length >= MAX_IO_CHUNK_SIZE) {
        await _bluebird.default.any(pushPromises);
      }
      _lodash.default.remove(pushPromises, p => p.isFulfilled());
    }
    if (!_lodash.default.isEmpty(pushPromises)) {
      await _bluebird.default.all(pushPromises);
    }
  } else {
    _logger.default.debug(`Proceeding to serial files push`);
    for (const relativeFilePath of filesToPush) {
      await pushFile(relativeFilePath);
    }
  }
  _logger.default.debug(`Successfully pushed ${_support.util.pluralize('folder', foldersToPush.length, true)} ` + `and ${_support.util.pluralize('file', filesToPush.length, true)} ` + `within ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfYmx1ZWJpcmQiLCJfc3VwcG9ydCIsIl9wYXRoIiwiX2xvZ2dlciIsIklPX1RJTUVPVVRfTVMiLCJNQVhfSU9fQ0hVTktfU0laRSIsInB1bGxGaWxlIiwiYWZjU2VydmljZSIsInJlbW90ZVBhdGgiLCJzdHJlYW0iLCJjcmVhdGVSZWFkU3RyZWFtIiwiYXV0b0Rlc3Ryb3kiLCJwdWxsUHJvbWlzZSIsIkIiLCJyZXNvbHZlIiwicmVqZWN0Iiwib24iLCJ0aW1lb3V0IiwiYnVmZmVycyIsImRhdGEiLCJwdXNoIiwiQnVmZmVyIiwiY29uY2F0IiwiZm9sZGVyRXhpc3RzIiwiZm9sZGVyUGF0aCIsImZzIiwic3RhdCIsImlzRGlyZWN0b3J5IiwiZSIsInB1bGxGb2xkZXIiLCJyZW1vdGVSb290UGF0aCIsInRtcEZvbGRlciIsInRlbXBEaXIiLCJvcGVuRGlyIiwibG9jYWxUb3BJdGVtIiwiY291bnRGaWxlc1N1Y2Nlc3MiLCJjb3VudEZpbGVzRmFpbCIsImNvdW50Rm9sZGVycyIsInB1bGxQcm9taXNlcyIsIndhbGtEaXIiLCJpc0RpciIsImxvY2FsUGF0aCIsInBhdGgiLCJqb2luIiwiZGlybmFtZSIsIm1rZGlycCIsInNwbGl0Iiwic2VwIiwibGVuZ3RoIiwicmVhZFN0cmVhbSIsIndyaXRlU3RyZWFtIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJhdXRvQ2xvc2UiLCJvblN0cmVhbWluZ0Vycm9yIiwidW5waXBlIiwibG9nIiwid2FybiIsIm1lc3NhZ2UiLCJwaXBlIiwiYW55IiwiXyIsInJlbW92ZSIsInAiLCJpc0Z1bGZpbGxlZCIsImlzRW1wdHkiLCJhbGwiLCJpbmZvIiwidXRpbCIsInBsdXJhbGl6ZSIsInppcCIsInRvSW5NZW1vcnlaaXAiLCJlbmNvZGVUb0Jhc2U2NCIsInJpbXJhZiIsInJlbW90ZU1rZGlycCIsInJlbW90ZVJvb3QiLCJsaXN0RGlyZWN0b3J5IiwiY3JlYXRlRGlyZWN0b3J5IiwicHVzaEZpbGUiLCJiYXNlNjREYXRhIiwicHVzaEVycm9yIiwicHVzaFByb21pc2UiLCJ3cml0ZSIsImZyb20iLCJlbmQiLCJwdXNoRm9sZGVyIiwic3JjUm9vdFBhdGgiLCJkc3RSb290UGF0aCIsIm9wdHMiLCJ0aW1lb3V0TXMiLCJlbmFibGVQYXJhbGxlbFB1c2giLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJpdGVtc1RvUHVzaCIsImdsb2IiLCJjd2QiLCJub3NvcnQiLCJtYXJrIiwiZGVidWciLCJmb2xkZXJzVG9QdXNoIiwiZmlsZXNUb1B1c2giLCJyZWR1Y2UiLCJhY2MiLCJ4IiwiZW5kc1dpdGgiLCJkZWxldGVEaXJlY3RvcnkiLCJpZ24iLCJmb2xkZXJzVG9QdXNoQnlIaWVyYXJjaHkiLCJzb3J0IiwiYSIsImIiLCJyZWxhdGl2ZUZvbGRlclBhdGgiLCJhYnNvbHV0ZUZvbGRlclBhdGgiLCJ0cmltRW5kIiwicmVsYXRpdmVQYXRoIiwiYWJzb2x1dGVTb3VyY2VQYXRoIiwiYWJzb2x1dGVEZXN0aW5hdGlvblBhdGgiLCJkZXN0cm95IiwiZmlsZVB1c2hQcm9taXNlIiwib25TdHJlYW1FcnJvciIsInB1c2hQcm9taXNlcyIsInJlbGF0aXZlRmlsZVBhdGgiLCJzaHVmZmxlIiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiXSwic291cmNlcyI6WyIuLi8uLi9saWIvaW9zLWZzLWhlbHBlcnMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCBta2RpcnAsIHppcCwgdXRpbCwgdGltaW5nIH0gZnJvbSAnYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcblxuY29uc3QgSU9fVElNRU9VVF9NUyA9IDQgKiA2MCAqIDEwMDA7XG4vLyBNb2JpbGUgZGV2aWNlcyB1c2UgTkFORCBtZW1vcnkgbW9kdWxlcyBmb3IgdGhlIHN0b3JhZ2UsXG4vLyBhbmQgdGhlIHBhcmFsbGVsaXNtIHRoZXJlIGlzIG5vdCBhcyBwZXJmb3JtYW50IGFzIG9uIHJlZ3VsYXIgU1NEc1xuY29uc3QgTUFYX0lPX0NIVU5LX1NJWkUgPSA4O1xuXG4vKipcbiAqIFJldHJpZXZlIGEgZmlsZSBmcm9tIGEgcmVhbCBkZXZpY2VcbiAqXG4gKiBAcGFyYW0ge0FmY1NlcnZpY2V9IGFmY1NlcnZpY2UgQXBwbGUgRmlsZSBDbGllbnQgc2VydmljZSBpbnN0YW5jZSBmcm9tXG4gKiAnYXBwaXVtLWlvcy1kZXZpY2UnIG1vZHVsZVxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggUmVsYXRpdmUgcGF0aCB0byB0aGUgZmlsZSBvbiB0aGUgZGV2aWNlXG4gKiBAcmV0dXJucyB7QnVmZmVyfSBUaGUgZmlsZSBjb250ZW50IGFzIGEgYnVmZmVyXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1bGxGaWxlIChhZmNTZXJ2aWNlLCByZW1vdGVQYXRoKSB7XG4gIGNvbnN0IHN0cmVhbSA9IGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlUmVhZFN0cmVhbShyZW1vdGVQYXRoLCB7IGF1dG9EZXN0cm95OiB0cnVlIH0pO1xuICBjb25zdCBwdWxsUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBzdHJlYW0ub24oJ2Nsb3NlJywgcmVzb2x2ZSk7XG4gICAgc3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gIH0pLnRpbWVvdXQoSU9fVElNRU9VVF9NUyk7XG4gIGNvbnN0IGJ1ZmZlcnMgPSBbXTtcbiAgc3RyZWFtLm9uKCdkYXRhJywgKGRhdGEpID0+IGJ1ZmZlcnMucHVzaChkYXRhKSk7XG4gIGF3YWl0IHB1bGxQcm9taXNlO1xuICByZXR1cm4gQnVmZmVyLmNvbmNhdChidWZmZXJzKTtcbn1cblxuLyoqXG4gKiBDaGVja3MgYSBwcmVzZW5jZSBvZiBhIGxvY2FsIGZvbGRlci5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gZm9sZGVyUGF0aCBGdWxsIHBhdGggdG8gdGhlIGxvY2FsIGZvbGRlclxuICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIGZvbGRlciBleGlzdHMgYW5kIGlzIGFjdHVhbGx5IGEgZm9sZGVyXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGZvbGRlckV4aXN0cyAoZm9sZGVyUGF0aCkge1xuICB0cnkge1xuICAgIHJldHVybiAoYXdhaXQgZnMuc3RhdChmb2xkZXJQYXRoKSkuaXNEaXJlY3RvcnkoKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIFJldHJpZXZlIGEgZm9sZGVyIGZyb20gYSByZWFsIGRldmljZVxuICpcbiAqIEBwYXJhbSB7QWZjU2VydmljZX0gYWZjU2VydmljZSBBcHBsZSBGaWxlIENsaWVudCBzZXJ2aWNlIGluc3RhbmNlIGZyb21cbiAqICdhcHBpdW0taW9zLWRldmljZScgbW9kdWxlXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUm9vdFBhdGggUmVsYXRpdmUgcGF0aCB0byB0aGUgZm9sZGVyIG9uIHRoZSBkZXZpY2VcbiAqIEByZXR1cm5zIHtCdWZmZXJ9IFRoZSBmb2xkZXIgY29udGVudCBhcyBhIHppcHBlZCBiYXNlNjQtZW5jb2RlZCBidWZmZXJcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVsbEZvbGRlciAoYWZjU2VydmljZSwgcmVtb3RlUm9vdFBhdGgpIHtcbiAgY29uc3QgdG1wRm9sZGVyID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIHRyeSB7XG4gICAgbGV0IGxvY2FsVG9wSXRlbSA9IG51bGw7XG4gICAgbGV0IGNvdW50RmlsZXNTdWNjZXNzID0gMDtcbiAgICBsZXQgY291bnRGaWxlc0ZhaWwgPSAwO1xuICAgIGxldCBjb3VudEZvbGRlcnMgPSAwO1xuICAgIGNvbnN0IHB1bGxQcm9taXNlcyA9IFtdO1xuICAgIGF3YWl0IGFmY1NlcnZpY2Uud2Fsa0RpcihyZW1vdGVSb290UGF0aCwgdHJ1ZSwgYXN5bmMgKHJlbW90ZVBhdGgsIGlzRGlyKSA9PiB7XG4gICAgICBjb25zdCBsb2NhbFBhdGggPSBwYXRoLmpvaW4odG1wRm9sZGVyLCByZW1vdGVQYXRoKTtcbiAgICAgIGNvbnN0IGRpcm5hbWUgPSBpc0RpciA/IGxvY2FsUGF0aCA6IHBhdGguZGlybmFtZShsb2NhbFBhdGgpO1xuICAgICAgaWYgKCFhd2FpdCBmb2xkZXJFeGlzdHMoZGlybmFtZSkpIHtcbiAgICAgICAgYXdhaXQgbWtkaXJwKGRpcm5hbWUpO1xuICAgICAgfVxuICAgICAgaWYgKCFsb2NhbFRvcEl0ZW1cbiAgICAgICAgICB8fCBsb2NhbFBhdGguc3BsaXQocGF0aC5zZXApLmxlbmd0aCA8IGxvY2FsVG9wSXRlbS5zcGxpdChwYXRoLnNlcCkubGVuZ3RoKSB7XG4gICAgICAgIGxvY2FsVG9wSXRlbSA9IGxvY2FsUGF0aDtcbiAgICAgIH1cbiAgICAgIGlmIChpc0Rpcikge1xuICAgICAgICArK2NvdW50Rm9sZGVycztcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZWFkU3RyZWFtID0gYXdhaXQgYWZjU2VydmljZS5jcmVhdGVSZWFkU3RyZWFtKHJlbW90ZVBhdGgsIHthdXRvRGVzdHJveTogdHJ1ZX0pO1xuICAgICAgY29uc3Qgd3JpdGVTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShsb2NhbFBhdGgsIHthdXRvQ2xvc2U6IHRydWV9KTtcbiAgICAgIHB1bGxQcm9taXNlcy5wdXNoKFxuICAgICAgICBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgIHdyaXRlU3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgICAgICsrY291bnRGaWxlc1N1Y2Nlc3M7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29uc3Qgb25TdHJlYW1pbmdFcnJvciA9IChlKSA9PiB7XG4gICAgICAgICAgICByZWFkU3RyZWFtLnVucGlwZSh3cml0ZVN0cmVhbSk7XG4gICAgICAgICAgICBsb2cud2FybihgQ2Fubm90IHB1bGwgJyR7cmVtb3RlUGF0aH0nIHRvICcke2xvY2FsUGF0aH0nLiBgICtcbiAgICAgICAgICAgICAgYFRoZSBmaWxlIHdpbGwgYmUgc2tpcHBlZC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICAgICAgKytjb3VudEZpbGVzRmFpbDtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIHdyaXRlU3RyZWFtLm9uKCdlcnJvcicsIG9uU3RyZWFtaW5nRXJyb3IpO1xuICAgICAgICAgIHJlYWRTdHJlYW0ub24oJ2Vycm9yJywgb25TdHJlYW1pbmdFcnJvcik7XG4gICAgICAgIH0pLnRpbWVvdXQoSU9fVElNRU9VVF9NUylcbiAgICAgICk7XG4gICAgICByZWFkU3RyZWFtLnBpcGUod3JpdGVTdHJlYW0pO1xuICAgICAgaWYgKHB1bGxQcm9taXNlcy5sZW5ndGggPj0gTUFYX0lPX0NIVU5LX1NJWkUpIHtcbiAgICAgICAgYXdhaXQgQi5hbnkocHVsbFByb21pc2VzKTtcbiAgICAgIH1cbiAgICAgIF8ucmVtb3ZlKHB1bGxQcm9taXNlcywgKHApID0+IHAuaXNGdWxmaWxsZWQoKSk7XG4gICAgfSk7XG4gICAgLy8gV2FpdCBmb3IgdGhlIHJlc3Qgb2YgZmlsZXMgdG8gYmUgcHVsbGVkXG4gICAgaWYgKCFfLmlzRW1wdHkocHVsbFByb21pc2VzKSkge1xuICAgICAgYXdhaXQgQi5hbGwocHVsbFByb21pc2VzKTtcbiAgICB9XG4gICAgbG9nLmluZm8oYFB1bGxlZCAke3V0aWwucGx1cmFsaXplKCdmaWxlJywgY291bnRGaWxlc1N1Y2Nlc3MsIHRydWUpfSBvdXQgb2YgYCArXG4gICAgICBgJHtjb3VudEZpbGVzU3VjY2VzcyArIGNvdW50RmlsZXNGYWlsfSBhbmQgJHt1dGlsLnBsdXJhbGl6ZSgnZm9sZGVyJywgY291bnRGb2xkZXJzLCB0cnVlKX0gYCArXG4gICAgICBgZnJvbSAnJHtyZW1vdGVSb290UGF0aH0nYCk7XG4gICAgcmV0dXJuIGF3YWl0IHppcC50b0luTWVtb3J5WmlwKGxvY2FsVG9wSXRlbSA/IHBhdGguZGlybmFtZShsb2NhbFRvcEl0ZW0pIDogdG1wRm9sZGVyLCB7XG4gICAgICBlbmNvZGVUb0Jhc2U2NDogdHJ1ZSxcbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodG1wRm9sZGVyKTtcbiAgfVxufVxuXG4vKipcbiAqIENyZWF0ZXMgcmVtb3RlIGZvbGRlciBwYXRoIHJlY3Vyc2l2ZWx5LiBOb29wIGlmIHRoZSBnaXZlbiBwYXRoXG4gKiBhbHJlYWR5IGV4aXN0c1xuICpcbiAqIEBwYXJhbSB7QWZjU2VydmljZX0gYWZjU2VydmljZSBBcHBsZSBGaWxlIENsaWVudCBzZXJ2aWNlIGluc3RhbmNlIGZyb21cbiAqICdhcHBpdW0taW9zLWRldmljZScgbW9kdWxlXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUm9vdCBUaGUgcmVsYXRpdmUgcGF0aCB0byB0aGUgcmVtb3RlIGZvbGRlciBzdHJ1Y3R1cmVcbiAqIHRvIGJlIGNyZWF0ZWRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcmVtb3RlTWtkaXJwIChhZmNTZXJ2aWNlLCByZW1vdGVSb290KSB7XG4gIGlmIChyZW1vdGVSb290ID09PSAnLicgfHwgcmVtb3RlUm9vdCA9PT0gJy8nKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHRyeSB7XG4gICAgYXdhaXQgYWZjU2VydmljZS5saXN0RGlyZWN0b3J5KHJlbW90ZVJvb3QpO1xuICAgIHJldHVybjtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIFRoaXMgbWVhbnMgdGhhdCB0aGUgZGlyZWN0b3J5IGlzIG1pc3NpbmcgYW5kIHdlIGdvdCBhbiBvYmplY3Qgbm90IGZvdW5kIGVycm9yLlxuICAgIC8vIFRoZXJlZm9yZSwgd2UgYXJlIGdvaW5nIHRvIHRoZSBwYXJlbnRcbiAgICBhd2FpdCByZW1vdGVNa2RpcnAoYWZjU2VydmljZSwgcGF0aC5kaXJuYW1lKHJlbW90ZVJvb3QpKTtcbiAgfVxuICBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZURpcmVjdG9yeShyZW1vdGVSb290KTtcbn1cblxuLyoqXG4gKiBQdXNoZXMgYSBmaWxlIHRvIGEgcmVhbCBkZXZpY2VcbiAqXG4gKiBAcGFyYW0ge0FmY1NlcnZpY2V9IGFmY1NlcnZpY2UgQXBwbGUgRmlsZSBDbGllbnQgc2VydmljZSBpbnN0YW5jZSBmcm9tXG4gKiAnYXBwaXVtLWlvcy1kZXZpY2UnIG1vZHVsZVxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggUmVsYXRpdmUgcGF0aCB0byB0aGUgZmlsZSBvbiB0aGUgZGV2aWNlLiBUaGUgcmVtb3RlXG4gKiBmb2xkZXIgc3RydWN0dXJlIGlzIGNyZWF0ZWQgYXV0b21hdGljYWxseSBpZiBuZWNlc3NhcnkuXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZTY0RGF0YSBCYXNlNjQtZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlIHRvIGJlIHdyaXR0ZW5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVzaEZpbGUgKGFmY1NlcnZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpIHtcbiAgYXdhaXQgcmVtb3RlTWtkaXJwKGFmY1NlcnZpY2UsIHBhdGguZGlybmFtZShyZW1vdGVQYXRoKSk7XG4gIGNvbnN0IHN0cmVhbSA9IGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlV3JpdGVTdHJlYW0ocmVtb3RlUGF0aCwge2F1dG9EZXN0cm95OiB0cnVlfSk7XG4gIGxldCBwdXNoRXJyb3IgPSBudWxsO1xuICBjb25zdCBwdXNoUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBzdHJlYW0ub24oJ2Vycm9yJywgKGUpID0+IHtcbiAgICAgIHB1c2hFcnJvciA9IGU7XG4gICAgfSk7XG4gICAgc3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgIGlmIChwdXNoRXJyb3IpIHtcbiAgICAgICAgcmVqZWN0KHB1c2hFcnJvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pLnRpbWVvdXQoSU9fVElNRU9VVF9NUyk7XG4gIHN0cmVhbS53cml0ZShCdWZmZXIuZnJvbShiYXNlNjREYXRhLCAnYmFzZTY0JykpO1xuICBzdHJlYW0uZW5kKCk7XG4gIGF3YWl0IHB1c2hQcm9taXNlO1xufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFB1c2hGb2xkZXJPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVvdXRNcyBbMjQwMDAwXSBUaGUgbWF4aW11bSB0aW1lb3V0IHRvIHdhaXQgdW50aWwgYVxuICogc2luZ2xlIGZpbGUgaXMgY29waWVkXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGVuYWJsZVBhcmFsbGVsUHVzaCBbZmFsc2VdIFdoZXRoZXIgdG8gcHVzaCBmaWxlcyBpbiBwYXJhbGxlbC5cbiAqIFRoaXMgdXN1YWxseSBnaXZlcyBiZXR0ZXIgcGVyZm9ybWFuY2UsIGJ1dCBtaWdodCBzb21ldGltZXMgYmUgbGVzcyBzdGFibGUuXG4gKi9cblxuLyoqXG4gKiBQdXNoZXMgYSBmb2xkZXIgdG8gYSByZWFsIGRldmljZVxuICpcbiAqIEBwYXJhbSB7QWZjU2VydmljZX0gYWZjU2VydmljZSBBcHBsZSBGaWxlIENsaWVudCBzZXJ2aWNlIGluc3RhbmNlIGZyb21cbiAqICdhcHBpdW0taW9zLWRldmljZScgbW9kdWxlXG4gKiBAcGFyYW0ge3N0cmluZ30gc3JjUm9vdFBhdGggVGhlIGZ1bGwgcGF0aCB0byB0aGUgc291cmNlIGZvbGRlclxuICogQHBhcmFtIHtzdHJpbmd9IGRzdFJvb3RQYXRoIFRoZSByZWxhdGl2ZSBwYXRoIHRvIHRoZSBkZXN0aW5hdGlvbiBmb2xkZXIuIFRoZSBmb2xkZXJcbiAqIHdpbGwgYmUgZGVsZXRlZCBpZiBhbHJlYWR5IGV4aXN0cy5cbiAqIEBwYXJhbSB7UHVzaEZvbGRlck9wdGlvbnN9IG9wdHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVzaEZvbGRlciAoYWZjU2VydmljZSwgc3JjUm9vdFBhdGgsIGRzdFJvb3RQYXRoLCBvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHRpbWVvdXRNcyA9IElPX1RJTUVPVVRfTVMsXG4gICAgZW5hYmxlUGFyYWxsZWxQdXNoID0gZmFsc2UsXG4gIH0gPSBvcHRzO1xuXG4gIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gIGNvbnN0IGl0ZW1zVG9QdXNoID0gYXdhaXQgZnMuZ2xvYignKionLCB7XG4gICAgY3dkOiBzcmNSb290UGF0aCxcbiAgICBub3NvcnQ6IHRydWUsXG4gICAgbWFyazogdHJ1ZSxcbiAgfSk7XG4gIGxvZy5kZWJ1ZyhgU3VjY2Vzc2Z1bGx5IHNjYW5uZWQgdGhlIHRyZWUgc3RydWN0dXJlIG9mICcke3NyY1Jvb3RQYXRofSdgKTtcbiAgY29uc3QgW2ZvbGRlcnNUb1B1c2gsIGZpbGVzVG9QdXNoXSA9IGl0ZW1zVG9QdXNoLnJlZHVjZSgoYWNjLCB4KSA9PiB7XG4gICAgYWNjW18uZW5kc1dpdGgoeCwgcGF0aC5zZXApID8gMCA6IDFdLnB1c2goeCk7XG4gICAgcmV0dXJuIGFjYztcbiAgfSwgW1tdLCBbXV0pO1xuICBsb2cuZGVidWcoYEdvdCAke3V0aWwucGx1cmFsaXplKCdmb2xkZXInLCBmb2xkZXJzVG9QdXNoLmxlbmd0aCwgdHJ1ZSl9IGFuZCBgICtcbiAgICBgJHt1dGlsLnBsdXJhbGl6ZSgnZmlsZScsIGZpbGVzVG9QdXNoLmxlbmd0aCwgdHJ1ZSl9IHRvIHB1c2hgKTtcbiAgLy8gY3JlYXRlIHRoZSBmb2xkZXIgc3RydWN0dXJlIGZpcnN0XG4gIHRyeSB7XG4gICAgYXdhaXQgYWZjU2VydmljZS5kZWxldGVEaXJlY3RvcnkoZHN0Um9vdFBhdGgpO1xuICB9IGNhdGNoIChpZ24pIHt9XG4gIGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlRGlyZWN0b3J5KGRzdFJvb3RQYXRoKTtcbiAgLy8gdG9wLWxldmVsIGZvbGRlcnMgbXVzdCBnbyBmaXJzdFxuICBjb25zdCBmb2xkZXJzVG9QdXNoQnlIaWVyYXJjaHkgPSBmb2xkZXJzVG9QdXNoXG4gICAgLnNvcnQoKGEsIGIpID0+IGEuc3BsaXQocGF0aC5zZXApLmxlbmd0aCAtIGIuc3BsaXQocGF0aC5zZXApLmxlbmd0aCk7XG4gIGZvciAoY29uc3QgcmVsYXRpdmVGb2xkZXJQYXRoIG9mIGZvbGRlcnNUb1B1c2hCeUhpZXJhcmNoeSkge1xuICAgIC8vIGNyZWF0ZURpcmVjdG9yeSBkb2VzIG5vdCBhY2NlcHQgZm9sZGVyIG5hbWVzIGVuZGluZyB3aXRoIGEgcGF0aCBzZXBhcmF0b3JcbiAgICBjb25zdCBhYnNvbHV0ZUZvbGRlclBhdGggPSBfLnRyaW1FbmQoXG4gICAgICBwYXRoLmpvaW4oZHN0Um9vdFBhdGgsIHJlbGF0aXZlRm9sZGVyUGF0aCksIHBhdGguc2VwXG4gICAgKTtcbiAgICBpZiAoYWJzb2x1dGVGb2xkZXJQYXRoKSB7XG4gICAgICBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZURpcmVjdG9yeShhYnNvbHV0ZUZvbGRlclBhdGgpO1xuICAgIH1cbiAgfVxuICAvLyBkbyBub3QgZm9yZ2V0IGFib3V0IHRoZSByb290IGZvbGRlclxuICBsb2cuZGVidWcoYFN1Y2Nlc3NmdWxseSBjcmVhdGVkIHRoZSByZW1vdGUgZm9sZGVyIHN0cnVjdHVyZSBgICtcbiAgICBgKCR7dXRpbC5wbHVyYWxpemUoJ2l0ZW0nLCBmb2xkZXJzVG9QdXNoLmxlbmd0aCArIDEsIHRydWUpfSlgKTtcblxuICBjb25zdCBwdXNoRmlsZSA9IGFzeW5jIChyZWxhdGl2ZVBhdGgpID0+IHtcbiAgICBjb25zdCBhYnNvbHV0ZVNvdXJjZVBhdGggPSBwYXRoLmpvaW4oc3JjUm9vdFBhdGgsIHJlbGF0aXZlUGF0aCk7XG4gICAgY29uc3QgcmVhZFN0cmVhbSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oYWJzb2x1dGVTb3VyY2VQYXRoLCB7YXV0b0Nsb3NlOiB0cnVlfSk7XG4gICAgY29uc3QgYWJzb2x1dGVEZXN0aW5hdGlvblBhdGggPSBwYXRoLmpvaW4oZHN0Um9vdFBhdGgsIHJlbGF0aXZlUGF0aCk7XG4gICAgY29uc3Qgd3JpdGVTdHJlYW0gPSBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZVdyaXRlU3RyZWFtKGFic29sdXRlRGVzdGluYXRpb25QYXRoLCB7XG4gICAgICBhdXRvRGVzdHJveTogdHJ1ZVxuICAgIH0pO1xuICAgIHdyaXRlU3RyZWFtLm9uKCdmaW5pc2gnLCB3cml0ZVN0cmVhbS5kZXN0cm95KTtcbiAgICBsZXQgcHVzaEVycm9yID0gbnVsbDtcbiAgICBjb25zdCBmaWxlUHVzaFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB3cml0ZVN0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgIGlmIChwdXNoRXJyb3IpIHtcbiAgICAgICAgICByZWplY3QocHVzaEVycm9yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgY29uc3Qgb25TdHJlYW1FcnJvciA9IChlKSA9PiB7XG4gICAgICAgIHJlYWRTdHJlYW0udW5waXBlKHdyaXRlU3RyZWFtKTtcbiAgICAgICAgbG9nLmRlYnVnKGUpO1xuICAgICAgICBwdXNoRXJyb3IgPSBlO1xuICAgICAgfTtcbiAgICAgIHdyaXRlU3RyZWFtLm9uKCdlcnJvcicsIG9uU3RyZWFtRXJyb3IpO1xuICAgICAgcmVhZFN0cmVhbS5vbignZXJyb3InLCBvblN0cmVhbUVycm9yKTtcbiAgICB9KTtcbiAgICByZWFkU3RyZWFtLnBpcGUod3JpdGVTdHJlYW0pO1xuICAgIGF3YWl0IGZpbGVQdXNoUHJvbWlzZS50aW1lb3V0KHRpbWVvdXRNcyk7XG4gIH07XG5cbiAgaWYgKGVuYWJsZVBhcmFsbGVsUHVzaCkge1xuICAgIGxvZy5kZWJ1ZyhgUHJvY2VlZGluZyB0byBwYXJhbGxlbCBmaWxlcyBwdXNoIChtYXggJHtNQVhfSU9fQ0hVTktfU0laRX0gd3JpdGVycylgKTtcbiAgICBjb25zdCBwdXNoUHJvbWlzZXMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IHJlbGF0aXZlRmlsZVBhdGggb2YgXy5zaHVmZmxlKGZpbGVzVG9QdXNoKSkge1xuICAgICAgcHVzaFByb21pc2VzLnB1c2goQi5yZXNvbHZlKHB1c2hGaWxlKHJlbGF0aXZlRmlsZVBhdGgpKSk7XG4gICAgICAvLyBrZWVwIHRoZSBwdXNoIHF1ZXVlIGZpbGxlZFxuICAgICAgaWYgKHB1c2hQcm9taXNlcy5sZW5ndGggPj0gTUFYX0lPX0NIVU5LX1NJWkUpIHtcbiAgICAgICAgYXdhaXQgQi5hbnkocHVzaFByb21pc2VzKTtcbiAgICAgIH1cbiAgICAgIF8ucmVtb3ZlKHB1c2hQcm9taXNlcywgKHApID0+IHAuaXNGdWxmaWxsZWQoKSk7XG4gICAgfVxuICAgIGlmICghXy5pc0VtcHR5KHB1c2hQcm9taXNlcykpIHtcbiAgICAgIC8vIGhhbmRsZSB0aGUgcmVzdCBvZiBwdXNoIHByb21pc2VzXG4gICAgICBhd2FpdCBCLmFsbChwdXNoUHJvbWlzZXMpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsb2cuZGVidWcoYFByb2NlZWRpbmcgdG8gc2VyaWFsIGZpbGVzIHB1c2hgKTtcbiAgICBmb3IgKGNvbnN0IHJlbGF0aXZlRmlsZVBhdGggb2YgZmlsZXNUb1B1c2gpIHtcbiAgICAgIGF3YWl0IHB1c2hGaWxlKHJlbGF0aXZlRmlsZVBhdGgpO1xuICAgIH1cbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgU3VjY2Vzc2Z1bGx5IHB1c2hlZCAke3V0aWwucGx1cmFsaXplKCdmb2xkZXInLCBmb2xkZXJzVG9QdXNoLmxlbmd0aCwgdHJ1ZSl9IGAgK1xuICAgIGBhbmQgJHt1dGlsLnBsdXJhbGl6ZSgnZmlsZScsIGZpbGVzVG9QdXNoLmxlbmd0aCwgdHJ1ZSl9IGAgK1xuICAgIGB3aXRoaW4gJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbn1cblxuXG5leHBvcnQgeyBwdWxsRmlsZSwgcHVsbEZvbGRlciwgcHVzaEZpbGUsIHB1c2hGb2xkZXIgfTsiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsSUFBQUEsT0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsU0FBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUUsUUFBQSxHQUFBRixPQUFBO0FBQ0EsSUFBQUcsS0FBQSxHQUFBSixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUksT0FBQSxHQUFBTCxzQkFBQSxDQUFBQyxPQUFBO0FBRUEsTUFBTUssYUFBYSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSTtBQUduQyxNQUFNQyxpQkFBaUIsR0FBRyxDQUFDO0FBVTNCLGVBQWVDLFFBQVFBLENBQUVDLFVBQVUsRUFBRUMsVUFBVSxFQUFFO0VBQy9DLE1BQU1DLE1BQU0sR0FBRyxNQUFNRixVQUFVLENBQUNHLGdCQUFnQixDQUFDRixVQUFVLEVBQUU7SUFBRUcsV0FBVyxFQUFFO0VBQUssQ0FBQyxDQUFDO0VBQ25GLE1BQU1DLFdBQVcsR0FBRyxJQUFJQyxpQkFBQyxDQUFDLENBQUNDLE9BQU8sRUFBRUMsTUFBTSxLQUFLO0lBQzdDTixNQUFNLENBQUNPLEVBQUUsQ0FBQyxPQUFPLEVBQUVGLE9BQU8sQ0FBQztJQUMzQkwsTUFBTSxDQUFDTyxFQUFFLENBQUMsT0FBTyxFQUFFRCxNQUFNLENBQUM7RUFDNUIsQ0FBQyxDQUFDLENBQUNFLE9BQU8sQ0FBQ2IsYUFBYSxDQUFDO0VBQ3pCLE1BQU1jLE9BQU8sR0FBRyxFQUFFO0VBQ2xCVCxNQUFNLENBQUNPLEVBQUUsQ0FBQyxNQUFNLEVBQUdHLElBQUksSUFBS0QsT0FBTyxDQUFDRSxJQUFJLENBQUNELElBQUksQ0FBQyxDQUFDO0VBQy9DLE1BQU1QLFdBQVc7RUFDakIsT0FBT1MsTUFBTSxDQUFDQyxNQUFNLENBQUNKLE9BQU8sQ0FBQztBQUMvQjtBQVFBLGVB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