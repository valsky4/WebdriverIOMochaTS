{"version":3,"file":"py-ios-device-client.js","names":["_teen_process","require","_support","_logger","_interopRequireDefault","_path","BINARY_NAME","Pyidevice","constructor","udid","binaryPath","assertExists","isStrict","fs","which","e","Error","execute","args","opts","cwd","format","logStdout","asynchronous","finalArgs","push","cmdStr","util","quote","log","debug","result","SubProcess","start","exec","stdout","stderr","message","listProfiles","JSON","parse","installProfile","profilePath","payload","tmpRoot","srcPath","tempDir","openDir","path","join","writeFile","rimraf","removeProfile","name","listCrashes","replace","filter","x","includes","exportCrash","dstFolder","collectPcap","dstFile","exports","_default","default"],"sources":["../../lib/py-ios-device-client.js"],"sourcesContent":["import { exec, SubProcess } from 'teen_process';\nimport { fs, util, tempDir } from 'appium/support';\nimport log from './logger';\nimport path from 'path';\n\n// https://github.com/YueChen-C/py-ios-device\n\nconst BINARY_NAME = 'pyidevice';\n\nclass Pyidevice {\n  constructor (udid) {\n    this.udid = udid;\n    this.binaryPath = null;\n  }\n\n  async assertExists (isStrict = true) {\n    if (this.binaryPath) {\n      return true;\n    }\n\n    try {\n      this.binaryPath = await fs.which(BINARY_NAME);\n      return true;\n    } catch (e) {\n      if (isStrict) {\n        throw new Error(`${BINARY_NAME} binary cannot be found in PATH. ` +\n          `Please make sure it is installed. Visit https://github.com/YueChen-C/py-ios-device for ` +\n          `more details.`);\n      }\n      return false;\n    }\n  }\n\n  async execute (args, opts = {}) {\n    await this.assertExists();\n    const {\n      cwd,\n      format = 'json',\n      logStdout = false,\n      asynchronous = false,\n    } = opts;\n\n    const finalArgs = [...args, '--udid', this.udid];\n    if (format) {\n      finalArgs.push('--format', format);\n    }\n    const cmdStr = util.quote([this.binaryPath, ...finalArgs]);\n    log.debug(`Executing ${cmdStr}`);\n    try {\n      if (asynchronous) {\n        const result = new SubProcess(this.binaryPath, finalArgs, {cwd});\n        await result.start(0);\n        return result;\n      }\n      const result = await exec(this.binaryPath, finalArgs, {cwd});\n      if (logStdout) {\n        log.debug(`Command output: ${result.stdout}`);\n      }\n      return result;\n    } catch (e) {\n      throw new Error(`'${cmdStr}' failed. Original error: ${e.stderr || e.stdout || e.message}`);\n    }\n  }\n\n  async listProfiles () {\n    const {stdout} = await this.execute(['profiles', 'list']);\n    return JSON.parse(stdout);\n  }\n\n  async installProfile ({profilePath, payload} = {}) {\n    if (!profilePath && !payload) {\n      throw new Error('Either the full path to the profile or its payload must be provided');\n    }\n\n    let tmpRoot;\n    let srcPath = profilePath;\n    try {\n      if (!srcPath) {\n        tmpRoot = await tempDir.openDir();\n        srcPath = path.join(tmpRoot, 'cert.pem');\n        await fs.writeFile(srcPath, payload, 'utf8');\n      }\n      await this.execute(['profiles', 'install', '--path', srcPath], {\n        logStdout: true\n      });\n    } finally {\n      if (tmpRoot) {\n        await fs.rimraf(tmpRoot);\n      }\n    }\n  }\n\n  async removeProfile (name) {\n    await this.execute(['profiles', 'remove', name], {logStdout: true});\n  }\n\n  async listCrashes () {\n    const {stdout} = await this.execute(['crash', 'list']);\n    return JSON.parse(stdout.replace(/'/g, '\"')).filter((x) => !['.', '..'].includes(x));\n  }\n\n  async exportCrash (name, dstFolder) {\n    await this.execute(['crash', 'export', '--name', name], {\n      logStdout: true,\n      // The tool exports crash reports to the current working dir\n      cwd: dstFolder\n    });\n  }\n\n  async collectPcap (dstFile) {\n    return await this.execute(['pcapd', dstFile], {\n      format: null,\n      asynchronous: true\n    });\n  }\n}\n\nexport { Pyidevice };\nexport default Pyidevice;\n"],"mappings":";;;;;;;;AAAA,IAAAA,aAAA,GAAAC,OAAA;AACA,IAAAC,QAAA,GAAAD,OAAA;AACA,IAAAE,OAAA,GAAAC,sBAAA,CAAAH,OAAA;AACA,IAAAI,KAAA,GAAAD,sBAAA,CAAAH,OAAA;AAIA,MAAMK,WAAW,GAAG,WAAW;AAE/B,MAAMC,SAAS,CAAC;EACdC,WAAWA,CAAEC,IAAI,EAAE;IACjB,IAAI,CAACA,IAAI,GAAGA,IAAI;IAChB,IAAI,CAACC,UAAU,GAAG,IAAI;EACxB;EAEA,MAAMC,YAAYA,CAAEC,QAAQ,GAAG,IAAI,EAAE;IACnC,IAAI,IAAI,CAACF,UAAU,EAAE;MACnB,OAAO,IAAI;IACb;IAEA,IAAI;MACF,IAAI,CAACA,UAAU,GAAG,MAAMG,WAAE,CAACC,KAAK,CAACR,WAAW,CAAC;MAC7C,OAAO,IAAI;IACb,CAAC,CAAC,OAAOS,CAAC,EAAE;MACV,IAAIH,QAAQ,EAAE;QACZ,MAAM,IAAII,KAAK,CAAE,GAAEV,WAAY,mCAAkC,GAC9D,yFAAwF,GACxF,eAAc,CAAC;MACpB;MACA,OAAO,KAAK;IACd;EACF;EAEA,MAAMW,OAAOA,CAAEC,IAAI,EAAEC,IAAI,GAAG,CAAC,CAAC,EAAE;IAC9B,MAAM,IAAI,CAACR,YAAY,EAAE;IACzB,MAAM;MACJS,GAAG;MACHC,MAAM,GAAG,MAAM;MACfC,SAAS,GAAG,KAAK;MACjBC,YAAY,GAAG;IACjB,CAAC,GAAGJ,IAAI;IAER,MAAMK,SAAS,GAAG,CAAC,GAAGN,IAAI,EAAE,QAAQ,EAAE,IAAI,CAACT,IAAI,CAAC;IAChD,IAAIY,MAAM,EAAE;MACVG,SAAS,CAACC,IAAI,CAAC,UAAU,EAAEJ,MAAM,CAAC;IACpC;IACA,MAAMK,MAAM,GAAGC,aAAI,CAACC,KAAK,CAAC,CAAC,IAAI,CAAClB,UAAU,EAAE,GAAGc,SAAS,CAAC,CAAC;IAC1DK,eAAG,CAACC,KAAK,CAAE,aAAYJ,MAAO,EAAC,CAAC;IAChC,IAAI;MACF,IAAIH,YAAY,EAAE;QAChB,MAAMQ,MAAM,GAAG,IAAIC,wBAAU,CAAC,IAAI,CAACtB,UAAU,EAAEc,SAAS,EAAE;UAACJ;QAAG,CAAC,CAAC;QAChE,MAAMW,MAAM,CAACE,KAAK,CAAC,CAAC,CAAC;QACrB,OAAOF,MAAM;MACf;MACA,MAAMA,MAAM,GAAG,MAAM,IAAAG,kBAAI,EAAC,IAAI,CAACxB,UAAU,EAAEc,SAAS,EAAE;QAACJ;MAAG,CAAC,CAAC;MAC5D,IAAIE,SAAS,EAAE;QACbO,eAAG,CAACC,KAAK,CAAE,mBAAkBC,MAAM,CAACI,MAAO,EAAC,CAAC;MAC/C;MACA,OAAOJ,MAAM;IACf,CAAC,CAAC,OAAOhB,CAAC,EAAE;MACV,MAAM,IAAIC,KAAK,CAAE,IAAGU,MAAO,6BAA4BX,CAAC,CAACqB,MAAM,IAAIrB,CAAC,CAACoB,MAAM,IAAIpB,CAAC,CAACsB,OAAQ,EAAC,CAAC;IAC7F;EACF;EAEA,MAAMC,YAAYA,CAAA,EAAI;IACpB,MAAM;MAACH;IAAM,CAAC,GAAG,MAAM,IAAI,CAAClB,OAAO,CAAC,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC;IACzD,OAAOsB,IAAI,CAACC,KAAK,CAACL,MAAM,CAAC;EAC3B;EAEA,MAAMM,cAAcA,CAAE;IAACC,WAAW;IAAEC;EAAO,CAAC,GAAG,CAAC,CAAC,EAAE;IACjD,IAAI,CAACD,WAAW,IAAI,CAACC,OAAO,EAAE;MAC5B,MAAM,IAAI3B,KAAK,CAAC,qEAAqE,CAAC;IACxF;IAEA,IAAI4B,OAAO;IACX,IAAIC,OAAO,GAAGH,WAAW;IACzB,IAAI;MACF,IAAI,CAACG,OAAO,EAAE;QACZD,OAAO,GAAG,MAAME,gBAAO,CAACC,OAAO,EAAE;QACjCF,OAAO,GAAGG,aAAI,CAACC,IAAI,CAACL,OAAO,EAAE,UAAU,CAAC;QACxC,MAAM/B,WAAE,CAACqC,SAAS,CAACL,OAAO,EAAEF,OAAO,EAAE,MAAM,CAAC;MAC9C;MACA,MAAM,IAAI,CAAC1B,OAAO,CAAC,CAAC,UAAU,EAAE,SAAS,EAAE,QAAQ,EAAE4B,OAAO,CAAC,EAAE;QAC7DvB,SAAS,EAAE;MACb,CAAC,CAAC;IACJ,CAAC,SAAS;MACR,IAAIsB,OAAO,EAAE;QACX,MAAM/B,WAAE,CAACsC,MAAM,CAACP,OAAO,CAAC;MAC1B;IACF;EACF;EAEA,MAAMQ,aAAaA,CAAEC,IAAI,EAAE;IACzB,MAAM,IAAI,CAACpC,OAAO,CAAC,CAAC,UAAU,EAAE,QAAQ,EAAEoC,IAAI,CAAC,EAAE;MAAC/B,SAAS,EAAE;IAAI,CAAC,CAAC;EACrE;EAEA,MAAMgC,WAAWA,CAAA,EAAI;IACnB,MAAM;MAACnB;IAAM,CAAC,GAAG,MAAM,IAAI,CAAClB,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;IACtD,OAAOsB,IAAI,CAACC,KAAK,CAACL,MAAM,CAACoB,OAAO,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC,CAACC,MAAM,CAAEC,CAAC,IAAK,CAAC,CAAC,GAAG,EAAE,IAAI,CAAC,CAACC,QAAQ,CAACD,CAAC,CAAC,CAAC;EACtF;EAEA,MAAME,WAAWA,CAAEN,IAAI,EAAEO,SAAS,EAAE;IAClC,MAAM,IAAI,CAAC3C,OAAO,CAAC,CAAC,OAAO,EAAE,QAAQ,EAAE,QAAQ,EAAEoC,IAAI,CAAC,EAAE;MACtD/B,SAAS,EAAE,IAAI;MAEfF,GAAG,EAAEwC;IACP,CAAC,CAAC;EACJ;EAEA,MAAMC,WAAWA,CAAEC,OAAO,EAAE;IAC1B,OAAO,MAAM,IAAI,CAAC7C,OAAO,CAAC,CAAC,OAAO,EAAE6C,OAAO,CAAC,EAAE;MAC5CzC,MAAM,EAAE,IAAI;MACZE,YAAY,EAAE;IAChB,CAAC,CAAC;EACJ;AACF;AAACwC,OAAA,CAAAxD,SAAA,GAAAA,SAAA;AAAA,IAAAyD,QAAA,GAGczD,SAAS;AAAAwD,OAAA,CAAAE,OAAA,GAAAD,QAAA"}