"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _support = require("@appium/support");
var _teen_process = require("teen_process");
var _lodash = _interopRequireDefault(require("lodash"));
var _asyncbox = require("asyncbox");
var _helpers = require("../helpers");
var _logger = _interopRequireDefault(require("../logger.js"));
const COMPANION_PGREP_PATTERN = udid => `${_helpers.IDB_COMPANION_EXECUTABLE}.*--udid[[:space:]]+${udid}`;
const systemCallMethods = {};
systemCallMethods.connect = async function connect(opts = {}) {
  const {
    onlineTimeout
  } = opts;
  const binaryPaths = {};
  for (const binary of [_helpers.IDB_EXECUTABLE, _helpers.IDB_COMPANION_EXECUTABLE]) {
    try {
      binaryPaths[binary] = await _support.fs.which(binary);
    } catch (e) {
      throw new Error(`'${binary}' has not been found in PATH. ` + `Is it installed? Read https://www.fbidb.io for more details`);
    }
  }
  _logger.default.debug(`Starting and connecting companion: '${binaryPaths[_helpers.IDB_COMPANION_EXECUTABLE]}'`);
  try {
    try {
      await (0, _teen_process.exec)(_helpers.IDB_EXECUTABLE, ['connect', this.udid]);
    } catch (connectionError) {
      await (0, _asyncbox.retryInterval)(2, 100, async () => {
        await this.disconnect();
        try {
          await (0, _teen_process.exec)(_helpers.IDB_EXECUTABLE, ['kill']);
        } catch (ign) {}
        await (0, _teen_process.exec)(_helpers.IDB_EXECUTABLE, ['connect', this.udid]);
      });
    }
  } catch (e) {
    if (e.stderr || e.stdout) {
      _logger.default.debug(e.stderr || e.stdout);
    }
    throw new Error(`Cannot start ${_helpers.IDB_EXECUTABLE} service for the device '${this.udid}'. ` + `Check the server log for more details.`);
  }
  _logger.default.info(`Successfully established the connection to ${_helpers.IDB_EXECUTABLE} service for '${this.udid}'`);
  if (onlineTimeout) {
    await this.waitForDevice(onlineTimeout);
  }
  this.executable.path = binaryPaths[_helpers.IDB_EXECUTABLE];
  this.companion.path = binaryPaths[_helpers.IDB_COMPANION_EXECUTABLE];
};
systemCallMethods.waitForDevice = async function waitForDevice(timeoutMs = 10000) {
  if (!timeoutMs) {
    _logger.default.debug('No timeout is provided, so not waiting until the device is online');
    return;
  }
  _logger.default.debug(`Waiting up to ${timeoutMs}ms for the device to be online`);
  const timer = new _support.timing.Timer().start();
  let lastError = null;
  try {
    await (0, _asyncbox.waitForCondition)(async () => {
      try {
        await this.exec(['ui', 'describe-all']);
        return true;
      } catch (e) {
        lastError = e.stderr || e.message;
        return false;
      }
    }, {
      waitMs: timeoutMs,
      intervalMs: 300
    });
  } catch (e) {
    throw new Error(`The device '${this.udid}' is not responding to idb requests after ${timeoutMs}ms timeout. ` + `Original error: ${lastError || e.message}`);
  }
  _logger.default.debug(`The device '${this.udid}' is online and ready to accept idb commands in ` + `${timer.getDuration().asSeconds.toFixed(3)}s`);
};
systemCallMethods.disconnect = async function disconnect() {
  _logger.default.debug(`Disconnecting ${_helpers.IDB_EXECUTABLE} service from '${this.udid}'`);
  try {
    await (0, _teen_process.exec)(this.executable.path, ['disconnect', this.udid]);
  } catch (ign) {}
  const companionPids = await (0, _helpers.getPids)(COMPANION_PGREP_PATTERN(this.udid));
  if (_lodash.default.isEmpty(companionPids)) {
    return;
  }
  _logger.default.debug(`Cleaning up ${companionPids.length} obsolete ${_helpers.IDB_COMPANION_EXECUTABLE} ` + `process${companionPids.length === 1 ? '' : 'es'}`);
  await (0, _teen_process.exec)('kill', ['-2', ...companionPids]);
};
systemCallMethods.exec = async function exec(cmd, args = [], opts = {}) {
  if (!cmd) {
    throw new Error('You need to pass in a command to exec()');
  }
  cmd = _lodash.default.isArray(cmd) ? cmd : [cmd];
  opts = _lodash.default.cloneDeep(opts);
  opts.timeout = opts.timeout || this.execTimeout || _helpers.DEFAULT_IDB_EXEC_TIMEOUT;
  opts.timeoutCapName = opts.timeoutCapName || 'execTimeout';
  const fullArgs = [...cmd, ...this.executable.defaultArgs, ...args];
  _logger.default.debug(`Running '${this.executable.path} ${_support.util.quote(fullArgs)}'`);
  try {
    const {
      stdout
    } = await (0, _teen_process.exec)(this.executable.path, fullArgs, opts);
    return stdout;
  } catch (e) {
    if (_support.util.hasValue(e.code)) {
      e.message = `Error executing ${_helpers.IDB_EXECUTABLE}. Original error: '${e.message}'; ` + `Stdout: '${(e.stdout || '').trim()}'; ` + `Stderr: '${(e.stderr || '').trim()}'; ` + `Code: '${e.code}'`;
    } else {
      e.message = `Error executing ${_helpers.IDB_EXECUTABLE}. Original error: '${e.message}'. ` + `Try to increase the ${opts.timeout}ms ${_helpers.IDB_EXECUTABLE} execution timeout represented by '${opts.timeoutCapName}' capability`;
    }
    throw e;
  }
};
systemCallMethods.createSubProcess = function createSubProcess(command = [], args = [], opts = {}) {
  const idbArgs = [...command, ...this.executable.defaultArgs, ...args];
  _logger.default.debug(`Creating ${_helpers.IDB_EXECUTABLE} subprocess with args: ${_support.util.quote(args)}`);
  return new _teen_process.SubProcess(this.executable.path, idbArgs, opts);
};
var _default = systemCallMethods;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDT01QQU5JT05fUEdSRVBfUEFUVEVSTiIsInVkaWQiLCJJREJfQ09NUEFOSU9OX0VYRUNVVEFCTEUiLCJzeXN0ZW1DYWxsTWV0aG9kcyIsImNvbm5lY3QiLCJvcHRzIiwib25saW5lVGltZW91dCIsImJpbmFyeVBhdGhzIiwiYmluYXJ5IiwiSURCX0VYRUNVVEFCTEUiLCJmcyIsIndoaWNoIiwiZSIsIkVycm9yIiwibG9nIiwiZGVidWciLCJ0cEV4ZWMiLCJjb25uZWN0aW9uRXJyb3IiLCJyZXRyeUludGVydmFsIiwiZGlzY29ubmVjdCIsImlnbiIsInN0ZGVyciIsInN0ZG91dCIsImluZm8iLCJ3YWl0Rm9yRGV2aWNlIiwiZXhlY3V0YWJsZSIsInBhdGgiLCJjb21wYW5pb24iLCJ0aW1lb3V0TXMiLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJsYXN0RXJyb3IiLCJ3YWl0Rm9yQ29uZGl0aW9uIiwiZXhlYyIsIm1lc3NhZ2UiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwiZ2V0RHVyYXRpb24iLCJhc1NlY29uZHMiLCJ0b0ZpeGVkIiwiY29tcGFuaW9uUGlkcyIsImdldFBpZHMiLCJfIiwiaXNFbXB0eSIsImxlbmd0aCIsImNtZCIsImFyZ3MiLCJpc0FycmF5IiwiY2xvbmVEZWVwIiwidGltZW91dCIsImV4ZWNUaW1lb3V0IiwiREVGQVVMVF9JREJfRVhFQ19USU1FT1VUIiwidGltZW91dENhcE5hbWUiLCJmdWxsQXJncyIsImRlZmF1bHRBcmdzIiwidXRpbCIsInF1b3RlIiwiaGFzVmFsdWUiLCJjb2RlIiwidHJpbSIsImNyZWF0ZVN1YlByb2Nlc3MiLCJjb21tYW5kIiwiaWRiQXJncyIsIlN1YlByb2Nlc3MiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvdG9vbHMvc3lzdGVtLWNvbW1hbmRzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzLCB1dGlsLCB0aW1pbmcgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyBhcyB0cEV4ZWMsIFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwsIHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQge1xuICBnZXRQaWRzLCBERUZBVUxUX0lEQl9FWEVDX1RJTUVPVVQsIElEQl9FWEVDVVRBQkxFLFxuICBJREJfQ09NUEFOSU9OX0VYRUNVVEFCTEUsXG59IGZyb20gJy4uL2hlbHBlcnMnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXIuanMnO1xuXG5cbmNvbnN0IENPTVBBTklPTl9QR1JFUF9QQVRURVJOID0gKHVkaWQpID0+XG4gIGAke0lEQl9DT01QQU5JT05fRVhFQ1VUQUJMRX0uKi0tdWRpZFtbOnNwYWNlOl1dKyR7dWRpZH1gO1xuXG5jb25zdCBzeXN0ZW1DYWxsTWV0aG9kcyA9IHt9O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENvbm5lY3RPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/bnVtYmVyfSBvbmxpbmVUaW1lb3V0IC0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdFxuICogdW50aWwgdGhlIGRldmljZSB1bmRlciB0ZXN0cyBpcyBvbmxpbmUuIE5vIHdhaXQgaXMgZ29pbmcgdG8gYmUgcGVyZm9ybWVkXG4gKiBpZiB0aGUgdGltZW91dCBpcyBub3Qgc2V0LiBJdCBpcyByZWNvbW1lbmRlZCB0byBwcm92aWRlIHRoaXMgdmFsdWUgaWZcbiAqIGBjb25uZWN0YCBpcyBjYWxsZWQgcmlnaHQgYWZ0ZXIgZGV2aWNlIGlzIGJvb3RlZCwgc28gbm90IGFsbCB0aGUgcmVxdWlyZWRcbiAqIGRldmljZSBzZXJ2aWNlcyBoYXZlIGJlZW4gc3RhcnRlZCB5ZXQuXG4gKi9cblxuLyoqXG4gKiBJbml0aWFsaXplcyBpZGIgYW5kIGNvbXBhbmlvbiBwcm9jZXNzZXMgaWYgbmVjZXNzYXJ5IGFuZFxuICogYXNzaWducyBwYXRoIHByb3BlcnRpZXMuIEl0IGlzIG1hbmRhdG9yeSB0byBjYWxsIHRoaXMgbWV0aG9kIGJlZm9yZVxuICogb25lIGNhbiBzdGFydCB1c2luZyBJREIgaW5zdGFuY2UsXG4gKlxuICogQHRocm93cyB7RXJyb3J9IElmIG1hbmRhdG9yeSBpZGIgZXhlY3V0YWJsZXMgYXJlIG5vdCBwcmVzZW50IG9uIHRoZVxuICogbG9jYWxob3N0IG9yIHRoZXJlIHdhcyBhIGZhaWx1cmUgd2hpbGUgc3RhcnRpbmcvZGV0ZWN0aW5nIHRoZW1cbiAqL1xuc3lzdGVtQ2FsbE1ldGhvZHMuY29ubmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGNvbm5lY3QgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgb25saW5lVGltZW91dCxcbiAgfSA9IG9wdHM7XG5cbiAgY29uc3QgYmluYXJ5UGF0aHMgPSB7fTtcbiAgZm9yIChjb25zdCBiaW5hcnkgb2YgW0lEQl9FWEVDVVRBQkxFLCBJREJfQ09NUEFOSU9OX0VYRUNVVEFCTEVdKSB7XG4gICAgdHJ5IHtcbiAgICAgIGJpbmFyeVBhdGhzW2JpbmFyeV0gPSBhd2FpdCBmcy53aGljaChiaW5hcnkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJyR7YmluYXJ5fScgaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIGAgK1xuICAgICAgICBgSXMgaXQgaW5zdGFsbGVkPyBSZWFkIGh0dHBzOi8vd3d3LmZiaWRiLmlvIGZvciBtb3JlIGRldGFpbHNgKTtcbiAgICB9XG4gIH1cblxuICBsb2cuZGVidWcoYFN0YXJ0aW5nIGFuZCBjb25uZWN0aW5nIGNvbXBhbmlvbjogJyR7YmluYXJ5UGF0aHNbSURCX0NPTVBBTklPTl9FWEVDVVRBQkxFXX0nYCk7XG5cbiAgdHJ5IHtcbiAgICB0cnkge1xuICAgICAgLy8gaWRiIGNvbm5lY3QgY29tbWFuZCBsb29rcyBmb3IgYSBydW5uaW5nIGlkYl9jb21wYW5pb24gcHJvY2VzcyB0aGF0IGFzc29jaWF0ZXMgd2l0aCBzcGVjaWZpZWQgdWRpZC5cbiAgICAgIC8vIElmIG5vdCBmb3VuZCwgdGhlIGNvbW1hbmQgYXR0ZW1wdHMgdG8gc3RhcnQgdGhlIG5ldyBpZGJfY29tcGFuaW9uIHByb2Nlc3MgdGhhdCBsaXN0ZW5zIG9uIGFuIFVuaXggZG9tYWluIHNvY2tldC5cbiAgICAgIGF3YWl0IHRwRXhlYyhJREJfRVhFQ1VUQUJMRSwgWydjb25uZWN0JywgdGhpcy51ZGlkXSk7XG4gICAgfSBjYXRjaCAoY29ubmVjdGlvbkVycm9yKSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDIsIDEwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0cEV4ZWMoSURCX0VYRUNVVEFCTEUsIFsna2lsbCddKTtcbiAgICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgICBhd2FpdCB0cEV4ZWMoSURCX0VYRUNVVEFCTEUsIFsnY29ubmVjdCcsIHRoaXMudWRpZF0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGUuc3RkZXJyIHx8IGUuc3Rkb3V0KSB7XG4gICAgICBsb2cuZGVidWcoZS5zdGRlcnIgfHwgZS5zdGRvdXQpO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBzdGFydCAke0lEQl9FWEVDVVRBQkxFfSBzZXJ2aWNlIGZvciB0aGUgZGV2aWNlICcke3RoaXMudWRpZH0nLiBgICtcbiAgICAgIGBDaGVjayB0aGUgc2VydmVyIGxvZyBmb3IgbW9yZSBkZXRhaWxzLmApO1xuICB9XG4gIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQgdGhlIGNvbm5lY3Rpb24gdG8gJHtJREJfRVhFQ1VUQUJMRX0gc2VydmljZSBmb3IgJyR7dGhpcy51ZGlkfSdgKTtcblxuICBpZiAob25saW5lVGltZW91dCkge1xuICAgIGF3YWl0IHRoaXMud2FpdEZvckRldmljZShvbmxpbmVUaW1lb3V0KTtcbiAgfVxuXG4gIHRoaXMuZXhlY3V0YWJsZS5wYXRoID0gYmluYXJ5UGF0aHNbSURCX0VYRUNVVEFCTEVdO1xuICB0aGlzLmNvbXBhbmlvbi5wYXRoID0gYmluYXJ5UGF0aHNbSURCX0NPTVBBTklPTl9FWEVDVVRBQkxFXTtcbn07XG5cbi8qKlxuICogQmxvY2tzIHVudGlsIHRoZSBkZXZpY2UgdW5kZXIgdGVzdCBzdGFydHMgcmVzcG9uZGluZyB0byBpZGIgY29tbWFuZHMuXG4gKiBUaGUgZGV2aWNlIG11c3QgYmUgYm9vdGVkL29ubGluZSBhbmQgaWRiIG11c3QgYmUgYWxyZWFkeSBjb25uZWN0ZWQgZm9yIHRoYXQgdG8gaGFwcGVuXG4gKlxuICogQHBhcmFtIHs/bnVtYmVyfSB0aW1lb3V0TXMgWzEwMDAwXSAtIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXRcbiAqIHVudGlsIHRoZSBkZXZpY2UgdW5kZXIgdGVzdHMgaXMgb25saW5lLiBUaGUgbWV0aG9kIHdpbGwgcmV0dXJuIGltbWVkaWF0ZWx5XG4gKiBpZiB0aGUgdGltZW91dCBpcyBmYWxzeVxuICogQHRocm93cyB7RXJyb3J9IGlmIHRoZSBkZXZpY2UgaXMgbm90IHJlc3BvbmRpbmcgd2l0aGluIHRoZSBnaXZlbiB0aW1lb3V0XG4gKi9cbnN5c3RlbUNhbGxNZXRob2RzLndhaXRGb3JEZXZpY2UgPSBhc3luYyBmdW5jdGlvbiB3YWl0Rm9yRGV2aWNlICh0aW1lb3V0TXMgPSAxMDAwMCkge1xuICBpZiAoIXRpbWVvdXRNcykge1xuICAgIGxvZy5kZWJ1ZygnTm8gdGltZW91dCBpcyBwcm92aWRlZCwgc28gbm90IHdhaXRpbmcgdW50aWwgdGhlIGRldmljZSBpcyBvbmxpbmUnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoYFdhaXRpbmcgdXAgdG8gJHt0aW1lb3V0TXN9bXMgZm9yIHRoZSBkZXZpY2UgdG8gYmUgb25saW5lYCk7XG4gIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gIGxldCBsYXN0RXJyb3IgPSBudWxsO1xuICB0cnkge1xuICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5leGVjKFsndWknLCAnZGVzY3JpYmUtYWxsJ10pO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbGFzdEVycm9yID0gZS5zdGRlcnIgfHwgZS5tZXNzYWdlO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSwge1xuICAgICAgd2FpdE1zOiB0aW1lb3V0TXMsXG4gICAgICBpbnRlcnZhbE1zOiAzMDAsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBkZXZpY2UgJyR7dGhpcy51ZGlkfScgaXMgbm90IHJlc3BvbmRpbmcgdG8gaWRiIHJlcXVlc3RzIGFmdGVyICR7dGltZW91dE1zfW1zIHRpbWVvdXQuIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2xhc3RFcnJvciB8fCBlLm1lc3NhZ2V9YCk7XG4gIH1cbiAgbG9nLmRlYnVnKGBUaGUgZGV2aWNlICcke3RoaXMudWRpZH0nIGlzIG9ubGluZSBhbmQgcmVhZHkgdG8gYWNjZXB0IGlkYiBjb21tYW5kcyBpbiBgICtcbiAgICBgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcy50b0ZpeGVkKDMpfXNgKTtcbn07XG5cbi8qKlxuICogUGVyZm9ybXMgY2xlYW51cCBvZiBvYnNvbGV0ZSBjb21wYW5pb24gcHJvY2Vzc2VzXG4gKiBUaGUgZGFlbW9uIHByb2Nlc3MgaXMgbGVmdCB1bnRvdWNoZWQsIGJlY2F1c2Uga2lsbGluZyBpdCBtaWdodFxuICogcG90ZW50aWFsbHkgYWZmZWN0IG90aGVyIHBhcmFsbGVsIHNlc3Npb25zLiBOb3RoaW5nXG4gKiBpcyBkb25lIGlmIG5vIG9ic29sZXRlIHByb2Nlc3NlcyBhcmUgZm91bmQuXG4gKi9cbnN5c3RlbUNhbGxNZXRob2RzLmRpc2Nvbm5lY3QgPSBhc3luYyBmdW5jdGlvbiBkaXNjb25uZWN0ICgpIHtcbiAgbG9nLmRlYnVnKGBEaXNjb25uZWN0aW5nICR7SURCX0VYRUNVVEFCTEV9IHNlcnZpY2UgZnJvbSAnJHt0aGlzLnVkaWR9J2ApO1xuXG4gIHRyeSB7XG4gICAgLy8gaWRiIGRpc2Nvbm5lY3QganVzdCByZW1vdmVzIHRoZSBnaXZlbiB1ZGlkIGZyb20gaWRiIHN0YXRlLlxuICAgIC8vIEl0IGRvZXNuJ3Qga2lsbCB0aGUgaWRiX2NvbXBhbmlvbiBwcm9jZXNzIGFzc29jaWF0ZWQgd2l0aCB0aGUgdWRpZC5cbiAgICBhd2FpdCB0cEV4ZWModGhpcy5leGVjdXRhYmxlLnBhdGgsIFsnZGlzY29ubmVjdCcsIHRoaXMudWRpZF0pO1xuICB9IGNhdGNoIChpZ24pIHt9XG5cbiAgY29uc3QgY29tcGFuaW9uUGlkcyA9IGF3YWl0IGdldFBpZHMoQ09NUEFOSU9OX1BHUkVQX1BBVFRFUk4odGhpcy51ZGlkKSk7XG4gIGlmIChfLmlzRW1wdHkoY29tcGFuaW9uUGlkcykpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoYENsZWFuaW5nIHVwICR7Y29tcGFuaW9uUGlkcy5sZW5ndGh9IG9ic29sZXRlICR7SURCX0NPTVBBTklPTl9FWEVDVVRBQkxFfSBgICtcbiAgICBgcHJvY2VzcyR7Y29tcGFuaW9uUGlkcy5sZW5ndGggPT09IDEgPyAnJyA6ICdlcyd9YCk7XG4gIGF3YWl0IHRwRXhlYygna2lsbCcsIFsnLTInLCAuLi5jb21wYW5pb25QaWRzXSk7XG59O1xuXG4vKipcbiAqIEV4ZWN1dGUgdGhlIGdpdmVuIGlkYiBjb21tYW5kLlxuICpcbiAqIEBwYXJhbSB7QXJyYXkuPHN0cmluZz59IGNtZCAtIFRoZSBhY3R1YWwgaWRiIGNvbW1hbmQgd2l0aG91dCBhcmd1bWVudHMvcGFyYW1zLlxuICogQHBhcmFtIHtBcnJheTxzdHJpbmc+fSBhcmdzIC0gT3B0aW9uYWwgY29tbWFuZCBhcmd1bWVudHMuXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cyAtIEFkZGl0aW9uYWwgb3B0aW9ucyBtYXBwaW5nLiBTZWVcbiAqICAgICAgICAgICAgICAgICAgICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vbm9kZS10ZWVuX3Byb2Nlc3N9XG4gKiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBtb3JlIGRldGFpbHMuXG4gKiBAcmV0dXJuIHtzdHJpbmd9IC0gQ29tbWFuZCdzIHN0ZG91dC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgY29tbWFuZCByZXR1cm5lZCBub24temVybyBleGl0IGNvZGUuXG4gKi9cbnN5c3RlbUNhbGxNZXRob2RzLmV4ZWMgPSBhc3luYyBmdW5jdGlvbiBleGVjIChjbWQsIGFyZ3MgPSBbXSwgb3B0cyA9IHt9KSB7XG4gIGlmICghY21kKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbmVlZCB0byBwYXNzIGluIGEgY29tbWFuZCB0byBleGVjKCknKTtcbiAgfVxuICBjbWQgPSBfLmlzQXJyYXkoY21kKSA/IGNtZCA6IFtjbWRdO1xuXG4gIG9wdHMgPSBfLmNsb25lRGVlcChvcHRzKTtcbiAgLy8gc2V0dGluZyBkZWZhdWx0IHRpbWVvdXQgZm9yIGVhY2ggY29tbWFuZCB0byBwcmV2ZW50IGluZmluaXRlIHdhaXQuXG4gIG9wdHMudGltZW91dCA9IG9wdHMudGltZW91dCB8fCB0aGlzLmV4ZWNUaW1lb3V0IHx8IERFRkFVTFRfSURCX0VYRUNfVElNRU9VVDtcbiAgb3B0cy50aW1lb3V0Q2FwTmFtZSA9IG9wdHMudGltZW91dENhcE5hbWUgfHwgJ2V4ZWNUaW1lb3V0JzsgLy8gRm9yIGVycm9yIG1lc3NhZ2VcblxuICBjb25zdCBmdWxsQXJncyA9IFsuLi5jbWQsIC4uLnRoaXMuZXhlY3V0YWJsZS5kZWZhdWx0QXJncywgLi4uYXJnc107XG4gIGxvZy5kZWJ1ZyhgUnVubmluZyAnJHt0aGlzLmV4ZWN1dGFibGUucGF0aH0gJHt1dGlsLnF1b3RlKGZ1bGxBcmdzKX0nYCk7XG4gIHRyeSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCB0cEV4ZWModGhpcy5leGVjdXRhYmxlLnBhdGgsIGZ1bGxBcmdzLCBvcHRzKTtcbiAgICByZXR1cm4gc3Rkb3V0O1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUoZS5jb2RlKSkge1xuICAgICAgZS5tZXNzYWdlID0gYEVycm9yIGV4ZWN1dGluZyAke0lEQl9FWEVDVVRBQkxFfS4gT3JpZ2luYWwgZXJyb3I6ICcke2UubWVzc2FnZX0nOyBgICtcbiAgICAgICAgYFN0ZG91dDogJyR7KGUuc3Rkb3V0IHx8ICcnKS50cmltKCl9JzsgYCArXG4gICAgICAgIGBTdGRlcnI6ICckeyhlLnN0ZGVyciB8fCAnJykudHJpbSgpfSc7IGAgK1xuICAgICAgICBgQ29kZTogJyR7ZS5jb2RlfSdgO1xuICAgIH0gZWxzZSB7XG4gICAgICBlLm1lc3NhZ2UgPSBgRXJyb3IgZXhlY3V0aW5nICR7SURCX0VYRUNVVEFCTEV9LiBPcmlnaW5hbCBlcnJvcjogJyR7ZS5tZXNzYWdlfScuIGAgK1xuICAgICAgICBgVHJ5IHRvIGluY3JlYXNlIHRoZSAke29wdHMudGltZW91dH1tcyAke0lEQl9FWEVDVVRBQkxFfSBleGVjdXRpb24gdGltZW91dCByZXByZXNlbnRlZCBieSAnJHtvcHRzLnRpbWVvdXRDYXBOYW1lfScgY2FwYWJpbGl0eWA7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cbn07XG5cbi8qKlxuICogQ3JlYXRlcyBTdWJQcm9jZXNzIGluc3RhbmNlIG9mIGlkYiBmb3IgYmFja2dyb3VuZFxuICogZXhlY3V0aW9uLlxuICpcbiAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nPn0gY29tbWFuZCBkZXNpcmVkIGlkYiBjb21tYW5kIChlLmcuOiBbXCJsYXVuY2hcIl0sIFtcInhjdGVzdFwiLCBcInJ1blwiLCBcInVpXCJdKVxuICogQHBhcmFtIHtBcnJheTxTdHJpbmc+fSBhcmdzIGFkZGl0aW9uYWwgaWRiIGFyZ3VtZW50c1xuICogQHJldHVybnMge1N1YlByb2Nlc3N9XG4gKi9cbnN5c3RlbUNhbGxNZXRob2RzLmNyZWF0ZVN1YlByb2Nlc3MgPSBmdW5jdGlvbiBjcmVhdGVTdWJQcm9jZXNzIChjb21tYW5kID0gW10sIGFyZ3MgPSBbXSwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IGlkYkFyZ3MgPSBbLi4uY29tbWFuZCwgLi4udGhpcy5leGVjdXRhYmxlLmRlZmF1bHRBcmdzLCAuLi5hcmdzXTtcbiAgbG9nLmRlYnVnKGBDcmVhdGluZyAke0lEQl9FWEVDVVRBQkxFfSBzdWJwcm9jZXNzIHdpdGggYXJnczogJHt1dGlsLnF1b3RlKGFyZ3MpfWApO1xuICByZXR1cm4gbmV3IFN1YlByb2Nlc3ModGhpcy5leGVjdXRhYmxlLnBhdGgsIGlkYkFyZ3MsIG9wdHMpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgc3lzdGVtQ2FsbE1ldGhvZHM7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUlBO0FBR0EsTUFBTUEsdUJBQXVCLEdBQUlDLElBQUksSUFDbEMsR0FBRUMsaUNBQXlCLHVCQUFzQkQsSUFBSyxFQUFDO0FBRTFELE1BQU1FLGlCQUFpQixHQUFHLENBQUMsQ0FBQztBQW9CNUJBLGlCQUFpQixDQUFDQyxPQUFPLEdBQUcsZUFBZUEsT0FBTyxDQUFFQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUU7RUFDN0QsTUFBTTtJQUNKQztFQUNGLENBQUMsR0FBR0QsSUFBSTtFQUVSLE1BQU1FLFdBQVcsR0FBRyxDQUFDLENBQUM7RUFDdEIsS0FBSyxNQUFNQyxNQUFNLElBQUksQ0FBQ0MsdUJBQWMsRUFBRVAsaUNBQXdCLENBQUMsRUFBRTtJQUMvRCxJQUFJO01BQ0ZLLFdBQVcsQ0FBQ0MsTUFBTSxDQUFDLEdBQUcsTUFBTUUsV0FBRSxDQUFDQyxLQUFLLENBQUNILE1BQU0sQ0FBQztJQUM5QyxDQUFDLENBQUMsT0FBT0ks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