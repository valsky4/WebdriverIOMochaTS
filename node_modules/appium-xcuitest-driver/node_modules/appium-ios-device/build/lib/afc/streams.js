"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AfcWritableFileStream = exports.AfcReadableFileStream = void 0;
require("source-map-support/register");
var _stream = _interopRequireDefault(require("stream"));
var _lodash = _interopRequireDefault(require("lodash"));
var _logger = _interopRequireDefault(require("../logger"));
class AfcReadableFileStream extends _stream.default.Readable {
  constructor(fileHandle, afcService, options) {
    super(options);
    this._fileHandle = fileHandle;
    this._afcService = afcService;
    this._autoDestroy = !!options.autoDestroy;
    this._destroyed = false;
  }
  _read(size) {
    this._afcService.readFile(this._fileHandle, size).then(data => {
      if (!this._destroyed) {
        this.push(_lodash.default.isEmpty(data) ? null : data);
      }
    }).catch(e => {
      if (this._autoDestroy) {
        this.destroy(e);
      } else {
        this.emit('error', e);
      }
    });
  }
  _destroy(err, done) {
    if (this._destroyed) {
      return;
    }
    this._destroyed = true;
    this.push(null);
    this._afcService.closeFileHandle(this._fileHandle).then(() => done(err)).catch(e => {
      if (err) {
        _logger.default.debug(e);
      } else {
        err = e;
      }
      done(err);
    });
  }
}
exports.AfcReadableFileStream = AfcReadableFileStream;
class AfcWritableFileStream extends _stream.default.Writable {
  constructor(fileHandle, afcService, options) {
    super(options);
    this._fileHandle = fileHandle;
    this._afcService = afcService;
    this._autoDestroy = !!options.autoDestroy;
    this._destroyed = false;
  }
  _write(chunk, encoding, next) {
    this._afcService.writeFile(this._fileHandle, chunk).then(() => next()).catch(e => {
      if (this._autoDestroy) {
        this.destroy(e);
      }
      next(e);
    });
  }
  _destroy(err, done) {
    if (this._destroyed) {
      return;
    }
    this._destroyed = true;
    this._afcService.closeFileHandle(this._fileHandle).then(() => done(err)).catch(e => {
      if (err) {
        _logger.default.debug(e);
      } else {
        err = e;
      }
      done(err);
    });
  }
}
exports.AfcWritableFileStream = AfcWritableFileStream;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3RyZWFtIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfbG9kYXNoIiwiX2xvZ2dlciIsIkFmY1JlYWRhYmxlRmlsZVN0cmVhbSIsInN0cmVhbSIsIlJlYWRhYmxlIiwiY29uc3RydWN0b3IiLCJmaWxlSGFuZGxlIiwiYWZjU2VydmljZSIsIm9wdGlvbnMiLCJfZmlsZUhhbmRsZSIsIl9hZmNTZXJ2aWNlIiwiX2F1dG9EZXN0cm95IiwiYXV0b0Rlc3Ryb3kiLCJfZGVzdHJveWVkIiwiX3JlYWQiLCJzaXplIiwicmVhZEZpbGUiLCJ0aGVuIiwiZGF0YSIsInB1c2giLCJfIiwiaXNFbXB0eSIsImNhdGNoIiwiZSIsImRlc3Ryb3kiLCJlbWl0IiwiX2Rlc3Ryb3kiLCJlcnIiLCJkb25lIiwiY2xvc2VGaWxlSGFuZGxlIiwibG9nIiwiZGVidWciLCJleHBvcnRzIiwiQWZjV3JpdGFibGVGaWxlU3RyZWFtIiwiV3JpdGFibGUiLCJfd3JpdGUiLCJjaHVuayIsImVuY29kaW5nIiwibmV4dCIsIndyaXRlRmlsZSJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZmMvc3RyZWFtcy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by10aGVuICovXG5pbXBvcnQgc3RyZWFtIGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuXG5jbGFzcyBBZmNSZWFkYWJsZUZpbGVTdHJlYW0gZXh0ZW5kcyBzdHJlYW0uUmVhZGFibGUge1xuXG4gIGNvbnN0cnVjdG9yIChmaWxlSGFuZGxlLCBhZmNTZXJ2aWNlLCBvcHRpb25zKSB7XG4gICAgc3VwZXIob3B0aW9ucyk7XG4gICAgdGhpcy5fZmlsZUhhbmRsZSA9IGZpbGVIYW5kbGU7XG4gICAgdGhpcy5fYWZjU2VydmljZSA9IGFmY1NlcnZpY2U7XG4gICAgdGhpcy5fYXV0b0Rlc3Ryb3kgPSAhIW9wdGlvbnMuYXV0b0Rlc3Ryb3k7XG4gICAgdGhpcy5fZGVzdHJveWVkID0gZmFsc2U7XG4gIH1cblxuICBfcmVhZCAoc2l6ZSkge1xuICAgIHRoaXMuX2FmY1NlcnZpY2UucmVhZEZpbGUodGhpcy5fZmlsZUhhbmRsZSwgc2l6ZSlcbiAgICAgIC50aGVuKChkYXRhKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5fZGVzdHJveWVkKSB7XG4gICAgICAgICAgdGhpcy5wdXNoKF8uaXNFbXB0eShkYXRhKSA/IG51bGwgOiBkYXRhKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoZSkgPT4ge1xuICAgICAgICBpZiAodGhpcy5fYXV0b0Rlc3Ryb3kpIHtcbiAgICAgICAgICB0aGlzLmRlc3Ryb3koZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIF9kZXN0cm95IChlcnIsIGRvbmUpIHtcbiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWU7XG4gICAgdGhpcy5wdXNoKG51bGwpO1xuICAgIHRoaXMuX2FmY1NlcnZpY2UuY2xvc2VGaWxlSGFuZGxlKHRoaXMuX2ZpbGVIYW5kbGUpXG4gICAgICAudGhlbigoKSA9PiBkb25lKGVycikpXG4gICAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBlcnIgPSBlO1xuICAgICAgICB9XG4gICAgICAgIGRvbmUoZXJyKTtcbiAgICAgIH0pO1xuICB9XG59XG5cbmNsYXNzIEFmY1dyaXRhYmxlRmlsZVN0cmVhbSBleHRlbmRzIHN0cmVhbS5Xcml0YWJsZSB7XG5cbiAgY29uc3RydWN0b3IgKGZpbGVIYW5kbGUsIGFmY1NlcnZpY2UsIG9wdGlvbnMpIHtcbiAgICBzdXBlcihvcHRpb25zKTtcbiAgICB0aGlzLl9maWxlSGFuZGxlID0gZmlsZUhhbmRsZTtcbiAgICB0aGlzLl9hZmNTZXJ2aWNlID0gYWZjU2VydmljZTtcbiAgICB0aGlzLl9hdXRvRGVzdHJveSA9ICEhb3B0aW9ucy5hdXRvRGVzdHJveTtcbiAgICB0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIF93cml0ZSAoY2h1bmssIGVuY29kaW5nLCBuZXh0KSB7XG4gICAgdGhpcy5fYWZjU2VydmljZS53cml0ZUZpbGUodGhpcy5fZmlsZUhhbmRsZSwgY2h1bmspXG4gICAgICAudGhlbigoKSA9PiBuZXh0KCkpXG4gICAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuX2F1dG9EZXN0cm95KSB7XG4gICAgICAgICAgdGhpcy5kZXN0cm95KGUpO1xuICAgICAgICB9XG4gICAgICAgIG5leHQoZSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIF9kZXN0cm95IChlcnIsIGRvbmUpIHtcbiAgICBpZiAodGhpcy5fZGVzdHJveWVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2Rlc3Ryb3llZCA9IHRydWU7XG4gICAgdGhpcy5fYWZjU2VydmljZS5jbG9zZUZpbGVIYW5kbGUodGhpcy5fZmlsZUhhbmRsZSlcbiAgICAgIC50aGVuKCgpID0+IGRvbmUoZXJyKSlcbiAgICAgIC5jYXRjaCgoZSkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGVyciA9IGU7XG4gICAgICAgIH1cbiAgICAgICAgZG9uZShlcnIpO1xuICAgICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgQWZjUmVhZGFibGVGaWxlU3RyZWFtLCBBZmNXcml0YWJsZUZpbGVTdHJlYW0gfTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFDQSxJQUFBQSxPQUFB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