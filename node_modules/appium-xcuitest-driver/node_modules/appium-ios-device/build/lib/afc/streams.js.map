{"version":3,"file":"streams.js","names":["_stream","_interopRequireDefault","require","_lodash","_logger","AfcReadableFileStream","stream","Readable","constructor","fileHandle","afcService","options","_fileHandle","_afcService","_autoDestroy","autoDestroy","_destroyed","_read","size","readFile","then","data","push","_","isEmpty","catch","e","destroy","emit","_destroy","err","done","closeFileHandle","log","debug","exports","AfcWritableFileStream","Writable","_write","chunk","encoding","next","writeFile"],"sources":["../../../lib/afc/streams.js"],"sourcesContent":["/* eslint-disable promise/prefer-await-to-then */\nimport stream from 'stream';\nimport _ from 'lodash';\nimport log from '../logger';\n\nclass AfcReadableFileStream extends stream.Readable {\n\n  constructor (fileHandle, afcService, options) {\n    super(options);\n    this._fileHandle = fileHandle;\n    this._afcService = afcService;\n    this._autoDestroy = !!options.autoDestroy;\n    this._destroyed = false;\n  }\n\n  _read (size) {\n    this._afcService.readFile(this._fileHandle, size)\n      .then((data) => {\n        if (!this._destroyed) {\n          this.push(_.isEmpty(data) ? null : data);\n        }\n      })\n      .catch((e) => {\n        if (this._autoDestroy) {\n          this.destroy(e);\n        } else {\n          this.emit('error', e);\n        }\n      });\n  }\n\n  _destroy (err, done) {\n    if (this._destroyed) {\n      return;\n    }\n    this._destroyed = true;\n    this.push(null);\n    this._afcService.closeFileHandle(this._fileHandle)\n      .then(() => done(err))\n      .catch((e) => {\n        if (err) {\n          log.debug(e);\n        } else {\n          err = e;\n        }\n        done(err);\n      });\n  }\n}\n\nclass AfcWritableFileStream extends stream.Writable {\n\n  constructor (fileHandle, afcService, options) {\n    super(options);\n    this._fileHandle = fileHandle;\n    this._afcService = afcService;\n    this._autoDestroy = !!options.autoDestroy;\n    this._destroyed = false;\n  }\n\n  _write (chunk, encoding, next) {\n    this._afcService.writeFile(this._fileHandle, chunk)\n      .then(() => next())\n      .catch((e) => {\n        if (this._autoDestroy) {\n          this.destroy(e);\n        }\n        next(e);\n      });\n  }\n\n  _destroy (err, done) {\n    if (this._destroyed) {\n      return;\n    }\n    this._destroyed = true;\n    this._afcService.closeFileHandle(this._fileHandle)\n      .then(() => done(err))\n      .catch((e) => {\n        if (err) {\n          log.debug(e);\n        } else {\n          err = e;\n        }\n        done(err);\n      });\n  }\n}\n\nexport { AfcReadableFileStream, AfcWritableFileStream };\n"],"mappings":"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"}