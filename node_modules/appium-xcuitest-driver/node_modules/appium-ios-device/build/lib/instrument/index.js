"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.InstrumentService = exports.INSTRUMENT_SERVICE_NAME_VERSION_14 = exports.INSTRUMENT_SERVICE_NAME = exports.INSTRUMENT_CHANNEL = void 0;
require("source-map-support/register");
var _baseService = require("../base-service");
var _headers = require("./headers");
var _dtxEncode = require("./transformer/dtx-encode");
var _dtxDecode = require("./transformer/dtx-decode");
var _events = _interopRequireDefault(require("events"));
var _lodash = _interopRequireDefault(require("lodash"));
var _asyncbox = require("asyncbox");
const CHECK_FREQ_MS = 500;
const WAIT_REPLY_TIME_MS = 10000;
const EMPTY_MESSAGE_SIZE = 16;
const CHANNEL_CANCELED = '_channelCanceled';
const CHANNEL_OFFSET = 2 ** 32;
const INSTRUMENT_SERVICE_NAME_VERSION_14 = 'com.apple.instruments.remoteserver.DVTSecureSocketProxy';
exports.INSTRUMENT_SERVICE_NAME_VERSION_14 = INSTRUMENT_SERVICE_NAME_VERSION_14;
const INSTRUMENT_SERVICE_NAME = 'com.apple.instruments.remoteserver';
exports.INSTRUMENT_SERVICE_NAME = INSTRUMENT_SERVICE_NAME;
const INSTRUMENT_CHANNEL = Object.freeze({
  DEVICE_INFO: 'com.apple.instruments.server.services.deviceinfo',
  PROCESS_CONTROL: 'com.apple.instruments.server.services.processcontrol',
  SYSMONTAP: 'com.apple.instruments.server.services.sysmontap',
  NETWORKING: 'com.apple.instruments.server.services.networking',
  MOBILE_NOTIFICATIONS: 'com.apple.instruments.server.services.mobilenotifications',
  GRAPHICS_OPENGL: 'com.apple.instruments.server.services.graphics.opengl',
  APPLICATION_LISTING: 'com.apple.instruments.server.services.device.applictionListing',
  CONDITION_INDUCER: 'com.apple.instruments.server.services.ConditionInducer'
});
exports.INSTRUMENT_CHANNEL = INSTRUMENT_CHANNEL;
function defaultDict(createValue) {
  return new Proxy(Object.create(null), {
    get(storage, property) {
      if (!(property in storage)) {
        storage[property] = createValue(property);
      }
      return storage[property];
    }
  });
}
class InstrumentService extends _baseService.BaseServiceSocket {
  constructor(socketClient, event) {
    super(socketClient);
    this._undefinedCallback = event;
    this._callbacks = new _events.default.EventEmitter();
    this._channelCallbacks = new _events.default.EventEmitter();
    this._replyQueues = defaultDict(() => []);
    this._channels = {};
    this._nextIdentifier = 1;
    this._encoder = new _dtxEncode.DTXEncoder();
    this._encoder.pipe(this._socketClient);
    this._assignClientFailureHandlers(this._encoder);
    this._decoder = new _dtxDecode.DTXDecoder();
    this._socketClient.pipe(this._decoder);
    this._decoder.on('data', this._handleData.bind(this));
  }
  registerSelectorCallback(selector, event) {
    this._callbacks.addListener(selector, event);
  }
  registerUndefinedCallback(event) {
    this._undefinedCallback = event;
  }
  async registerChannelCallback(channel, event) {
    const channelId = await this.makeChannel(channel);
    this._channelCallbacks.addListener(channelId, event);
  }
  async makeChannel(channel) {
    if (channel in this._channels) {
      return this._channels[channel];
    }
    const channelCode = Object.keys(this._channels).length + 1;
    await this._callChannel(true, 0, '_requestChannelWithCode:identifier:', channelCode, channel);
    this._channels[channel] = channelCode;
    return channelCode;
  }
  async callChannel(channel, selector, ...auxiliaries) {
    const channelCode = await this.makeChannel(channel);
    return await this._callChannel(true, channelCode, selector, ...auxiliaries);
  }
  async _callChannel(sync, channelCode, selector, ...auxiliaries) {
    const identifier = this._nextIdentifier;
    this._encoder.write({
      sync,
      channelCode,
      selector,
      auxiliaries,
      identifier
    });
    ++this._nextIdentifier;
    if (sync) {
      try {
        return await (0, _asyncbox.waitForCondition)(() => {
          const queue = this._replyQueues[identifier];
          const data = queue.shift();
          if (!_lodash.default.isUndefined(data)) {
            return data;
          }
        }, {
          waitMs: WAIT_REPLY_TIME_MS,
          intervalMs: CHECK_FREQ_MS,
          error: 'reply channel data timeout'
        });
      } catch (err) {
        this.close();
        throw new Error(err);
      }
    }
  }
  _handleData(data) {
    if (_lodash.default.includes(data.selector, CHANNEL_CANCELED)) {
      this.close();
    }
    if (data.conversationIndex === 1) {
      this._replyQueues[data.identifier].push(data);
    } else if (this._channelCallbacks.listenerCount(CHANNEL_OFFSET - data.channelCode) > 0) {
      this._channelCallbacks.emit(CHANNEL_OFFSET - data.channelCode, data);
    } else {
      const selector = data.selector;
      if (_lodash.default.isString(selector) && this._callbacks.listenerCount(selector) > 0) {
        this._callbacks.emit(selector, data);
      } else if (this._undefinedCallback) {
        this._undefinedCallback(data);
      }
      if (data.expectsReply) {
        this._replyAck(data);
      }
    }
  }
  _replyAck(data) {
    const reply = new _headers.DTXMessage({
      identifier: data.identifier,
      channelCode: data.channelCode,
      selector: Buffer.alloc(EMPTY_MESSAGE_SIZE),
      conversationIndex: data.conversationIndex + 1,
      flags: _headers.FLAG_TYPES.reply
    });
    this._socketClient.write(reply.build());
  }
}
exports.InstrumentService = InstrumentService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYmFzZVNlcnZpY2UiLCJyZXF1aXJlIiwiX2hlYWRlcnMiLCJfZHR4RW5jb2RlIiwiX2R0eERlY29kZSIsIl9ldmVudHMiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwiX2xvZGFzaCIsIl9hc3luY2JveCIsIkNIRUNLX0ZSRVFfTVMiLCJXQUlUX1JFUExZX1RJTUVfTVMiLCJFTVBUWV9NRVNTQUdFX1NJWkUiLCJDSEFOTkVMX0NBTkNFTEVEIiwiQ0hBTk5FTF9PRkZTRVQiLCJJTlNUUlVNRU5UX1NFUlZJQ0VfTkFNRV9WRVJTSU9OXzE0IiwiZXhwb3J0cyIsIklOU1RSVU1FTlRfU0VSVklDRV9OQU1FIiwiSU5TVFJVTUVOVF9DSEFOTkVMIiwiT2JqZWN0IiwiZnJlZXplIiwiREVWSUNFX0lORk8iLCJQUk9DRVNTX0NPTlRST0wiLCJTWVNNT05UQVAiLCJORVRXT1JLSU5HIiwiTU9CSUxFX05PVElGSUNBVElPTlMiLCJHUkFQSElDU19PUEVOR0wiLCJBUFBMSUNBVElPTl9MSVNUSU5HIiwiQ09ORElUSU9OX0lORFVDRVIiLCJkZWZhdWx0RGljdCIsImNyZWF0ZVZhbHVlIiwiUHJveHkiLCJjcmVhdGUiLCJnZXQiLCJzdG9yYWdlIiwicHJvcGVydHkiLCJJbnN0cnVtZW50U2VydmljZSIsIkJhc2VTZXJ2aWNlU29ja2V0IiwiY29uc3RydWN0b3IiLCJzb2NrZXRDbGllbnQiLCJldmVudCIsIl91bmRlZmluZWRDYWxsYmFjayIsIl9jYWxsYmFja3MiLCJldmVudHMiLCJFdmVudEVtaXR0ZXIiLCJfY2hhbm5lbENhbGxiYWNrcyIsIl9yZXBseVF1ZXVlcyIsIl9jaGFubmVscyIsIl9uZXh0SWRlbnRpZmllciIsIl9lbmNvZGVyIiwiRFRYRW5jb2RlciIsInBpcGUiLCJfc29ja2V0Q2xpZW50IiwiX2Fzc2lnbkNsaWVudEZhaWx1cmVIYW5kbGVycyIsIl9kZWNvZGVyIiwiRFRYRGVjb2RlciIsIm9uIiwiX2hhbmRsZURhdGEiLCJiaW5kIiwicmVnaXN0ZXJTZWxlY3RvckNhbGxiYWNrIiwic2VsZWN0b3IiLCJhZGRMaXN0ZW5lciIsInJlZ2lzdGVyVW5kZWZpbmVkQ2FsbGJhY2siLCJyZWdpc3RlckNoYW5uZWxDYWxsYmFjayIsImNoYW5uZWwiLCJjaGFubmVsSWQiLCJtYWtlQ2hhbm5lbCIsImNoYW5uZWxDb2RlIiwia2V5cyIsImxlbmd0aCIsIl9jYWxsQ2hhbm5lbCIsImNhbGxDaGFubmVsIiwiYXV4aWxpYXJpZXMiLCJzeW5jIiwiaWRlbnRpZmllciIsIndyaXRlIiwid2FpdEZvckNvbmRpdGlvbiIsInF1ZXVlIiwiZGF0YSIsInNoaWZ0IiwiXyIsImlzVW5kZWZpbmVkIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImVycm9yIiwiZXJyIiwiY2xvc2UiLCJFcnJvciIsImluY2x1ZGVzIiwiY29udmVyc2F0aW9uSW5kZXgiLCJwdXNoIiwibGlzdGVuZXJDb3VudCIsImVtaXQiLCJpc1N0cmluZyIsImV4cGVjdHNSZXBseSIsIl9yZXBseUFjayIsInJlcGx5IiwiRFRYTWVzc2FnZSIsIkJ1ZmZlciIsImFsbG9jIiwiZmxhZ3MiLCJGTEFHX1RZUEVTIiwiYnVpbGQiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvaW5zdHJ1bWVudC9pbmRleC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBZGFwdGVkIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL1l1ZUNoZW4tQy9weS1pb3MtZGV2aWNlXG5cbmltcG9ydCB7QmFzZVNlcnZpY2VTb2NrZXR9IGZyb20gJy4uL2Jhc2Utc2VydmljZSc7XG5pbXBvcnQge0RUWE1lc3NhZ2UsIEZMQUdfVFlQRVN9IGZyb20gJy4vaGVhZGVycyc7XG5pbXBvcnQge0RUWEVuY29kZXJ9IGZyb20gJy4vdHJhbnNmb3JtZXIvZHR4LWVuY29kZSc7XG5pbXBvcnQge0RUWERlY29kZXJ9IGZyb20gJy4vdHJhbnNmb3JtZXIvZHR4LWRlY29kZSc7XG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHt3YWl0Rm9yQ29uZGl0aW9ufSBmcm9tICdhc3luY2JveCc7XG5cbmNvbnN0IENIRUNLX0ZSRVFfTVMgPSA1MDA7XG5jb25zdCBXQUlUX1JFUExZX1RJTUVfTVMgPSAxMDAwMDtcbmNvbnN0IEVNUFRZX01FU1NBR0VfU0laRSA9IDE2O1xuY29uc3QgQ0hBTk5FTF9DQU5DRUxFRCA9ICdfY2hhbm5lbENhbmNlbGVkJztcbmNvbnN0IENIQU5ORUxfT0ZGU0VUID0gMiAqKiAzMjtcblxuY29uc3QgSU5TVFJVTUVOVF9TRVJWSUNFX05BTUVfVkVSU0lPTl8xNCA9ICdjb20uYXBwbGUuaW5zdHJ1bWVudHMucmVtb3Rlc2VydmVyLkRWVFNlY3VyZVNvY2tldFByb3h5JztcbmNvbnN0IElOU1RSVU1FTlRfU0VSVklDRV9OQU1FID0gJ2NvbS5hcHBsZS5pbnN0cnVtZW50cy5yZW1vdGVzZXJ2ZXInO1xuXG5leHBvcnQgY29uc3QgSU5TVFJVTUVOVF9DSEFOTkVMID0gT2JqZWN0LmZyZWV6ZSh7XG4gIERFVklDRV9JTkZPOiAnY29tLmFwcGxlLmluc3RydW1lbnRzLnNlcnZlci5zZXJ2aWNlcy5kZXZpY2VpbmZvJyxcbiAgUFJPQ0VTU19DT05UUk9MOiAnY29tLmFwcGxlLmluc3RydW1lbnRzLnNlcnZlci5zZXJ2aWNlcy5wcm9jZXNzY29udHJvbCcsXG4gIFNZU01PTlRBUDogJ2NvbS5hcHBsZS5pbnN0cnVtZW50cy5zZXJ2ZXIuc2VydmljZXMuc3lzbW9udGFwJyxcbiAgTkVUV09SS0lORzogJ2NvbS5hcHBsZS5pbnN0cnVtZW50cy5zZXJ2ZXIuc2VydmljZXMubmV0d29ya2luZycsXG4gIE1PQklMRV9OT1RJRklDQVRJT05TOiAnY29tLmFwcGxlLmluc3RydW1lbnRzLnNlcnZlci5zZXJ2aWNlcy5tb2JpbGVub3RpZmljYXRpb25zJyxcbiAgR1JBUEhJQ1NfT1BFTkdMOiAnY29tLmFwcGxlLmluc3RydW1lbnRzLnNlcnZlci5zZXJ2aWNlcy5ncmFwaGljcy5vcGVuZ2wnLFxuICBBUFBMSUNBVElPTl9MSVNUSU5HOiAnY29tLmFwcGxlLmluc3RydW1lbnRzLnNlcnZlci5zZXJ2aWNlcy5kZXZpY2UuYXBwbGljdGlvbkxpc3RpbmcnLFxuICBDT05ESVRJT05fSU5EVUNFUjogJ2NvbS5hcHBsZS5pbnN0cnVtZW50cy5zZXJ2ZXIuc2VydmljZXMuQ29uZGl0aW9uSW5kdWNlcidcbn0pO1xuXG5mdW5jdGlvbiBkZWZhdWx0RGljdCAoY3JlYXRlVmFsdWUpIHtcbiAgcmV0dXJuIG5ldyBQcm94eShPYmplY3QuY3JlYXRlKG51bGwpLCB7XG4gICAgZ2V0IChzdG9yYWdlLCBwcm9wZXJ0eSkge1xuICAgICAgaWYgKCEocHJvcGVydHkgaW4gc3RvcmFnZSkpIHtcbiAgICAgICAgc3RvcmFnZVtwcm9wZXJ0eV0gPSBjcmVhdGVWYWx1ZShwcm9wZXJ0eSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gc3RvcmFnZVtwcm9wZXJ0eV07XG4gICAgfVxuICB9KTtcbn1cblxuLyoqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aGljaCB3aWxsIGJlIGNhbGxlZCBkdXJpbmcgdGhlIGRhdGEgdHJhbnNtaXNzaW9uIGluIGluc3RydW1lbnQgc2VydmVcbiAqIEBuYW1lIERUWENhbGxiYWNrXG4gKiBAZnVuY3Rpb25cbiAqIEBwYXJhbSB7RFRYTWVzc2FnZX0gb2JqZWN0XG4qL1xuXG4vKipcbiAqIEBwYXJhbSB7U29ja2V0fSBzb2NrZXRDbGllbnQgIERUWE1lc3NhZ2Uuc2VsZWN0b3JcbiAqIEBwYXJhbSB7P0RUWENhbGxiYWNrfSBldmVudCBpZiBlbXB0eSB3aWxsIGlnbm9yZSBhbnkgbWVzc2FnZXNcbiAqL1xuY2xhc3MgSW5zdHJ1bWVudFNlcnZpY2UgZXh0ZW5kcyBCYXNlU2VydmljZVNvY2tldCB7XG4gIGNvbnN0cnVjdG9yIChzb2NrZXRDbGllbnQsIGV2ZW50KSB7XG4gICAgc3VwZXIoc29ja2V0Q2xpZW50KTtcbiAgICB0aGlzLl91bmRlZmluZWRDYWxsYmFjayA9IGV2ZW50O1xuICAgIHRoaXMuX2NhbGxiYWNrcyA9IG5ldyBldmVudHMuRXZlbnRFbWl0dGVyKCk7XG4gICAgdGhpcy5fY2hhbm5lbENhbGxiYWNrcyA9IG5ldyBldmVudHMuRXZlbnRFbWl0dGVyKCk7XG4gICAgdGhpcy5fcmVwbHlRdWV1ZXMgPSBkZWZhdWx0RGljdCgoKSA9PiBbXSk7XG4gICAgdGhpcy5fY2hhbm5lbHMgPSB7fTtcbiAgICB0aGlzLl9uZXh0SWRlbnRpZmllciA9IDE7XG4gICAgdGhpcy5fZW5jb2RlciA9IG5ldyBEVFhFbmNvZGVyKCk7XG4gICAgdGhpcy5fZW5jb2Rlci5waXBlKHRoaXMuX3NvY2tldENsaWVudCk7XG4gICAgdGhpcy5fYXNzaWduQ2xpZW50RmFpbHVyZUhhbmRsZXJzKHRoaXMuX2VuY29kZXIpO1xuICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgRFRYRGVjb2RlcigpO1xuICAgIHRoaXMuX3NvY2tldENsaWVudC5waXBlKHRoaXMuX2RlY29kZXIpO1xuICAgIHRoaXMuX2RlY29kZXIub24oJ2RhdGEnLCB0aGlzLl9oYW5kbGVEYXRhLmJpbmQodGhpcykpO1xuICB9XG5cbiAgLyoqXG4gICAqIElmIHRoZSBzZWxlY3RvciBpcyByZWdpc3RlcmVkLCBUaGUgbWVzc2FnZSBvZiB0aGUgc2VsZWN0b3IgZXZlbnQgd2lsbCBiZSByZXR1cm5lZC4gcmVmZXIgdG8gdGhpcy5faGFuZGxlRGF0YVxuICAgKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0b3IgIExpc3RlbiBmb3IgcmV0dXJuIERUWE1lc3NhZ2Uuc2VsZWN0b3IgZGF0YVxuICAgKiBAcGFyYW0ge0RUWENhbGxiYWNrfSBldmVudFxuICAgKi9cbiAgcmVnaXN0ZXJTZWxlY3RvckNhbGxiYWNrIChzZWxlY3RvciwgZXZlbnQpIHtcbiAgICB0aGlzLl9jYWxsYmFja3MuYWRkTGlzdGVuZXIoc2VsZWN0b3IsIGV2ZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJZiB0aGUgZXZlbnQgaXMgcmVnaXN0ZXJlZCwgYWxsIHVucmVnaXN0ZXJlZCBtZXNzYWdlcyB3aWxsIGJlIHJldHVybmVkIHRvIGV2ZW50LiByZWZlciB0byB0aGlzLl9oYW5kbGVEYXRhXG4gICAqIEBwYXJhbSB7RFRYQ2FsbGJhY2t9IGV2ZW50XG4gICAqL1xuICByZWdpc3RlclVuZGVmaW5lZENhbGxiYWNrIChldmVudCkge1xuICAgIHRoaXMuX3VuZGVmaW5lZENhbGxiYWNrID0gZXZlbnQ7XG4gIH1cblxuICAvKipcbiAgICogSWYgdGhlIGV2ZW50IGlzIHJlZ2lzdGVyZWQsIHRoaXMgY2hhbm5lbCB7Q0hBTk5FTH0gbWVzc2FnZXMgd2lsbCBiZSByZXR1cm5lZCB0byBldmVudC4gcmVmZXIgdG8gdGhpcy5faGFuZGxlRGF0YVxuICAgKiBJdCdzIGFjdHVhbGx5IGxpc3RlbmluZyBmb3IgaW50IGNoYW5uZWxDb2RlLiBJbiB0aGlzLl9jaGFubmVsIG9iamVjdCB0byByZWNvcmQgY2hhbm5lbCBrZXkgYW5kIGludCB2YWx1ZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gY2hhbm5lbCBpbnN0cnVtZW50cyBzZXJ2aWNlIGNoYW5uZWwgZS5nOiBJTlNUUlVNRU5UX0NIQU5ORUwuREVWSUNFX0lORk8uXG4gICAqIEBwYXJhbSB7RFRYQ2FsbGJhY2t9IGV2ZW50XG4gICAqL1xuICBhc3luYyByZWdpc3RlckNoYW5uZWxDYWxsYmFjayAoY2hhbm5lbCwgZXZlbnQpIHtcbiAgICBjb25zdCBjaGFubmVsSWQgPSBhd2FpdCB0aGlzLm1ha2VDaGFubmVsKGNoYW5uZWwpO1xuICAgIHRoaXMuX2NoYW5uZWxDYWxsYmFja3MuYWRkTGlzdGVuZXIoY2hhbm5lbElkLCBldmVudCk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgc2VydmljZSBjaGFubmVsLCBkYXRhIHRyYW5zbWlzc2lvbiBvZiB0aGUgc2VydmljZSB3aWxsIHVzZSB0aGlzIGNoYW5uZWxDb2RlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjaGFubmVsICBpbnN0cnVtZW50cyBzZXJ2aWNlIGNoYW5uZWwgZS5nOiBJTlNUUlVNRU5UX0NIQU5ORUwuREVWSUNFX0lORk9cbiAgICogQHJldHVybnMge1Byb21pc2U8bnVtYmVyfCo+fSBpbnN0cnVtZW50cyBzZXJ2aWNlIGNoYW5uZWwgY29kZSBmb3IgZGF0YSB0cmFuc21pc3Npb25cbiAgICovXG4gIGFzeW5jIG1ha2VDaGFubmVsIChjaGFubmVsKSB7XG4gICAgaWYgKGNoYW5uZWwgaW4gdGhpcy5fY2hhbm5lbHMpIHtcbiAgICAgIHJldHVybiB0aGlzLl9jaGFubmVsc1tjaGFubmVsXTtcbiAgICB9XG4gICAgY29uc3QgY2hhbm5lbENvZGUgPSBPYmplY3Qua2V5cyh0aGlzLl9jaGFubmVscykubGVuZ3RoICsgMTtcbiAgICBhd2FpdCB0aGlzLl9jYWxsQ2hhbm5lbCh0cnVlLCAwLCAnX3JlcXVlc3RDaGFubmVsV2l0aENvZGU6aWRlbnRpZmllcjonLCBjaGFubmVsQ29kZSwgY2hhbm5lbCk7XG4gICAgdGhpcy5fY2hhbm5lbHNbY2hhbm5lbF0gPSBjaGFubmVsQ29kZTtcbiAgICByZXR1cm4gY2hhbm5lbENvZGU7XG4gIH1cblxuICAvKipcbiAgICogSW4gZ2VuZXJhbCwgd2UgY2FsbCB0aGlzIG1ldGhvZCB0byBzdGFydCB0aGUgaW5zdHJ1bWVudCBkdHggc2VydmljZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gY2hhbm5lbCBpbnN0cnVtZW50IGR0eCBzZXJ2aWNlIGUuZzogSU5TVFJVTUVOVF9DSEFOTkVMLkRFVklDRV9JTkZPXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzZWxlY3RvciBpbnN0cnVtZW50IHNlcnZpY2UgbWV0aG9kIG5hbWUgKHJlZmxlY3Rpb24gY2FsbHMpXG4gICAqIEBwYXJhbSB7Li4uYW55fSBhdXhpbGlhcmllcyBwYXJhbWV0ZXJzIHJlcXVpcmVkIGJ5IHNlbGVjdG9yXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPERUWE1lc3NhZ2U+fVxuICAgKiBleGFtcGxl77yaXG4gICAqIGluc3RydW1lbnRTZXJ2aWNlLmNhbGxDaGFubmVsKElOU1RSVU1FTlRfQ0hBTk5FTC5QUk9DRVNTX0NPTlRST0wsXG4gICAgICAgICdsYXVuY2hTdXNwZW5kZWRQcm9jZXNzV2l0aERldmljZVBhdGg6YnVuZGxlSWRlbnRpZmllcjplbnZpcm9ubWVudDphcmd1bWVudHM6b3B0aW9uczonLCAnJyxcbiAgICAgICAgYnVuZGxlSUQsIHt9LCBbXSwgeydTdGFydFN1c3BlbmRlZEtleSc6IDAsICdLaWxsRXhpc3RpbmcnOiAxfVxuICAgKi9cbiAgYXN5bmMgY2FsbENoYW5uZWwgKGNoYW5uZWwsIHNlbGVjdG9yLCAuLi5hdXhpbGlhcmllcykge1xuICAgIGNvbnN0IGNoYW5uZWxDb2RlID0gYXdhaXQgdGhpcy5tYWtlQ2hhbm5lbChjaGFubmVsKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5fY2FsbENoYW5uZWwodHJ1ZSwgY2hhbm5lbENvZGUsIHNlbGVjdG9yLCAuLi5hdXhpbGlhcmllcyk7XG4gIH1cblxuICBhc3luYyBfY2FsbENoYW5uZWwgKHN5bmMsIGNoYW5uZWxDb2RlLCBzZWxlY3RvciwgLi4uYXV4aWxpYXJpZXMpIHtcbiAgICBjb25zdCBpZGVudGlmaWVyID0gdGhpcy5fbmV4dElkZW50aWZpZXI7XG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZSh7c3luYywgY2hhbm5lbENvZGUsIHNlbGVjdG9yLCBhdXhpbGlhcmllcywgaWRlbnRpZmllcn0pO1xuICAgICsrdGhpcy5fbmV4dElkZW50aWZpZXI7XG4gICAgaWYgKHN5bmMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKCgpID0+IHtcbiAgICAgICAgICBjb25zdCBxdWV1ZSA9IHRoaXMuX3JlcGx5UXVldWVzW2lkZW50aWZpZXJdO1xuICAgICAgICAgIGNvbnN0IGRhdGEgPSBxdWV1ZS5zaGlmdCgpO1xuICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChkYXRhKSkge1xuICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgfVxuICAgICAgICB9LCB7d2FpdE1zOiBXQUlUX1JFUExZX1RJTUVfTVMsIGludGVydmFsTXM6IENIRUNLX0ZSRVFfTVMsIGVycm9yOiAncmVwbHkgY2hhbm5lbCBkYXRhIHRpbWVvdXQnfSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxpbmcgcmVnaXN0ZXJlZCBhc3luY2hyb25vdXMgbWVzc2FnZSBjYWxsYmFja3NcbiAgICogQHBhcmFtIHtEVFhNZXNzYWdlfSBkYXRhXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBfaGFuZGxlRGF0YSAoZGF0YSkge1xuICAgIGlmIChfLmluY2x1ZGVzKGRhdGEuc2VsZWN0b3IsIENIQU5ORUxfQ0FOQ0VMRUQpKSB7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfVxuICAgIGlmIChkYXRhLmNvbnZlcnNhdGlvbkluZGV4ID09PSAxKSB7XG4gICAgICB0aGlzLl9yZXBseVF1ZXVlc1tkYXRhLmlkZW50aWZpZXJdLnB1c2goZGF0YSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLl9jaGFubmVsQ2FsbGJhY2tzLmxpc3RlbmVyQ291bnQoQ0hBTk5FTF9PRkZTRVQgLSBkYXRhLmNoYW5uZWxDb2RlKSA+IDApIHtcbiAgICAgIHRoaXMuX2NoYW5uZWxDYWxsYmFja3MuZW1pdChDSEFOTkVMX09GRlNFVCAtIGRhdGEuY2hhbm5lbENvZGUsIGRhdGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzZWxlY3RvciA9IGRhdGEuc2VsZWN0b3I7XG4gICAgICBpZiAoXy5pc1N0cmluZyhzZWxlY3RvcikgJiYgdGhpcy5fY2FsbGJhY2tzLmxpc3RlbmVyQ291bnQoc2VsZWN0b3IpID4gMCkge1xuICAgICAgICB0aGlzLl9jYWxsYmFja3MuZW1pdChzZWxlY3RvciwgZGF0YSk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuX3VuZGVmaW5lZENhbGxiYWNrKSB7XG4gICAgICAgIHRoaXMuX3VuZGVmaW5lZENhbGxiYWNrKGRhdGEpO1xuICAgICAgfVxuICAgICAgaWYgKGRhdGEuZXhwZWN0c1JlcGx5KSB7XG4gICAgICAgIHRoaXMuX3JlcGx5QWNrKGRhdGEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiByZXR1cm4gYSBlbXB0eSBhY2sgbWVzc2FnZVxuICAgKiBAcGFyYW0ge0RUWE1lc3NhZ2V9IGRhdGFcbiAgICovXG4gIF9yZXBseUFjayAoZGF0YSkge1xuICAgIGNvbnN0IHJlcGx5ID0gbmV3IERUWE1lc3NhZ2Uoe1xuICAgICAgaWRlbnRpZmllcjogZGF0YS5pZGVudGlmaWVyLFxuICAgICAgY2hhbm5lbENvZGU6IGRhdGEuY2hhbm5lbENvZGUsXG4gICAgICBzZWxlY3RvcjogQnVmZmVyLmFsbG9jKEVNUFRZX01FU1NBR0VfU0laRSksXG4gICAgICBjb252ZXJzYXRpb25JbmRleDogZGF0YS5jb252ZXJzYXRpb25JbmRleCArIDEsXG4gICAgICBmbGFnczogRkxBR19UWVBFUy5yZXBseVxuICAgIH0pO1xuICAgIHRoaXMuX3NvY2tldENsaWVudC53cml0ZShyZXBseS5idWlsZCgpKTtcbiAgfVxufVxuXG5leHBvcnQgeyBJbnN0cnVtZW50U2VydmljZSwgSU5TVFJVTUVOVF9TRVJWSUNFX05BTUVfVkVSU0lPTl8xNCwgSU5TVFJVTUVOVF9TRVJWSUNFX05BTUUgfTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFFQSxJQUFBQSxZQUFBLEdBQUFDLE9BQUE7QUFDQSxJQUFBQyxRQUFBLEdBQUFELE9BQUE7QUFDQSxJQUFBRSxVQUFBLEdBQUFGLE9BQUE7QUFDQSxJQUFBRyxVQUFBLEdBQUFILE9BQUE7QUFDQSxJQUFBSSxPQUFBLEdBQUFDLHNCQUFBLENBQUFMLE9BQUE7QUFDQSxJQUFBTSxPQUFBLEdBQUFELHNCQUFBLENBQUFMLE9BQUE7QUFDQSxJQUFBTyxTQUFBLEdBQUFQLE9BQUE7QUFFQSxNQUFNUSxhQUFhLEdBQUcsR0FBRztB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