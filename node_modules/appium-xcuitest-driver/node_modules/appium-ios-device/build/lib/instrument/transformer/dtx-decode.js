"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DTXDecoder = void 0;
require("source-map-support/register");
var _stream = _interopRequireDefault(require("stream"));
var _headers = require("../headers");
class DTXDecoder extends _stream.default.Transform {
  constructor() {
    super({
      objectMode: true
    });
    this._dtxManager = {};
    this.buffer = Buffer.allocUnsafe(0);
    this.cursor = 0;
    this.header = undefined;
  }
  _transform(data, encoding, onData) {
    this._decode(data);
    onData();
  }
  _decode(data) {
    this.buffer = Buffer.concat([this.buffer.slice(this.cursor, this.buffer.length), data]);
    this.cursor = 0;
    while (this.cursor < this.buffer.length) {
      const magic = this._recv(_headers.DTX_MESSAGE_HEADER_MAGIC_LEN);
      if (!magic) {
        return;
      }
      this.cursor -= _headers.DTX_MESSAGE_HEADER_MAGIC_LEN;
      if (magic && magic.readUInt32LE(0) === _headers.DTX_MESSAGE_HEADER_MAGIC) {
        const headerBuffer = this._recv(_headers.DTX_MESSAGE_HEADER_LENGTH);
        if (!headerBuffer) {
          return;
        }
        this.header = _headers.DTXMessageHeader.parse(headerBuffer);
        if (this.header.fragmentId === 0) {
          if (!(this.header.channel in this._dtxManager)) {
            this._dtxManager[this.header.channel] = {
              headerBuffer,
              payloadBuffer: new Buffer.allocUnsafe(0)
            };
          }
          if (this.header.fragmentCount > 1) {
            continue;
          }
        }
      }
      const bodyBuffer = this._recv(this.header.payloadLength);
      if (!bodyBuffer) {
        return;
      }
      if (this._dtxManager[this.header.channel]) {
        this._dtxManager[this.header.channel].payloadBuffer = Buffer.concat([this._dtxManager[this.header.channel].payloadBuffer, bodyBuffer]);
      }
      if (this.header.fragmentId === this.header.fragmentCount - 1) {
        data = this._dtxManager[this.header.channel];
        delete this._dtxManager[this.header.channel];
        if (data) {
          this.push(_headers.DTXMessage.parse(data.headerBuffer, data.payloadBuffer));
        }
      }
    }
    this.cursor = 0;
    this.buffer = Buffer.allocUnsafe(0);
  }
  _recv(length) {
    if (this.buffer.length < this.cursor + length) {
      return null;
    }
    const buf = this.buffer.slice(this.cursor, this.cursor + length);
    this.cursor += length;
    return buf;
  }
}
exports.DTXDecoder = DTXDecoder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3RyZWFtIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfaGVhZGVycyIsIkRUWERlY29kZXIiLCJTdHJlYW0iLCJUcmFuc2Zvcm0iLCJjb25zdHJ1Y3RvciIsIm9iamVjdE1vZGUiLCJfZHR4TWFuYWdlciIsImJ1ZmZlciIsIkJ1ZmZlciIsImFsbG9jVW5zYWZlIiwiY3Vyc29yIiwiaGVhZGVyIiwidW5kZWZpbmVkIiwiX3RyYW5zZm9ybSIsImRhdGEiLCJlbmNvZGluZyIsIm9uRGF0YSIsIl9kZWNvZGUiLCJjb25jYXQiLCJzbGljZSIsImxlbmd0aCIsIm1hZ2ljIiwiX3JlY3YiLCJEVFhfTUVTU0FHRV9IRUFERVJfTUFHSUNfTEVOIiwicmVhZFVJbnQzMkxFIiwiRFRYX01FU1NBR0VfSEVBREVSX01BR0lDIiwiaGVhZGVyQnVmZmVyIiwiRFRYX01FU1NBR0VfSEVBREVSX0xFTkdUSCIsIkRUWE1lc3NhZ2VIZWFkZXIiLCJwYXJzZSIsImZyYWdtZW50SWQiLCJjaGFubmVsIiwicGF5bG9hZEJ1ZmZlciIsImZyYWdtZW50Q291bnQiLCJib2R5QnVmZmVyIiwicGF5bG9hZExlbmd0aCIsInB1c2giLCJEVFhNZXNzYWdlIiwiYnVmIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9pbnN0cnVtZW50L3RyYW5zZm9ybWVyL2R0eC1kZWNvZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFN0cmVhbSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgRFRYX01FU1NBR0VfSEVBREVSX0xFTkdUSCwgRFRYX01FU1NBR0VfSEVBREVSX01BR0lDLCBEVFhfTUVTU0FHRV9IRUFERVJfTUFHSUNfTEVOLFxuICAgICAgICAgRFRYTWVzc2FnZUhlYWRlciwgRFRYTWVzc2FnZX0gZnJvbSAnLi4vaGVhZGVycyc7XG5cbmNsYXNzIERUWERlY29kZXIgZXh0ZW5kcyBTdHJlYW0uVHJhbnNmb3JtIHtcblxuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgc3VwZXIoeyBvYmplY3RNb2RlOiB0cnVlIH0pO1xuICAgIHRoaXMuX2R0eE1hbmFnZXIgPSB7fTtcbiAgICB0aGlzLmJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSgwKTtcbiAgICB0aGlzLmN1cnNvciA9IDA7XG4gICAgdGhpcy5oZWFkZXIgPSB1bmRlZmluZWQ7XG4gIH1cblxuICBfdHJhbnNmb3JtIChkYXRhLCBlbmNvZGluZywgb25EYXRhKSB7XG4gICAgdGhpcy5fZGVjb2RlKGRhdGEpO1xuICAgIG9uRGF0YSgpO1xuICB9XG5cbiAgX2RlY29kZSAoZGF0YSkge1xuICAgIC8vIE1lcmdlIHBhY2tldHNcbiAgICB0aGlzLmJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoW3RoaXMuYnVmZmVyLnNsaWNlKHRoaXMuY3Vyc29yLCB0aGlzLmJ1ZmZlci5sZW5ndGgpLCBkYXRhXSk7XG4gICAgdGhpcy5jdXJzb3IgPSAwO1xuICAgIHdoaWxlICh0aGlzLmN1cnNvciA8IHRoaXMuYnVmZmVyLmxlbmd0aCkge1xuICAgICAgY29uc3QgbWFnaWMgPSB0aGlzLl9yZWN2KERUWF9NRVNTQUdFX0hFQURFUl9NQUdJQ19MRU4pO1xuICAgICAgaWYgKCFtYWdpYykgeyByZXR1cm47IH1cbiAgICAgIHRoaXMuY3Vyc29yIC09IERUWF9NRVNTQUdFX0hFQURFUl9NQUdJQ19MRU47XG4gICAgICBpZiAobWFnaWMgJiYgbWFnaWMucmVhZFVJbnQzMkxFKDApID09PSBEVFhfTUVTU0FHRV9IRUFERVJfTUFHSUMpIHtcbiAgICAgICAgY29uc3QgaGVhZGVyQnVmZmVyID0gdGhpcy5fcmVjdihEVFhfTUVTU0FHRV9IRUFERVJfTEVOR1RIKTtcbiAgICAgICAgaWYgKCFoZWFkZXJCdWZmZXIpIHsgcmV0dXJuOyB9XG4gICAgICAgIHRoaXMuaGVhZGVyID0gRFRYTWVzc2FnZUhlYWRlci5wYXJzZShoZWFkZXJCdWZmZXIpO1xuICAgICAgICBpZiAodGhpcy5oZWFkZXIuZnJhZ21lbnRJZCA9PT0gMCkge1xuICAgICAgICAgIC8vIG9ubHkgdGhlIDB0aCBmcmFnbWVudCBjb250YWlucyBhIG1lc3NhZ2UgaGVhZGVyXG4gICAgICAgICAgaWYgKCEodGhpcy5oZWFkZXIuY2hhbm5lbCBpbiB0aGlzLl9kdHhNYW5hZ2VyKSkge1xuICAgICAgICAgICAgdGhpcy5fZHR4TWFuYWdlclt0aGlzLmhlYWRlci5jaGFubmVsXSA9IHtoZWFkZXJCdWZmZXIsIHBheWxvYWRCdWZmZXI6IG5ldyBCdWZmZXIuYWxsb2NVbnNhZmUoMCl9O1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodGhpcy5oZWFkZXIuZnJhZ21lbnRDb3VudCA+IDEpIHtcbiAgICAgICAgICAgIC8vIENvbnRpbnVlIHRvIGdldCB0aGUgbmV4dCBtZXNzYWdlIGZyYWdtZW50c1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCBib2R5QnVmZmVyID0gdGhpcy5fcmVjdih0aGlzLmhlYWRlci5wYXlsb2FkTGVuZ3RoKTtcbiAgICAgIGlmICghYm9keUJ1ZmZlcikgeyByZXR1cm47IH1cbiAgICAgIGlmICh0aGlzLl9kdHhNYW5hZ2VyW3RoaXMuaGVhZGVyLmNoYW5uZWxdKSB7XG4gICAgICAgIHRoaXMuX2R0eE1hbmFnZXJbdGhpcy5oZWFkZXIuY2hhbm5lbF0ucGF5bG9hZEJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoW3RoaXMuX2R0eE1hbmFnZXJbdGhpcy5oZWFkZXIuY2hhbm5lbF0ucGF5bG9hZEJ1ZmZlciwgYm9keUJ1ZmZlcl0pO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuaGVhZGVyLmZyYWdtZW50SWQgPT09ICh0aGlzLmhlYWRlci5mcmFnbWVudENvdW50IC0gMSkpIHtcbiAgICAgICAgZGF0YSA9IHRoaXMuX2R0eE1hbmFnZXJbdGhpcy5oZWFkZXIuY2hhbm5lbF07XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9kdHhNYW5hZ2VyW3RoaXMuaGVhZGVyLmNoYW5uZWxdO1xuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgIHRoaXMucHVzaChEVFhNZXNzYWdlLnBhcnNlKGRhdGEuaGVhZGVyQnVmZmVyLCBkYXRhLnBheWxvYWRCdWZmZXIpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmN1cnNvciA9IDA7XG4gICAgdGhpcy5idWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoMCk7XG4gIH1cblxuICBfcmVjdiAobGVuZ3RoKSB7XG4gICAgaWYgKHRoaXMuYnVmZmVyLmxlbmd0aCA8IHRoaXMuY3Vyc29yICsgbGVuZ3RoKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgYnVmID0gdGhpcy5idWZmZXIuc2xpY2UodGhpcy5jdXJzb3IsIHRoaXMuY3Vyc29yICsgbGVuZ3RoKTtcbiAgICB0aGlzLmN1cnNvciArPSBsZW5ndGg7XG4gICAgcmV0dXJuIGJ1ZjtcbiAgfVxufVxuXG5leHBvcnQgeyBEVFhEZWNvZGVyIH07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsSUFBQUEsT0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsUUFBQSxHQUFBRCxPQUFBO0FBR0EsTUFBTUUsVUFBVSxTQUFTQyxlQUFNLENBQUNDLFNBQVMsQ0FBQztFQUV4Q0MsV0FBV0EsQ0FBQSxFQUFJO0lBQ2IsS0FBSyxDQUFDO01BQUVDLFVBQVUsRUFBRTtJQUFLLENBQUMsQ0FBQztJQUMzQixJQUFJLENBQUNDLFdBQVcsR0FBRyxDQUFDLENBQUM7SUFDckIsSUFBSSxDQUFDQyxNQUFNLEdBQUdDLE1BQU0sQ0FBQ0MsV0FBVyxDQUFDLENBQUMsQ0FBQztJQUNuQyxJQUFJLENBQUNDLE1BQU0sR0FBRyxDQUFDO0lBQ2YsSUFBSSxDQUFDQyxNQUFNLEdBQUdDLFNBQVM7RUFDekI7RUFFQUMsVUFBVUEsQ0FBRUMsSUFBSSxFQUFFQyxRQUFRLEVBQUVDLE1BQU0sRUFBRTtJQUNsQyxJQUFJLENBQUNDLE9BQU8sQ0FBQ0gsSUFBSSxD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