{"version":3,"file":"dtx-decode.js","names":["_stream","_interopRequireDefault","require","_headers","DTXDecoder","Stream","Transform","constructor","objectMode","_dtxManager","buffer","Buffer","allocUnsafe","cursor","header","undefined","_transform","data","encoding","onData","_decode","concat","slice","length","magic","_recv","DTX_MESSAGE_HEADER_MAGIC_LEN","readUInt32LE","DTX_MESSAGE_HEADER_MAGIC","headerBuffer","DTX_MESSAGE_HEADER_LENGTH","DTXMessageHeader","parse","fragmentId","channel","payloadBuffer","fragmentCount","bodyBuffer","payloadLength","push","DTXMessage","buf","exports"],"sources":["../../../../lib/instrument/transformer/dtx-decode.js"],"sourcesContent":["import Stream from 'stream';\nimport { DTX_MESSAGE_HEADER_LENGTH, DTX_MESSAGE_HEADER_MAGIC, DTX_MESSAGE_HEADER_MAGIC_LEN,\n         DTXMessageHeader, DTXMessage} from '../headers';\n\nclass DTXDecoder extends Stream.Transform {\n\n  constructor () {\n    super({ objectMode: true });\n    this._dtxManager = {};\n    this.buffer = Buffer.allocUnsafe(0);\n    this.cursor = 0;\n    this.header = undefined;\n  }\n\n  _transform (data, encoding, onData) {\n    this._decode(data);\n    onData();\n  }\n\n  _decode (data) {\n    // Merge packets\n    this.buffer = Buffer.concat([this.buffer.slice(this.cursor, this.buffer.length), data]);\n    this.cursor = 0;\n    while (this.cursor < this.buffer.length) {\n      const magic = this._recv(DTX_MESSAGE_HEADER_MAGIC_LEN);\n      if (!magic) { return; }\n      this.cursor -= DTX_MESSAGE_HEADER_MAGIC_LEN;\n      if (magic && magic.readUInt32LE(0) === DTX_MESSAGE_HEADER_MAGIC) {\n        const headerBuffer = this._recv(DTX_MESSAGE_HEADER_LENGTH);\n        if (!headerBuffer) { return; }\n        this.header = DTXMessageHeader.parse(headerBuffer);\n        if (this.header.fragmentId === 0) {\n          // only the 0th fragment contains a message header\n          if (!(this.header.channel in this._dtxManager)) {\n            this._dtxManager[this.header.channel] = {headerBuffer, payloadBuffer: new Buffer.allocUnsafe(0)};\n          }\n          if (this.header.fragmentCount > 1) {\n            // Continue to get the next message fragments\n            continue;\n          }\n        }\n      }\n      const bodyBuffer = this._recv(this.header.payloadLength);\n      if (!bodyBuffer) { return; }\n      if (this._dtxManager[this.header.channel]) {\n        this._dtxManager[this.header.channel].payloadBuffer = Buffer.concat([this._dtxManager[this.header.channel].payloadBuffer, bodyBuffer]);\n      }\n      if (this.header.fragmentId === (this.header.fragmentCount - 1)) {\n        data = this._dtxManager[this.header.channel];\n        delete this._dtxManager[this.header.channel];\n        if (data) {\n          this.push(DTXMessage.parse(data.headerBuffer, data.payloadBuffer));\n        }\n      }\n    }\n    this.cursor = 0;\n    this.buffer = Buffer.allocUnsafe(0);\n  }\n\n  _recv (length) {\n    if (this.buffer.length < this.cursor + length) {\n      return null;\n    }\n    const buf = this.buffer.slice(this.cursor, this.cursor + length);\n    this.cursor += length;\n    return buf;\n  }\n}\n\nexport { DTXDecoder };\n"],"mappings":"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"}