{"version":3,"file":"index.js","names":["_lodash","_interopRequireDefault","require","_baseService","LOCKDOWN_PORT","exports","LABEL","PROTOCOL_VERSION","Lockdown","BaseServicePlist","queryType","timeout","data","_plistService","sendPlistAndReceive","Label","ProtocolVersion","Request","Type","Error","JSON","stringify","startSession","hostID","systemBUID","HostID","SystemBUID","SessionID","sessionID","enableSessionSSL","EnableSessionSSL","hostPrivateKey","hostCertificate","getValue","query","plist","Object","assign","_","isNil","Value","startService","serviceName","Service","_default","default"],"sources":["../../../lib/lockdown/index.js"],"sourcesContent":["import _ from 'lodash';\nimport { BaseServicePlist } from '../base-service';\n\n\nconst LOCKDOWN_PORT = 62078;\nconst LABEL = 'usbmuxd';\nconst PROTOCOL_VERSION = 2;\n\nclass Lockdown extends BaseServicePlist {\n  /**\n   * Makes a query type request to lockdown\n   * @param {number} [timeout=5000] the timeout of receiving a response from lockdownd\n   * @returns {Object}\n   */\n  async queryType (timeout = 5000) {\n    const data = await this._plistService.sendPlistAndReceive({\n      Label: LABEL,\n      ProtocolVersion: PROTOCOL_VERSION,\n      Request: 'QueryType'\n    }, timeout);\n    if (data.Request === 'QueryType' && data.Type === 'com.apple.mobile.lockdown') {\n      return data;\n    } else {\n      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);\n    }\n  }\n\n  /**\n   * Starts a lockdown session which allows to use certain apis\n   * @param {string} hostID the host id which can be retrieved from the pair record\n   * @param {string} systemBUID the host BUID which can be retrieved from the pair record\n   * @param {number} [timeout=5000] the timeout of receiving a response from lockdownd\n   * @returns {Object}\n   */\n  async startSession (hostID, systemBUID, timeout = 5000) {\n    const data = await this._plistService.sendPlistAndReceive({\n      Label: LABEL,\n      ProtocolVersion: PROTOCOL_VERSION,\n      Request: 'StartSession',\n      HostID: hostID,\n      SystemBUID: systemBUID\n    }, timeout);\n\n    if (data.Request === 'StartSession' && data.SessionID) {\n      return { sessionID: data.SessionID, enableSessionSSL: data.EnableSessionSSL };\n    } else {\n      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);\n    }\n  }\n\n  /**\n   * Enables ssl in the underlying socket socket connection\n   * @param {Buffer} hostPrivateKey the private key which can be retrieved from the pair record\n   * @param {Buffer} hostCertificate the certificate which can be retrieved from the pair record\n   */\n  enableSessionSSL (hostPrivateKey, hostCertificate) {\n    this._plistService.enableSessionSSL(hostPrivateKey, hostCertificate);\n  }\n\n  /**\n  * @typedef {Object} Query\n  *\n  * @property {?string} key The key we want to access\n  * @property {?string} domain The domain where we want to access\n  */\n\n  /**\n   * Gets values from the device according to the query passed\n   *\n   * @param {Query} query the query we want to send to lockdownd\n   * @param {number} [timeout=5000] the timeout of receiving a response from lockdownd\n   * @returns {*} The actual response value. It should never be `null` or `undefined`\n   * @throws {Error} If an unexpected response is received from lockdownd\n   */\n  async getValue (query = {}, timeout = 5000) {\n    const plist = Object.assign({\n      Label: LABEL,\n      ProtocolVersion: PROTOCOL_VERSION,\n      Request: 'GetValue'\n    }, query);\n    const data = await this._plistService.sendPlistAndReceive(plist, timeout);\n    if (data?.Request === 'GetValue' && !_.isNil(data?.Value)) {\n      return data.Value;\n    }\n    throw new Error(`Unexpected data received for ${JSON.stringify(query)} request: ` +\n      JSON.stringify(data));\n  }\n\n  /**\n   * Starts a service on the phone corresponding to the name\n   * @param {string} serviceName the name of the service which we want to start\n   * @param {number} [timeout=5000] the timeout of receiving a response from lockdownd\n   * @returns {Object}\n   */\n  async startService (serviceName, timeout = 5000) {\n    const data = await this._plistService.sendPlistAndReceive({\n      Label: LABEL,\n      ProtocolVersion: PROTOCOL_VERSION,\n      Request: 'StartService',\n      Service: serviceName,\n    }, timeout);\n\n    if (data.Error) {\n      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);\n    } else {\n      return data;\n    }\n  }\n}\n\nexport { Lockdown, LOCKDOWN_PORT };\nexport default Lockdown;\n"],"mappings":"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"}