"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SyslogDecoder = void 0;
exports.unescape = unescape;
require("source-map-support/register");
var _stream = _interopRequireDefault(require("stream"));
const NEW_LINE_CODE = 0x0A;
const NULL_DELIMETER_CODE = 0x00;
const BACKSLASH_CODE = '\\'.codePointAt(0);
const SHIFTS_MAPPING = {
  '-': 0x80,
  '^': 0x40
};
const ESCAPE_TOKEN_LEN = 4;
const ESCAPE_TOKEN_PATTERN = /\\M(-|\^)(.)/;
function toUtf8Byte(escapedChar, modifier) {
  const shift = SHIFTS_MAPPING[modifier];
  return isNaN(shift) ? null : escapedChar.codePointAt(0) + shift;
}
function unescape(logBuffer) {
  const parseUtf8Chars = start => {
    let cursor = start;
    const token = new Uint8Array(ESCAPE_TOKEN_LEN);
    const utf8CharsAsBytes = [];
    while (cursor <= logBuffer.length - ESCAPE_TOKEN_LEN) {
      logBuffer.copy(token, 0, cursor, cursor + ESCAPE_TOKEN_LEN);
      const tokenStr = Buffer.from(token).toString('latin1');
      const tokenMatch = ESCAPE_TOKEN_PATTERN.exec(tokenStr);
      if (!tokenMatch) {
        break;
      }
      const byte = toUtf8Byte(tokenMatch[2], tokenMatch[1]);
      if (byte === null) {
        break;
      }
      utf8CharsAsBytes.push(byte);
      cursor += ESCAPE_TOKEN_LEN;
    }
    return utf8CharsAsBytes.length ? [cursor, Buffer.from(utf8CharsAsBytes).toString('utf8')] : [start, null];
  };
  let index = 0;
  let result = '';
  const bytesView = new Uint8Array(logBuffer);
  while (index < bytesView.length) {
    if (bytesView[index] === BACKSLASH_CODE) {
      const [newIndex, chars] = parseUtf8Chars(index);
      if (newIndex > index) {
        result += chars;
        index = newIndex;
        continue;
      }
    }
    result += String.fromCharCode(bytesView[index++]);
  }
  return result;
}
class SyslogDecoder extends _stream.default.Transform {
  constructor(bufferLength) {
    super({
      objectMode: true
    });
    this.bufferIndex = 0;
    this.buffer = Buffer.allocUnsafe(bufferLength);
  }
  _transform(data, encoding, onData) {
    this._decode(data);
    onData();
  }
  _decode(data) {
    for (let i = 0; i < data.length; i++) {
      if (data[i] === NULL_DELIMETER_CODE) {
        continue;
      }
      if (data[i] === NEW_LINE_CODE) {
        if (this.bufferIndex > 0) {
          const stringBuffer = Buffer.allocUnsafe(this.bufferIndex);
          this.buffer.copy(stringBuffer, 0, 0, this.bufferIndex);
          this.push(unescape(stringBuffer), 'utf8');
          this.bufferIndex = 0;
        }
        continue;
      }
      this.buffer[this.bufferIndex] = data[i];
      this.bufferIndex++;
    }
  }
}
exports.SyslogDecoder = SyslogDecoder;
var _default = SyslogDecoder;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3RyZWFtIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJORVdfTElORV9DT0RFIiwiTlVMTF9ERUxJTUVURVJfQ09ERSIsIkJBQ0tTTEFTSF9DT0RFIiwiY29kZVBvaW50QXQiLCJTSElGVFNfTUFQUElORyIsIkVTQ0FQRV9UT0tFTl9MRU4iLCJFU0NBUEVfVE9LRU5fUEFUVEVSTiIsInRvVXRmOEJ5dGUiLCJlc2NhcGVkQ2hhciIsIm1vZGlmaWVyIiwic2hpZnQiLCJpc05hTiIsInVuZXNjYXBlIiwibG9nQnVmZmVyIiwicGFyc2VVdGY4Q2hhcnMiLCJzdGFydCIsImN1cnNvciIsInRva2VuIiwiVWludDhBcnJheSIsInV0ZjhDaGFyc0FzQnl0ZXMiLCJsZW5ndGgiLCJjb3B5IiwidG9rZW5TdHIiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJ0b2tlbk1hdGNoIiwiZXhlYyIsImJ5dGUiLCJwdXNoIiwiaW5kZXgiLCJyZXN1bHQiLCJieXRlc1ZpZXciLCJuZXdJbmRleCIsImNoYXJzIiwiU3RyaW5nIiwiZnJvbUNoYXJDb2RlIiwiU3lzbG9nRGVjb2RlciIsIlN0cmVhbSIsIlRyYW5zZm9ybSIsImNvbnN0cnVjdG9yIiwiYnVmZmVyTGVuZ3RoIiwib2JqZWN0TW9kZSIsImJ1ZmZlckluZGV4IiwiYnVmZmVyIiwiYWxsb2NVbnNhZmUiLCJfdHJhbnNmb3JtIiwiZGF0YSIsImVuY29kaW5nIiwib25EYXRhIiwiX2RlY29kZSIsImkiLCJzdHJpbmdCdWZmZXIiLCJleHBvcnRzIiwiX2RlZmF1bHQiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vbGliL3N5c2xvZy90cmFuc2Zvcm1lci9zeXNsb2ctZGVjb2Rlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3RyZWFtIGZyb20gJ3N0cmVhbSc7XG5cbmNvbnN0IE5FV19MSU5FX0NPREUgPSAweDBBO1xuY29uc3QgTlVMTF9ERUxJTUVURVJfQ09ERSA9IDB4MDA7XG5jb25zdCBCQUNLU0xBU0hfQ09ERSA9ICdcXFxcJy5jb2RlUG9pbnRBdCgwKTtcbmNvbnN0IFNISUZUU19NQVBQSU5HID0ge1xuICAnLSc6IDB4ODAsXG4gICdeJzogMHg0MCxcbn07XG5jb25zdCBFU0NBUEVfVE9LRU5fTEVOID0gNDtcbmNvbnN0IEVTQ0FQRV9UT0tFTl9QQVRURVJOID0gL1xcXFxNKC18XFxeKSguKS87XG5cblxuZnVuY3Rpb24gdG9VdGY4Qnl0ZSAoZXNjYXBlZENoYXIsIG1vZGlmaWVyKSB7XG4gIGNvbnN0IHNoaWZ0ID0gU0hJRlRTX01BUFBJTkdbbW9kaWZpZXJdO1xuICByZXR1cm4gaXNOYU4oc2hpZnQpID8gbnVsbCA6IGVzY2FwZWRDaGFyLmNvZGVQb2ludEF0KDApICsgc2hpZnQ7XG59XG5cbi8qKlxuICogVW5lc2NhcGVzIHV0ZjgtZW5jb2RlZCBjaGFyYWN0ZXJzLCBzbyB0aGUgb3V0cHV0IGxvb2tzXG4gKiBsaWtlIGEgdmFsaWQgc3RyaW5nLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzE0NDc2XG4gKiBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBwYXJhbSB7QnVmZmVyfSBsb2dCdWZmZXIgQSBzaW5nbGUgZXNjYXBlZCBsb2cgbGluZVxuICogQHJldHVybnMge3N0cmluZ30gVGhlIHVuZXNjYXBlZCBzdHJpbmcgb3IgdGhlIHNhbWUgc3RyaW5nIGlmIG5vIHVuZXNjYXBpbmdcbiAqIGlzIG5lY2Vzc2FyeS5cbiAqL1xuZnVuY3Rpb24gdW5lc2NhcGUgKGxvZ0J1ZmZlcikge1xuICBjb25zdCBwYXJzZVV0ZjhDaGFycyA9IChzdGFydCkgPT4ge1xuICAgIGxldCBjdXJzb3IgPSBzdGFydDtcbiAgICBjb25zdCB0b2tlbiA9IG5ldyBVaW50OEFycmF5KEVTQ0FQRV9UT0tFTl9MRU4pO1xuICAgIGNvbnN0IHV0ZjhDaGFyc0FzQnl0ZXMgPSBbXTtcbiAgICB3aGlsZSAoY3Vyc29yIDw9IGxvZ0J1ZmZlci5sZW5ndGggLSBFU0NBUEVfVE9LRU5fTEVOKSB7XG4gICAgICBsb2dCdWZmZXIuY29weSh0b2tlbiwgMCwgY3Vyc29yLCBjdXJzb3IgKyBFU0NBUEVfVE9LRU5fTEVOKTtcbiAgICAgIGNvbnN0IHRva2VuU3RyID0gQnVmZmVyLmZyb20odG9rZW4pLnRvU3RyaW5nKCdsYXRpbjEnKTtcbiAgICAgIGNvbnN0IHRva2VuTWF0Y2ggPSBFU0NBUEVfVE9LRU5fUEFUVEVSTi5leGVjKHRva2VuU3RyKTtcbiAgICAgIGlmICghdG9rZW5NYXRjaCkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJ5dGUgPSB0b1V0ZjhCeXRlKHRva2VuTWF0Y2hbMl0sIHRva2VuTWF0Y2hbMV0pO1xuICAgICAgaWYgKGJ5dGUgPT09IG51bGwpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICB1dGY4Q2hhcnNBc0J5dGVzLnB1c2goYnl0ZSk7XG4gICAgICBjdXJzb3IgKz0gRVNDQVBFX1RPS0VOX0xFTjtcbiAgICB9XG4gICAgcmV0dXJuIHV0ZjhDaGFyc0FzQnl0ZXMubGVuZ3RoXG4gICAgICA/IFtjdXJzb3IsIEJ1ZmZlci5mcm9tKHV0ZjhDaGFyc0FzQnl0ZXMpLnRvU3RyaW5nKCd1dGY4JyldXG4gICAgICA6IFtzdGFydCwgbnVsbF07XG4gIH07XG5cbiAgbGV0IGluZGV4ID0gMDtcbiAgbGV0IHJlc3VsdCA9ICcnO1xuICBjb25zdCBieXRlc1ZpZXcgPSBuZXcgVWludDhBcnJheShsb2dCdWZmZXIpO1xuICB3aGlsZSAoaW5kZXggPCBieXRlc1ZpZXcubGVuZ3RoKSB7XG4gICAgaWYgKGJ5dGVzVmlld1tpbmRleF0gPT09IEJBQ0tTTEFTSF9DT0RFKSB7XG4gICAgICBjb25zdCBbbmV3SW5kZXgsIGNoYXJzXSA9IHBhcnNlVXRmOENoYXJzKGluZGV4KTtcbiAgICAgIGlmIChuZXdJbmRleCA+IGluZGV4KSB7XG4gICAgICAgIHJlc3VsdCArPSBjaGFycztcbiAgICAgICAgaW5kZXggPSBuZXdJbmRleDtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzVmlld1tpbmRleCsrXSk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5cbmNsYXNzIFN5c2xvZ0RlY29kZXIgZXh0ZW5kcyBTdHJlYW0uVHJhbnNmb3JtIHtcblxuICBjb25zdHJ1Y3RvciAoYnVmZmVyTGVuZ3RoKSB7XG4gICAgc3VwZXIoeyBvYmplY3RNb2RlOiB0cnVlIH0pO1xuICAgIHRoaXMuYnVmZmVySW5kZXggPSAwO1xuICAgIHRoaXMuYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKGJ1ZmZlckxlbmd0aCk7XG4gIH1cblxuICBfdHJhbnNmb3JtIChkYXRhLCBlbmNvZGluZywgb25EYXRhKSB7XG4gICAgdGhpcy5fZGVjb2RlKGRhdGEpO1xuICAgIG9uRGF0YSgpO1xuICB9XG5cbiAgX2RlY29kZSAoZGF0YSkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgLy8gRG9uJ3Qgc3RvcmUgdGhlIG51bGwgZGVsaW1ldGVyIG1lc3NhZ2VzXG4gICAgICBpZiAoZGF0YVtpXSA9PT0gTlVMTF9ERUxJTUVURVJfQ09ERSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIC8vIFB1c2ggdGhlIGRhdGEgd2hlbiBuZXcgbGluZSBpcyBzZW50XG4gICAgICBpZiAoZGF0YVtpXSA9PT0gTkVXX0xJTkVfQ09ERSkge1xuICAgICAgICBpZiAodGhpcy5idWZmZXJJbmRleCA+IDApIHtcbiAgICAgICAgICBjb25zdCBzdHJpbmdCdWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUodGhpcy5idWZmZXJJbmRleCk7XG4gICAgICAgICAgdGhpcy5idWZmZXIuY29weShzdHJpbmdCdWZmZXIsIDAsIDAsIHRoaXMuYnVmZmVySW5kZXgpO1xuICAgICAgICAgIHRoaXMucHVzaCh1bmVzY2FwZShzdHJpbmdCdWZmZXIpLCAndXRmOCcpO1xuICAgICAgICAgIHRoaXMuYnVmZmVySW5kZXggPSAwO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgdGhpcy5idWZmZXJbdGhpcy5idWZmZXJJbmRleF0gPSBkYXRhW2ldO1xuICAgICAgdGhpcy5idWZmZXJJbmRleCsrO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBTeXNsb2dEZWNvZGVyLCB1bmVzY2FwZSB9O1xuZXhwb3J0IGRlZmF1bHQgU3lzbG9nRGVjb2RlcjtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsSUFBQUEsT0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBRUEsTUFBTUMsYUFBYSxHQUFHLElBQUk7QUFDMUIsTUFBTUMsbUJBQW1CLEdBQUcsSUFBSTtBQUNoQyxNQUFNQyxjQUFjLEdBQUcsSUFBSSxDQUFDQyxXQUFXLENBQUMsQ0FBQyxDQUFDO0FBQzFDLE1BQU1DLGNBQWMsR0FBRztFQUNyQixHQUFHLEVBQUUsSUFBSTtFQUNULEdBQUcsRUFBRTtBQUNQLENBQUM7QUFDRCxNQUFNQyxnQkFBZ0IsR0FBRyxDQUFDO0FBQzFCLE1BQU1DLG9CQUFvQixHQUFHLGNBQWM7QUFHM0MsU0FBU0MsVUFBVUEsQ0FBRUMsV0FBVyxFQUFFQyxRQUFRLEVBQUU7RUFDMUMsTUFBTUMsS0FBSyxHQUFHTixjQUFjLENBQUNLLFFBQVEsQ0FBQztFQUN0QyxPQUFPRSxLQUFLLENBQUNELEtBQUssQ0FBQyxHQUFHLElBQUksR0FBR0YsV0FBVyxDQUFDTCxXQUFXLENBQUMsQ0FBQyxDQUFDLEdBQUdPLEtBQUs7QUFDakU7QUFXQSxTQUFTRSxRQUFRQSxDQUFFQyxTQUFTLEVBQUU7RUFDNUIsTUFBTUMsY0FBYyxHQUFJQyxLQUFLLElBQUs7SUFDaEMsSUFBSUMsTUFBTSxHQUFHRCxLQUFLO0lBQ2xCLE1BQU1FLEtBQUssR0FBRyxJQUFJQyxVQUFVLENBQUNiLGdCQUFnQixDQUFDO0lBQzlDLE1BQU1jLGdCQUFnQixHQUFHLEVBQUU7SUFDM0IsT0FBT0gsTUFBTSxJQUFJSCxTQUFTLENBQUNPLE1BQU0sR0FBR2YsZ0JBQWdCLEVBQUU7TUFDcERRLFNBQVMsQ0FBQ1EsSUFBSSxDQUFDSixLQUFLLEVBQUUsQ0FBQyxFQUFFRCxNQUFNLEVBQUVBLE1BQU0sR0FBR1gsZ0JBQWdCLENBQUM7TUFDM0QsTUFBTWlCLFFBQVEsR0FBR0MsTUFBTSxDQUFDQyxJQUFJLENBQUNQLEtBQUssQ0FBQyxDQUFDUSxRQUFRLENBQUMsUUFBUSxDQUFDO01BQ3RELE1BQU1DLFVBQVUsR0FBR3BCLG9CQUFvQixDQUFDcUIsSUFBSSxDQUFDTCxRQUFRLENBQUM7TUFDdEQsSUFBSSxDQUFDSSxVQUFVLEVBQUU7UUFDZjtNQUNGO01BQ0EsTUFBTUUsSUFBSSxHQUFHckIsVUFBVSxDQUFDbUIsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFQSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7TUFDckQsSUFBSUUsSUFBSSxLQUFLLElBQUksRUFBRTtRQUNqQjtNQUNGO01BQ0FULGdCQUFnQixDQUFDVSxJQUFJLENBQUNELElBQUksQ0FBQztNQUMzQlosTUFBTSxJQUFJWCxnQkFBZ0I7SUFDNUI7SUFDQSxPQUFPYyxnQkFBZ0IsQ0FBQ0MsTUFBTSxHQUMxQixDQUFDSixNQUFNLEVBQUVPLE1BQU0sQ0FBQ0MsSUFBSSxDQUFDTCxnQkFBZ0IsQ0FBQyxDQUFDTSxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsR0FDeEQsQ0FBQ1YsS0FBSyxFQUFFLElBQUksQ0FBQztFQUNuQixDQUFDO0VBRUQsSUFBSWUsS0FBSyxHQUFHLENBQUM7RUFDYixJQUFJQyxNQUFNLEdBQUcsRUFBRTtFQUNmLE1BQU1DLFNBQVMsR0FBRyxJQUFJZCxVQUFVLENBQUNMLFNBQVMsQ0FBQztFQUMzQyxPQUFPaUIsS0FBSyxHQUFHRSxTQUFTLENBQUNaLE1BQU0sRUFBRTtJQUMvQixJQUFJWSxTQUFTLENBQUNGLEtBQUssQ0FBQyxLQUFLNUIsY0FBYyxFQUFFO01BQ3ZDLE1BQU0sQ0FBQytCLFFBQVEsRUFBRUMsS0FBSyxDQUFDLEdBQUdwQixjQUFjLENBQUNnQixLQUFLLENBQUM7TUFDL0MsSUFBSUcsUUFBUSxHQUFHSCxLQUFLLEVBQUU7UUFDcEJDLE1BQU0sSUFBSUcsS0FBSztRQUNmSixLQUFLLEdBQUdHLFFBQVE7UUFDaEI7TUFDRjtJQUNGO0lBQ0FGLE1BQU0sSUFBSUksTUFBTSxDQUFDQyxZQUFZLENBQUNKLFNBQVMsQ0FBQ0YsS0FBSyxFQUFFLENBQUMsQ0FBQztFQUNuRDtFQUVBLE9BQU9DLE1BQU07QUFDZjtBQUdBLE1BQU1NLGFBQWEsU0FBU0MsZUFBTSxDQUFDQyxTQUFTLENBQUM7RUFFM0NDLFdBQVdBLENBQUVDLFlBQVksRUFBRTtJQUN6QixLQUFLLENBQUM7TUFBRUMsVUFBVSxFQUFFO0lBQUssQ0FBQyxDQUFDO0lBQzNCLElBQUksQ0FBQ0MsV0FBVyxHQUFHLENBQUM7SUFDcEIsSUFBSSxDQUFDQyxNQUFNLEdBQUdyQixNQUFNLENBQUNzQixXQUFXLENBQUNKLFlBQVksQ0FBQztFQUNoRDtFQUVBSyxVQUFVQSxDQUFFQyxJQUFJLEVBQUVDLFFBQVEsRUFBRUMsTUFBTSxFQUFFO0lBQ2xDLElBQUksQ0FBQ0MsT0FBTyxDQUFDSCxJQUFJLENBQUM7SUFDbEJFLE1BQU0sRUFBRTtFQUNWO0VBRUFDLE9BQU9BLENBQUVILElBQUksRUFBRTtJQUNiLEtBQUssSUFBSUksQ0FBQyxHQUFHLENBQUMsRUFBRUEsQ0FBQyxHQUFHSixJQUFJLENBQUMzQixNQUFNLEVBQUUrQixDQUFDLEVBQUUsRUFBRTtNQUVwQyxJQUFJSixJQUFJLENBQUNJLENBQUMsQ0FBQyxLQUFLbEQsbUJBQW1CLEVBQUU7UUFDbkM7TUFDRjtNQUVBLElBQUk4QyxJQUFJLENBQUNJLENBQUMsQ0FBQyxLQUFLbkQsYUFBYSxFQUFFO1FBQzdCLElBQUksSUFBSSxDQUFDMkMsV0FBVyxHQUFHLENBQUMsRUFBRTtVQUN4QixNQUFNUyxZQUFZLEdBQUc3QixNQUFNLENBQUNzQixXQUFXLENBQUMsSUFBSSxDQUFDRixXQUFXLENBQUM7VUFDekQsSUFBSSxDQUFDQyxNQUFNLENBQUN2QixJQUFJLENBQUMrQixZQUFZLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUNULFdBQVcsQ0FBQztVQUN0RCxJQUFJLENBQUNkLElBQUksQ0FBQ2pCLFFBQVEsQ0FBQ3dDLFlBQVksQ0FBQyxFQUFFLE1BQU0sQ0FBQztVQUN6QyxJQUFJLENBQUNULFdBQVcsR0FBRyxDQUFDO1FBQ3RCO1FBQ0E7TUFDRjtNQUNBLElBQUksQ0FBQ0MsTUFBTSxDQUFDLElBQUksQ0FBQ0QsV0FBVyxDQUFDLEdBQUdJLElBQUksQ0FBQ0ksQ0FBQyxDQUFDO01BQ3ZDLElBQUksQ0FBQ1IsV0FBVyxFQUFFO0lBQ3BCO0VBQ0Y7QUFDRjtBQUFDVSxPQUFBLENBQUFoQixhQUFBLEdBQUFBLGFBQUE7QUFBQSxJQUFBaUIsUUFBQSxHQUdjakIsYUFBYTtBQUFBZ0IsT0FBQSxDQUFBRSxPQUFBLEdBQUFELFFBQUEifQ==