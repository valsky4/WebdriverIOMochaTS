{"version":3,"file":"syslog-decoder.js","names":["_stream","_interopRequireDefault","require","NEW_LINE_CODE","NULL_DELIMETER_CODE","BACKSLASH_CODE","codePointAt","SHIFTS_MAPPING","ESCAPE_TOKEN_LEN","ESCAPE_TOKEN_PATTERN","toUtf8Byte","escapedChar","modifier","shift","isNaN","unescape","logBuffer","parseUtf8Chars","start","cursor","token","Uint8Array","utf8CharsAsBytes","length","copy","tokenStr","Buffer","from","toString","tokenMatch","exec","byte","push","index","result","bytesView","newIndex","chars","String","fromCharCode","SyslogDecoder","Stream","Transform","constructor","bufferLength","objectMode","bufferIndex","buffer","allocUnsafe","_transform","data","encoding","onData","_decode","i","stringBuffer","exports","_default","default"],"sources":["../../../../lib/syslog/transformer/syslog-decoder.js"],"sourcesContent":["import Stream from 'stream';\n\nconst NEW_LINE_CODE = 0x0A;\nconst NULL_DELIMETER_CODE = 0x00;\nconst BACKSLASH_CODE = '\\\\'.codePointAt(0);\nconst SHIFTS_MAPPING = {\n  '-': 0x80,\n  '^': 0x40,\n};\nconst ESCAPE_TOKEN_LEN = 4;\nconst ESCAPE_TOKEN_PATTERN = /\\\\M(-|\\^)(.)/;\n\n\nfunction toUtf8Byte (escapedChar, modifier) {\n  const shift = SHIFTS_MAPPING[modifier];\n  return isNaN(shift) ? null : escapedChar.codePointAt(0) + shift;\n}\n\n/**\n * Unescapes utf8-encoded characters, so the output looks\n * like a valid string. See https://github.com/appium/appium/issues/14476\n * for more details.\n *\n * @param {Buffer} logBuffer A single escaped log line\n * @returns {string} The unescaped string or the same string if no unescaping\n * is necessary.\n */\nfunction unescape (logBuffer) {\n  const parseUtf8Chars = (start) => {\n    let cursor = start;\n    const token = new Uint8Array(ESCAPE_TOKEN_LEN);\n    const utf8CharsAsBytes = [];\n    while (cursor <= logBuffer.length - ESCAPE_TOKEN_LEN) {\n      logBuffer.copy(token, 0, cursor, cursor + ESCAPE_TOKEN_LEN);\n      const tokenStr = Buffer.from(token).toString('latin1');\n      const tokenMatch = ESCAPE_TOKEN_PATTERN.exec(tokenStr);\n      if (!tokenMatch) {\n        break;\n      }\n      const byte = toUtf8Byte(tokenMatch[2], tokenMatch[1]);\n      if (byte === null) {\n        break;\n      }\n      utf8CharsAsBytes.push(byte);\n      cursor += ESCAPE_TOKEN_LEN;\n    }\n    return utf8CharsAsBytes.length\n      ? [cursor, Buffer.from(utf8CharsAsBytes).toString('utf8')]\n      : [start, null];\n  };\n\n  let index = 0;\n  let result = '';\n  const bytesView = new Uint8Array(logBuffer);\n  while (index < bytesView.length) {\n    if (bytesView[index] === BACKSLASH_CODE) {\n      const [newIndex, chars] = parseUtf8Chars(index);\n      if (newIndex > index) {\n        result += chars;\n        index = newIndex;\n        continue;\n      }\n    }\n    result += String.fromCharCode(bytesView[index++]);\n  }\n\n  return result;\n}\n\n\nclass SyslogDecoder extends Stream.Transform {\n\n  constructor (bufferLength) {\n    super({ objectMode: true });\n    this.bufferIndex = 0;\n    this.buffer = Buffer.allocUnsafe(bufferLength);\n  }\n\n  _transform (data, encoding, onData) {\n    this._decode(data);\n    onData();\n  }\n\n  _decode (data) {\n    for (let i = 0; i < data.length; i++) {\n      // Don't store the null delimeter messages\n      if (data[i] === NULL_DELIMETER_CODE) {\n        continue;\n      }\n      // Push the data when new line is sent\n      if (data[i] === NEW_LINE_CODE) {\n        if (this.bufferIndex > 0) {\n          const stringBuffer = Buffer.allocUnsafe(this.bufferIndex);\n          this.buffer.copy(stringBuffer, 0, 0, this.bufferIndex);\n          this.push(unescape(stringBuffer), 'utf8');\n          this.bufferIndex = 0;\n        }\n        continue;\n      }\n      this.buffer[this.bufferIndex] = data[i];\n      this.bufferIndex++;\n    }\n  }\n}\n\nexport { SyslogDecoder, unescape };\nexport default SyslogDecoder;\n"],"mappings":"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"}