"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Usbmux = void 0;
exports.getDefaultSocket = getDefaultSocket;
require("source-map-support/register");
var _net = _interopRequireDefault(require("net"));
var _os = _interopRequireDefault(require("os"));
var _lodash = _interopRequireDefault(require("lodash"));
var _bluebird = _interopRequireDefault(require("bluebird"));
var _support = require("@appium/support");
var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));
var _usbmuxDecoder = _interopRequireDefault(require("./transformer/usbmux-decoder.js"));
var _usbmuxEncoder = _interopRequireDefault(require("./transformer/usbmux-encoder.js"));
var _path = _interopRequireDefault(require("path"));
var _plistService = _interopRequireDefault(require("../plist-service"));
var _lockdown = require("../lockdown");
var _baseService = require("../base-service");
var _constants = require("../constants");
const MAX_FRAME_SIZE = 1 * _constants.MB;
const USBMUX_RESULT = {
  OK: 0,
  BADCOMMAND: 1,
  BADDEV: 2,
  CONNREFUSED: 3
};
let name, version;
try {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', '..', 'package.json')));
} catch (err) {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', 'package.json')));
}
const DEFAULT_USBMUXD_SOCKET = '/var/run/usbmuxd';
const DEFAULT_USBMUXD_PORT = 27015;
const DEFAULT_USBMUXD_HOST = '127.0.0.1';
const PROG_NAME = name;
const CLIENT_VERSION_STRING = `${name}-${version}`;
function swap16(val) {
  return (val & 0xFF) << 8 | val >> 8 & 0xFF;
}
async function getDefaultSocket(opts = {}) {
  const {
    socketPath = DEFAULT_USBMUXD_SOCKET,
    socketPort = DEFAULT_USBMUXD_PORT,
    socketHost = DEFAULT_USBMUXD_HOST,
    timeout = 5000
  } = opts;
  let socket;
  if (await _support.fs.exists(socketPath)) {
    socket = _net.default.createConnection(socketPath);
  } else if (process.platform === 'win32' || process.platform === 'linux' && /microsoft/i.test(_os.default.release())) {
    socket = _net.default.createConnection(socketPort, socketHost);
  } else {
    throw new Error(`The usbmuxd socket at '${socketPath}' does not exist or is not accessible`);
  }
  return await new _bluebird.default((resolve, reject) => {
    socket.once('error', reject);
    socket.once('connect', () => resolve(socket));
  }).timeout(timeout);
}
class Usbmux extends _baseService.BaseServiceSocket {
  constructor(socketClient) {
    super(socketClient);
    this._decoder = new _usbmuxDecoder.default();
    this._splitter = new _lengthBasedSplitter.default({
      readableStream: socketClient,
      littleEndian: true,
      maxFrameLength: MAX_FRAME_SIZE,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 0
    });
    this._socketClient.pipe(this._splitter).pipe(this._decoder);
    this._encoder = new _usbmuxEncoder.default();
    this._encoder.pipe(this._socketClient);
    this._assignClientFailureHandlers(this._encoder);
    this._tag = 0;
    this._responseCallbacks = {};
    this._decoder.on('data', this._handleData.bind(this));
  }
  _handleData(data) {
    const cb = this._responseCallbacks[data.header.tag] || _lodash.default.noop;
    cb(data);
  }
  async readBUID(timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (data.payload.BUID) {
        return data.payload.BUID;
      }
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    });
    this._sendPlist({
      tag,
      payload: {
        MessageType: 'ReadBUID',
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING
      }
    });
    return await receivePromise;
  }
  async readPairRecord(udid, timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (!data.payload.PairRecordData) {
        return null;
      }
      try {
        return _support.plist.parsePlist(data.payload.PairRecordData);
      } catch (err) {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
    });
    this._sendPlist({
      tag,
      payload: {
        MessageType: 'ReadPairRecord',
        PairRecordID: udid,
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING
      }
    });
    return await receivePromise;
  }
  _sendPlist(json) {
    this._encoder.write(json);
  }
  _receivePlistPromise(timeout = 5000, responseCallback) {
    const tag = this._tag++;
    const receivePromise = new _bluebird.default((resolve, reject) => {
      this._responseCallbacks[tag] = data => {
        try {
          resolve(responseCallback(data));
        } catch (e) {
          reject(e);
        }
      };
      setTimeout(() => reject(new Error(`Failed to receive any data within the timeout: ${timeout}`)), timeout);
    });
    return {
      tag,
      receivePromise
    };
  }
  async listDevices(timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (data.payload.DeviceList) {
        return data.payload.DeviceList;
      }
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    });
    this._sendPlist({
      tag,
      payload: {
        MessageType: 'ListDevices',
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING
      }
    });
    return await receivePromise;
  }
  async findDevice(udid, timeout = 5000) {
    const devices = await this.listDevices(timeout);
    return _lodash.default.find(devices, device => device.Properties.SerialNumber === udid);
  }
  async connectLockdown(udid, timeout = 5000) {
    const device = await this.findDevice(udid, timeout);
    if (!device) {
      throw new Error(`Could not find the expected device '${udid}'`);
    }
    const socket = await this.connect(device.Properties.DeviceID, _lockdown.LOCKDOWN_PORT, timeout);
    return new _lockdown.Lockdown(new _plistService.default(socket));
  }
  async connect(deviceID, port, timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (data.payload.MessageType !== 'Result') {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
      if (data.payload.Number === USBMUX_RESULT.OK) {
        this._splitter.shutdown();
        this._socketClient.unpipe(this._splitter);
        this._splitter.unpipe(this._decoder);
        return this._socketClient;
      } else if (data.payload.Number === USBMUX_RESULT.CONNREFUSED) {
        throw new Error(`Connection was refused to port ${port}`);
      } else {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
    });
    this._sendPlist({
      tag,
      payload: {
        MessageType: 'Connect',
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING,
        DeviceID: deviceID,
        PortNumber: swap16(port)
      }
    });
    return await receivePromise;
  }
}
exports.Usbmux = Usbmux;
var _default = Usbmux;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbmV0IiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfb3MiLCJfbG9kYXNoIiwiX2JsdWViaXJkIiwiX3N1cHBvcnQiLCJfbGVuZ3RoQmFzZWRTcGxpdHRlciIsIl91c2JtdXhEZWNvZGVyIiwiX3VzYm11eEVuY29kZXIiLCJfcGF0aCIsIl9wbGlzdFNlcnZpY2UiLCJfbG9ja2Rvd24iLCJfYmFzZVNlcnZpY2UiLCJfY29uc3RhbnRzIiwiTUFYX0ZSQU1FX1NJWkUiLCJNQiIsIlVTQk1VWF9SRVNVTFQiLCJPSyIsIkJBRENPTU1BTkQiLCJCQURERVYiLCJDT05OUkVGVVNFRCIsIm5hbWUiLCJ2ZXJzaW9uIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJlcnIiLCJERUZBVUxUX1VTQk1VWERfU09DS0VUIiwiREVGQVVMVF9VU0JNVVhEX1BPUlQiLCJERUZBVUxUX1VTQk1VWERfSE9TVCIsIlBST0dfTkFNRSIsIkNMSUVOVF9WRVJTSU9OX1NUUklORyIsInN3YXAxNiIsInZhbCIsImdldERlZmF1bHRTb2NrZXQiLCJvcHRzIiwic29ja2V0UGF0aCIsInNvY2tldFBvcnQiLCJzb2NrZXRIb3N0IiwidGltZW91dCIsInNvY2tldCIsImZzIiwiZXhpc3RzIiwibmV0IiwiY3JlYXRlQ29ubmVjdGlvbiIsInByb2Nlc3MiLCJwbGF0Zm9ybSIsInRlc3QiLCJvcyIsInJlbGVhc2UiLCJFcnJvciIsIkIiLCJyZWplY3QiLCJvbmNlIiwiVXNibXV4IiwiQmFzZVNlcnZpY2VTb2NrZXQiLCJjb25zdHJ1Y3RvciIsInNvY2tldENsaWVudCIsIl9kZWNvZGVyIiwiVXNibXV4RGVjb2RlciIsIl9zcGxpdHRlciIsIkxlbmd0aEJhc2VkU3BsaXR0ZXIiLCJyZWFkYWJsZVN0cmVhbSIsImxpdHRsZUVuZGlhbiIsIm1heEZyYW1lTGVuZ3RoIiwibGVuZ3RoRmllbGRPZmZzZXQiLCJsZW5ndGhGaWVsZExlbmd0aCIsImxlbmd0aEFkanVzdG1lbnQiLCJfc29ja2V0Q2xpZW50IiwicGlwZSIsIl9lbmNvZGVyIiwiVXNibXV4RW5jb2RlciIsIl9hc3NpZ25DbGllbnRGYWlsdXJlSGFuZGxlcnMiLCJfdGFnIiwiX3Jlc3BvbnNlQ2FsbGJhY2tzIiwib24iLCJfaGFuZGxlRGF0YSIsImJpbmQiLCJkYXRhIiwiY2IiLCJoZWFkZXIiLCJ0YWciLCJfIiwibm9vcCIsInJlYWRCVUlEIiwicmVjZWl2ZVByb21pc2UiLCJfcmVjZWl2ZVBsaXN0UHJvbWlzZSIsInBheWxvYWQiLCJCVUlEIiwiSlNPTiIsInN0cmluZ2lmeSIsIl9zZW5kUGxpc3QiLCJNZXNzYWdlVHlwZSIsIlByb2dOYW1lIiwiQ2xpZW50VmVyc2lvblN0cmluZyIsInJlYWRQYWlyUmVjb3JkIiwidWRpZCIsIlBhaXJSZWNvcmREYXRhIiwicGxpc3QiLCJwYXJzZVBsaXN0IiwiUGFpclJlY29yZElEIiwianNvbiIsIndyaXRlIiwicmVzcG9uc2VDYWxsYmFjayIsImUiLCJzZXRUaW1lb3V0IiwibGlzdERldmljZXMiLCJEZXZpY2VMaXN0IiwiZmluZERldmljZSIsImRldmljZXMiLCJmaW5kIiwiZGV2aWNlIiwiUHJvcGVydGllcyIsIlNlcmlhbE51bWJlciIsImNvbm5lY3RMb2NrZG93biIsImNvbm5lY3QiLCJEZXZpY2VJRCIsIkxPQ0tET1dOX1BPUlQiLCJMb2NrZG93biIsIlBsaXN0U2VydmljZSIsImRldmljZUlEIiwicG9ydCIsIk51bWJlciIsInNodXRkb3duIiwidW5waXBlIiwiUG9ydE51bWJlciIsImV4cG9ydHMiLCJfZGVmYXVsdCIsImRlZmF1bHQiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvdXNibXV4L2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgcGxpc3QsIGZzIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBMZW5ndGhCYXNlZFNwbGl0dGVyIGZyb20gJy4uL3V0aWwvdHJhbnNmb3JtZXIvbGVuZ3RoLWJhc2VkLXNwbGl0dGVyJztcbmltcG9ydCBVc2JtdXhEZWNvZGVyIGZyb20gJy4vdHJhbnNmb3JtZXIvdXNibXV4LWRlY29kZXIuanMnO1xuaW1wb3J0IFVzYm11eEVuY29kZXIgZnJvbSAnLi90cmFuc2Zvcm1lci91c2JtdXgtZW5jb2Rlci5qcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBQbGlzdFNlcnZpY2UgZnJvbSAnLi4vcGxpc3Qtc2VydmljZSc7XG5pbXBvcnQgeyBMb2NrZG93biwgTE9DS0RPV05fUE9SVCB9IGZyb20gJy4uL2xvY2tkb3duJztcbmltcG9ydCB7IEJhc2VTZXJ2aWNlU29ja2V0IH0gZnJvbSAnLi4vYmFzZS1zZXJ2aWNlJztcbmltcG9ydCB7IE1CIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcblxuXG5jb25zdCBNQVhfRlJBTUVfU0laRSA9IDEgKiBNQjtcblxuY29uc3QgVVNCTVVYX1JFU1VMVCA9IHtcbiAgT0s6IDAsXG4gIEJBRENPTU1BTkQ6IDEsXG4gIEJBRERFVjogMixcbiAgQ09OTlJFRlVTRUQ6IDMsXG59O1xuXG5sZXQgbmFtZSwgdmVyc2lvbjtcbnRyeSB7XG4gIC8vIGZpcnN0IHRyeSBhc3N1bWluZyB0aGlzIGlzIGluIHRoZSBgYnVpbGRgIGZvbGRlclxuICAoeyBuYW1lLCB2ZXJzaW9uIH0gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSkpO1xufSBjYXRjaCAoZXJyKSB7XG4gIC8vIHRoZW4gdHJ5IGFzc3VtaW5nIGl0IGlzIG5vdFxuICAoeyBuYW1lLCB2ZXJzaW9uIH0gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSkpO1xufVxuXG5jb25zdCBERUZBVUxUX1VTQk1VWERfU09DS0VUID0gJy92YXIvcnVuL3VzYm11eGQnO1xuY29uc3QgREVGQVVMVF9VU0JNVVhEX1BPUlQgPSAyNzAxNTtcbmNvbnN0IERFRkFVTFRfVVNCTVVYRF9IT1NUID0gJzEyNy4wLjAuMSc7XG5jb25zdCBQUk9HX05BTUUgPSBuYW1lO1xuY29uc3QgQ0xJRU5UX1ZFUlNJT05fU1RSSU5HID0gYCR7bmFtZX0tJHt2ZXJzaW9ufWA7XG5cbmZ1bmN0aW9uIHN3YXAxNiAodmFsKSB7XG4gIHJldHVybiAoKHZhbCAmIDB4RkYpIDw8IDgpIHwgKCh2YWwgPj4gOCkgJiAweEZGKTtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTb2NrZXRPcHRpb25zXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHNvY2tldFBhdGggWy92YXIvcnVuL3VzYm11eGRdIFRoZSBmdWxsIHBhdGggdG8gdGhlIHVzYm11eGQgVW5peCBzb2NrZXRcbiAqIEBwcm9wZXJ0eSB7P251bWJlcn0gc29ja2V0UG9ydCBbMjcwMTVdIFRoZSBwb3J0IG51bWJlciB0byBjb25uZWN0IHRvIGlmIHJ1bm5pbmcgb24gV2luZG93c1xuICogb3IgaW4gV1NMMSBtb2RlXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHNvY2tldEhvc3QgWzEyNy4wLjAuMV0gVGhlIGhvc3QgbmFtZSB0byBjb25uZWN0IHRvIGlmIHJ1bm5pbmcgb24gV2luZG93c1xuICogb3IgaW4gV1NMMSBtb2RlXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IHRpbWVvdXQgWzUwMDBdIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWxcbiAqIHRoZSBzb2NrZXQgaXMgY29ubmVjdGVkXG4gKi9cblxuLyoqXG4gKiBDb25uZWN0cyBhIHNvY2tldCB0byB1c2JtdXhkIHNlcnZpY2VcbiAqXG4gKiBAcGFyYW0gez9Tb2NrZXRPcHRpb25zfSBvcHRzXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGFjY2Vzc2luZyB0aGUgc29ja2V0IG9yXG4gKiBhIGNvbm5lY3Rpb24gZXJyb3IgaGFwcGVuZWRcbiAqIEB0aHJvd3Mge0IuVGltZW91dEVycm9yfSBpZiBjb25uZWN0aW9uIHRpbWVvdXQgaGFwcGVuZWRcbiAqIEByZXR1cm5zIHtuZXQuU29ja2V0fSBDb25uZWN0ZWQgc29ja2V0IGluc3RhbmNlXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldERlZmF1bHRTb2NrZXQgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgc29ja2V0UGF0aCA9IERFRkFVTFRfVVNCTVVYRF9TT0NLRVQsXG4gICAgc29ja2V0UG9ydCA9IERFRkFVTFRfVVNCTVVYRF9QT1JULFxuICAgIHNvY2tldEhvc3QgPSBERUZBVUxUX1VTQk1VWERfSE9TVCxcbiAgICB0aW1lb3V0ID0gNTAwMCxcbiAgfSA9IG9wdHM7XG5cbiAgbGV0IHNvY2tldDtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhzb2NrZXRQYXRoKSkge1xuICAgIHNvY2tldCA9IG5ldC5jcmVhdGVDb25uZWN0aW9uKHNvY2tldFBhdGgpO1xuICB9IGVsc2UgaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMidcbiAgICAgIHx8IChwcm9jZXNzLnBsYXRmb3JtID09PSAnbGludXgnICYmIC9taWNyb3NvZnQvaS50ZXN0KG9zLnJlbGVhc2UoKSkpKSB7XG4gICAgLy8gQ29ubmVjdCB0byB1c2JtdXhkIHdoZW4gcnVubmluZyBvbiBXU0wxXG4gICAgc29ja2V0ID0gbmV0LmNyZWF0ZUNvbm5lY3Rpb24oc29ja2V0UG9ydCwgc29ja2V0SG9zdCk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgdXNibXV4ZCBzb2NrZXQgYXQgJyR7c29ja2V0UGF0aH0nIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHNvY2tldC5vbmNlKCdlcnJvcicsIHJlamVjdCk7XG4gICAgc29ja2V0Lm9uY2UoJ2Nvbm5lY3QnLCAoKSA9PiByZXNvbHZlKHNvY2tldCkpO1xuICB9KS50aW1lb3V0KHRpbWVvdXQpO1xufVxuXG5cbmNsYXNzIFVzYm11eCBleHRlbmRzIEJhc2VTZXJ2aWNlU29ja2V0IHtcbiAgY29uc3RydWN0b3IgKHNvY2tldENsaWVudCkge1xuICAgIHN1cGVyKHNvY2tldENsaWVudCk7XG5cbiAgICB0aGlzLl9kZWNvZGVyID0gbmV3IFVzYm11eERlY29kZXIoKTtcbiAgICB0aGlzLl9zcGxpdHRlciA9IG5ldyBMZW5ndGhCYXNlZFNwbGl0dGVyKHtcbiAgICAgIHJlYWRhYmxlU3RyZWFtOiBzb2NrZXRDbGllbnQsXG4gICAgICBsaXR0bGVFbmRpYW46IHRydWUsXG4gICAgICBtYXhGcmFtZUxlbmd0aDogTUFYX0ZSQU1FX1NJWkUsXG4gICAgICBsZW5ndGhGaWVsZE9mZnNldDogMCxcbiAgICAgIGxlbmd0aEZpZWxkTGVuZ3RoOiA0LFxuICAgICAgbGVuZ3RoQWRqdXN0bWVudDogMCxcbiAgICB9KTtcbiAgICB0aGlzLl9zb2NrZXRDbGllbnQucGlwZSh0aGlzLl9zcGxpdHRlcikucGlwZSh0aGlzLl9kZWNvZGVyKTtcblxuICAgIHRoaXMuX2VuY29kZXIgPSBuZXcgVXNibXV4RW5jb2RlcigpO1xuICAgIHRoaXMuX2VuY29kZXIucGlwZSh0aGlzLl9zb2NrZXRDbGllbnQpO1xuICAgIHRoaXMuX2Fzc2lnbkNsaWVudEZhaWx1cmVIYW5kbGVycyh0aGlzLl9lbmNvZGVyKTtcblxuICAgIHRoaXMuX3RhZyA9IDA7XG4gICAgdGhpcy5fcmVzcG9uc2VDYWxsYmFja3MgPSB7fTtcbiAgICB0aGlzLl9kZWNvZGVyLm9uKCdkYXRhJywgdGhpcy5faGFuZGxlRGF0YS5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIF9oYW5kbGVEYXRhIChkYXRhKSB7XG4gICAgY29uc3QgY2IgPSB0aGlzLl9yZXNwb25zZUNhbGxiYWNrc1tkYXRhLmhlYWRlci50YWddIHx8IF8ubm9vcDtcbiAgICBjYihkYXRhKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3NcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBCVUlEIG9mIHRoZSBob3N0IGNvbXB1dGVyIGZyb20gdXNibXV4ZFxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSB1c2JtdXhkXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAqL1xuICBhc3luYyByZWFkQlVJRCAodGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCB7dGFnLCByZWNlaXZlUHJvbWlzZX0gPSB0aGlzLl9yZWNlaXZlUGxpc3RQcm9taXNlKHRpbWVvdXQsIChkYXRhKSA9PiB7XG4gICAgICBpZiAoZGF0YS5wYXlsb2FkLkJVSUQpIHtcbiAgICAgICAgcmV0dXJuIGRhdGEucGF5bG9hZC5CVUlEO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLl9zZW5kUGxpc3Qoe1xuICAgICAgdGFnLFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICBNZXNzYWdlVHlwZTogJ1JlYWRCVUlEJyxcbiAgICAgICAgUHJvZ05hbWU6IFBST0dfTkFNRSxcbiAgICAgICAgQ2xpZW50VmVyc2lvblN0cmluZzogQ0xJRU5UX1ZFUlNJT05fU1RSSU5HXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYXdhaXQgcmVjZWl2ZVByb21pc2U7XG4gIH1cblxuICAvKipcbiAgICogUmVhZHMgdGhlIHBhaXIgcmVjb3JkIG9mIGEgZGV2aWNlLiBJdCB3aWxsIHJldHVybiBudWxsIGlmIGl0IGRvZXNuJ3QgZXhpc3RzXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIHRoZSB1ZGlkIG9mIHRoZSBkZXZpY2VcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gdXNibXV4ZFxuICAgKiBAcmV0dXJucyB7P09iamVjdH1cbiAgICovXG4gIGFzeW5jIHJlYWRQYWlyUmVjb3JkICh1ZGlkLCB0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IHt0YWcsIHJlY2VpdmVQcm9taXNlfSA9IHRoaXMuX3JlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCwgKGRhdGEpID0+IHtcbiAgICAgIGlmICghZGF0YS5wYXlsb2FkLlBhaXJSZWNvcmREYXRhKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIHBsaXN0LnBhcnNlUGxpc3QoZGF0YS5wYXlsb2FkLlBhaXJSZWNvcmREYXRhKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuX3NlbmRQbGlzdCh7XG4gICAgICB0YWcsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIE1lc3NhZ2VUeXBlOiAnUmVhZFBhaXJSZWNvcmQnLFxuICAgICAgICBQYWlyUmVjb3JkSUQ6IHVkaWQsXG4gICAgICAgIFByb2dOYW1lOiBQUk9HX05BTUUsXG4gICAgICAgIENsaWVudFZlcnNpb25TdHJpbmc6IENMSUVOVF9WRVJTSU9OX1NUUklOR1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCByZWNlaXZlUHJvbWlzZTtcbiAgfVxuXG4gIF9zZW5kUGxpc3QgKGpzb24pIHtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKGpzb24pO1xuICB9XG5cbiAgX3JlY2VpdmVQbGlzdFByb21pc2UgKHRpbWVvdXQgPSA1MDAwLCByZXNwb25zZUNhbGxiYWNrKSB7XG4gICAgY29uc3QgdGFnID0gdGhpcy5fdGFnKys7XG4gICAgY29uc3QgcmVjZWl2ZVByb21pc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLl9yZXNwb25zZUNhbGxiYWNrc1t0YWddID0gKGRhdGEpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlQ2FsbGJhY2soZGF0YSkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgc2V0VGltZW91dCgoKSA9PiByZWplY3QobmV3IEVycm9yKGBGYWlsZWQgdG8gcmVjZWl2ZSBhbnkgZGF0YSB3aXRoaW4gdGhlIHRpbWVvdXQ6ICR7dGltZW91dH1gKSksIHRpbWVvdXQpO1xuICAgIH0pO1xuICAgIHJldHVybiB7dGFnLCByZWNlaXZlUHJvbWlzZX07XG4gIH1cblxuICAvKipcbiAgICogTGlzdHMgYWxsIGRldmljZXMgY29ubmVjdGVkIHRvIHRoZSBob3N0XG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHVzYm11eGRcbiAgICogQHJldHVybnMge0FycmF5fVxuICAgKi9cbiAgYXN5bmMgbGlzdERldmljZXMgKHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3Qge3RhZywgcmVjZWl2ZVByb21pc2V9ID0gdGhpcy5fcmVjZWl2ZVBsaXN0UHJvbWlzZSh0aW1lb3V0LCAoZGF0YSkgPT4ge1xuICAgICAgaWYgKGRhdGEucGF5bG9hZC5EZXZpY2VMaXN0KSB7XG4gICAgICAgIHJldHVybiBkYXRhLnBheWxvYWQuRGV2aWNlTGlzdDtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgIH0pO1xuXG4gICAgdGhpcy5fc2VuZFBsaXN0KHtcbiAgICAgIHRhZyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgTWVzc2FnZVR5cGU6ICdMaXN0RGV2aWNlcycsXG4gICAgICAgIFByb2dOYW1lOiBQUk9HX05BTUUsXG4gICAgICAgIENsaWVudFZlcnNpb25TdHJpbmc6IENMSUVOVF9WRVJTSU9OX1NUUklOR1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IHJlY2VpdmVQcm9taXNlO1xuICB9XG5cbiAgLyoqXG4gICAqIExvb2tzIGZvciBhIGRldmljZSB3aXRoIHRoZSBwYXNzZWQgdWRpZC4gSXQgd2lsbCByZXR1cm4gdW5kZWZpbmVkIGlmIHRoZSBkZXZpY2UgaXMgbm90IGZvdW5kXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIHRoZSB1ZGlkIG9mIHRoZSBkZXZpY2VcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gdXNibXV4ZFxuICAgKiBAcmV0dXJucyB7P09iamVjdH1cbiAgICovXG4gIGFzeW5jIGZpbmREZXZpY2UgKHVkaWQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgZGV2aWNlcyA9IGF3YWl0IHRoaXMubGlzdERldmljZXModGltZW91dCk7XG4gICAgcmV0dXJuIF8uZmluZChkZXZpY2VzLCAoZGV2aWNlKSA9PiBkZXZpY2UuUHJvcGVydGllcy5TZXJpYWxOdW1iZXIgPT09IHVkaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbm5lY3RzIHRvIHRoZSBsb2NrZG93bmQgb24gdGhlIGRldmljZSBhbmQgcmV0dXJucyBhIExvY2tkb3duIGNsaWVudFxuICAgKiBAcGFyYW0ge3N0cmluZ30gdWRpZCB0aGUgdWRpZCBvZiB0aGUgZGV2aWNlXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHVzYm11eGRcbiAgICogQHJldHVybnMge0xvY2tkb3dufVxuICAgKi9cbiAgYXN5bmMgY29ubmVjdExvY2tkb3duICh1ZGlkLCB0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IGRldmljZSA9IGF3YWl0IHRoaXMuZmluZERldmljZSh1ZGlkLCB0aW1lb3V0KTtcbiAgICBpZiAoIWRldmljZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCB0aGUgZXhwZWN0ZWQgZGV2aWNlICcke3VkaWR9J2ApO1xuICAgIH1cbiAgICBjb25zdCBzb2NrZXQgPSBhd2FpdCB0aGlzLmNvbm5lY3QoZGV2aWNlLlByb3BlcnRpZXMuRGV2aWNlSUQsIExPQ0tET1dOX1BPUlQsIHRpbWVvdXQpO1xuICAgIHJldHVybiBuZXcgTG9ja2Rvd24obmV3IFBsaXN0U2VydmljZShzb2NrZXQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0cyB0byBhIGNlcnRhaW4gcG9ydCBvbiB0aGUgZGV2aWNlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkZXZpY2VJRCB0aGUgZGV2aWNlIGlkIHdoaWNoIGNhbiBiZSByZXRyaWV2ZWQgZnJvbSB0aGUgcHJvcGVydGllcyBvZiBhIGRldmljZVxuICAgKiBAcGFyYW0ge251bWJlcn0gcG9ydCB0aGUgcG9ydCBudW1iZXIgdGhhdCB3YW50cyB0byBiZSBjb25uZWN0ZWRcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gdXNibXV4ZFxuICAgKiBAcmV0dXJucyB7bmV0LlNvY2tldHxPYmplY3R9IFRoZSBzb2NrZXQgb3IgdGhlIG9iamVjdCByZXR1cm5lZCBpbiB0aGUgY2FsbGJhY2sgaWYgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGV4aXN0c1xuICAgKi9cbiAgYXN5bmMgY29ubmVjdCAoZGV2aWNlSUQsIHBvcnQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3Qge3RhZywgcmVjZWl2ZVByb21pc2V9ID0gdGhpcy5fcmVjZWl2ZVBsaXN0UHJvbWlzZSh0aW1lb3V0LCAoZGF0YSkgPT4ge1xuICAgICAgaWYgKGRhdGEucGF5bG9hZC5NZXNzYWdlVHlwZSAhPT0gJ1Jlc3VsdCcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgICB9XG4gICAgICBpZiAoZGF0YS5wYXlsb2FkLk51bWJlciA9PT0gVVNCTVVYX1JFU1VMVC5PSykge1xuICAgICAgICB0aGlzLl9zcGxpdHRlci5zaHV0ZG93bigpO1xuICAgICAgICB0aGlzLl9zb2NrZXRDbGllbnQudW5waXBlKHRoaXMuX3NwbGl0dGVyKTtcbiAgICAgICAgdGhpcy5fc3BsaXR0ZXIudW5waXBlKHRoaXMuX2RlY29kZXIpO1xuICAgICAgICByZXR1cm4gdGhpcy5fc29ja2V0Q2xpZW50O1xuICAgICAgfSBlbHNlIGlmIChkYXRhLnBheWxvYWQuTnVtYmVyID09PSBVU0JNVVhfUkVTVUxULkNPTk5SRUZVU0VEKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29ubmVjdGlvbiB3YXMgcmVmdXNlZCB0byBwb3J0ICR7cG9ydH1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5fc2VuZFBsaXN0KHtcbiAgICAgIHRhZyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgTWVzc2FnZVR5cGU6ICdDb25uZWN0JyxcbiAgICAgICAgUHJvZ05hbWU6IFBST0dfTkFNRSxcbiAgICAgICAgQ2xpZW50VmVyc2lvblN0cmluZzogQ0xJRU5UX1ZFUlNJT05fU1RSSU5HLFxuICAgICAgICBEZXZpY2VJRDogZGV2aWNlSUQsXG4gICAgICAgIFBvcnROdW1iZXI6IHN3YXAxNihwb3J0KVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IHJlY2VpdmVQcm9taXNlO1xuICB9XG59XG5cbmV4cG9ydCB7IFVzYm11eCwgZ2V0RGVmYXVsdFNvY2tldCB9O1xuZXhwb3J0IGRlZmF1bHQgVXNibXV4O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxJQUFBQSxJQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBQyxHQUFBLEdBQUFGLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBRSxPQUFBLEdBQUFILHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBRyxTQUFBLEdBQUFKLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBSSxRQUFBLEdBQUFKLE9BQUE7QUFDQSxJQUFBSyxvQkFBQSxHQUFBTixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQU0sY0FBQSxHQUFBUCxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQU8sY0FBQSxHQUFBUixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQVEsS0FBQSxHQUFBVCxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQVMsYUFBQSxHQUFBVixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQVUsU0FBQSxHQUFBVixPQUFBO0FBQ0EsSUFBQVcsWUFBQSxHQUFBWCxPQUFBO0FBQ0EsSUFBQVksVUFBQSxHQUFBWixPQUFBO0FBR0EsTUFBTWEsY0FBYyxHQUFHLENBQUMsR0FBR0MsYUFBRTtBQUU3QixNQUFNQyxhQUFhLEdBQUc7RUFDcEJDLEVBQUUsRUFBRSxDQUFDO0VBQ0xDLFVBQVUsRUFBRSxDQUFDO0VBQ2JDLE1BQU0sRUFBRSxDQUFDO0VBQ1RDLFdBQVcsRUFBRTtBQUNmLENBQUM7QUFFRCxJQUFJQyxJQUFJLEVBQUVDLE9BQU87QUFDakIsSUFBSTtFQUVGLENBQUM7SUFBRUQsSUFBSTtJQUFFQztFQUFRLENBQUMsR0FBR3JCLE9BQU8sQ0FBQ3NCLGFBQUksQ0FBQ0MsT0FBTyxDQUFDQyxTQUFTLEVBQUUsSUFBSSxFQUFF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