"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.UsbmuxEncoder = void 0;
require("source-map-support/register");
var _stream = _interopRequireDefault(require("stream"));
var _support = require("@appium/support");
const HEADER_LENGTH = 16;
const VERSION = 1;
const TYPE = 8;
class UsbmuxEncoder extends _stream.default.Transform {
  constructor() {
    super({
      objectMode: true
    });
  }
  _transform(data, encoding, onData) {
    this._encode(data);
    onData();
  }
  _encode(data) {
    const payloadBuffer = Buffer.from(_support.plist.createPlist(data.payload, false));
    const header = {
      length: HEADER_LENGTH + payloadBuffer.length,
      version: VERSION,
      type: TYPE,
      tag: data.tag
    };
    const headerBuffer = Buffer.allocUnsafe(HEADER_LENGTH);
    headerBuffer.writeUInt32LE(header.length, 0);
    headerBuffer.writeUInt32LE(header.version, 4);
    headerBuffer.writeUInt32LE(header.type, 8);
    headerBuffer.writeUInt32LE(header.tag, 12);
    this.push(Buffer.concat([headerBuffer, payloadBuffer], headerBuffer.length + payloadBuffer.length));
  }
}
exports.UsbmuxEncoder = UsbmuxEncoder;
var _default = UsbmuxEncoder;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3RyZWFtIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfc3VwcG9ydCIsIkhFQURFUl9MRU5HVEgiLCJWRVJTSU9OIiwiVFlQRSIsIlVzYm11eEVuY29kZXIiLCJTdHJlYW0iLCJUcmFuc2Zvcm0iLCJjb25zdHJ1Y3RvciIsIm9iamVjdE1vZGUiLCJfdHJhbnNmb3JtIiwiZGF0YSIsImVuY29kaW5nIiwib25EYXRhIiwiX2VuY29kZSIsInBheWxvYWRCdWZmZXIiLCJCdWZmZXIiLCJmcm9tIiwicGxpc3QiLCJjcmVhdGVQbGlzdCIsInBheWxvYWQiLCJoZWFkZXIiLCJsZW5ndGgiLCJ2ZXJzaW9uIiwidHlwZSIsInRhZyIsImhlYWRlckJ1ZmZlciIsImFsbG9jVW5zYWZlIiwid3JpdGVVSW50MzJMRSIsInB1c2giLCJjb25jYXQiLCJleHBvcnRzIiwiX2RlZmF1bHQiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vbGliL3VzYm11eC90cmFuc2Zvcm1lci91c2JtdXgtZW5jb2Rlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3RyZWFtIGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgeyBwbGlzdCB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5cbmNvbnN0IEhFQURFUl9MRU5HVEggPSAxNjtcbmNvbnN0IFZFUlNJT04gPSAxO1xuY29uc3QgVFlQRSA9IDg7XG5cbmNsYXNzIFVzYm11eEVuY29kZXIgZXh0ZW5kcyBTdHJlYW0uVHJhbnNmb3JtIHtcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHN1cGVyKHsgb2JqZWN0TW9kZTogdHJ1ZSB9KTtcbiAgfVxuXG4gIF90cmFuc2Zvcm0gKGRhdGEsIGVuY29kaW5nLCBvbkRhdGEpIHtcbiAgICB0aGlzLl9lbmNvZGUoZGF0YSk7XG4gICAgb25EYXRhKCk7XG4gIH1cblxuICBfZW5jb2RlIChkYXRhKSB7XG4gICAgY29uc3QgcGF5bG9hZEJ1ZmZlciA9IEJ1ZmZlci5mcm9tKHBsaXN0LmNyZWF0ZVBsaXN0KGRhdGEucGF5bG9hZCwgZmFsc2UpKTtcblxuICAgIGNvbnN0IGhlYWRlciA9IHtcbiAgICAgIGxlbmd0aDogSEVBREVSX0xFTkdUSCArIHBheWxvYWRCdWZmZXIubGVuZ3RoLFxuICAgICAgdmVyc2lvbjogVkVSU0lPTixcbiAgICAgIHR5cGU6IFRZUEUsXG4gICAgICB0YWc6IGRhdGEudGFnXG4gICAgfTtcblxuICAgIGNvbnN0IGhlYWRlckJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShIRUFERVJfTEVOR1RIKTtcbiAgICBoZWFkZXJCdWZmZXIud3JpdGVVSW50MzJMRShoZWFkZXIubGVuZ3RoLCAwKTtcbiAgICBoZWFkZXJCdWZmZXIud3JpdGVVSW50MzJMRShoZWFkZXIudmVyc2lvbiwgNCk7XG4gICAgaGVhZGVyQnVmZmVyLndyaXRlVUludDMyTEUoaGVhZGVyLnR5cGUsIDgpO1xuICAgIGhlYWRlckJ1ZmZlci53cml0ZVVJbnQzMkxFKGhlYWRlci50YWcsIDEyKTtcblxuICAgIHRoaXMucHVzaChCdWZmZXIuY29uY2F0KFtoZWFkZXJCdWZmZXIsIHBheWxvYWRCdWZmZXJdLCBoZWFkZXJCdWZmZXIubGVuZ3RoICsgcGF5bG9hZEJ1ZmZlci5sZW5ndGgpKTtcbiAgfVxufVxuXG5leHBvcnQgeyBVc2JtdXhFbmNvZGVyfTtcbmV4cG9ydCBkZWZhdWx0IFVzYm11eEVuY29kZXI7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsSUFBQUEsT0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsUUFBQSxHQUFBRCxPQUFBO0FBRUEsTUFBTUUsYUFBYSxHQUFHLEVBQUU7QUFDeEIsTUFBTUMsT0FBTyxHQUFHLENBQUM7QUFDakIsTUFBTUMsSUFBSSxHQUFHLENBQUM7QUFFZCxNQUFNQyxhQUFhLFNBQVNDLGVBQU0sQ0FBQ0MsU0FBUyxDQUFDO0VBQzNDQyxXQUFXQSxDQUFBLEVBQUk7SUFDYixLQUFLLENBQUM7TUFBRUMsVUFBVSxFQUFFO0lBQUssQ0FBQyxDQUFDO0VBQzdCO0VBRUFDLFVBQVVBLENBQUVDLElBQUksRUFBRUMsUUFBUSxFQUFFQyxNQUFNLEVBQUU7SUFDbEMsSUFBSSxDQUFDQyxPQUFPLENBQUNILElBQUksQ0FBQztJQUNsQkUsTUFBTSxFQUFFO0VBQ1Y7RUFFQUMsT0FBT0EsQ0FBRUgsSUFBSSxFQUFFO0lBQ2IsTUFBTUksYUFBYSxHQUFHQyxNQUFNLENBQUNDLElBQUksQ0FBQ0MsY0FBSyxDQUFDQyxXQUFXLENBQUNSLElBQUksQ0FBQ1MsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXpFLE1BQU1DLE1BQU0sR0FBRztNQUNiQyxNQUFNLEVBQUVwQixhQUFhLEdBQUdhLGFBQWEsQ0FBQ08sTUFBTTtNQUM1Q0MsT0FBTyxFQUFFcEIsT0FBTztNQUNoQnFCLElBQUksRUFBRXBCLElBQUk7TUFDVnFCLEdBQUcsRUFBRWQsSUFBSSxDQUFDYztJQUNaLENBQUM7SUFFRCxNQUFNQyxZQUFZLEdBQUdWLE1BQU0sQ0FBQ1csV0FBVyxDQUFDekIsYUFBYSxDQUFDO0lBQ3REd0IsWUFBWSxDQUFDRSxhQUFhLENBQUNQLE1BQU0sQ0FBQ0MsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUM1Q0ksWUFBWSxDQUFDRSxhQUFhLENBQUNQLE1BQU0sQ0FBQ0UsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUM3Q0csWUFBWSxDQUFDRSxhQUFhLENBQUNQLE1BQU0sQ0FBQ0csSUFBSSxFQUFFLENBQUMsQ0FBQztJQUMxQ0UsWUFBWSxDQUFDRSxhQUFhLENBQUNQLE1BQU0sQ0FBQ0ksR0FBRyxFQUFFLEVBQUUsQ0FBQztJQUUxQyxJQUFJLENBQUNJLElBQUksQ0FBQ2IsTUFBTSxDQUFDYyxNQUFNLENBQUMsQ0FBQ0osWUFBWSxFQUFFWCxhQUFhLENBQUMsRUFBRVcsWUFBWSxDQUFDSixNQUFNLEdBQUdQLGFBQWEsQ0FBQ08sTUFBTSxDQUFDLENBQUM7RUFDckc7QUFDRjtBQUFDUyxPQUFBLENBQUExQixhQUFBLEdBQUFBLGFBQUE7QUFBQSxJQUFBMkIsUUFBQSxHQUdjM0IsYUFBYTtBQUFBMEIsT0FBQSxDQUFBRSxPQUFBLEdBQUFELFFBQUEifQ==