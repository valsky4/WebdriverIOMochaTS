"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger"));
var _lodash = _interopRequireDefault(require("lodash"));
var _support = require("@appium/support");
var _teen_process = require("teen_process");
var _path = _interopRequireDefault(require("path"));
const STATUS = Object.freeze({
  UNSET: 'unset',
  NO: 'no',
  YES: 'yes',
  LIMITED: 'limited'
});
const WIX_SIM_UTILS = 'applesimutils';
const SERVICES = Object.freeze({
  calendar: 'kTCCServiceCalendar',
  camera: 'kTCCServiceCamera',
  contacts: 'kTCCServiceAddressBook',
  homekit: 'kTCCServiceWillow',
  microphone: 'kTCCServiceMicrophone',
  photos: 'kTCCServicePhotos',
  reminders: 'kTCCServiceReminders',
  medialibrary: 'kTCCServiceMediaLibrary',
  motion: 'kTCCServiceMotion',
  health: 'kTCCServiceMSO',
  siri: 'kTCCServiceSiri',
  speech: 'kTCCServiceSpeechRecognition'
});
function toInternalServiceName(serviceName) {
  if (_lodash.default.has(SERVICES, _lodash.default.toLower(serviceName))) {
    return SERVICES[_lodash.default.toLower(serviceName)];
  }
  throw new Error(`'${serviceName}' is unknown. Only the following service names are supported: ${JSON.stringify(_lodash.default.keys(SERVICES))}`);
}
function formatStatus(status) {
  return [STATUS.UNSET, STATUS.NO].includes(status) ? _lodash.default.toUpper(status) : status;
}
async function execSQLiteQuery(db, query) {
  _logger.default.debug(`Executing SQL query "${query}" on '${db}'`);
  try {
    return (await (0, _teen_process.exec)('sqlite3', ['-line', db, query])).stdout;
  } catch (err) {
    throw new Error(`Cannot execute SQLite query "${query}" to '${db}'. Original error: ${err.stderr}`);
  }
}
async function execWix(args) {
  try {
    await _support.fs.which(WIX_SIM_UTILS);
  } catch (e) {
    throw new Error(`${WIX_SIM_UTILS} binary has not been found in your PATH. ` + `Please install it ('brew tap wix/brew && brew install wix/brew/applesimutils') to ` + `be able to change application permissions`);
  }
  _logger.default.debug(`Executing: ${WIX_SIM_UTILS} ${_support.util.quote(args)}`);
  try {
    const {
      stdout
    } = await (0, _teen_process.exec)(WIX_SIM_UTILS, args);
    _logger.default.debug(`Command output: ${stdout}`);
    return stdout;
  } catch (e) {
    throw new Error(`Cannot execute "${WIX_SIM_UTILS} ${_support.util.quote(args)}". Original error: ${e.stderr || e.message}`);
  }
}
async function setAccess(udid, bundleId, permissionsMapping) {
  const permissionsArg = _lodash.default.toPairs(permissionsMapping).map(x => `${x[0]}=${formatStatus(x[1])}`).join(',');
  return await execWix(['--byId', udid, '--bundle', bundleId, '--setPermissions', permissionsArg]);
}
async function getAccess(bundleId, serviceName, simDataRoot) {
  const internalServiceName = toInternalServiceName(serviceName);
  const dbPath = _path.default.resolve(simDataRoot, 'Library', 'TCC', 'TCC.db');
  const getAccessStatus = async (statusPairs, statusKey) => {
    for (const [statusValue, status] of statusPairs) {
      const sql = `SELECT count(*) FROM 'access' ` + `WHERE client='${bundleId}' AND ${statusKey}=${statusValue} AND service='${internalServiceName}'`;
      const count = await execSQLiteQuery(dbPath, sql);
      if (parseInt(count.split('=')[1], 10) > 0) {
        return status;
      }
    }
    return STATUS.UNSET;
  };
  try {
    return await getAccessStatus([['0', STATUS.NO], ['2', STATUS.YES], ['3', STATUS.LIMITED]], 'auth_value');
  } catch {
    return await getAccessStatus([['0', STATUS.NO], ['1', STATUS.YES]], 'allowed');
  }
}
const extensions = {};
extensions.setPermission = async function setPermission(bundleId, permission, value) {
  await this.setPermissions(bundleId, {
    [permission]: value
  });
};
extensions.setPermissions = async function setPermissions(bundleId, permissionsMapping) {
  _logger.default.debug(`Setting access for '${bundleId}': ${JSON.stringify(permissionsMapping, null, 2)}`);
  await setAccess(this.udid, bundleId, permissionsMapping);
};
extensions.getPermission = async function getPermission(bundleId, serviceName) {
  const result = await getAccess(bundleId, serviceName, this.getDir());
  _logger.default.debug(`Got ${serviceName} access status for '${bundleId}': ${result}`);
  return result;
};
var _default = extensions;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTVEFUVVMiLCJPYmplY3QiLCJmcmVlemUiLCJVTlNFVCIsIk5PIiwiWUVTIiwiTElNSVRFRCIsIldJWF9TSU1fVVRJTFMiLCJTRVJWSUNFUyIsImNhbGVuZGFyIiwiY2FtZXJhIiwiY29udGFjdHMiLCJob21la2l0IiwibWljcm9waG9uZSIsInBob3RvcyIsInJlbWluZGVycyIsIm1lZGlhbGlicmFyeSIsIm1vdGlvbiIsImhlYWx0aCIsInNpcmkiLCJzcGVlY2giLCJ0b0ludGVybmFsU2VydmljZU5hbWUiLCJzZXJ2aWNlTmFtZSIsIl8iLCJoYXMiLCJ0b0xvd2VyIiwiRXJyb3IiLCJKU09OIiwic3RyaW5naWZ5Iiwia2V5cyIsImZvcm1hdFN0YXR1cyIsInN0YXR1cyIsImluY2x1ZGVzIiwidG9VcHBlciIsImV4ZWNTUUxpdGVRdWVyeSIsImRiIiwicXVlcnkiLCJsb2ciLCJkZWJ1ZyIsImV4ZWMiLCJzdGRvdXQiLCJlcnIiLCJzdGRlcnIiLCJleGVjV2l4IiwiYXJncyIsImZzIiwid2hpY2giLCJlIiwidXRpbCIsInF1b3RlIiwibWVzc2FnZSIsInNldEFjY2VzcyIsInVkaWQiLCJidW5kbGVJZCIsInBlcm1pc3Npb25zTWFwcGluZyIsInBlcm1pc3Npb25zQXJnIiwidG9QYWlycyIsIm1hcCIsIngiLCJqb2luIiwiZ2V0QWNjZXNzIiwic2ltRGF0YVJvb3QiLCJpbnRlcm5hbFNlcnZpY2VOYW1lIiwiZGJQYXRoIiwicGF0aCIsInJlc29sdmUiLCJnZXRBY2Nlc3NTdGF0dXMiLCJzdGF0dXNQYWlycyIsInN0YXR1c0tleSIsInN0YXR1c1ZhbHVlIiwic3FsIiwiY291bnQiLCJwYXJzZUludCIsInNwbGl0IiwiZXh0ZW5zaW9ucyIsInNldFBlcm1pc3Npb24iLCJwZXJtaXNzaW9uIiwidmFsdWUiLCJzZXRQZXJtaXNzaW9ucyIsImdldFBlcm1pc3Npb24iLCJyZXN1bHQiLCJnZXREaXIiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvZXh0ZW5zaW9ucy9wZXJtaXNzaW9ucy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuY29uc3QgU1RBVFVTID0gT2JqZWN0LmZyZWV6ZSh7XG4gIFVOU0VUOiAndW5zZXQnLFxuICBOTzogJ25vJyxcbiAgWUVTOiAneWVzJyxcbiAgTElNSVRFRDogJ2xpbWl0ZWQnLFxufSk7XG5cbmNvbnN0IFdJWF9TSU1fVVRJTFMgPSAnYXBwbGVzaW11dGlscyc7XG5jb25zdCBTRVJWSUNFUyA9IE9iamVjdC5mcmVlemUoe1xuICBjYWxlbmRhcjogJ2tUQ0NTZXJ2aWNlQ2FsZW5kYXInLFxuICBjYW1lcmE6ICdrVENDU2VydmljZUNhbWVyYScsXG4gIGNvbnRhY3RzOiAna1RDQ1NlcnZpY2VBZGRyZXNzQm9vaycsXG4gIGhvbWVraXQ6ICdrVENDU2VydmljZVdpbGxvdycsXG4gIG1pY3JvcGhvbmU6ICdrVENDU2VydmljZU1pY3JvcGhvbmUnLFxuICBwaG90b3M6ICdrVENDU2VydmljZVBob3RvcycsXG4gIHJlbWluZGVyczogJ2tUQ0NTZXJ2aWNlUmVtaW5kZXJzJyxcbiAgbWVkaWFsaWJyYXJ5OiAna1RDQ1NlcnZpY2VNZWRpYUxpYnJhcnknLFxuICBtb3Rpb246ICdrVENDU2VydmljZU1vdGlvbicsXG4gIGhlYWx0aDogJ2tUQ0NTZXJ2aWNlTVNPJyxcbiAgc2lyaTogJ2tUQ0NTZXJ2aWNlU2lyaScsXG4gIHNwZWVjaDogJ2tUQ0NTZXJ2aWNlU3BlZWNoUmVjb2duaXRpb24nLFxufSk7XG5cbmZ1bmN0aW9uIHRvSW50ZXJuYWxTZXJ2aWNlTmFtZSAoc2VydmljZU5hbWUpIHtcbiAgaWYgKF8uaGFzKFNFUlZJQ0VTLCBfLnRvTG93ZXIoc2VydmljZU5hbWUpKSkge1xuICAgIHJldHVybiBTRVJWSUNFU1tfLnRvTG93ZXIoc2VydmljZU5hbWUpXTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgYCcke3NlcnZpY2VOYW1lfScgaXMgdW5rbm93bi4gT25seSB0aGUgZm9sbG93aW5nIHNlcnZpY2UgbmFtZXMgYXJlIHN1cHBvcnRlZDogJHtKU09OLnN0cmluZ2lmeShfLmtleXMoU0VSVklDRVMpKX1gXG4gICk7XG59XG5cbmZ1bmN0aW9uIGZvcm1hdFN0YXR1cyAoc3RhdHVzKSB7XG4gIHJldHVybiBbU1RBVFVTLlVOU0VULCBTVEFUVVMuTk9dLmluY2x1ZGVzKHN0YXR1cykgPyBfLnRvVXBwZXIoc3RhdHVzKSA6IHN0YXR1cztcbn1cblxuLyoqXG4gKiBSdW5zIGEgY29tbWFuZCBsaW5lIHNxbGl0ZTMgcXVlcnlcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gZGIgLSBGdWxsIHBhdGggdG8gc3FsaXRlIGRhdGFiYXNlXG4gKiBAcGFyYW0ge3N0cmluZ30gcXVlcnkgLSBUaGUgYWN0dWFsIHF1ZXJ5IHN0cmluZ1xuICogQHJldHVybnMge3N0cmluZ30gc3FsaXRlIGNvbW1hbmQgc3Rkb3V0XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGV4ZWNTUUxpdGVRdWVyeSAoZGIsIHF1ZXJ5KSB7XG4gIGxvZy5kZWJ1ZyhgRXhlY3V0aW5nIFNRTCBxdWVyeSBcIiR7cXVlcnl9XCIgb24gJyR7ZGJ9J2ApO1xuICB0cnkge1xuICAgIHJldHVybiAoYXdhaXQgZXhlYygnc3FsaXRlMycsIFsnLWxpbmUnLCBkYiwgcXVlcnldKSkuc3Rkb3V0O1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgQ2Fubm90IGV4ZWN1dGUgU1FMaXRlIHF1ZXJ5IFwiJHtxdWVyeX1cIiB0byAnJHtkYn0nLiBPcmlnaW5hbCBlcnJvcjogJHtlcnIuc3RkZXJyfWBcbiAgICApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGV4ZWNXaXggKGFyZ3MpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53aGljaChXSVhfU0lNX1VUSUxTKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGAke1dJWF9TSU1fVVRJTFN9IGJpbmFyeSBoYXMgbm90IGJlZW4gZm91bmQgaW4geW91ciBQQVRILiBgICtcbiAgICAgIGBQbGVhc2UgaW5zdGFsbCBpdCAoJ2JyZXcgdGFwIHdpeC9icmV3ICYmIGJyZXcgaW5zdGFsbCB3aXgvYnJldy9hcHBsZXNpbXV0aWxzJykgdG8gYCArXG4gICAgICBgYmUgYWJsZSB0byBjaGFuZ2UgYXBwbGljYXRpb24gcGVybWlzc2lvbnNgXG4gICAgKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgRXhlY3V0aW5nOiAke1dJWF9TSU1fVVRJTFN9ICR7dXRpbC5xdW90ZShhcmdzKX1gKTtcbiAgdHJ5IHtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoV0lYX1NJTV9VVElMUywgYXJncyk7XG4gICAgbG9nLmRlYnVnKGBDb21tYW5kIG91dHB1dDogJHtzdGRvdXR9YCk7XG4gICAgcmV0dXJuIHN0ZG91dDtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGV4ZWN1dGUgXCIke1dJWF9TSU1fVVRJTFN9ICR7dXRpbC5xdW90ZShhcmdzKX1cIi4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5zdGRlcnIgfHwgZS5tZXNzYWdlfWApO1xuICB9XG59XG5cbi8qKlxuICogU2V0cyBwZXJtaXNzaW9ucyBmb3IgdGhlIGdpdmVuIGFwcGxpY2F0aW9uXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgLSB1ZGlkIG9mIHRoZSB0YXJnZXQgc2ltdWxhdG9yIGRldmljZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCAtIGJ1bmRsZSBpZGVudGlmaWVyIG9mIHRoZSB0YXJnZXQgYXBwbGljYXRpb24uXG4gKiBAcGFyYW0ge09iamVjdH0gcGVybWlzc2lvbnNNYXBwaW5nIC0gQW4gb2JqZWN0LCB3aGVyZSBrZXlzIGFyICBzZXJ2aWNlIG5hbWVzXG4gKiBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHN0YXRlIHZhbHVlcy4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS93aXgvQXBwbGVTaW11bGF0b3JVdGlsc1xuICogZm9yIG1vcmUgZGV0YWlscyBvbiBhdmFpbGFibGUgc2VydmljZSBuYW1lcyBhbmQgc3RhdHVzZXMuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGNoYW5naW5nIHBlcm1pc3Npb25zLlxuICovXG5hc3luYyBmdW5jdGlvbiBzZXRBY2Nlc3MgKHVkaWQsIGJ1bmRsZUlkLCBwZXJtaXNzaW9uc01hcHBpbmcpIHtcbiAgY29uc3QgcGVybWlzc2lvbnNBcmcgPSBfLnRvUGFpcnMocGVybWlzc2lvbnNNYXBwaW5nKVxuICAgIC5tYXAoKHgpID0+IGAke3hbMF19PSR7Zm9ybWF0U3RhdHVzKHhbMV0pfWApXG4gICAgLmpvaW4oJywnKTtcbiAgcmV0dXJuIGF3YWl0IGV4ZWNXaXgoW1xuICAgICctLWJ5SWQnLCB1ZGlkLFxuICAgICctLWJ1bmRsZScsIGJ1bmRsZUlkLFxuICAgICctLXNldFBlcm1pc3Npb25zJywgcGVybWlzc2lvbnNBcmcsXG4gIF0pO1xufVxuXG4vKipcbiAqIFJldHJpZXZlcyB0aGUgY3VycmVudCBwZXJtaXNzaW9uIHN0YXR1cyBmb3IgdGhlIGdpdmVuIHNlcnZpY2UgYW5kIGFwcGxpY2F0aW9uLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCAtIGJ1bmRsZSBpZGVudGlmaWVyIG9mIHRoZSB0YXJnZXQgYXBwbGljYXRpb24uXG4gKiBAcGFyYW0ge3N0cmluZ30gc2VydmljZU5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgc2VydmljZS4gU2hvdWxkIGJlIG9uZSBvZlxuICogYFNFUlZJQ0VTYCBrZXlzLlxuICogQHBhcmFtIHtzdHJpbmd9IHNpbURhdGFSb290IC0gdGhlIHBhdGggdG8gU2ltdWxhdG9yIGBkYXRhYCByb290XG4gKiBAcmV0dXJucyB7c3RyaW5nfSAtIFRoZSBjdXJyZW50IHN0YXR1czogeWVzL25vL3Vuc2V0L2xpbWl0ZWRcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgcmV0cmlldmluZyBwZXJtaXNzaW9ucy5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0QWNjZXNzIChidW5kbGVJZCwgc2VydmljZU5hbWUsIHNpbURhdGFSb290KSB7XG4gIGNvbnN0IGludGVybmFsU2VydmljZU5hbWUgPSB0b0ludGVybmFsU2VydmljZU5hbWUoc2VydmljZU5hbWUpO1xuICBjb25zdCBkYlBhdGggPSBwYXRoLnJlc29sdmUoc2ltRGF0YVJvb3QsICdMaWJyYXJ5JywgJ1RDQycsICdUQ0MuZGInKTtcbiAgY29uc3QgZ2V0QWNjZXNzU3RhdHVzID0gYXN5bmMgKHN0YXR1c1BhaXJzLCBzdGF0dXNLZXkpID0+IHtcbiAgICBmb3IgKGNvbnN0IFtzdGF0dXNWYWx1ZSwgc3RhdHVzXSBvZiBzdGF0dXNQYWlycykge1xuICAgICAgY29uc3Qgc3FsID0gYFNFTEVDVCBjb3VudCgqKSBGUk9NICdhY2Nlc3MnIGAgK1xuICAgICAgICBgV0hFUkUgY2xpZW50PScke2J1bmRsZUlkfScgQU5EICR7c3RhdHVzS2V5fT0ke3N0YXR1c1ZhbHVlfSBBTkQgc2VydmljZT0nJHtpbnRlcm5hbFNlcnZpY2VOYW1lfSdgO1xuICAgICAgY29uc3QgY291bnQgPSBhd2FpdCBleGVjU1FMaXRlUXVlcnkoZGJQYXRoLCBzcWwpO1xuICAgICAgaWYgKHBhcnNlSW50KGNvdW50LnNwbGl0KCc9JylbMV0sIDEwKSA+IDApIHtcbiAgICAgICAgcmV0dXJuIHN0YXR1cztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFNUQVRVUy5VTlNFVDtcbiAgfTtcblxuICAvLyAnYXV0aF92YWx1ZScgZXhpc3RlbmNlIGRlcGVuZHMgb24gdGhlIE9TIHZlcnNpb24gcmF0aGVyIHRoYW4gWGNvZGUgdmVyc2lvbi5cbiAgLy8gVGh1cyBoZXJlIGNoZWNrIHRoZSBuZXdlciBvbmUgZmlyc3QsIHRoZW4gZmFsbGJhY2sgdG8gdGhlIG9sZGVyIHZlcnNpb24gd2F5LlxuICB0cnkge1xuICAgIC8vIGlPUyAxNCtcbiAgICByZXR1cm4gYXdhaXQgZ2V0QWNjZXNzU3RhdHVzKFxuICAgICAgW1snMCcsIFNUQVRVUy5OT10sIFsnMicsIFNUQVRVUy5ZRVNdLCBbJzMnLCBTVEFUVVMuTElNSVRFRF1dLFxuICAgICAgJ2F1dGhfdmFsdWUnXG4gICAgKTtcbiAgfSBjYXRjaCB7XG4gICAgcmV0dXJuIGF3YWl0IGdldEFjY2Vzc1N0YXR1cyhcbiAgICAgIFtbJzAnLCBTVEFUVVMuTk9dLCBbJzEnLCBTVEFUVVMuWUVTXV0sXG4gICAgICAnYWxsb3dlZCdcbiAgICApO1xuICB9XG59XG5cbmNvbnN0IGV4dGVuc2lvbnMgPSB7fTtcblxuLyoqXG4gKiBTZXRzIHRoZSBwYXJ0aWN1bGFyIHBlcm1pc3Npb24gdG8gdGhlIGFwcGxpY2F0aW9uIGJ1bmRsZS4gU2VlXG4gKiBodHRwczovL2dpdGh1Yi5jb20vd2l4L0FwcGxlU2ltdWxhdG9yVXRpbHMgZm9yIG1vcmUgZGV0YWlscyBvblxuICogdGhlIGF2YWlsYWJsZSBzZXJ2aWNlIG5hbWVzIGFuZCBzdGF0dXNlcy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlSWQgLSBBcHBsaWNhdGlvbiBidW5kbGUgaWRlbnRpZmllci5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwZXJtaXNzaW9uIC0gU2VydmljZSBuYW1lIHRvIGJlIHNldC5cbiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSBkZXNpcmVkIHN0YXR1cyBmb3IgdGhlIHNlcnZpY2UuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGNoYW5naW5nIHBlcm1pc3Npb24uXG4gKi9cbmV4dGVuc2lvbnMuc2V0UGVybWlzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uIHNldFBlcm1pc3Npb24gKGJ1bmRsZUlkLCBwZXJtaXNzaW9uLCB2YWx1ZSkge1xuICBhd2FpdCB0aGlzLnNldFBlcm1pc3Npb25zKGJ1bmRsZUlkLCB7W3Blcm1pc3Npb25dOiB2YWx1ZX0pO1xufTtcblxuLyoqXG4gKiBTZXRzIHRoZSBwZXJtaXNzaW9ucyBmb3IgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gYnVuZGxlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCAtIEFwcGxpY2F0aW9uIGJ1bmRsZSBpZGVudGlmaWVyLlxuICogQHBhcmFtIHtPYmplY3R9IHBlcm1pc3Npb25zTWFwcGluZyAtIEEgbWFwcGluZyB3aGVyZSBrYXlzXG4gKiBhcmUgc2VydmljZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSB0aGVpciBjb3JyZXNwb25kaW5nIHN0YXR1cyB2YWx1ZXMuXG4gKiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3dpeC9BcHBsZVNpbXVsYXRvclV0aWxzXG4gKiBmb3IgbW9yZSBkZXRhaWxzIG9uIGF2YWlsYWJsZSBzZXJ2aWNlIG5hbWVzIGFuZCBzdGF0dXNlcy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgY2hhbmdpbmcgcGVybWlzc2lvbnMuXG4gKi9cbmV4dGVuc2lvbnMuc2V0UGVybWlzc2lvbnMgPSBhc3luYyBmdW5jdGlvbiBzZXRQZXJtaXNzaW9ucyAoYnVuZGxlSWQsIHBlcm1pc3Npb25zTWFwcGluZykge1xuICBsb2cuZGVidWcoYFNldHRpbmcgYWNjZXNzIGZvciAnJHtidW5kbGVJZH0nOiAke0pTT04uc3RyaW5naWZ5KHBlcm1pc3Npb25zTWFwcGluZywgbnVsbCwgMil9YCk7XG4gIGF3YWl0IHNldEFjY2Vzcyh0aGlzLnVkaWQsIGJ1bmRsZUlkLCBwZXJtaXNzaW9uc01hcHBpbmcpO1xufTtcblxuLyoqXG4gKiBSZXRyaWV2ZXMgY3VycmVudCBwZXJtaXNzaW9uIHN0YXR1cyBmb3IgdGhlIGdpdmVuIGFwcGxpY2F0aW9uIGJ1bmRsZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlSWQgLSBBcHBsaWNhdGlvbiBidW5kbGUgaWRlbnRpZmllci5cbiAqIEBwYXJhbSB7c3RyaW5nfSBzZXJ2aWNlTmFtZSAtIE9uZSBvZiBhdmFpbGFibGUgc2VydmljZSBuYW1lcy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgcmV0cmlldmluZyBwZXJtaXNzaW9ucy5cbiAqL1xuZXh0ZW5zaW9ucy5nZXRQZXJtaXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gZ2V0UGVybWlzc2lvbiAoYnVuZGxlSWQsIHNlcnZpY2VOYW1lKSB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldEFjY2VzcyhidW5kbGVJZCwgc2VydmljZU5hbWUsIHRoaXMuZ2V0RGlyKCkpO1xuICBsb2cuZGVidWcoYEdvdCAke3NlcnZpY2VOYW1lfSBhY2Nlc3Mgc3RhdHVzIGZvciAnJHtidW5kbGVJZH0nOiAke3Jlc3VsdH1gKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBLE1BQU1BLE1BQU0sR0FBR0MsTUFBTSxDQUFDQyxNQUFNLENBQUM7RUFDM0JDLEtBQUssRUFBRSxPQUFPO0VBQ2RDLEVBQUUsRUFBRSxJQUFJO0VBQ1JDLEdBQUcsRUFBRSxLQUFLO0VBQ1ZDLE9BQU8sRUFBRTtBQUNYLENBQUMsQ0FBQztBQUVGLE1BQU1DLGFBQWEsR0FBRyxlQUFlO0FBQ3JDLE1BQU1DLFFBQVEsR0FBR1AsTUFBTSxDQUFDQyxNQUFNLENBQUM7RUFDN0JPLFFBQVEsRUFBRSxxQkFBcUI7RUFDL0JDLE1BQU0sRUFBRSxtQkFBbUI7RUFDM0JDLFFBQVEsRUFBRSx3QkFBd0I7RUFDbENDLE9BQU8sRUFBRSxtQkFBbUI7RUFDNUJDLFVBQVUsRUFBRSx1QkFBdUI7RUFDbkNDLE1BQU0sRUFBRSxtQkFBbUI7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