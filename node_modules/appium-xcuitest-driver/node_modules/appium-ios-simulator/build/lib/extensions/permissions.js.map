{"version":3,"file":"permissions.js","names":["STATUS","Object","freeze","UNSET","NO","YES","LIMITED","WIX_SIM_UTILS","SERVICES","calendar","camera","contacts","homekit","microphone","photos","reminders","medialibrary","motion","health","siri","speech","toInternalServiceName","serviceName","_","has","toLower","Error","JSON","stringify","keys","formatStatus","status","includes","toUpper","execSQLiteQuery","db","query","log","debug","exec","stdout","err","stderr","execWix","args","fs","which","e","util","quote","message","setAccess","udid","bundleId","permissionsMapping","permissionsArg","toPairs","map","x","join","getAccess","simDataRoot","internalServiceName","dbPath","path","resolve","getAccessStatus","statusPairs","statusKey","statusValue","sql","count","parseInt","split","extensions","setPermission","permission","value","setPermissions","getPermission","result","getDir"],"sources":["../../../lib/extensions/permissions.js"],"sourcesContent":["import log from '../logger';\nimport _ from 'lodash';\nimport { fs, util } from '@appium/support';\nimport { exec } from 'teen_process';\nimport path from 'path';\n\nconst STATUS = Object.freeze({\n  UNSET: 'unset',\n  NO: 'no',\n  YES: 'yes',\n  LIMITED: 'limited',\n});\n\nconst WIX_SIM_UTILS = 'applesimutils';\nconst SERVICES = Object.freeze({\n  calendar: 'kTCCServiceCalendar',\n  camera: 'kTCCServiceCamera',\n  contacts: 'kTCCServiceAddressBook',\n  homekit: 'kTCCServiceWillow',\n  microphone: 'kTCCServiceMicrophone',\n  photos: 'kTCCServicePhotos',\n  reminders: 'kTCCServiceReminders',\n  medialibrary: 'kTCCServiceMediaLibrary',\n  motion: 'kTCCServiceMotion',\n  health: 'kTCCServiceMSO',\n  siri: 'kTCCServiceSiri',\n  speech: 'kTCCServiceSpeechRecognition',\n});\n\nfunction toInternalServiceName (serviceName) {\n  if (_.has(SERVICES, _.toLower(serviceName))) {\n    return SERVICES[_.toLower(serviceName)];\n  }\n  throw new Error(\n    `'${serviceName}' is unknown. Only the following service names are supported: ${JSON.stringify(_.keys(SERVICES))}`\n  );\n}\n\nfunction formatStatus (status) {\n  return [STATUS.UNSET, STATUS.NO].includes(status) ? _.toUpper(status) : status;\n}\n\n/**\n * Runs a command line sqlite3 query\n *\n * @param {string} db - Full path to sqlite database\n * @param {string} query - The actual query string\n * @returns {string} sqlite command stdout\n */\nasync function execSQLiteQuery (db, query) {\n  log.debug(`Executing SQL query \"${query}\" on '${db}'`);\n  try {\n    return (await exec('sqlite3', ['-line', db, query])).stdout;\n  } catch (err) {\n    throw new Error(\n      `Cannot execute SQLite query \"${query}\" to '${db}'. Original error: ${err.stderr}`\n    );\n  }\n}\n\nasync function execWix (args) {\n  try {\n    await fs.which(WIX_SIM_UTILS);\n  } catch (e) {\n    throw new Error(\n      `${WIX_SIM_UTILS} binary has not been found in your PATH. ` +\n      `Please install it ('brew tap wix/brew && brew install wix/brew/applesimutils') to ` +\n      `be able to change application permissions`\n    );\n  }\n\n  log.debug(`Executing: ${WIX_SIM_UTILS} ${util.quote(args)}`);\n  try {\n    const {stdout} = await exec(WIX_SIM_UTILS, args);\n    log.debug(`Command output: ${stdout}`);\n    return stdout;\n  } catch (e) {\n    throw new Error(`Cannot execute \"${WIX_SIM_UTILS} ${util.quote(args)}\". Original error: ${e.stderr || e.message}`);\n  }\n}\n\n/**\n * Sets permissions for the given application\n *\n * @param {string} udid - udid of the target simulator device.\n * @param {string} bundleId - bundle identifier of the target application.\n * @param {Object} permissionsMapping - An object, where keys ar  service names\n * and values are corresponding state values. See https://github.com/wix/AppleSimulatorUtils\n * for more details on available service names and statuses.\n * @throws {Error} If there was an error while changing permissions.\n */\nasync function setAccess (udid, bundleId, permissionsMapping) {\n  const permissionsArg = _.toPairs(permissionsMapping)\n    .map((x) => `${x[0]}=${formatStatus(x[1])}`)\n    .join(',');\n  return await execWix([\n    '--byId', udid,\n    '--bundle', bundleId,\n    '--setPermissions', permissionsArg,\n  ]);\n}\n\n/**\n * Retrieves the current permission status for the given service and application.\n *\n * @param {string} bundleId - bundle identifier of the target application.\n * @param {string} serviceName - the name of the service. Should be one of\n * `SERVICES` keys.\n * @param {string} simDataRoot - the path to Simulator `data` root\n * @returns {string} - The current status: yes/no/unset/limited\n * @throws {Error} If there was an error while retrieving permissions.\n */\nasync function getAccess (bundleId, serviceName, simDataRoot) {\n  const internalServiceName = toInternalServiceName(serviceName);\n  const dbPath = path.resolve(simDataRoot, 'Library', 'TCC', 'TCC.db');\n  const getAccessStatus = async (statusPairs, statusKey) => {\n    for (const [statusValue, status] of statusPairs) {\n      const sql = `SELECT count(*) FROM 'access' ` +\n        `WHERE client='${bundleId}' AND ${statusKey}=${statusValue} AND service='${internalServiceName}'`;\n      const count = await execSQLiteQuery(dbPath, sql);\n      if (parseInt(count.split('=')[1], 10) > 0) {\n        return status;\n      }\n    }\n    return STATUS.UNSET;\n  };\n\n  // 'auth_value' existence depends on the OS version rather than Xcode version.\n  // Thus here check the newer one first, then fallback to the older version way.\n  try {\n    // iOS 14+\n    return await getAccessStatus(\n      [['0', STATUS.NO], ['2', STATUS.YES], ['3', STATUS.LIMITED]],\n      'auth_value'\n    );\n  } catch {\n    return await getAccessStatus(\n      [['0', STATUS.NO], ['1', STATUS.YES]],\n      'allowed'\n    );\n  }\n}\n\nconst extensions = {};\n\n/**\n * Sets the particular permission to the application bundle. See\n * https://github.com/wix/AppleSimulatorUtils for more details on\n * the available service names and statuses.\n *\n * @param {string} bundleId - Application bundle identifier.\n * @param {string} permission - Service name to be set.\n * @param {string} value - The desired status for the service.\n * @throws {Error} If there was an error while changing permission.\n */\nextensions.setPermission = async function setPermission (bundleId, permission, value) {\n  await this.setPermissions(bundleId, {[permission]: value});\n};\n\n/**\n * Sets the permissions for the particular application bundle.\n *\n * @param {string} bundleId - Application bundle identifier.\n * @param {Object} permissionsMapping - A mapping where kays\n * are service names and values are their corresponding status values.\n * See https://github.com/wix/AppleSimulatorUtils\n * for more details on available service names and statuses.\n * @throws {Error} If there was an error while changing permissions.\n */\nextensions.setPermissions = async function setPermissions (bundleId, permissionsMapping) {\n  log.debug(`Setting access for '${bundleId}': ${JSON.stringify(permissionsMapping, null, 2)}`);\n  await setAccess(this.udid, bundleId, permissionsMapping);\n};\n\n/**\n * Retrieves current permission status for the given application bundle.\n *\n * @param {string} bundleId - Application bundle identifier.\n * @param {string} serviceName - One of available service names.\n * @throws {Error} If there was an error while retrieving permissions.\n */\nextensions.getPermission = async function getPermission (bundleId, serviceName) {\n  const result = await getAccess(bundleId, serviceName, this.getDir());\n  log.debug(`Got ${serviceName} access status for '${bundleId}': ${result}`);\n  return result;\n};\n\nexport default extensions;\n"],"mappings":";;;;;;;;AAAA;AACA;AACA;AACA;AACA;AAEA,MAAMA,MAAM,GAAGC,MAAM,CAACC,MAAM,CAAC;EAC3BC,KAAK,EAAE,OAAO;EACdC,EAAE,EAAE,IAAI;EACRC,GAAG,EAAE,KAAK;EACVC,OAAO,EAAE;AACX,CAAC,CAAC;AAEF,MAAMC,aAAa,GAAG,eAAe;AACrC,MAAMC,QAAQ,GAAGP,MAAM,CAACC,MAAM,CAAC;EAC7BO,QAAQ,EAAE,qBAAqB;EAC/BC,MAAM,EAAE,mBAAmB;EAC3BC,QAAQ,EAAE,wBAAwB;EAClCC,OAAO,EAAE,mBAAmB;EAC5BC,UAAU,EAAE,uBAAuB;EACnCC,MAAM,EAAE,mBAAmB;EAC3BC,SAAS,EAAE,sBAAsB;EACjCC,YAAY,EAAE,yBAAyB;EACvCC,MAAM,EAAE,mBAAmB;EAC3BC,MAAM,EAAE,gBAAgB;EACxBC,IAAI,EAAE,iBAAiB;EACvBC,MAAM,EAAE;AACV,CAAC,CAAC;AAEF,SAASC,qBAAqB,CAAEC,WAAW,EAAE;EAC3C,IAAIC,eAAC,CAACC,GAAG,CAAChB,QAAQ,EAAEe,eAAC,CAACE,OAAO,CAACH,WAAW,CAAC,CAAC,EAAE;IAC3C,OAAOd,QAAQ,CAACe,eAAC,CAACE,OAAO,CAACH,WAAW,CAAC,CAAC;EACzC;EACA,MAAM,IAAII,KAAK,CACZ,IAAGJ,WAAY,iEAAgEK,IAAI,CAACC,SAAS,CAACL,eAAC,CAACM,IAAI,CAACrB,QAAQ,CAAC,CAAE,EAAC,CACnH;AACH;AAEA,SAASsB,YAAY,CAAEC,MAAM,EAAE;EAC7B,OAAO,CAAC/B,MAAM,CAACG,KAAK,EAAEH,MAAM,CAACI,EAAE,CAAC,CAAC4B,QAAQ,CAACD,MAAM,CAAC,GAAGR,eAAC,CAACU,OAAO,CAACF,MAAM,CAAC,GAAGA,MAAM;AAChF;AASA,eAAeG,eAAe,CAAEC,EAAE,EAAEC,KAAK,EAAE;EACzCC,eAAG,CAACC,KAAK,CAAE,wBAAuBF,KAAM,SAAQD,EAAG,GAAE,CAAC;EACtD,IAAI;IACF,OAAO,CAAC,MAAM,IAAAI,kBAAI,EAAC,SAAS,EAAE,CAAC,OAAO,EAAEJ,EAAE,EAAEC,KAAK,CAAC,CAAC,EAAEI,MAAM;EAC7D,CAAC,CAAC,OAAOC,GAAG,EAAE;IACZ,MAAM,IAAIf,KAAK,CACZ,gCAA+BU,KAAM,SAAQD,EAAG,sBAAqBM,GAAG,CAACC,MAAO,EAAC,CACnF;EACH;AACF;AAEA,eAAeC,OAAO,CAAEC,IAAI,EAAE;EAC5B,IAAI;IACF,MAAMC,WAAE,CAACC,KAAK,CAACvC,aAAa,CAAC;EAC/B,CAAC,CAAC,OAAOwC,CAAC,EAAE;IACV,MAAM,IAAIrB,KAAK,CACZ,GAAEnB,aAAc,2CAA0C,GAC1D,oFAAmF,GACnF,2CAA0C,CAC5C;EACH;EAEA8B,eAAG,CAACC,KAAK,CAAE,cAAa/B,aAAc,IAAGyC,aAAI,CAACC,KAAK,CAACL,IAAI,CAAE,EAAC,CAAC;EAC5D,IAAI;IACF,MAAM;MAACJ;IAAM,CAAC,GAAG,MAAM,IAAAD,kBAAI,EAAChC,aAAa,EAAEqC,IAAI,CAAC;IAChDP,eAAG,CAACC,KAAK,CAAE,mBAAkBE,MAAO,EAAC,CAAC;IACtC,OAAOA,MAAM;EACf,CAAC,CAAC,OAAOO,CAAC,EAAE;IACV,MAAM,IAAIrB,KAAK,CAAE,mBAAkBnB,aAAc,IAAGyC,aAAI,CAACC,KAAK,CAACL,IAAI,CAAE,sBAAqBG,CAAC,CAACL,MAAM,IAAIK,CAAC,CAACG,OAAQ,EAAC,CAAC;EACpH;AACF;AAYA,eAAeC,SAAS,CAAEC,IAAI,EAAEC,QAAQ,EAAEC,kBAAkB,EAAE;EAC5D,MAAMC,cAAc,GAAGhC,eAAC,CAACiC,OAAO,CAACF,kBAAkB,CAAC,CACjDG,GAAG,CAAEC,CAAC,IAAM,GAAEA,CAAC,CAAC,CAAC,CAAE,IAAG5B,YAAY,CAAC4B,CAAC,CAAC,CAAC,CAAC,CAAE,EAAC,CAAC,CAC3CC,IAAI,CAAC,GAAG,CAAC;EACZ,OAAO,MAAMhB,OAAO,CAAC,CACnB,QAAQ,EAAES,IAAI,EACd,UAAU,EAAEC,QAAQ,EACpB,kBAAkB,EAAEE,cAAc,CACnC,CAAC;AACJ;AAYA,eAAeK,SAAS,CAAEP,QAAQ,EAAE/B,WAAW,EAAEuC,WAAW,EAAE;EAC5D,MAAMC,mBAAmB,GAAGzC,qBAAqB,CAACC,WAAW,CAAC;EAC9D,MAAMyC,MAAM,GAAGC,aAAI,CAACC,OAAO,CAACJ,WAAW,EAAE,SAAS,EAAE,KAAK,EAAE,QAAQ,CAAC;EACpE,MAAMK,eAAe,GAAG,OAAOC,WAAW,EAAEC,SAAS,KAAK;IACxD,KAAK,MAAM,CAACC,WAAW,EAAEtC,MAAM,CAAC,IAAIoC,WAAW,EAAE;MAC/C,MAAMG,GAAG,GAAI,gCAA+B,GACzC,iBAAgBjB,QAAS,SAAQe,SAAU,IAAGC,WAAY,iBAAgBP,mBAAoB,GAAE;MACnG,MAAMS,KAAK,GAAG,MAAMrC,eAAe,CAAC6B,MAAM,EAAEO,GAAG,CAAC;MAChD,IAAIE,QAAQ,CAACD,KAAK,CAACE,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,GAAG,CAAC,EAAE;QACzC,OAAO1C,MAAM;MACf;IACF;IACA,OAAO/B,MAAM,CAACG,KAAK;EACrB,CAAC;EAID,IAAI;IAEF,OAAO,MAAM+D,eAAe,CAC1B,CAAC,CAAC,GAAG,EAAElE,MAAM,CAACI,EAAE,CAAC,EAAE,CAAC,GAAG,EAAEJ,MAAM,CAACK,GAAG,CAAC,EAAE,CAAC,GAAG,EAAEL,MAAM,CAACM,OAAO,CAAC,CAAC,EAC5D,YAAY,CACb;EACH,CAAC,CAAC,MAAM;IACN,OAAO,MAAM4D,eAAe,CAC1B,CAAC,CAAC,GAAG,EAAElE,MAAM,CAACI,EAAE,CAAC,EAAE,CAAC,GAAG,EAAEJ,MAAM,CAACK,GAAG,CAAC,CAAC,EACrC,SAAS,CACV;EACH;AACF;AAEA,MAAMqE,UAAU,GAAG,CAAC,CAAC;AAYrBA,UAAU,CAACC,aAAa,GAAG,eAAeA,aAAa,CAAEtB,QAAQ,EAAEuB,UAAU,EAAEC,KAAK,EAAE;EACpF,MAAM,IAAI,CAACC,cAAc,CAACzB,QAAQ,EAAE;IAAC,CAACuB,UAAU,GAAGC;EAAK,CAAC,CAAC;AAC5D,CAAC;AAYDH,UAAU,CAACI,cAAc,GAAG,eAAeA,cAAc,CAAEzB,QAAQ,EAAEC,kBAAkB,EAAE;EACvFjB,eAAG,CAACC,KAAK,CAAE,uBAAsBe,QAAS,MAAK1B,IAAI,CAACC,SAAS,CAAC0B,kBAAkB,EAAE,IAAI,EAAE,CAAC,CAAE,EAAC,CAAC;EAC7F,MAAMH,SAAS,CAAC,IAAI,CAACC,IAAI,EAAEC,QAAQ,EAAEC,kBAAkB,CAAC;AAC1D,CAAC;AASDoB,UAAU,CAACK,aAAa,GAAG,eAAeA,aAAa,CAAE1B,QAAQ,EAAE/B,WAAW,EAAE;EAC9E,MAAM0D,MAAM,GAAG,MAAMpB,SAAS,CAACP,QAAQ,EAAE/B,WAAW,EAAE,IAAI,CAAC2D,MAAM,EAAE,CAAC;EACpE5C,eAAG,CAACC,KAAK,CAAE,OAAMhB,WAAY,uBAAsB+B,QAAS,MAAK2B,MAAO,EAAC,CAAC;EAC1E,OAAOA,MAAM;AACf,CAAC;AAAC,eAEaN,UAAU;AAAA"}