"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _path = _interopRequireDefault(require("path"));
var _support = require("@appium/support");
var _logger = _interopRequireDefault(require("../logger"));
var _bluebird = _interopRequireDefault(require("bluebird"));
var _utils = require("../utils");
const DATA_FILES = [['Caches', '*'], ['Image Cache', '*'], ['WebKit', _utils.MOBILE_SAFARI_BUNDLE_ID, '*'], ['WebKit', 'GeolocationSites.plist'], ['WebKit', 'LocalStorage', '*.*'], ['Safari', '*'], ['Cookies', '*.binarycookies'], ['..', 'tmp', _utils.MOBILE_SAFARI_BUNDLE_ID, '*']];
const extensions = {};
extensions.openUrl = async function openUrl(url) {
  if (!(await this.isRunning())) {
    throw new Error(`Tried to open '${url}', but Simulator is not in Booted state`);
  }
  const timer = new _support.timing.Timer().start();
  try {
    await this.launchApp(_utils.MOBILE_SAFARI_BUNDLE_ID, {
      wait: true,
      timeoutMs: _utils.SAFARI_STARTUP_TIMEOUT_MS
    });
    await this.simctl.openUrl(url);
  } catch (err) {
    throw new Error(`Safari could not open '${url}' after ${timer.getDuration().asSeconds.toFixed(3)}s. ` + `Original error: ${err.stderr || err.message}`);
  }
  _logger.default.debug(`Safari successfully opened '${url}' in ${timer.getDuration().asSeconds.toFixed(3)}s`);
};
extensions.scrubSafari = async function scrubSafari(keepPrefs = true) {
  try {
    await this.terminateApp(_utils.MOBILE_SAFARI_BUNDLE_ID);
  } catch (ign) {}
  _logger.default.debug('Scrubbing Safari data files');
  const safariData = await this.simctl.getAppContainer(_utils.MOBILE_SAFARI_BUNDLE_ID, 'data');
  const libraryDir = _path.default.resolve(safariData, 'Library');
  const deletePromises = DATA_FILES.map(p => _support.fs.rimraf(_path.default.join(libraryDir, ...p)));
  if (!keepPrefs) {
    deletePromises.push(_support.fs.rimraf(_path.default.join(libraryDir, 'Preferences', '*.plist')));
  }
  await _bluebird.default.all(deletePromises);
};
extensions.updateSafariSettings = async function updateSafariSettings(updates) {
  if (_lodash.default.isEmpty(updates)) {
    return false;
  }
  const containerRoot = await this.simctl.getAppContainer(_utils.MOBILE_SAFARI_BUNDLE_ID, 'data');
  const plistPath = _path.default.join(containerRoot, 'Library', 'Preferences', 'com.apple.mobilesafari.plist');
  return await this.updateSettings(plistPath, updates);
};
var _default = extensions;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEQVRBX0ZJTEVTIiwiTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQiLCJleHRlbnNpb25zIiwib3BlblVybCIsInVybCIsImlzUnVubmluZyIsIkVycm9yIiwidGltZXIiLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwibGF1bmNoQXBwIiwid2FpdCIsInRpbWVvdXRNcyIsIlNBRkFSSV9TVEFSVFVQX1RJTUVPVVRfTVMiLCJzaW1jdGwiLCJlcnIiLCJnZXREdXJhdGlvbiIsImFzU2Vjb25kcyIsInRvRml4ZWQiLCJzdGRlcnIiLCJtZXNzYWdlIiwibG9nIiwiZGVidWciLCJzY3J1YlNhZmFyaSIsImtlZXBQcmVmcyIsInRlcm1pbmF0ZUFwcCIsImlnbiIsInNhZmFyaURhdGEiLCJnZXRBcHBDb250YWluZXIiLCJsaWJyYXJ5RGlyIiwicGF0aCIsInJlc29sdmUiLCJkZWxldGVQcm9taXNlcyIsIm1hcCIsInAiLCJmcyIsInJpbXJhZiIsImpvaW4iLCJwdXNoIiwiQiIsImFsbCIsInVwZGF0ZVNhZmFyaVNldHRpbmdzIiwidXBkYXRlcyIsIl8iLCJpc0VtcHR5IiwiY29udGFpbmVyUm9vdCIsInBsaXN0UGF0aCIsInVwZGF0ZVNldHRpbmdzIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2V4dGVuc2lvbnMvc2FmYXJpLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB0aW1pbmcgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQsIFNBRkFSSV9TVEFSVFVQX1RJTUVPVVRfTVMgfSBmcm9tICcuLi91dGlscyc7XG5cbi8vIFRoZSByb290IG9mIGFsbCB0aGVzZSBmaWxlcyBpcyBsb2NhdGVkIHVuZGVyIFNhZmFyaSBkYXRhIGNvbnRhaW5lciByb290XG4vLyBpbiAnTGlicmFyeScgc3ViZm9sZGVyXG5jb25zdCBEQVRBX0ZJTEVTID0gW1xuICBbJ0NhY2hlcycsICcqJ10sXG4gIFsnSW1hZ2UgQ2FjaGUnLCAnKiddLFxuICBbJ1dlYktpdCcsIE1PQklMRV9TQUZBUklfQlVORExFX0lELCAnKiddLFxuICBbJ1dlYktpdCcsICdHZW9sb2NhdGlvblNpdGVzLnBsaXN0J10sXG4gIFsnV2ViS2l0JywgJ0xvY2FsU3RvcmFnZScsICcqLionXSxcbiAgWydTYWZhcmknLCAnKiddLFxuICBbJ0Nvb2tpZXMnLCAnKi5iaW5hcnljb29raWVzJ10sXG4gIFsnLi4nLCAndG1wJywgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQsICcqJ10sXG5dO1xuXG5jb25zdCBleHRlbnNpb25zID0ge307XG5cbi8qKlxuICogT3BlbiB0aGUgZ2l2ZW4gVVJMIGluIG1vYmlsZSBTYWZhcmkgYnJvd3Nlci5cbiAqIFRoZSBicm93c2VyIHdpbGwgYmUgc3RhcnRlZCBhdXRvbWF0aWNhbGx5IGlmIGl0IGlzIG5vdCBydW5uaW5nLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBUaGUgVVJMIHRvIGJlIG9wZW5lZC5cbiAqL1xuZXh0ZW5zaW9ucy5vcGVuVXJsID0gYXN5bmMgZnVuY3Rpb24gb3BlblVybCAodXJsKSB7XG4gIGlmICghYXdhaXQgdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVHJpZWQgdG8gb3BlbiAnJHt1cmx9JywgYnV0IFNpbXVsYXRvciBpcyBub3QgaW4gQm9vdGVkIHN0YXRlYCk7XG4gIH1cbiAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmxhdW5jaEFwcChNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCwge1xuICAgICAgd2FpdDogdHJ1ZSxcbiAgICAgIHRpbWVvdXRNczogU0FGQVJJX1NUQVJUVVBfVElNRU9VVF9NUyxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLnNpbWN0bC5vcGVuVXJsKHVybCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgU2FmYXJpIGNvdWxkIG5vdCBvcGVuICcke3VybH0nIGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc1NlY29uZHMudG9GaXhlZCgzKX1zLiBgICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlfWApO1xuICB9XG4gIGxvZy5kZWJ1ZyhgU2FmYXJpIHN1Y2Nlc3NmdWxseSBvcGVuZWQgJyR7dXJsfScgaW4gJHt0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcy50b0ZpeGVkKDMpfXNgKTtcbn07XG5cbi8qKlxuICogQ2xlYW4gdXAgdGhlIGRpcmVjdG9yaWVzIGZvciBtb2JpbGUgU2FmYXJpLlxuICogU2FmYXJpIHdpbGwgYmUgdGVybWluYXRlZCBpZiBpdCBpcyBydW5uaW5nLlxuICpcbiAqIEBwYXJhbSB7Ym9vbGVhbn0ga2VlcFByZWZzIC0gV2hldGhlciB0byBrZWVwIFNhZmFyaSBwcmVmZXJlbmNlcyBmcm9tIGJlaW5nIGRlbGV0ZWQuXG4gKi9cbmV4dGVuc2lvbnMuc2NydWJTYWZhcmkgPSBhc3luYyBmdW5jdGlvbiBzY3J1YlNhZmFyaSAoa2VlcFByZWZzID0gdHJ1ZSkge1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMudGVybWluYXRlQXBwKE1PQklMRV9TQUZBUklfQlVORExFX0lEKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxuXG4gIGxvZy5kZWJ1ZygnU2NydWJiaW5nIFNhZmFyaSBkYXRhIGZpbGVzJyk7XG4gIGNvbnN0IHNhZmFyaURhdGEgPSBhd2FpdCB0aGlzLnNpbWN0bC5nZXRBcHBDb250YWluZXIoTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQsICdkYXRhJyk7XG4gIGNvbnN0IGxpYnJhcnlEaXIgPSBwYXRoLnJlc29sdmUoc2FmYXJpRGF0YSwgJ0xpYnJhcnknKTtcbiAgY29uc3QgZGVsZXRlUHJvbWlzZXMgPSBEQVRBX0ZJTEVTLm1hcCgocCkgPT4gZnMucmltcmFmKHBhdGguam9pbihsaWJyYXJ5RGlyLCAuLi5wKSkpO1xuICBpZiAoIWtlZXBQcmVmcykge1xuICAgIGRlbGV0ZVByb21pc2VzLnB1c2goZnMucmltcmFmKHBhdGguam9pbihsaWJyYXJ5RGlyLCAnUHJlZmVyZW5jZXMnLCAnKi5wbGlzdCcpKSk7XG4gIH1cbiAgYXdhaXQgQi5hbGwoZGVsZXRlUHJvbWlzZXMpO1xufTtcblxuLyoqXG4gKiBVcGRhdGVzIHZhcmlpb3VzIFNhZmFyaSBzZXR0aW5ncy4gU2ltdWxhdG9yIG11c3QgYmUgYm9vdGVkIGluIG9yZGVyIHRvIGZvciBpdFxuICogdG8gc3VjY2Vzcy5cbiAqXG4gKiBAcGFyYW0ge29iamVjdH0gdXBkYXRlcyBBbiBvYmplY3QgY29udGFpbmluZyBTYWZhcmkgc2V0dGluZ3MgdG8gYmUgdXBkYXRlZC5cbiAqIFRoZSBsaXN0IG9mIGF2YWlsYWJsZSBzZXR0aW5nIG5hbWVzIGFuZCB0aGVpciB2YWx1ZXMgY291bGQgYmUgcmV0cml2ZWQgYnlcbiAqIGNoYW5naW5nIHRoZSBjb3JyZXNwb25kaW5nIFNhZmFyaSBzZXR0aW5ncyBpbiB0aGUgVUkgYW5kIHRoZW4gaW5zcGVjdGluZ1xuICogJ0xpYnJhcnkvUHJlZmVyZW5jZXMvY29tLmFwcGxlLm1vYmlsZXNhZmFyaS5wbGlzdCcgZmlsZSBpbnNpZGUgb2ZcbiAqIGNvbS5hcHBsZS5tb2JpbGVzYWZhcmkgYXBwIGNvbnRhaW5lci5cbiAqIFRoZSBmdWxsIHBhdGggdG8gdGhlIE1vYmlsZSBTYWZhcmkncyBjb250YWluZXIgY291bGQgYmUgcmV0cmlldmVkIGZyb21cbiAqIGB4Y3J1biBzaW1jdGwgZ2V0X2FwcF9jb250YWluZXIgPHNpbV91ZGlkPiBjb20uYXBwbGUubW9iaWxlc2FmYXJpIGRhdGFgXG4gKiBjb21tYW5kIG91dHB1dC5cbiAqIFVzZSB0aGUgYHhjcnVuIHNpbWN0bCBzcGF3biA8c2ltX3VkaWQ+IGRlZmF1bHRzIHJlYWQgPHBhdGhfdG9fcGxpc3Q+YCBjb21tYW5kXG4gKiB0byBwcmludCB0aGUgcGxpc3QgY29udGVudCB0byB0aGUgVGVybWluYWwuXG4gKi9cbmV4dGVuc2lvbnMudXBkYXRlU2FmYXJpU2V0dGluZ3MgPSBhc3luYyBmdW5jdGlvbiB1cGRhdGVTYWZhcmlTZXR0aW5ncyAodXBkYXRlcykge1xuICBpZiAoXy5pc0VtcHR5KHVwZGF0ZXMpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3QgY29udGFpbmVyUm9vdCA9IGF3YWl0IHRoaXMuc2ltY3RsLmdldEFwcENvbnRhaW5lcihNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCwgJ2RhdGEnKTtcbiAgY29uc3QgcGxpc3RQYXRoID0gcGF0aC5qb2luKGNvbnRhaW5lclJvb3QsICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmkucGxpc3QnKTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlU2V0dGluZ3MocGxpc3RQYXRoLCB1cGRhdGVzKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBSUEsTUFBTUEsVUFBVSxHQUFHLENBQ2pCLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxFQUNmLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxFQUNwQixDQUFDLFFBQVEsRUFBRUMsOEJBQXVCLEVBQUUsR0FBRyxDQUFDLEVBQ3hDLENBQUMsUUFBUSxFQUFFLHdCQUF3QixDQUFDLEVBQ3BDLENBQUMsUUFBUSxFQUFFLGNBQWMsRUFBRSxLQUFLLENBQUMsRUFDakMsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLEVBQ2YsQ0FBQyxTQUFTLEVBQUUsaUJBQWlCLENBQUMsRUFDOUIsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFQSw4QkFBdUIsRUFBRSxHQUFHLENB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