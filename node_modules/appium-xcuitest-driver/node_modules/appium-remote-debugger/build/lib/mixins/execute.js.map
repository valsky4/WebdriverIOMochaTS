{"version":3,"file":"execute.js","names":["_logger","_interopRequireDefault","require","_baseDriver","_utils","_atoms","_support","_asyncbox","_lodash","RPC_RESPONSE_TIMEOUT_MS","executeAtom","atom","args","frames","rpcClient","isConnected","Error","log","debug","JSON","stringify","script","getScriptForAtom","value","execute","_","truncate","simpleStringify","length","RESPONSE_LOG_LENGTH","executeAtomAsync","evaluate","method","opts","send","Object","assign","appIdKey","pageIdKey","returnByValue","promiseName","util","uuidV4","replace","obj","expression","promiseObjectId","result","objectId","asyncCallBack","res","subcommandTimeout","generatePreview","saveResult","err","message","includes","retryWait","timeout","retries","parseInt","timer","timing","Timer","start","retryInterval","hasValue","errors","TimeoutError","getDuration","asMilliSeconds","toFixed","ign","convertResult","command","override","pageLoading","waitForDom","isNil","garbageCollectOnExecute","garbageCollect","callFunction","fn","checkParams","functionDeclaration","arguments","_default","exports","default"],"sources":["../../../lib/mixins/execute.js"],"sourcesContent":["import log from '../logger';\nimport { errors } from '@appium/base-driver';\nimport { checkParams, simpleStringify, convertResult, RESPONSE_LOG_LENGTH } from '../utils';\nimport { getScriptForAtom } from '../atoms';\nimport { util, timing } from '@appium/support';\nimport { retryInterval } from 'asyncbox';\nimport _ from 'lodash';\n\n\n/* How many milliseconds to wait for webkit to return a response before timing out */\nconst RPC_RESPONSE_TIMEOUT_MS = 5000;\n\n/**\n * Execute a Selenium atom in Safari\n * @param {string} atom Name of Selenium atom (see atoms/ directory)\n * @param {Array<*>} args Arguments passed to the atom\n * @param {Array<string>} frames\n * @returns {string} The result received from the atom\n */\nasync function executeAtom (atom, args, frames) {\n  if (!this.rpcClient.isConnected) {\n    throw new Error('Remote debugger is not connected');\n  }\n\n  log.debug(`Executing atom '${atom}' with 'args=${JSON.stringify(args)}; frames=${frames}'`);\n  const script = await getScriptForAtom(atom, args, frames);\n  const value = await this.execute(script, true);\n  log.debug(`Received result for atom '${atom}' execution: ${_.truncate(simpleStringify(value), {length: RESPONSE_LOG_LENGTH})}`);\n  return value;\n}\n\nasync function executeAtomAsync (atom, args, frames) {\n  // helper to send directly to the web inspector\n  const evaluate = async (method, opts) => await this.rpcClient.send(method, Object.assign({\n    appIdKey: this.appIdKey,\n    pageIdKey: this.pageIdKey,\n    returnByValue: false,\n  }, opts));\n\n  // first create a Promise on the page, saving the resolve/reject functions\n  // as properties\n  const promiseName = `appiumAsyncExecutePromise${util.uuidV4().replace(/-/g, '')}`;\n  const script =\n    `var res, rej;\n    window.${promiseName} = new Promise(function (resolve, reject) {\n      res = resolve;\n      rej = reject;\n    });\n    window.${promiseName}.resolve = res;\n    window.${promiseName}.reject = rej;\n    window.${promiseName};`;\n  const obj = await evaluate('Runtime.evaluate', {\n    expression: script,\n  });\n  const promiseObjectId = obj.result.objectId;\n\n  // execute the atom, calling back to the resolve function\n  const asyncCallBack =\n    `function (res) {\n      window.${promiseName}.resolve(res);\n      window.${promiseName}Value = res;\n    }`;\n  await this.execute(await getScriptForAtom(atom, args, frames, asyncCallBack));\n\n  // wait for the promise to be resolved\n  let res;\n  const subcommandTimeout = 1000; // timeout on individual commands\n  try {\n    res = await evaluate('Runtime.awaitPromise', {\n      promiseObjectId,\n      returnByValue: true,\n      generatePreview: true,\n      saveResult: true,\n    });\n  } catch (err) {\n    if (!err.message.includes(`'Runtime.awaitPromise' was not found`)) {\n      throw err;\n    }\n    // awaitPromise is not always available, so simulate it with poll\n    const retryWait = 100;\n    const timeout = (args.length >= 3) ? args[2] : RPC_RESPONSE_TIMEOUT_MS;\n    // if the timeout math turns up 0 retries, make sure it happens once\n    const retries = parseInt(timeout / retryWait, 10) || 1;\n    const timer = new timing.Timer().start();\n    log.debug(`Waiting up to ${timeout}ms for async execute to finish`);\n    res = await retryInterval(retries, retryWait, async () => {\n      // the atom _will_ return, either because it finished or an error\n      // including a timeout error\n      const hasValue = await evaluate('Runtime.evaluate', {\n        expression: `window.hasOwnProperty('${promiseName}Value');`,\n        returnByValue: true,\n      });\n      if (hasValue) {\n        // we only put the property on `window` when the callback is called,\n        // so if it is there, everything is done\n        return await evaluate('Runtime.evaluate', {\n          expression: `window.${promiseName}Value;`,\n          returnByValue: true,\n        });\n      }\n      // throw a TimeoutError, or else it needs to be caught and re-thrown\n      throw new errors.TimeoutError(`Timed out waiting for asynchronous script ` +\n                                    `result after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms'));`);\n    });\n  } finally {\n    try {\n      // try to get rid of the promise\n      await this.executeAtom('execute_script', [`delete window.${promiseName};`, [null, null], subcommandTimeout], frames);\n    } catch (ign) {}\n  }\n  return convertResult(res);\n}\n\nasync function execute (command, override) {\n  // if the page is not loaded yet, wait for it\n  if (this.pageLoading && !override) {\n    log.debug('Trying to execute but page is not loaded.');\n    await this.waitForDom();\n  }\n\n  if (_.isNil(this.appIdKey)) {\n    throw new Error('Missing parameter: appIdKey. Is the target web application still alive?');\n  }\n  if (_.isNil(this.pageIdKey)) {\n    throw new Error('Missing parameter: pageIdKey. Is the target web page still alive?');\n  }\n\n  if (this.garbageCollectOnExecute) {\n    await this.garbageCollect();\n  }\n\n  log.debug(`Sending javascript command: '${_.truncate(command, {length: 50})}'`);\n  const res = await this.rpcClient.send('Runtime.evaluate', {\n    expression: command,\n    returnByValue: true,\n    appIdKey: this.appIdKey,\n    pageIdKey: this.pageIdKey,\n  });\n\n  return convertResult(res);\n}\n\nasync function callFunction (objectId, fn, args) {\n  checkParams({appIdKey: this.appIdKey, pageIdKey: this.pageIdKey});\n\n  if (this.garbageCollectOnExecute) {\n    await this.garbageCollect();\n  }\n\n  log.debug('Calling javascript function');\n  const res = await this.rpcClient.send('Runtime.callFunctionOn', {\n    objectId,\n    functionDeclaration: fn,\n    arguments: args,\n    returnByValue: true,\n    appIdKey: this.appIdKey,\n    pageIdKey: this.pageIdKey,\n  });\n\n  return convertResult(res);\n}\n\n\nexport default { executeAtom, executeAtomAsync, execute, callFunction };\n"],"mappings":"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"}