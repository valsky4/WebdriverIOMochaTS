"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger"));
var _utils = require("../utils");
var _events = _interopRequireDefault(require("./events"));
var _support = require("@appium/support");
var _lodash = _interopRequireDefault(require("lodash"));
var _bluebird = _interopRequireDefault(require("bluebird"));
function frameDetached() {
  this.emit(_events.default.EVENT_FRAMES_DETACHED);
}
async function pageLoad(startPageLoadTimer, pageLoadVerifyHook = _lodash.default.noop) {
  var _startPageLoadTimer;
  const timeoutMs = 500;
  if (!_lodash.default.isFunction((_startPageLoadTimer = startPageLoadTimer) === null || _startPageLoadTimer === void 0 ? void 0 : _startPageLoadTimer.getDuration)) {
    _logger.default.debug(`Page load timer not a timer. Creating new timer`);
    startPageLoadTimer = new _support.timing.Timer().start();
  }
  _logger.default.debug('Page loaded, verifying whether ready');
  this.pageLoading = true;
  const verify = async () => {
    this.pageLoadDelay = _support.util.cancellableDelay(timeoutMs);
    try {
      await this.pageLoadDelay;
    } catch (err) {
      if (err instanceof _bluebird.default.CancellationError) {
        return;
      }
    }
    if (!this.appIdKey) {
      _logger.default.debug('Not connected to an application. Ignoring page load');
      return;
    }
    if (_lodash.default.isFunction(pageLoadVerifyHook)) {
      await pageLoadVerifyHook();
    }
    const elapsedMs = startPageLoadTimer.getDuration().asMilliSeconds;
    if ((await this.checkPageIsReady()) || this.pageLoadMs > 0 && elapsedMs > this.pageLoadMs) {
      _logger.default.debug('Page is ready');
      this.pageLoading = false;
    } else {
      _logger.default.debug('Page was not ready, retrying');
      await verify();
    }
  };
  try {
    await verify();
  } finally {
    _logger.default.debug(`Page load completed in ${startPageLoadTimer.getDuration().asMilliSeconds.toFixed(0)}ms`);
    this.pageLoading = false;
  }
}
function cancelPageLoad() {
  _logger.default.debug('Unregistering from page readiness notifications');
  this.pageLoading = false;
  if (this.pageLoadDelay) {
    this.pageLoadDelay.cancel();
  }
}
async function pageUnload() {
  _logger.default.debug('Page unloading');
  await this.waitForDom();
}
async function waitForDom(startPageLoadTimer, pageLoadVerifyHook) {
  _logger.default.debug('Waiting for dom...');
  await this.pageLoad(startPageLoadTimer, pageLoadVerifyHook);
}
async function checkPageIsReady() {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey
  });
  _logger.default.debug('Checking document readyState');
  const readyCmd = 'document.readyState;';
  let readyState = 'loading';
  try {
    readyState = await _bluebird.default.resolve(this.execute(readyCmd, true)).timeout(this.pageReadyTimeout);
  } catch (err) {
    if (!(err instanceof _bluebird.default.TimeoutError)) {
      throw err;
    }
    _logger.default.debug(`Page readiness check timed out after ${this.pageReadyTimeout}ms`);
    return false;
  }
  _logger.default.debug(`Document readyState is '${readyState}'`);
  return readyState === 'complete';
}
async function navToUrl(url, pageLoadVerifyHook) {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  this._navigatingToPage = true;
  try {
    _logger.default.debug(`Navigating to new URL: '${url}'`);
    const waitForFramePromise = this.waitForFrameNavigated();
    await this.rpcClient.send('Page.navigate', {
      url,
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
    if (!this.useNewSafari) {
      await _bluebird.default.delay(1000);
    }
    await waitForFramePromise;
    await this.waitForDom(new _support.timing.Timer().start(), pageLoadVerifyHook);
    await this.rpcClient.send('Console.enable', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
  } finally {
    this._navigatingToPage = false;
  }
}
async function waitForFrameNavigated() {
  let navEventListener;
  return await new _bluebird.default(async resolve => {
    _logger.default.debug('Waiting for frame navigated message...');
    const start = new _support.timing.Timer().start();
    navEventListener = (err, value) => {
      _logger.default.debug(`Frame navigated in ${start.getDuration().asMilliSeconds.toFixed(0)}ms from: ${value}`);
      if (!this.allowNavigationWithoutReload && !this.pageLoading) {
        resolve(value);
      } else {
        _logger.default.debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');
        this.allowNavigationWithoutReload = false;
      }
      if (this.navigationDelay) {
        this.navigationDelay.cancel();
      }
    };
    this.rpcClient.once('Page.frameNavigated', navEventListener);
    if (!this.useNewSafari || this.pageLoadMs >= 0) {
      const timeout = this.useNewSafari ? this.pageLoadMs : 500;
      this.navigationDelay = _support.util.cancellableDelay(timeout);
      try {
        await this.navigationDelay;
        navEventListener(null, `${timeout}ms timeout`);
      } catch (err) {}
    }
  }).finally(() => {
    if (navEventListener) {
      this.rpcClient.off('Page.frameNavigated', navEventListener);
    }
  });
}
var _default = {
  frameDetached,
  pageLoad,
  cancelPageLoad,
  pageUnload,
  waitForDom,
  checkPageIsReady,
  navToUrl,
  waitForFrameNavigated
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9nZ2VyIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfdXRpbHMiLCJfZXZlbnRzIiwiX3N1cHBvcnQiLCJfbG9kYXNoIiwiX2JsdWViaXJkIiwiZnJhbWVEZXRhY2hlZCIsImVtaXQiLCJldmVudHMiLCJFVkVOVF9GUkFNRVNfREVUQUNIRUQiLCJwYWdlTG9hZCIsInN0YXJ0UGFnZUxvYWRUaW1lciIsInBhZ2VMb2FkVmVyaWZ5SG9vayIsIl8iLCJub29wIiwiX3N0YXJ0UGFnZUxvYWRUaW1lciIsInRpbWVvdXRNcyIsImlzRnVuY3Rpb24iLCJnZXREdXJhdGlvbiIsImxvZyIsImRlYnVnIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsInBhZ2VMb2FkaW5nIiwidmVyaWZ5IiwicGFnZUxvYWREZWxheSIsInV0aWwiLCJjYW5jZWxsYWJsZURlbGF5IiwiZXJyIiwiQiIsIkNhbmNlbGxhdGlvbkVycm9yIiwiYXBwSWRLZXkiLCJlbGFwc2VkTXMiLCJhc01pbGxpU2Vjb25kcyIsImNoZWNrUGFnZUlzUmVhZHkiLCJwYWdlTG9hZE1zIiwidG9GaXhlZCIsImNhbmNlbFBhZ2VMb2FkIiwiY2FuY2VsIiwicGFnZVVubG9hZCIsIndhaXRGb3JEb20iLCJjaGVja1BhcmFtcyIsInJlYWR5Q21kIiwicmVhZHlTdGF0ZSIsInJlc29sdmUiLCJleGVjdXRlIiwidGltZW91dCIsInBhZ2VSZWFkeVRpbWVvdXQiLCJUaW1lb3V0RXJyb3IiLCJuYXZUb1VybCIsInVybCIsInBhZ2VJZEtleSIsIl9uYXZpZ2F0aW5nVG9QYWdlIiwid2FpdEZvckZyYW1lUHJvbWlzZSIsIndhaXRGb3JGcmFtZU5hdmlnYXRlZCIsInJwY0NsaWVudCIsInNlbmQiLCJ1c2VOZXdTYWZhcmkiLCJkZWxheSIsIm5hdkV2ZW50TGlzdGVuZXIiLCJ2YWx1ZSIsImFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQiLCJuYXZpZ2F0aW9uRGVsYXkiLCJvbmNlIiwiZmluYWxseSIsIm9mZiIsIl9kZWZhdWx0IiwiZXhwb3J0cyIsImRlZmF1bHQiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvbWl4aW5zL25hdmlnYXRlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGNoZWNrUGFyYW1zIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IGV2ZW50cyBmcm9tICcuL2V2ZW50cyc7XG5pbXBvcnQgeyB0aW1pbmcsIHV0aWwgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG5mdW5jdGlvbiBmcmFtZURldGFjaGVkICgpIHtcbiAgdGhpcy5lbWl0KGV2ZW50cy5FVkVOVF9GUkFNRVNfREVUQUNIRUQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwYWdlTG9hZCAoc3RhcnRQYWdlTG9hZFRpbWVyLCBwYWdlTG9hZFZlcmlmeUhvb2sgPSBfLm5vb3ApIHtcbiAgY29uc3QgdGltZW91dE1zID0gNTAwO1xuICBpZiAoIV8uaXNGdW5jdGlvbihzdGFydFBhZ2VMb2FkVGltZXI/LmdldER1cmF0aW9uKSkge1xuICAgIGxvZy5kZWJ1ZyhgUGFnZSBsb2FkIHRpbWVyIG5vdCBhIHRpbWVyLiBDcmVhdGluZyBuZXcgdGltZXJgKTtcbiAgICBzdGFydFBhZ2VMb2FkVGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnUGFnZSBsb2FkZWQsIHZlcmlmeWluZyB3aGV0aGVyIHJlYWR5Jyk7XG4gIHRoaXMucGFnZUxvYWRpbmcgPSB0cnVlO1xuXG4gIGNvbnN0IHZlcmlmeSA9IGFzeW5jICgpID0+IHtcbiAgICB0aGlzLnBhZ2VMb2FkRGVsYXkgPSB1dGlsLmNhbmNlbGxhYmxlRGVsYXkodGltZW91dE1zKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wYWdlTG9hZERlbGF5O1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIEIuQ2FuY2VsbGF0aW9uRXJyb3IpIHtcbiAgICAgICAgLy8gaWYgdGhlIHByb21pc2UgaGFzIGJlZW4gY2FuY2VsbGVkXG4gICAgICAgIC8vIHdlIHdhbnQgdG8gc2tpcCBjaGVja2luZyB0aGUgcmVhZGluZXNzXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB3ZSBjYW4gZ2V0IHRoaXMgY2FsbGVkIGluIHRoZSBtaWRkbGUgb2YgdHJ5aW5nIHRvIGZpbmQgYSBuZXcgYXBwXG4gICAgaWYgKCF0aGlzLmFwcElkS2V5KSB7XG4gICAgICBsb2cuZGVidWcoJ05vdCBjb25uZWN0ZWQgdG8gYW4gYXBwbGljYXRpb24uIElnbm9yaW5nIHBhZ2UgbG9hZCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChfLmlzRnVuY3Rpb24ocGFnZUxvYWRWZXJpZnlIb29rKSkge1xuICAgICAgYXdhaXQgcGFnZUxvYWRWZXJpZnlIb29rKCk7XG4gICAgfVxuXG4gICAgLy8gaWYgd2UgYXJlIHJlYWR5LCBvciB3ZSd2ZSBzcGVuZCB0b28gbXVjaCB0aW1lIG9uIHRoaXNcbiAgICBjb25zdCBlbGFwc2VkTXMgPSBzdGFydFBhZ2VMb2FkVGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcztcbiAgICBpZiAoYXdhaXQgdGhpcy5jaGVja1BhZ2VJc1JlYWR5KCkgfHwgKHRoaXMucGFnZUxvYWRNcyA+IDAgJiYgZWxhcHNlZE1zID4gdGhpcy5wYWdlTG9hZE1zKSkge1xuICAgICAgbG9nLmRlYnVnKCdQYWdlIGlzIHJlYWR5Jyk7XG4gICAgICB0aGlzLnBhZ2VMb2FkaW5nID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnUGFnZSB3YXMgbm90IHJlYWR5LCByZXRyeWluZycpO1xuICAgICAgYXdhaXQgdmVyaWZ5KCk7XG4gICAgfVxuICB9O1xuICB0cnkge1xuICAgIGF3YWl0IHZlcmlmeSgpO1xuICB9IGZpbmFsbHkge1xuICAgIGxvZy5kZWJ1ZyhgUGFnZSBsb2FkIGNvbXBsZXRlZCBpbiAke3N0YXJ0UGFnZUxvYWRUaW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgICB0aGlzLnBhZ2VMb2FkaW5nID0gZmFsc2U7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2FuY2VsUGFnZUxvYWQgKCkge1xuICBsb2cuZGVidWcoJ1VucmVnaXN0ZXJpbmcgZnJvbSBwYWdlIHJlYWRpbmVzcyBub3RpZmljYXRpb25zJyk7XG4gIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgaWYgKHRoaXMucGFnZUxvYWREZWxheSkge1xuICAgIHRoaXMucGFnZUxvYWREZWxheS5jYW5jZWwoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwYWdlVW5sb2FkICgpIHtcbiAgbG9nLmRlYnVnKCdQYWdlIHVubG9hZGluZycpO1xuICBhd2FpdCB0aGlzLndhaXRGb3JEb20oKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gd2FpdEZvckRvbSAoc3RhcnRQYWdlTG9hZFRpbWVyLCBwYWdlTG9hZFZlcmlmeUhvb2spIHtcbiAgbG9nLmRlYnVnKCdXYWl0aW5nIGZvciBkb20uLi4nKTtcbiAgYXdhaXQgdGhpcy5wYWdlTG9hZChzdGFydFBhZ2VMb2FkVGltZXIsIHBhZ2VMb2FkVmVyaWZ5SG9vayk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrUGFnZUlzUmVhZHkgKCkge1xuICBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXl9KTtcblxuICBsb2cuZGVidWcoJ0NoZWNraW5nIGRvY3VtZW50IHJlYWR5U3RhdGUnKTtcbiAgY29uc3QgcmVhZHlDbWQgPSAnZG9jdW1lbnQucmVhZHlTdGF0ZTsnO1xuICBsZXQgcmVhZHlTdGF0ZSA9ICdsb2FkaW5nJztcbiAgdHJ5IHtcbiAgICByZWFkeVN0YXRlID0gYXdhaXQgQi5yZXNvbHZlKHRoaXMuZXhlY3V0ZShyZWFkeUNtZCwgdHJ1ZSkpLnRpbWVvdXQodGhpcy5wYWdlUmVhZHlUaW1lb3V0KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKCEoZXJyIGluc3RhbmNlb2YgQi5UaW1lb3V0RXJyb3IpKSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgUGFnZSByZWFkaW5lc3MgY2hlY2sgdGltZWQgb3V0IGFmdGVyICR7dGhpcy5wYWdlUmVhZHlUaW1lb3V0fW1zYCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGxvZy5kZWJ1ZyhgRG9jdW1lbnQgcmVhZHlTdGF0ZSBpcyAnJHtyZWFkeVN0YXRlfSdgKTtcblxuICByZXR1cm4gcmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJztcbn1cblxuYXN5bmMgZnVuY3Rpb24gbmF2VG9VcmwgKHVybCwgcGFnZUxvYWRWZXJpZnlIb29rKSB7XG4gIGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleSwgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleX0pO1xuXG4gIHRoaXMuX25hdmlnYXRpbmdUb1BhZ2UgPSB0cnVlO1xuXG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKGBOYXZpZ2F0aW5nIHRvIG5ldyBVUkw6ICcke3VybH0nYCk7XG5cbiAgICAvLyBiZWdpbiBsaXN0ZW5pbmcgZm9yIGZyYW1lIG5hdmlnYXRpb24gZXZlbnQsIHdoaWNoIHdpbGwgYmUgd2FpdGVkIGZvciBsYXRlclxuICAgIGNvbnN0IHdhaXRGb3JGcmFtZVByb21pc2UgPSB0aGlzLndhaXRGb3JGcmFtZU5hdmlnYXRlZCgpO1xuXG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnUGFnZS5uYXZpZ2F0ZScsIHtcbiAgICAgIHVybCxcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICB9KTtcblxuICAgIGlmICghdGhpcy51c2VOZXdTYWZhcmkpIHtcbiAgICAgIC8vIGEgc21hbGwgcGF1c2UgZm9yIHRoZSBicm93c2VyIHRvIGNhdGNoIHVwXG4gICAgICBhd2FpdCBCLmRlbGF5KDEwMDApO1xuICAgIH1cblxuICAgIC8vIHdhaXQgdW50aWwgdGhlIHBhZ2UgaGFzIGJlZW4gbmF2aWdhdGVkXG4gICAgYXdhaXQgd2FpdEZvckZyYW1lUHJvbWlzZTtcblxuICAgIGF3YWl0IHRoaXMud2FpdEZvckRvbShuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKSwgcGFnZUxvYWRWZXJpZnlIb29rKTtcblxuICAgIC8vIGVuYWJsZSBjb25zb2xlIGxvZ2dpbmcsIHNvIHdlIGdldCB0aGUgZXZlbnRzIChvdGhlcndpc2Ugd2Ugb25seVxuICAgIC8vIGdldCBub3RpZmllZCB3aGVuIG5hdmlnYXRpbmcgdG8gYSBsb2NhbCBwYWdlXG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnQ29uc29sZS5lbmFibGUnLCB7XG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgfSk7XG4gIH0gZmluYWxseSB7XG4gICAgdGhpcy5fbmF2aWdhdGluZ1RvUGFnZSA9IGZhbHNlO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdhaXRGb3JGcmFtZU5hdmlnYXRlZCAoKSB7XG4gIGxldCBuYXZFdmVudExpc3RlbmVyO1xuICByZXR1cm4gYXdhaXQgbmV3IEIoYXN5bmMgKHJlc29sdmUpID0+IHtcbiAgICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGZyYW1lIG5hdmlnYXRlZCBtZXNzYWdlLi4uJyk7XG4gICAgY29uc3Qgc3RhcnQgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcblxuICAgIC8vIGFkZCBhIGhhbmRsZXIgZm9yIHRoZSBgUGFnZS5mcmFtZU5hdmlnYXRlZGAgbWVzc2FnZVxuICAgIC8vIGZyb20gdGhlIHJlbW90ZSBkZWJ1Z2dlclxuICAgIG5hdkV2ZW50TGlzdGVuZXIgPSAoZXJyLCB2YWx1ZSkgPT4ge1xuICAgICAgbG9nLmRlYnVnKGBGcmFtZSBuYXZpZ2F0ZWQgaW4gJHtzdGFydC5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXMgZnJvbTogJHt2YWx1ZX1gKTtcbiAgICAgIGlmICghdGhpcy5hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkICYmICF0aGlzLnBhZ2VMb2FkaW5nKSB7XG4gICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKCdGcmFtZSBuYXZpZ2F0ZWQgYnV0IHdlIHdlcmUgd2FybmVkIGFib3V0IGl0LCBub3QgJyArXG4gICAgICAgICAgICAgICAgICAnY29uc2lkZXJpbmcgcGFnZSBzdGF0ZSB1bmxvYWRlZCcpO1xuICAgICAgICB0aGlzLmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLm5hdmlnYXRpb25EZWxheSkge1xuICAgICAgICB0aGlzLm5hdmlnYXRpb25EZWxheS5jYW5jZWwoKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5ycGNDbGllbnQub25jZSgnUGFnZS5mcmFtZU5hdmlnYXRlZCcsIG5hdkV2ZW50TGlzdGVuZXIpO1xuXG4gICAgLy8gdGltZW91dCwgaW4gY2FzZSByZW1vdGUgZGVidWdnZXIgZG9lc24ndCByZXNwb25kLFxuICAgIC8vIG9yIHRha2VzIGEgbG9uZyB0aW1lXG4gICAgaWYgKCF0aGlzLnVzZU5ld1NhZmFyaSB8fCB0aGlzLnBhZ2VMb2FkTXMgPj0gMCkge1xuICAgICAgLy8gdXNlIHBhZ2VMb2FkTXMsIG9yIGEgc21hbGwgYW1vdW50IG9mIHRpbWVcbiAgICAgIGNvbnN0IHRpbWVvdXQgPSB0aGlzLnVzZU5ld1NhZmFyaSA/IHRoaXMucGFnZUxvYWRNcyA6IDUwMDtcbiAgICAgIHRoaXMubmF2aWdhdGlvbkRlbGF5ID0gdXRpbC5jYW5jZWxsYWJsZURlbGF5KHRpbWVvdXQpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5uYXZpZ2F0aW9uRGVsYXk7XG4gICAgICAgIG5hdkV2ZW50TGlzdGVuZXIobnVsbCwgYCR7dGltZW91dH1tcyB0aW1lb3V0YCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gbm90aGluZyB0byBkbzogd2Ugb25seSBnZXQgaGVyZSBpZiB0aGUgcmVtb3RlIGRlYnVnZ2VyXG4gICAgICAgIC8vIGFscmVhZHkgbm90aWZpZWQgb2YgZnJhbWUgbmF2aWdhdGlvbiwgYW5kIHRoZSBkZWxheVxuICAgICAgICAvLyB3YXMgY2FuY2VsbGVkXG4gICAgICB9XG4gICAgfVxuICB9KS5maW5hbGx5KCgpID0+IHtcbiAgICBpZiAobmF2RXZlbnRMaXN0ZW5lcikge1xuICAgICAgdGhpcy5ycGNDbGllbnQub2ZmKCdQYWdlLmZyYW1lTmF2aWdhdGVkJywgbmF2RXZlbnRMaXN0ZW5lcik7XG4gICAgfVxuICB9KTtcbn1cblxuXG5leHBvcnQgZGVmYXVsdCB7IGZyYW1lRGV0YWNoZWQsIHBhZ2VMb2FkLCBjYW5jZWxQYWdlTG9hZCwgcGFnZVVubG9hZCwgd2FpdEZvckRvbSwgY2hlY2tQYWdlSXNSZWFkeSwgbmF2VG9VcmwsIHdhaXRGb3JGcmFtZU5hdmlnYXRlZCB9O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLE1BQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLE9BQUEsR0FBQUgsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFHLFFBQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLE9BQUEsR0FBQUwsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFLLFNBQUEsR0FBQU4sc0JBQUEsQ0FBQUMsT0FBQTtBQUdBLFNBQVNNLGFBQWFBLENBQUEsRUFBSTtFQUN4QixJQUFJLENBQUNDLElBQUksQ0FBQ0MsZUFBTSxDQUFDQyxxQkFBcUIsQ0FBQztBQUN6QztBQUVBLGVB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